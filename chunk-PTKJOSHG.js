import{T as c,Z as g,aa as _,ca as f}from"./chunk-4OLSY4ZS.js";import{I as u,N as d,da as n}from"./chunk-5O64VQN5.js";var h=15,m=class l{datastore=d(g);rpc=d(_);seasonService=d(f);subscription=null;orderSubscription=null;_orders=n([]);_loading=n(!1);_error=n(null);_activeFilter=n("all");_selectedSeasonIds=n([]);_cursor=n(null);_hasMore=n(!1);_loadingMore=n(!1);_actionLoading=n(!1);_actionError=n(null);orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();selectedSeasonIds=this._selectedSeasonIds.asReadonly();filteredOrders=this._orders.asReadonly();setSelectedSeasons(s){console.log("[AdminOrdersStore] setSelectedSeasons:",s.length===0?"all":s),this._selectedSeasonIds.set(s)}toggleSeasonSelection(s){let r=this._selectedSeasonIds();r.includes(s)?this._selectedSeasonIds.set(r.filter(e=>e!==s)):this._selectedSeasonIds.set([...r,s]),console.log("[AdminOrdersStore] toggleSeasonSelection:",this._selectedSeasonIds())}setFilter(s){this._activeFilter.set(s),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(s){console.log("[AdminOrdersStore] loadPage called, seasonId param:",s),this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let r=s??this.getActiveSeasonId();if(console.log("[AdminOrdersStore] loadPage: resolved seasonId =",r),!r){console.warn("[AdminOrdersStore] loadPage: no seasonId, setting empty orders"),this._orders.set([]);return}let e=await this.queryOrders(r,h);console.log("[AdminOrdersStore] loadPage: fetched",e.orders.length,"orders, hasMore:",e.hasMore),this._orders.set(e.orders),this._cursor.set(e.lastDoc),this._hasMore.set(e.hasMore)}catch(r){console.error("[AdminOrdersStore] loadPage error:",r);let e=r instanceof Error?r.message:String(r);throw this._error.set(e),r}finally{this._loading.set(!1)}}async loadMore(s){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let r=s??this.getActiveSeasonId();if(!r)return;let e=this._cursor(),t=await this.queryOrders(r,h,e);this._orders.update(o=>[...o,...t.orders]),this._cursor.set(t.lastDoc),this._hasMore.set(t.hasMore)}catch(r){let e=r instanceof Error?r.message:String(r);throw this._error.set(e),r}finally{this._loadingMore.set(!1)}}}queryOrders(s,r,e){let t=this._activeFilter();switch(t){case"locked":case"submitted":case"paid":return this.datastore.listOrdersByStatusPaginated(s,t,r,e);case"all":return this.datastore.listOrdersPaginated(s,r,e)}}getActiveSeasonId(){let r=this.seasonService.selectedSeason()?.id??null;return console.log("[AdminOrdersStore] getActiveSeasonId:",r),r}async loadAllOrders(s,r){console.log("[AdminOrdersStore] loadAllOrders called, status:",s,"limit:",r),this._loading.set(!0),this._error.set(null);try{let e=this._selectedSeasonIds(),t=e.length>0?e:void 0;console.log("[AdminOrdersStore] loadAllOrders: seasonFilter =",t??"all seasons");let o=await this.datastore.listAllSeasonOrders(t);console.log("[AdminOrdersStore] loadAllOrders: fetched",o.length,"orders from datastore"),s&&(o=o.filter(a=>c(a)===s)),o.sort((a,i)=>new Date(i.createdAt).getTime()-new Date(a.createdAt).getTime()),r&&r>0&&(o=o.slice(0,r)),this._orders.set(o)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async recordPayment(s,r,e,t="zelle",o,a=!1){this._actionLoading.set(!0),this._actionError.set(null);try{let i=this.getActiveSeasonId();if(!i)throw new Error("No season selected");await this.rpc.recordPayment({year:2026,seasonId:i,userAuthId:s,amount:r,reference:e??null,method:t,notes:o??null,isDepositConfirmation:a,itemKeys:null}),await this.loadAllOrders()}catch(i){let S=i instanceof Error?i.message:String(i);throw this._actionError.set(S),i}finally{this._actionLoading.set(!1)}}async cancelOrder(s,r,e){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(s,r,e),await this.loadAllOrders()}catch(t){let o=t instanceof Error?t.message:String(t);throw this._actionError.set(o),t}finally{this._actionLoading.set(!1)}}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this.unsubscribe(),this.unsubscribeOrder(),this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}subscribeToOrders(s){console.log("[AdminOrdersStore] subscribeToOrders called, seasonId param:",s),this.unsubscribe();let r=s??this.getActiveSeasonId();if(console.log("[AdminOrdersStore] subscribeToOrders: resolved seasonId =",r),!r){console.warn("[AdminOrdersStore] subscribeToOrders: no seasonId, setting empty orders"),this._orders.set([]);return}this._loading.set(!0),this._error.set(null),console.log("[AdminOrdersStore] subscribeToOrders: creating subscription for season",r),this.subscription=this.datastore.subscribeToSeasonOrders(r,h).subscribe({next:e=>{console.log("[AdminOrdersStore] subscribeToOrders: received",e.length,"orders");let t=this.filterOrders(e);console.log("[AdminOrdersStore] subscribeToOrders: after filter:",t.length,"orders (filter:",this._activeFilter(),")"),this._orders.set(t),this._loading.set(!1)},error:e=>{console.error("[AdminOrdersStore] subscribeToOrders error:",e);let t=e instanceof Error?e.message:String(e);this._error.set(t),this._loading.set(!1)}})}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}subscribeToOrder(s,r,e){this.unsubscribeOrder();let t=this.getActiveSeasonId();return t?(this.orderSubscription=this.datastore.subscribeToOrder(t,s).subscribe({next:r,error:e}),()=>this.unsubscribeOrder()):(e(new Error("No season selected")),()=>{})}unsubscribeOrder(){this.orderSubscription&&(this.orderSubscription.unsubscribe(),this.orderSubscription=null)}filterOrders(s){let r=this._activeFilter();switch(r){case"locked":case"submitted":case"paid":return s.filter(e=>c(e)===r);case"all":default:return s}}async getOrder(s,r=!1){if(!r){let e=this._orders().find(t=>t.userAuthId===s);if(e)return e}this._loading.set(!0),this._error.set(null);try{let e=this.getActiveSeasonId();if(!e)throw new Error("No season selected");let t=await this.datastore.getUserSeasonOrder(e,s);if(!t)throw new Error(`Order not found for user: ${s}`);if(r){let o=this._orders(),a=o.findIndex(i=>i.userAuthId===s);if(a>=0){let i=[...o];i[a]=t,this._orders.set(i)}}return t}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||l)};static \u0275prov=u({token:l,factory:l.\u0275fac,providedIn:"root"})};export{m as a};
