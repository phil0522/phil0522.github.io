import{a as Te}from"./chunk-H5ZUYZQU.js";import{c as Ae,f as Oe,i as De,j as Me,k as Ue,q as Ge}from"./chunk-7YZ2SOVO.js";import{c as Pe}from"./chunk-RYIKU5Y3.js";import{A as ie,L as be,M as Ee,R as ve,S as de,Y as f,ba as Ie,ca as Re,ea as Ne,h as fe,ha as ke,n as Ce,q as oe,s as Se}from"./chunk-ZYKK7F52.js";import{Ba as Z,Da as xe,F as H,Ia as se,Ka as ae,Oa as we,_ as J,aa as k,db as F,gb as B,ha as Y,wa as _e}from"./chunk-CIPCES67.js";import{$a as I,Ba as le,Bb as ye,Db as u,Ea as y,Eb as W,Fb as he,N as j,Qa as pe,S as U,T as G,ab as R,da as E,db as ne,eb as re,fb as O,gb as p,hb as m,ib as me,ob as ue,qb as T,sb as v,zb as ge}from"./chunk-CNMR2ZL6.js";import{a as ee,b as te}from"./chunk-Q7L6LLAK.js";var ot=50,st=30,z=class{constructor(n){this.firestore=n}async loadSeasonRaw(n){let t=k(this.firestore,`years/${2026}/seasons`,n),r=await F(t);if(!r.exists())throw new Error(`Season ${n} not found`);return r.data()}async loadSeason(n){let t=await this.loadSeasonRaw(n);return ie(t)}async loadOrders(n,t,r=ot){let o=[],s=J(this.firestore,`years/${2026}/seasons/${n}/orders`),a=null,i=0;for(;;){i++,t({step:"Loading orders...",detail:`batch ${i}`});let d=a?Z(s,se("userAuthId"),ae(r),we(a)):Z(s,se("userAuthId"),ae(r)),c=await B(d);for(let l of c.docs)o.push(l.data());if(c.size<r)break;a=c.docs[c.docs.length-1]}return o}async loadUsers(n,t,r=st){let o=new Map,s=[...new Set(n)];if(s.length===0)return o;let a=J(this.firestore,"users"),i=Math.ceil(s.length/r);for(let d=0;d<s.length;d+=r){let c=Math.floor(d/r)+1;t({step:"Loading user data...",detail:`batch ${c} of ${i}`});let l=s.slice(d,d+r),g=Z(a,xe(_e(),"in",l)),S=await B(g);for(let h of S.docs){let P=h.data();o.set(P.uid,P)}}return o}async loadRegistration(n){let t=k(this.firestore,`years/${2026}/registrations`,n),r=await F(t);return r.exists()?r.data():null}async loadSystemConfig(){let n=k(this.firestore,"system","config"),t=await F(n);return t.exists()?t.data():null}async loadAdminUserCache(){let n=k(this.firestore,"admin","userCache"),t=await F(n);return t.exists()?t.data():null}async loadCounters(){let n=J(this.firestore,"sys","counters");return(await B(n)).docs.map(r=>({id:r.id,data:r.data()}))}async loadCoupons(n,t){let r=[],o=J(this.firestore,"coupons"),s=await B(o);for(let d of s.docs)r.push(d.data());let a=new Set(r.map(d=>d.id));for(let d of n.coupons??[])a.has(d.id)||(r.push(d),a.add(d.id));let i=new Set;for(let d of t)for(let c of d.appliedCouponIds??[])a.has(c)||i.add(c);for(let d of i){let c=k(this.firestore,"coupons",d),l=await F(c);if(l.exists()){let g=l.data();a.has(g.id)||(r.push(g),a.add(g.id))}}return r}async loadAllData(n,t){t({step:"Loading season data..."});let r=await this.loadSeasonRaw(n),o=ie(r),s=await this.loadOrders(n,t),a=s.map(h=>h.userAuthId),i=await this.loadUsers(a,t);t({step:"Loading registration data..."});let d=await this.loadRegistration(n);t({step:"Loading coupon data..."});let c=await this.loadCoupons(o,s);t({step:"Loading system config..."});let l=await this.loadSystemConfig();t({step:"Loading admin cache..."});let g=await this.loadAdminUserCache();t({step:"Loading system counters..."});let S=await this.loadCounters();return{seasonRaw:r,season:o,orders:s,users:i,registration:d,coupons:c,systemConfig:l,adminUserCache:g,counters:S}}};var Fe="https://sheets.googleapis.com/v4/spreadsheets",q=null,K=0,at=3300*1e3;var Q=class{async acquireAccessToken(){if(q&&Date.now()<K)return f("[GoogleSheets] Using cached access token (expires in",Math.round((K-Date.now())/1e3/60),"minutes)"),q;f("[GoogleSheets] Acquiring new access token via OAuth popup...");let n=new oe;n.addScope("https://www.googleapis.com/auth/spreadsheets"),f("[GoogleSheets] Opening sign-in popup...");let t=await Se(ke,n);f("[GoogleSheets] Sign-in popup completed, user:",t.user?.email);let r=oe.credentialFromResult(t);if(f("[GoogleSheets] Credential extracted:",r?"success":"null"),!r)throw console.error("[GoogleSheets] Failed to obtain Google credentials from result:",t),new Error("Failed to obtain Google credentials");let o=r.accessToken;if(f("[GoogleSheets] Access token present:",!!o),!o)throw console.error("[GoogleSheets] Credential has no accessToken. Credential type:",r.providerId),new Error("Failed to obtain access token");return q=o,K=Date.now()+at,f("[GoogleSheets] Access token cached successfully"),o}clearCachedToken(){f("[GoogleSheets] Clearing cached access token"),q=null,K=0}async createSpreadsheet(n,t,r){f("[GoogleSheets] Creating spreadsheet:",{title:n,sheetNames:t}),f("[GoogleSheets] Access token length:",r?.length||0);let o={properties:{title:n},sheets:t.map(i=>({properties:{title:i}}))};f("[GoogleSheets] Request body:",JSON.stringify(o));let s;try{s=await fetch(Fe,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(o)})}catch(i){throw console.error("[GoogleSheets] Network error during createSpreadsheet:",i),new Error(`Network error creating spreadsheet: ${i instanceof Error?i.message:String(i)}`)}if(f("[GoogleSheets] createSpreadsheet response status:",s.status,s.statusText),!s.ok){let i=await s.text();throw console.error("[GoogleSheets] createSpreadsheet API error:",{status:s.status,statusText:s.statusText,errorText:i,headers:Object.fromEntries(s.headers.entries())}),(s.status===401||s.status===403)&&(f("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${s.status}): ${i}`)}let a=await s.json();return f("[GoogleSheets] Spreadsheet created successfully:",{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}),{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}}async writeSheetData(n,t,r,o){f("[GoogleSheets] Writing sheet data:",{spreadsheetId:n,sheetName:t,rowCount:r.length,columnCount:r[0]?.length||0});let s=encodeURIComponent(t),a=`${Fe}/${n}/values/${s}?valueInputOption=RAW`,i;try{i=await fetch(a,{method:"PUT",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({range:t,majorDimension:"ROWS",values:r})})}catch(d){throw console.error("[GoogleSheets] Network error during writeSheetData:",d),new Error(`Network error writing sheet data: ${d instanceof Error?d.message:String(d)}`)}if(f("[GoogleSheets] writeSheetData response status:",i.status,i.statusText),!i.ok){let d=await i.text();throw console.error("[GoogleSheets] writeSheetData API error:",{status:i.status,statusText:i.statusText,errorText:d,sheetName:t}),(i.status===401||i.status===403)&&(f("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${i.status}): ${d}`)}f("[GoogleSheets] Sheet data written successfully:",t)}};function N(e){return`$${(e/100).toFixed(2)}`}function ce(e,n,t){let r=e.get(n);return r?(r.students??[]).find(o=>o.id===t)??null:null}function it(e,n){return e.sessions.find(t=>t.id===n)?.name??n}function A(e){return JSON.stringify(e??null)}function $e(e,n,t){let o=["Order User Display ID","Parent Name","Parent Email","Parent Phone","Student Name","Student DOB","Student Gender","Student School","Student Allergies",...t.sessions.map(i=>i.name),"Student Subtotal","Order Discount","Order Total"],s=[];for(let i of e){let d=n.get(i.userAuthId),c=d?.displayName??"",l=i.items,g=new Map;for(let w of l){let b=g.get(w.studentId)??[];b.push(w),g.set(w.studentId,b)}if(g.size===0)continue;let S=Ee(i.pricing?.discounts??[]),h=de(i),P=[...g.keys()].sort((w,b)=>{let _=ce(n,i.userAuthId,w),$=_?`${_.firstName} ${_.lastName}`.trim():"",M=ce(n,i.userAuthId,b),L=M?`${M.firstName} ${M.lastName}`.trim():"";return $.localeCompare(L)}),C=[],x=!0;for(let w of P){let b=g.get(w),_=ce(n,i.userAuthId,w),$=t.sessions.map(L=>{let V=b.find(rt=>rt.sessionId===L.id);return V?N(V.snapshot.priceSnapshot.itemTotal):""}),M=b.reduce((L,V)=>L+V.snapshot.priceSnapshot.itemTotal,0);C.push([i.userDisplayId,c,d?.email??"",d?.primaryGuardian?.phone??"",_?`${_.firstName} ${_.lastName}`.trim():"",_?.dob??"",_?.gender??"",_?.school??"",_?.allergies??"",...$,N(M),x?N(Math.abs(S)):"",x?N(h):""]),x=!1}s.push({parentName:c,rows:C})}s.sort((i,d)=>i.parentName.localeCompare(d.parentName));let a=s.flatMap(i=>i.rows);return[o,...a]}function Le(e,n){let t=["User Display ID","Parent Name","Parent Email","Order Total","Coupon Discount","Total Paid","Balance Due","Payment Count","Payment Details","Refund Total"],r=[];for(let o of e){if(!o.items.some(h=>h.status==="submitted"||h.status==="paid"))continue;let a=n.get(o.userAuthId),i=de(o),d=o.couponDiscount??0,c=o.totalPaid??0,l=ve(o),g=be(o),S=(o.payments??[]).map(h=>`${h.method} ${N(h.amount)} ${h.recordedAt}${h.reference?` ref:${h.reference}`:""}`).join("; ");r.push([o.userDisplayId,a?.displayName??"",a?.email??"",N(i),N(d),N(c),N(g),String((o.payments??[]).length),S,N(l)])}return[t,...r]}function je(e,n){let t=["Coupon ID","Name","Description","Type","Max Credit (cents)","Eligible Emails","Used By (Order Count)"],r=new Map;for(let s of n)for(let a of s.appliedCouponIds??[])r.set(a,(r.get(a)??0)+1);let o=e.map(s=>[s.id,s.name,s.description,s.coupon_type,String(s.maxCreditCents),(s.eligible_emails??[]).join(", "),String(r.get(s.id)??0)]);return[t,...o]}function We(e,n,t){let r=["User Display ID","Parent Name","Parent Email","Session ID","Session Name","Joined At"],o=[];for(let s of e){let a=n.get(s.userAuthId);for(let i of s.waitlist??[])o.push([s.userDisplayId,a?.displayName??"",a?.email??"",i.sessionId,it(t,i.sessionId),i.joinedAt])}return[r,...o]}function Je(e,n,t,r){let o=["Session ID","Session Name","Start Date","End Date","Location","Active","Base Price (cents)","Lunch Price (cents)","Extended Care Price (cents)","Early Bird Tiers (JSON)","Capacity","Enrolled Count","Waitlisted Count","Available Spots","Enrolled Students"],s=new Map,a=new Map;for(let c of n){for(let l of c.items){let g=s.get(l.sessionId)??[];g.push(l.studentId),s.set(l.sessionId,g)}for(let l of c.waitlist??[])a.set(l.sessionId,(a.get(l.sessionId)??0)+1)}let i=new Map;if(r)for(let c of r.values())for(let l of c.students??[])i.set(l.id,`${l.firstName} ${l.lastName}`.trim());let d=e.sessions.map(c=>{let l=s.get(c.id)??[],g=l.length,S=a.get(c.id)??0,h=Math.max(0,c.capacity-g),P=l.map(C=>{let x=i.get(C);return x?`${x} (${C})`:C}).join(", ");return[c.id,c.name,c.startDate,c.endDate,c.location??"",c.isActive?"Yes":"No",String(c.basePrice),String(c.lunchPrice),String(c.extendedCarePrice),A(c.earlyBirdTiers??[]),String(c.capacity),String(g),String(S),String(h),P]});return[o,...d]}var dt={uid:"UID",displayId:"Display ID",email:"Email",displayName:"Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryEmail:"Primary Email",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",primaryEmployer:"Primary Employer",primaryStreet:"Primary Street",primaryCity:"Primary City",primaryState:"Primary State",primaryZipCode:"Primary Zip Code",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryEmail:"Secondary Email",secondaryPhone:"Secondary Phone",secondaryWechatId:"Secondary WeChat ID",secondaryWechatName:"Secondary WeChat Name",secondaryEmployer:"Secondary Employer",secondarySameAddress:"Secondary Same Address",secondaryStreet:"Secondary Street",secondaryCity:"Secondary City",secondaryState:"Secondary State",secondaryZipCode:"Secondary Zip Code",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship",couponIds:"Coupon IDs",referredStudentIds:"Referred Student IDs",createdAt:"Created At",updatedAt:"Updated At"};function ct(e){return{uid:e.uid,displayId:e.displayId,email:e.email,displayName:e.displayName,primaryFirstName:e.primaryGuardian?.firstName??"",primaryLastName:e.primaryGuardian?.lastName??"",primaryEmail:e.primaryGuardian?.email??"",primaryPhone:e.primaryGuardian?.phone??"",primaryWechatId:e.primaryGuardian?.wechatId??"",primaryWechatName:e.primaryGuardian?.wechatName??"",primaryEmployer:e.primaryGuardian?.employer??"",primaryStreet:e.primaryGuardian?.address?.street??"",primaryCity:e.primaryGuardian?.address?.city??"",primaryState:e.primaryGuardian?.address?.state??"",primaryZipCode:e.primaryGuardian?.address?.zipCode??"",secondaryFirstName:e.secondaryGuardian?.firstName??"",secondaryLastName:e.secondaryGuardian?.lastName??"",secondaryEmail:e.secondaryGuardian?.email??"",secondaryPhone:e.secondaryGuardian?.phone??"",secondaryWechatId:e.secondaryGuardian?.wechatId??"",secondaryWechatName:e.secondaryGuardian?.wechatName??"",secondaryEmployer:e.secondaryGuardian?.employer??"",secondarySameAddress:e.secondaryGuardian?.sameAddressAsPrimary?"Yes":"",secondaryStreet:e.secondaryGuardian?.address?.street??"",secondaryCity:e.secondaryGuardian?.address?.city??"",secondaryState:e.secondaryGuardian?.address?.state??"",secondaryZipCode:e.secondaryGuardian?.address?.zipCode??"",emergencyName:e.emergencyContact?.name??"",emergencyPhone:e.emergencyContact?.phone??"",emergencyRelationship:e.emergencyContact?.relationship??"",couponIds:(e.couponIds??[]).join(", "),referredStudentIds:(e.referredStudentIds??[]).join(", "),createdAt:e.timestamps.createdAt,updatedAt:e.timestamps.updatedAt}}function Be(e){let n=[...e.values()].sort((o,s)=>o.displayId.localeCompare(s.displayId)),t=Object.values(dt),r=n.map(o=>Object.values(ct(o)));return[t,...r]}var lt={studentId:"Student ID",studentFirstName:"Student First Name",studentLastName:"Student Last Name",studentDob:"Student DOB",studentGender:"Student Gender",studentAllergies:"Student Allergies",studentDietaryNotes:"Student Dietary Notes",studentMedicalNotes:"Student Medical Notes",studentSchool:"Student School",studentLastCampYear:"Student Last Camp Year",studentGrade:"Student Grade",studentReferCode:"Student Refer Code",parentDisplayId:"Parent Display ID",parentEmail:"Parent Email",parentDisplayName:"Parent Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryPhone:"Secondary Phone",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship"};function pt(e,n){return{studentId:e.id,studentFirstName:e.firstName,studentLastName:e.lastName,studentDob:e.dob,studentGender:e.gender,studentAllergies:e.allergies,studentDietaryNotes:e.dietaryNotes??"",studentMedicalNotes:e.medicalNotes??"",studentSchool:e.school??"",studentLastCampYear:e.lastCampYear??"",studentGrade:e.grade??"",studentReferCode:e.referCode??"",parentDisplayId:n.displayId,parentEmail:n.email,parentDisplayName:n.displayName,primaryFirstName:n.primaryGuardian?.firstName??"",primaryLastName:n.primaryGuardian?.lastName??"",primaryPhone:n.primaryGuardian?.phone??"",primaryWechatId:n.primaryGuardian?.wechatId??"",primaryWechatName:n.primaryGuardian?.wechatName??"",secondaryFirstName:n.secondaryGuardian?.firstName??"",secondaryLastName:n.secondaryGuardian?.lastName??"",secondaryPhone:n.secondaryGuardian?.phone??"",emergencyName:n.emergencyContact?.name??"",emergencyPhone:n.emergencyContact?.phone??"",emergencyRelationship:n.emergencyContact?.relationship??""}}function ze(e){let n=[];for(let o of e.values())for(let s of o.students??[])n.push({student:s,user:o});n.sort((o,s)=>{let a=o.user.displayId.localeCompare(s.user.displayId);return a!==0?a:o.student.id.localeCompare(s.student.id)});let t=Object.values(lt),r=n.map(({student:o,user:s})=>Object.values(pt(o,s)));return[t,...r]}var mt={isSystemInitialized:"System Initialized",currentDate:"Current Date",currentTime:"Current Time",allowEnrollment:"Allow Enrollment",maintenanceMode:"Maintenance Mode",financials:"Financials (JSON)",paymentInstructions:"Payment Instructions",returnInstructions:"Return Instructions",releaseAgreementContent:"Release Agreement Content",mediaPolicyContent:"Media Policy Content",formsPageContent:"Forms Page Content",contactEmail:"Contact Email",contactPhone:"Contact Phone",contactAddress:"Contact Address",waitlistLastRecalculationAt:"Waitlist Last Recalculation",waitlistRaw:"Waitlist Config (JSON)"};function ut(e){return{isSystemInitialized:e.isSystemInitialized?"Yes":"No",currentDate:e.currentDate,currentTime:e.currentTime,allowEnrollment:e.systemSwitch.allowEnrollment?"Yes":"No",maintenanceMode:e.systemSwitch.maintenanceMode?"Yes":"No",financials:A(e.financials),paymentInstructions:e.paymentInstructions.content,returnInstructions:e.returnInstructions?.content??"",releaseAgreementContent:e.releaseAgreementContent?.content??"",mediaPolicyContent:e.mediaPolicyContent?.content??"",formsPageContent:e.formsPageContent?.content??"",contactEmail:e.contactInfo.email,contactPhone:e.contactInfo.phone,contactAddress:e.contactInfo.address??"",waitlistLastRecalculationAt:e.waitlist?.lastRecalculationAt??"",waitlistRaw:A(e.waitlist??null)}}function Ve(e){let n=Object.values(mt),t=Object.values(ut(e));return[n,t]}function He(e){let n=["Key","Value"],t=[["exportedAt",e.exportedAt],["year",String(e.year)],["seasonId",e.seasonId],["seasonName",e.seasonName],["counts",A(e.counts)]];return[n,...t]}function X(e,n,t){let r=["Collection Path","Document ID","Document Path","JSON"];return t?[[...r],[e,n,`${e}/${n}`,A(t)]]:[r]}function Ye(e){return X(`years/${e.year}/seasons`,e.id,e)}function Ze(e,n,t){return X(`years/${e}/registrations`,n,t)}function qe(e){return X("system","config",e)}function Ke(e){return X("admin","userCache",e)}function Qe(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=e.map(r=>["sys/counters",r.id,`sys/counters/${r.id}`,A(r.data)]);return[n,...t]}function Xe(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=e.map(r=>["coupons",r.id,`coupons/${r.id}`,A(r)]);return[n,...t]}function et(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=[...e.values()].map(r=>["users",r.uid,`users/${r.uid}`,A(r)]);return[n,...t]}function tt(e,n,t){let r=["Collection Path","Document ID","Document Path","JSON"],o=t.map(s=>[`years/${e}/seasons/${n}/orders`,s.userAuthId,`years/${e}/seasons/${n}/orders/${s.userAuthId}`,A(s)]);return[r,...o]}var gt=(e,n)=>n.id,yt=(e,n)=>n.label;function ht(e,n){e&1&&(p(0,"div",3),me(1,"div",4),p(2,"p"),u(3,"Loading seasons..."),m()())}function ft(e,n){if(e&1&&(p(0,"option",10),u(1),m()),e&2){let t=n.$implicit;O("value",t.id),y(),W(t.name)}}function Ct(e,n){e&1&&u(0," Exporting... ")}function St(e,n){e&1&&u(0," Download JSON File ")}function _t(e,n){e&1&&u(0," Export to Google Sheets ")}function xt(e,n){e&1&&u(0," \u25CB ")}function wt(e,n){e&1&&u(0," \u25CC ")}function bt(e,n){e&1&&u(0," \u2713 ")}function Et(e,n){e&1&&u(0," \u2717 ")}function vt(e,n){if(e&1&&(p(0,"span",28),u(1),m()),e&2){let t=v().$implicit;y(),he("(",t.detail,")")}}function It(e,n){if(e&1&&(p(0,"div",25)(1,"span",26),I(2,xt,1,0)(3,wt,1,0)(4,bt,1,0)(5,Et,1,0),m(),p(6,"span",27),u(7),m(),I(8,vt,2,1,"span",28),m()),e&2){let t,r=n.$implicit;ye("step-pending",r.status==="pending")("step-in-progress",r.status==="in-progress")("step-completed",r.status==="completed")("step-error",r.status==="error"),y(2),R((t=r.status)==="pending"?2:t==="in-progress"?3:t==="completed"?4:t==="error"?5:-1),y(5),W(r.label),y(),R(r.detail?8:-1)}}function Rt(e,n){if(e&1&&(p(0,"div",17)(1,"h3"),u(2,"Export Progress"),m(),p(3,"div",23),ne(4,It,9,11,"div",24,yt),m()()),e&2){let t=v(2);y(4),re(t.steps())}}function Nt(e,n){e&1&&u(0," Importing... ")}function Pt(e,n){e&1&&u(0," Select JSON File to Import ")}function At(e,n){if(e&1&&(p(0,"div",21)(1,"div",29),u(2,"\u2713"),m(),p(3,"h3"),u(4,"Export Complete"),m(),p(5,"a",30),u(6," Open Spreadsheet \u2192 "),m()()),e&2){let t=v(2);y(5),O("href",t.spreadsheetUrl(),le)}}function Ot(e,n){e&1&&(p(0,"div",21)(1,"div",29),u(2,"\u2713"),m(),p(3,"h3"),u(4,"JSON Export Complete"),m(),p(5,"p"),u(6,"The file has been downloaded to your device."),m()())}function Dt(e,n){if(e&1&&(p(0,"div",21)(1,"div",29),u(2,"\u2713"),m(),p(3,"h3"),u(4,"Import Complete"),m(),p(5,"p"),u(6),m()()),e&2){let t=v(2);y(6),W(t.importSummary())}}function Mt(e,n){if(e&1&&(p(0,"div",22)(1,"p",31),u(2),m()()),e&2){let t=v(2);y(2),W(t.error())}}function Ut(e,n){if(e&1){let t=ue();p(0,"div",5)(1,"h3"),u(2,"Export Season Data"),m(),p(3,"div",6)(4,"label",7),u(5,"Select Season"),m(),p(6,"select",8),T("ngModelChange",function(o){U(t);let s=v();return G(s.onSeasonChange(o))}),p(7,"option",9),u(8,"-- Select a season --"),m(),ne(9,ft,2,2,"option",10,gt),m()(),p(11,"div",11)(12,"label"),u(13,"Export Format"),m(),p(14,"div",12)(15,"label",13)(16,"input",14),T("change",function(){U(t);let o=v();return G(o.onFormatChange("google-sheets"))}),m(),p(17,"span"),u(18,"Google Sheets"),m()(),p(19,"label",13)(20,"input",15),T("change",function(){U(t);let o=v();return G(o.onFormatChange("json"))}),m(),p(21,"span"),u(22,"JSON File"),m()()()(),p(23,"button",16),T("click",function(){U(t);let o=v();return G(o.startExport())}),I(24,Ct,1,0)(25,St,1,0)(26,_t,1,0),m()(),I(27,Rt,6,0,"div",17),p(28,"div",5)(29,"h3"),u(30,"Import from JSON"),m(),p(31,"p",18),u(32," Import season data from a previously exported JSON file. "),m(),p(33,"input",19,0),T("change",function(o){U(t);let s=v();return G(s.onFileSelected(o))}),m(),p(35,"button",20),T("click",function(){U(t);let o=ge(34);return G(o.click())}),I(36,Nt,1,0)(37,Pt,1,0),m()(),I(38,At,7,1,"div",21),I(39,Ot,7,0,"div",21),I(40,Dt,7,1,"div",21),I(41,Mt,3,1,"div",22)}if(e&2){let t=v();y(6),O("ngModel",t.selectedSeasonId()),y(3),re(t.seasons()),y(7),O("checked",t.exportFormat()==="google-sheets"),y(4),O("checked",t.exportFormat()==="json"),y(3),O("disabled",!t.selectedSeasonId()||t.exporting()),y(),R(t.exporting()?24:t.exportFormat()==="json"?25:26),y(3),R(t.steps().length>0?27:-1),y(8),O("disabled",t.importing()),y(),R(t.importing()?36:37),y(2),R(t.spreadsheetUrl()?38:-1),y(),R(t.jsonExportComplete()?39:-1),y(),R(t.importComplete()?40:-1),y(),R(t.error()?41:-1)}}var nt=class e{router=j(Ce);userService=j(Ne);configService=j(Ie);seasonService=j(Re);_steps=E([]);_selectedSeasonId=E(null);_exporting=E(!1);_spreadsheetUrl=E(null);_error=E(null);_loadingSeasons=E(!1);_exportFormat=E("google-sheets");_jsonExportComplete=E(!1);_importing=E(!1);_importComplete=E(!1);_importSummary=E("");steps=this._steps.asReadonly();selectedSeasonId=this._selectedSeasonId.asReadonly();exporting=this._exporting.asReadonly();spreadsheetUrl=this._spreadsheetUrl.asReadonly();error=this._error.asReadonly();loadingSeasons=this._loadingSeasons.asReadonly();exportFormat=this._exportFormat.asReadonly();jsonExportComplete=this._jsonExportComplete.asReadonly();importing=this._importing.asReadonly();importComplete=this._importComplete.asReadonly();importSummary=this._importSummary.asReadonly();seasons=this.seasonService.seasons;async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}this._loadingSeasons.set(!0);try{await this.seasonService.loadAllSeasons()}catch(n){this._error.set(n instanceof Error?n.message:"Failed to load seasons")}finally{this._loadingSeasons.set(!1)}}onSeasonChange(n){this._selectedSeasonId.set(n||null),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([]),this._jsonExportComplete.set(!1)}onFormatChange(n){this._exportFormat.set(n),this._spreadsheetUrl.set(null),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([])}async startExport(){return this._exportFormat()==="json"?this.startJsonExport():this.startGoogleSheetsExport()}async startJsonExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([{label:"Loading data from Firestore",status:"pending"},{label:"Generating JSON file",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=Y(H()),o=await new z(t).loadAllData(n,l=>{this.updateStep(0,"in-progress",l.detail)});this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let s={exportedAt:new Date().toISOString(),year:2026,seasonId:n,season:o.season,orders:o.orders,users:Object.fromEntries(o.users),registration:o.registration,coupons:o.coupons,systemConfig:o.systemConfig,adminUserCache:o.adminUserCache,counters:o.counters},a=JSON.stringify(s,null,2),i=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(i),c=document.createElement("a");c.href=d,c.download=`${o.season.name.replace(/[^a-zA-Z0-9]/g,"-")}-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(d),this.updateStep(1,"completed"),this._jsonExportComplete.set(!0)}catch(t){let r=this._steps().findIndex(o=>o.status==="in-progress");r>=0&&this.updateStep(r,"error"),this._error.set(t instanceof Error?t.message:"Export failed")}finally{this._exporting.set(!1)}}}async startGoogleSheetsExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([{label:"Authenticating with Google",status:"pending"},{label:"Loading data from Firestore",status:"pending"},{label:"Building spreadsheet data",status:"pending"},{label:"Creating Google Spreadsheet",status:"pending"},{label:"Writing sheet data",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=new Q,r=await t.acquireAccessToken();this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let o=Y(H()),a=await new z(o).loadAllData(n,g=>{this.updateStep(1,"in-progress",g.detail)});this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let i=te(ee({Meta:He({exportedAt:new Date().toISOString(),year:2026,seasonId:a.season.id,seasonName:a.season.name,counts:{orders:a.orders.length,users:a.users.size,coupons:a.coupons.length,counters:a.counters.length,hasRegistration:a.registration?1:0,hasSystemConfig:a.systemConfig?1:0,hasAdminUserCache:a.adminUserCache?1:0}}),Orders:$e(a.orders,a.users,a.season),Payments:Le(a.orders,a.users),Coupons:je(a.coupons,a.orders),Waitlist:We(a.orders,a.users,a.season),Sessions:Je(a.season,a.orders,a.registration,a.users),Users:Be(a.users),Students:ze(a.users)},a.systemConfig?{SystemConfig:Ve(a.systemConfig)}:{}),{SeasonRaw:Ye(a.seasonRaw),RegistrationRaw:Ze(2026,n,a.registration),SystemConfigRaw:qe(a.systemConfig),AdminUserCacheRaw:Ke(a.adminUserCache),CountersRaw:Qe(a.counters),CouponsRaw:Xe(a.coupons),UsersRaw:et(a.users),OrdersRaw:tt(2026,n,a.orders)});this.updateStep(2,"completed"),this.updateStep(3,"in-progress");let d=`${a.season.name} \u2014 Export ${Pe(new Date().toISOString())}`,c=Object.keys(i),l=await t.createSpreadsheet(d,c,r);this.updateStep(3,"completed"),this.updateStep(4,"in-progress");for(let[g,S]of Object.entries(i))this.updateStep(4,"in-progress",`Writing ${g}...`),await t.writeSheetData(l.spreadsheetId,g,S,r);this.updateStep(4,"completed"),this._spreadsheetUrl.set(l.spreadsheetUrl)}catch(t){let r=this._steps().findIndex(o=>o.status==="in-progress");r>=0&&this.updateStep(r,"error"),this._error.set(t instanceof Error?t.message:"Export failed")}finally{this._exporting.set(!1)}}}updateStep(n,t,r){this._steps.update(o=>o.map((s,a)=>a===n?te(ee({},s),{status:t,detail:r}):s))}async onFileSelected(n){let t=n.target,r=t.files?.[0];if(r){this._importing.set(!0),this._importComplete.set(!1),this._error.set(null),this._steps.set([{label:"Reading JSON file",status:"pending"},{label:"Validating data structure",status:"pending"},{label:"Importing to Firestore",status:"pending"}]);try{this.updateStep(0,"in-progress");let o=await r.text(),s=JSON.parse(o);if(this.updateStep(0,"completed"),this.updateStep(1,"in-progress"),!s.season||!s.orders)throw new Error("Invalid export file: missing season or orders data");this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let a=Y(H()),i=s.year??this.configService.activeYear(),{doc:d,setDoc:c,writeBatch:l}=await import("./chunk-GSMCNYGL.js"),g=d(a,`years/${i}/seasons`,s.season.id);await c(g,s.season),this.updateStep(2,"in-progress","Season imported");let S=s.orders,h=500,P=0;for(let C=0;C<S.length;C+=h){let x=l(a),w=S.slice(C,C+h);for(let b of w){let _=d(a,`years/${i}/seasons/${s.season.id}/orders`,b.userAuthId);x.set(_,b)}await x.commit(),P+=w.length,this.updateStep(2,"in-progress",`Imported ${P}/${S.length} orders`)}if(s.users&&typeof s.users=="object"){let C=Object.entries(s.users);for(let x=0;x<C.length;x+=h){let w=l(a),b=C.slice(x,x+h);for(let[_,$]of b){let M=d(a,"users",_);w.set(M,$,{merge:!0})}await w.commit()}this.updateStep(2,"in-progress",`Imported ${C.length} users`)}if(s.registration){let C=d(a,`years/${i}/registrations`,s.season.id);await c(C,s.registration)}this.updateStep(2,"completed"),this._importComplete.set(!0),this._importSummary.set(`Imported season "${s.season.name}" with ${S.length} orders.`)}catch(o){let s=this._steps().findIndex(a=>a.status==="in-progress");s>=0&&this.updateStep(s,"error"),this._error.set(o instanceof Error?o.message:"Import failed")}finally{this._importing.set(!1),t.value=""}}}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=pe({type:e,selectors:[["app-admin-export"]],decls:4,vars:1,consts:[["fileInput",""],["pageTitle","Data Export","pageSubtitle","Export season data to spreadsheets"],[1,"admin-export"],[1,"loading-container"],[1,"spinner"],[1,"export-card"],[1,"form-group"],["for","season-select"],["id","season-select",1,"season-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"format-group"],[1,"format-options"],[1,"format-option"],["type","radio","name","format","value","google-sheets",3,"change","checked"],["type","radio","name","format","value","json",3,"change","checked"],[1,"btn-export",3,"click","disabled"],[1,"steps-card"],[1,"import-description"],["type","file","accept",".json",2,"display","none",3,"change"],[1,"btn-import",3,"click","disabled"],[1,"success-card"],[1,"error-card"],[1,"steps-list"],[1,"step",3,"step-pending","step-in-progress","step-completed","step-error"],[1,"step"],[1,"step-icon"],[1,"step-label"],[1,"step-detail"],[1,"success-icon"],["target","_blank","rel","noopener",1,"spreadsheet-link",3,"href"],[1,"error-message"]],template:function(t,r){t&1&&(p(0,"app-admin-layout",1)(1,"div",2),I(2,ht,4,0,"div",3)(3,Ut,42,12),m()()),t&2&&(y(2),R(r.loadingSeasons()?2:3))},dependencies:[fe,Ge,Me,Ue,De,Ae,Oe,Te],styles:[".admin-export[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:1.5rem}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem 2rem}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.export-card[_ngcontent-%COMP%], .steps-card[_ngcontent-%COMP%], .success-card[_ngcontent-%COMP%], .error-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.export-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.season-select[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;font-size:1rem;background:#fff}.format-group[_ngcontent-%COMP%]{margin-bottom:1rem}.format-group[_ngcontent-%COMP%] > label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.format-options[_ngcontent-%COMP%]{display:flex;gap:1.5rem}.format-option[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;font-weight:400}.format-option[_ngcontent-%COMP%]   input[type=radio][_ngcontent-%COMP%]{cursor:pointer}.import-description[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.btn-import[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-tertiary, #1976d2);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-import[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-tertiary-dark, #1565c0)}.btn-import[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.btn-export[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-export[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-export[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.steps-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.steps-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.step[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.5rem 0}.step-icon[_ngcontent-%COMP%]{font-size:1rem;width:1.25rem;text-align:center}.step-pending[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #999)}.step-in-progress[_ngcontent-%COMP%]{color:var(--sys-tertiary, #1976d2);font-weight:500}.step-completed[_ngcontent-%COMP%]{color:var(--sys-secondary, #2e7d32)}.step-error[_ngcontent-%COMP%]{color:var(--sys-error, #c62828)}.step-detail[_ngcontent-%COMP%]{font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.success-card[_ngcontent-%COMP%]{text-align:center;border-color:var(--sys-secondary, #2e7d32)}.success-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--sys-secondary, #2e7d32);margin-bottom:.5rem}.success-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-secondary, #2e7d32)}.spreadsheet-link[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1.5rem;background:var(--sys-secondary, #2e7d32);color:#fff;border-radius:8px;text-decoration:none;font-weight:500}.spreadsheet-link[_ngcontent-%COMP%]:hover{opacity:.9}.error-card[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}.error-message[_ngcontent-%COMP%]{margin:0;color:var(--sys-error, #c62828);font-weight:500}"]})};export{nt as AdminExportComponent};
