import{d as ne}from"./chunk-P2AFQSJG.js";import{a as te}from"./chunk-J5GZWM3M.js";import{b as ee}from"./chunk-MEXQHVGL.js";import{a as X,d as Z}from"./chunk-RYIKU5Y3.js";import{da as Y,ea as J,ga as Q,h as H,l as q,n as G,o as j,oa as W}from"./chunk-R7Y3ICY3.js";import"./chunk-ZEYGPIIR.js";import"./chunk-KBXPF7D4.js";import"./chunk-2PX3OE6K.js";import{$a as w,Db as i,Ea as l,Eb as d,Fb as k,N as b,Ob as z,Pb as L,Qa as V,S as x,T as S,Tb as N,ab as D,da as C,db as F,eb as K,fb as E,gb as n,hb as a,ib as B,ob as $,qb as f,sb as m}from"./chunk-CNMR2ZL6.js";import"./chunk-Q7L6LLAK.js";var oe=()=>["/admin/users"],ae=s=>({q:s}),se=s=>["/admin/orders",s],le=s=>({seasonId:s}),de=(s,t)=>t.studentId;function ce(s,t){s&1&&(n(0,"div",2),B(1,"div",4),n(2,"p"),i(3,"Loading roster..."),a()())}function me(s,t){if(s&1&&(n(0,"div",3)(1,"div",5),i(2,"!"),a(),n(3,"p"),i(4),a()()),s&2){let e=m();l(4),d(e.error())}}function pe(s,t){s&1&&(n(0,"div",10)(1,"h3"),i(2,"No registrations found"),a(),n(3,"p"),i(4,"This session has no enrolled students."),a()())}function ue(s,t){if(s&1&&(n(0,"a",19),i(1),a()),s&2){let e=m().$implicit;E("routerLink",z(3,oe))("queryParams",L(4,ae,e.parentDisplayId)),l(),k(" ",e.parentName," ")}}function ge(s,t){if(s&1&&(n(0,"span",20),i(1),a()),s&2){let e=m().$implicit;l(),d(e.parentName)}}function _e(s,t){if(s&1&&(n(0,"a",24),i(1),a()),s&2){let e=m().$implicit;E("routerLink",L(3,se,e.orderUserAuthId))("queryParams",L(5,le,e.orderSeasonId)),l(),k(" ",e.orderStatusLabel," ")}}function xe(s,t){if(s&1&&(n(0,"span",25),i(1),a()),s&2){let e=m().$implicit;l(),d(e.orderStatusLabel)}}function Se(s,t){if(s&1&&(n(0,"tr")(1,"td",15)(2,"div",16),i(3),a(),n(4,"div",17),i(5),a()(),n(6,"td"),i(7),a(),n(8,"td"),i(9),a(),n(10,"td"),i(11),a(),n(12,"td"),i(13),a(),n(14,"td"),i(15),a(),n(16,"td"),i(17),a(),n(18,"td",18),w(19,ue,2,6,"a",19)(20,ge,2,1,"span",20),n(21,"div",21)(22,"span",22),i(23),a(),n(24,"span"),i(25),a(),n(26,"span"),i(27),a()()(),n(28,"td",23),i(29),a(),n(30,"td"),w(31,_e,2,7,"a",24)(32,xe,2,1,"span",25),a()()),s&2){let e=t.$implicit;l(3),d(e.studentName),l(2),d(e.studentId),l(2),d(e.ageLabel),l(2),d(e.genderLabel),l(2),d(e.dobLabel),l(2),d(e.gradeLabel),l(2),d(e.schoolLabel),l(2),d(e.allergiesLabel),l(2),D(e.parentDisplayId?19:20),l(4),d(e.parentDisplayId||"--"),l(2),d(e.parentEmail),l(2),d(e.parentPhone),l(2),d(e.addOnLabel),l(2),D(e.orderUserAuthId&&e.orderSeasonId?31:32)}}function fe(s,t){if(s&1){let e=$();n(0,"div",11)(1,"table",12)(2,"thead")(3,"tr")(4,"th")(5,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("studentName"))}),i(6," Student "),n(7,"span",14),i(8),a()()(),n(9,"th")(10,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("age"))}),i(11," Age "),n(12,"span",14),i(13),a()()(),n(14,"th")(15,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("gender"))}),i(16," Gender "),n(17,"span",14),i(18),a()()(),n(19,"th")(20,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("dob"))}),i(21," DOB "),n(22,"span",14),i(23),a()()(),n(24,"th")(25,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("grade"))}),i(26," Grade "),n(27,"span",14),i(28),a()()(),n(29,"th")(30,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("school"))}),i(31," School "),n(32,"span",14),i(33),a()()(),n(34,"th")(35,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("allergies"))}),i(36," Allergies "),n(37,"span",14),i(38),a()()(),n(39,"th")(40,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("parent"))}),i(41," Parent "),n(42,"span",14),i(43),a()()(),n(44,"th")(45,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("addOns"))}),i(46," Add-ons "),n(47,"span",14),i(48),a()()(),n(49,"th")(50,"button",13),f("click",function(){x(e);let o=m(2);return S(o.toggleSort("status"))}),i(51," Status "),n(52,"span",14),i(53),a()()()()(),n(54,"tbody"),F(55,Se,33,14,"tr",null,de),a()()()}if(s&2){let e=m(2);l(8),d(e.getSortIndicator("studentName")),l(5),d(e.getSortIndicator("age")),l(5),d(e.getSortIndicator("gender")),l(5),d(e.getSortIndicator("dob")),l(5),d(e.getSortIndicator("grade")),l(5),d(e.getSortIndicator("school")),l(5),d(e.getSortIndicator("allergies")),l(5),d(e.getSortIndicator("parent")),l(5),d(e.getSortIndicator("addOns")),l(5),d(e.getSortIndicator("status")),l(2),K(e.displayedRows())}}function he(s,t){if(s&1&&(n(0,"div",6)(1,"div",7)(2,"span",8),i(3,"Session"),a(),n(4,"span",9),i(5),a()(),n(6,"div",7)(7,"span",8),i(8,"Dates"),a(),n(9,"span",9),i(10),a()(),n(11,"div",7)(12,"span",8),i(13,"Enrolled"),a(),n(14,"span",9),i(15),a()()(),w(16,pe,5,0,"div",10)(17,fe,57,10,"div",11)),s&2){let e,r=m();l(5),d((e=r.session())==null?null:e.name),l(5),d(r.dateRange()),l(5),d(r.rows().length),l(),D(r.rows().length===0?16:17)}}var ie=class s{route=b(q);router=b(G);userService=b(W);userCacheService=b(te);seasonDatastore=b(Y);orderDatastore=b(Q);userDatastore=b(J);loading=C(!0);error=C(null);season=C(null);session=C(null);rows=C([]);sortKey=C("studentName");sortDirection=C("asc");subtitle=N(()=>{let t=this.season()?.name??"Season",e=this.session()?.name??"Session";return`${t} - ${e}`});dateRange=N(()=>{let t=this.session();return!t?.startDate||!t?.endDate?"--":Z(t.startDate,t.endDate)});displayedRows=N(()=>this.sortRows(this.rows(),this.sortKey(),this.sortDirection()));async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}let t=this.route.snapshot.paramMap.get("sessionId");if(!t){this.error.set("Missing session ID."),this.loading.set(!1);return}try{let{season:e,session:r}=await this.loadSessionContext(t);this.season.set(e),this.session.set(r);let g=(await this.seasonDatastore.getRegistration(e.id))?.classes[t]?.enrolledStudents??[];await this.userCacheService.loadCache();let _=new Map(this.userCacheService.users().map(c=>[c.displayId,c.authId])),M=g.map(c=>this.getParentDisplayId(c)).filter(c=>!!c).filter(c=>!_.has(c));if(M.length>0){let c=await this.userDatastore.listUsersByDisplayIds(M);for(let u of c)_.set(u.displayId,u.uid)}let v=new Map,y=new Map;for(let c of g){let u=this.getParentDisplayId(c);if(!u)continue;y.set(c,u);let U=_.get(u);U&&v.set(c,U)}let h=Array.from(new Set(v.values()));h.length>0&&await this.userCacheService.ensureUsersInCache(h);let p=new Map(this.userCacheService.users().map(c=>[c.authId,c])),R=h.length>0?await this.userDatastore.listUsersByAuthIds(h):[],I=new Map(R.map(c=>[c.uid,c])),T=h.length>0?await this.orderDatastore.listOrdersByUserIds(e.id,h):[],O=new Map,P=new Map;for(let c of T)for(let u of c.items)u.sessionId===t&&(O.set(u.studentId,u.status),P.set(u.studentId,this.getAddOnLabel(u.options?.lunch,u.options?.extendedCare)));let re=g.map(c=>this.buildRow(c,I,p,v.get(c)??null,y.get(c)??null,O.get(c)??null,P.get(c)??"--",e.id,r.startDate??null));this.rows.set(re)}catch(e){let r=e instanceof Error?e.message:"Failed to load session registrations.";this.error.set(r)}finally{this.loading.set(!1)}}async loadSessionContext(t){let e=await this.seasonDatastore.listAllSeasons();for(let r of e){let o=r.sessions?.find(g=>g.id===t);if(o)return{season:r,session:o}}throw new Error("Session not found.")}buildRow(t,e,r,o,g,_,A,M,v){let y=o?e.get(o)??null:null,h=o?r.get(o)??null:null,p=y?.students?.find(P=>P.id===t)??null,R=p?`${p.firstName} ${p.lastName}`:t,I=this.getAgeValue(p,v),T=I===null?"--":String(I),O=y?.displayId??h?.displayId??g??this.getParentDisplayId(t)??"";return{studentId:t,studentName:R,ageLabel:T,ageSort:I,dobLabel:p?.dob?X(p.dob,{month:"short",day:"numeric",year:"numeric"}):"--",dobSort:p?.dob??null,genderLabel:this.getGenderLabel(p),gradeLabel:p?.grade??"--",schoolLabel:p?.school??"--",allergiesLabel:p?.allergies??"--",parentName:y?.displayName??h?.parentName??"Unknown Parent",parentDisplayId:O,parentEmail:y?.email??h?.email??"--",parentPhone:y?.primaryGuardian?.phone??"--",addOnLabel:A,orderStatusLabel:_?ne(_):"Unknown",orderUserAuthId:o,orderSeasonId:M}}toggleSort(t){if(this.sortKey()===t){this.sortDirection.set(this.sortDirection()==="asc"?"desc":"asc");return}this.sortKey.set(t),this.sortDirection.set("asc")}getSortIndicator(t){return this.sortKey()!==t?"\u2195":this.sortDirection()==="asc"?"\u25B2":"\u25BC"}sortRows(t,e,r){let o=r==="asc"?1:-1;return[...t].sort((g,_)=>this.compareRows(g,_,e)*o)}compareRows(t,e,r){switch(r){case"studentName":return this.compareText(t.studentName,e.studentName);case"age":return this.compareNullableNumber(t.ageSort,e.ageSort);case"gender":return this.compareText(t.genderLabel,e.genderLabel);case"dob":return this.compareText(t.dobSort??"",e.dobSort??"");case"grade":return this.compareText(t.gradeLabel,e.gradeLabel);case"school":return this.compareText(t.schoolLabel,e.schoolLabel);case"allergies":return this.compareText(t.allergiesLabel,e.allergiesLabel);case"parent":return this.compareText(t.parentName,e.parentName);case"addOns":return this.compareText(t.addOnLabel,e.addOnLabel);case"status":return this.compareText(t.orderStatusLabel,e.orderStatusLabel);default:return 0}}compareText(t,e){return t.localeCompare(e,void 0,{sensitivity:"base",numeric:!0})}compareNullableNumber(t,e){let r=t??Number.POSITIVE_INFINITY,o=e??Number.POSITIVE_INFINITY;return r-o}getAddOnLabel(t,e){let r=[];return t&&r.push("Lunch"),e&&r.push("Extended Care"),r.length>0?r.join(`
`):"--"}getParentDisplayId(t){let e=t.match(/^(U-\d{8})-K\d+$/);return e?e[1]:null}getGenderLabel(t){return t?.gender?t.gender==="M"?"Male":"Female":"--"}getAgeValue(t,e){if(!t?.dob)return null;let r=e??t.dob,o=this.calculateAge(t.dob,r);return Number.isNaN(o)?null:o}calculateAge(t,e){let r=this.parseDateOnly(t),o=this.parseDateOnly(e),g=o.getUTCFullYear()-r.getUTCFullYear(),_=o.getUTCMonth()-r.getUTCMonth();return(_<0||_===0&&o.getUTCDate()<r.getUTCDate())&&(g-=1),g}parseDateOnly(t){let[e,r,o]=t.split("T")[0].split("-").map(Number);return new Date(Date.UTC(e,r-1,o,12))}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=V({type:s,selectors:[["app-admin-session-registrations"]],decls:5,vars:2,consts:[["pageTitle","Session Registrations",3,"pageSubtitle"],[1,"session-registrations"],[1,"loading-container"],[1,"error-container"],[1,"spinner"],[1,"error-icon"],[1,"session-summary"],[1,"summary-item"],[1,"summary-label"],[1,"summary-value"],[1,"empty-state"],[1,"table-container"],[1,"roster-table"],["type","button",1,"sort-btn",3,"click"],[1,"sort-indicator"],[1,"col-student"],[1,"student-name"],[1,"student-id"],[1,"col-parent"],[1,"parent-link",3,"routerLink","queryParams"],[1,"parent-link","disabled"],[1,"parent-meta"],[1,"mono"],[1,"col-addons"],[1,"status-pill","status-link",3,"routerLink","queryParams"],[1,"status-pill"]],template:function(e,r){e&1&&(n(0,"app-admin-layout",0)(1,"div",1),w(2,ce,4,0,"div",2)(3,me,5,1,"div",3)(4,he,18,4),a()()),e&2&&(E("pageSubtitle",r.subtitle()),l(2),D(r.loading()?2:r.error()?3:4))},dependencies:[H,j,ee],styles:[".session-registrations[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto;padding:1.5rem}.loading-container[_ngcontent-%COMP%], .error-container[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center}.spinner[_ngcontent-%COMP%]{width:32px;height:32px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.error-container[_ngcontent-%COMP%]{background:var(--sys-error-container, #ffebee);border-radius:12px}.error-icon[_ngcontent-%COMP%]{width:48px;height:48px;background:var(--sys-error, #c62828);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;margin-bottom:1rem}.session-summary[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem;padding:1rem 1.25rem;background:var(--sys-surface-variant, #f5f5f5);border-radius:12px;margin-bottom:1.5rem}.summary-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.summary-label[_ngcontent-%COMP%]{font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;color:var(--sys-on-surface-variant, #666)}.summary-value[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:var(--sys-on-surface, #212121)}.table-container[_ngcontent-%COMP%]{overflow-x:auto}.roster-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.85rem}.roster-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;padding:.5rem .75rem;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--sys-on-surface-variant, #666);border-bottom:2px solid var(--sys-outline-variant, #e0e0e0);white-space:nowrap}.roster-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.625rem .75rem;border-bottom:1px solid var(--sys-outline-variant, #f0f0f0);color:var(--sys-on-surface, #212121);vertical-align:top}.sort-btn[_ngcontent-%COMP%]{width:100%;display:inline-flex;align-items:center;gap:.35rem;border:none;background:transparent;padding:.125rem 0;font:inherit;color:inherit;text-transform:inherit;letter-spacing:inherit;cursor:pointer}.sort-btn[_ngcontent-%COMP%]:hover{color:var(--sys-primary, #c62828)}.sort-indicator[_ngcontent-%COMP%]{font-size:.72rem;line-height:1;opacity:.7}.col-student[_ngcontent-%COMP%]{min-width:180px}.student-name[_ngcontent-%COMP%]{font-weight:600}.student-id[_ngcontent-%COMP%]{font-size:.75rem;color:var(--sys-on-surface-variant, #666);margin-top:.2rem}.col-parent[_ngcontent-%COMP%]{min-width:220px}.col-addons[_ngcontent-%COMP%]{white-space:pre-line}.parent-link[_ngcontent-%COMP%]{color:var(--sys-primary, #c62828);text-decoration:none;font-weight:600}.parent-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.parent-link.disabled[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #888);cursor:default}.parent-meta[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.2rem;font-size:.75rem;color:var(--sys-on-surface-variant, #666);margin-top:.25rem}.mono[_ngcontent-%COMP%]{font-family:monospace}.status-pill[_ngcontent-%COMP%]{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:var(--sys-surface-variant, #f5f5f5);font-size:.75rem;font-weight:600}.status-link[_ngcontent-%COMP%]{color:var(--sys-primary, #c62828);text-decoration:none;transition:background-color .15s ease}.status-link[_ngcontent-%COMP%]:hover{background:var(--sys-primary-container, #fde8e8)}@media(max-width:960px){.session-summary[_ngcontent-%COMP%]{grid-template-columns:1fr}}"]})};export{ie as AdminSessionRegistrationsComponent};
