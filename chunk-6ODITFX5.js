import{a as Ge}from"./chunk-KSM3PUN2.js";import{c as Pe,f as Ae,i as Oe,j as De,k as Re,q as Me}from"./chunk-CTZTZ2LZ.js";import{c as Ne}from"./chunk-RYIKU5Y3.js";import{B as ve,C as oe,I as f,N as we,O as be,Q as Ie,T as Te,a as X,c as he,k as _e,v as xe,w as Ee}from"./chunk-UPS63TPQ.js";import{Ba as H,Da as Se,F as z,Ia as te,Ka as ne,Oa as Ce,_ as ee,aa as $,db as L,gb as re,ha as V,wa as fe}from"./chunk-UYHN5VVP.js";import{d as ge,j as ye}from"./chunk-7DYIQMZX.js";import{Ab as F,Ba as ie,Bb as ue,Ea as g,N as k,Pa as de,S as R,T as M,Za as I,_a as N,bb as K,cb as Q,da as w,db as O,eb as l,fb as p,gb as ce,kb as le,mb as G,ob as b,vb as pe,xb as me,zb as m}from"./chunk-5NVNCA6J.js";import{a as q,b as ae}from"./chunk-Q7L6LLAK.js";var Je=50,Ye=30,W=class{constructor(n){this.firestore=n}async loadSeason(n){let t=$(this.firestore,`years/${2026}/seasons`,n),s=await L(t);if(!s.exists())throw new Error(`Season ${n} not found`);let r=s.data();return _e(r)}async loadOrders(n,t,s=Je){let r=[],o=ee(this.firestore,`years/${2026}/seasons/${n}/orders`),a=null,i=0;for(;;){i++,t({step:"Loading orders...",detail:`batch ${i}`});let d=a?H(o,te("userAuthId"),ne(s),Ce(a)):H(o,te("userAuthId"),ne(s)),c=await re(d);for(let u of c.docs)r.push(u.data());if(c.size<s)break;a=c.docs[c.docs.length-1]}return r}async loadUsers(n,t,s=Ye){let r=new Map,o=[...new Set(n)];if(o.length===0)return r;let a=ee(this.firestore,"users"),i=Math.ceil(o.length/s);for(let d=0;d<o.length;d+=s){let c=Math.floor(d/s)+1;t({step:"Loading user data...",detail:`batch ${c} of ${i}`});let u=o.slice(d,d+s),y=H(a,Se(fe(),"in",u)),_=await re(y);for(let h of _.docs){let A=h.data();r.set(A.uid,A)}}return r}async loadRegistration(n){let t=$(this.firestore,`years/${2026}/registrations`,n),s=await L(t);return s.exists()?s.data():null}async loadGlobalConfig(){let n=$(this.firestore,"global","config"),t=await L(n);return t.exists()?t.data():null}async loadCoupons(n,t){let s=[...n.coupons??[]],r=new Set(s.map(a=>a.id)),o=new Set;for(let a of t)for(let i of a.appliedCouponIds??[])r.has(i)||o.add(i);for(let a of o){let i=$(this.firestore,"coupons",a),d=await L(i);d.exists()&&s.push(d.data())}return s}async loadAllData(n,t){t({step:"Loading season data..."});let s=await this.loadSeason(n),r=await this.loadOrders(n,t),o=r.map(u=>u.userAuthId),a=await this.loadUsers(o,t);t({step:"Loading registration data..."});let i=await this.loadRegistration(n);t({step:"Loading coupon data..."});let d=await this.loadCoupons(s,r);t({step:"Loading system config..."});let c=await this.loadGlobalConfig();return{season:s,orders:r,users:a,registration:i,coupons:d,globalConfig:c}}};var Ue="https://sheets.googleapis.com/v4/spreadsheets",J=null,Y=0,Ze=3300*1e3;var Z=class{async acquireAccessToken(){if(J&&Date.now()<Y)return f("[GoogleSheets] Using cached access token (expires in",Math.round((Y-Date.now())/1e3/60),"minutes)"),J;f("[GoogleSheets] Acquiring new access token via OAuth popup...");let n=new X;n.addScope("https://www.googleapis.com/auth/spreadsheets"),f("[GoogleSheets] Opening sign-in popup...");let t=await he(Te,n);f("[GoogleSheets] Sign-in popup completed, user:",t.user?.email);let s=X.credentialFromResult(t);if(f("[GoogleSheets] Credential extracted:",s?"success":"null"),!s)throw console.error("[GoogleSheets] Failed to obtain Google credentials from result:",t),new Error("Failed to obtain Google credentials");let r=s.accessToken;if(f("[GoogleSheets] Access token present:",!!r),!r)throw console.error("[GoogleSheets] Credential has no accessToken. Credential type:",s.providerId),new Error("Failed to obtain access token");return J=r,Y=Date.now()+Ze,f("[GoogleSheets] Access token cached successfully"),r}clearCachedToken(){f("[GoogleSheets] Clearing cached access token"),J=null,Y=0}async createSpreadsheet(n,t,s){f("[GoogleSheets] Creating spreadsheet:",{title:n,sheetNames:t}),f("[GoogleSheets] Access token length:",s?.length||0);let r={properties:{title:n},sheets:t.map(i=>({properties:{title:i}}))};f("[GoogleSheets] Request body:",JSON.stringify(r));let o;try{o=await fetch(Ue,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(r)})}catch(i){throw console.error("[GoogleSheets] Network error during createSpreadsheet:",i),new Error(`Network error creating spreadsheet: ${i instanceof Error?i.message:String(i)}`)}if(f("[GoogleSheets] createSpreadsheet response status:",o.status,o.statusText),!o.ok){let i=await o.text();throw console.error("[GoogleSheets] createSpreadsheet API error:",{status:o.status,statusText:o.statusText,errorText:i,headers:Object.fromEntries(o.headers.entries())}),(o.status===401||o.status===403)&&(f("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${o.status}): ${i}`)}let a=await o.json();return f("[GoogleSheets] Spreadsheet created successfully:",{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}),{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}}async writeSheetData(n,t,s,r){f("[GoogleSheets] Writing sheet data:",{spreadsheetId:n,sheetName:t,rowCount:s.length,columnCount:s[0]?.length||0});let o=encodeURIComponent(t),a=`${Ue}/${n}/values/${o}?valueInputOption=RAW`,i;try{i=await fetch(a,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({range:t,majorDimension:"ROWS",values:s})})}catch(d){throw console.error("[GoogleSheets] Network error during writeSheetData:",d),new Error(`Network error writing sheet data: ${d instanceof Error?d.message:String(d)}`)}if(f("[GoogleSheets] writeSheetData response status:",i.status,i.statusText),!i.ok){let d=await i.text();throw console.error("[GoogleSheets] writeSheetData API error:",{status:i.status,statusText:i.statusText,errorText:d,sheetName:t}),(i.status===401||i.status===403)&&(f("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${i.status}): ${d}`)}f("[GoogleSheets] Sheet data written successfully:",t)}};function P(e){return`$${(e/100).toFixed(2)}`}function se(e,n,t){let s=e.get(n);return s?(s.students??[]).find(r=>r.id===t)??null:null}function qe(e,n){return e.sessions.find(t=>t.id===n)?.name??n}function ke(e,n,t){let r=["Order User Display ID","Parent Name","Parent Email","Parent Phone","Student Name","Student DOB","Student Gender","Student School","Student Allergies",...t.sessions.map(i=>i.name),"Student Subtotal","Order Discount","Order Total"],o=[];for(let i of e){let d=n.get(i.userAuthId),c=d?.displayName??"",u=i.items,y=new Map;for(let E of u){let v=y.get(E.studentId)??[];v.push(E),y.set(E.studentId,v)}if(y.size===0)continue;let _=Ee(i.pricing?.discounts??[]),h=oe(i),A=[...y.keys()].sort((E,v)=>{let C=se(n,i.userAuthId,E),T=C?`${C.firstName} ${C.lastName}`.trim():"",D=se(n,i.userAuthId,v),U=D?`${D.firstName} ${D.lastName}`.trim():"";return T.localeCompare(U)}),S=[],x=!0;for(let E of A){let v=y.get(E),C=se(n,i.userAuthId,E),T=t.sessions.map(U=>{let B=v.find(He=>He.sessionId===U.id);return B?P(B.snapshot.priceSnapshot.itemTotal):""}),D=v.reduce((U,B)=>U+B.snapshot.priceSnapshot.itemTotal,0);S.push([i.userDisplayId,c,d?.email??"",d?.primaryGuardian?.phone??"",C?`${C.firstName} ${C.lastName}`.trim():"",C?.dob??"",C?.gender??"",C?.school??"",C?.allergies??"",...T,P(D),x?P(Math.abs(_)):"",x?P(h):""]),x=!1}o.push({parentName:c,rows:S})}o.sort((i,d)=>i.parentName.localeCompare(d.parentName));let a=o.flatMap(i=>i.rows);return[r,...a]}function Fe(e,n){let t=["User Display ID","Parent Name","Parent Email","Order Total","Coupon Discount","Total Paid","Balance Due","Payment Count","Payment Details","Refund Total"],s=[];for(let r of e){if(!r.items.some(h=>h.status==="submitted"||h.status==="paid"))continue;let a=n.get(r.userAuthId),i=oe(r),d=r.couponDiscount??0,c=r.totalPaid??0,u=ve(r),y=xe(r),_=(r.payments??[]).map(h=>`${h.method} ${P(h.amount)} ${h.recordedAt}${h.reference?` ref:${h.reference}`:""}`).join("; ");s.push([r.userDisplayId,a?.displayName??"",a?.email??"",P(i),P(d),P(c),P(y),String((r.payments??[]).length),_,P(u)])}return[t,...s]}function $e(e,n){let t=["Coupon ID","Name","Description","Type","Max Credit (cents)","Eligible Emails","Used By (Order Count)"],s=new Map;for(let o of n)for(let a of o.appliedCouponIds??[])s.set(a,(s.get(a)??0)+1);let r=e.map(o=>[o.id,o.name,o.description,o.coupon_type,String(o.maxCreditCents),(o.eligible_emails??[]).join(", "),String(s.get(o.id)??0)]);return[t,...r]}function Le(e,n,t){let s=["User Display ID","Parent Name","Parent Email","Session ID","Session Name","Joined At"],r=[];for(let o of e){let a=n.get(o.userAuthId);for(let i of o.waitlist??[])r.push([o.userDisplayId,a?.displayName??"",a?.email??"",i.sessionId,qe(t,i.sessionId),i.joinedAt])}return[s,...r]}function je(e,n,t,s){let r=["Session ID","Session Name","Start Date","End Date","Capacity","Enrolled Count","Waitlisted Count","Available Spots","Enrolled Students"],o=new Map,a=new Map;for(let c of n){for(let u of c.items){let y=o.get(u.sessionId)??[];y.push(u.studentId),o.set(u.sessionId,y)}for(let u of c.waitlist??[])a.set(u.sessionId,(a.get(u.sessionId)??0)+1)}let i=new Map;if(s)for(let c of s.values())for(let u of c.students??[])i.set(u.id,`${u.firstName} ${u.lastName}`.trim());let d=e.sessions.map(c=>{let u=o.get(c.id)??[],y=u.length,_=a.get(c.id)??0,h=Math.max(0,c.capacity-y),A=u.map(S=>{let x=i.get(S);return x?`${x} (${S})`:S}).join(", ");return[c.id,c.name,c.startDate,c.endDate,String(c.capacity),String(y),String(_),String(h),A]});return[r,...d]}var Ke={uid:"UID",displayId:"Display ID",email:"Email",displayName:"Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryEmail:"Primary Email",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",primaryEmployer:"Primary Employer",primaryStreet:"Primary Street",primaryCity:"Primary City",primaryState:"Primary State",primaryZipCode:"Primary Zip Code",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryEmail:"Secondary Email",secondaryPhone:"Secondary Phone",secondaryWechatId:"Secondary WeChat ID",secondaryWechatName:"Secondary WeChat Name",secondaryEmployer:"Secondary Employer",secondarySameAddress:"Secondary Same Address",secondaryStreet:"Secondary Street",secondaryCity:"Secondary City",secondaryState:"Secondary State",secondaryZipCode:"Secondary Zip Code",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship",couponIds:"Coupon IDs",referredStudentIds:"Referred Student IDs",createdAt:"Created At",updatedAt:"Updated At"};function Qe(e){return{uid:e.uid,displayId:e.displayId,email:e.email,displayName:e.displayName,primaryFirstName:e.primaryGuardian?.firstName??"",primaryLastName:e.primaryGuardian?.lastName??"",primaryEmail:e.primaryGuardian?.email??"",primaryPhone:e.primaryGuardian?.phone??"",primaryWechatId:e.primaryGuardian?.wechatId??"",primaryWechatName:e.primaryGuardian?.wechatName??"",primaryEmployer:e.primaryGuardian?.employer??"",primaryStreet:e.primaryGuardian?.address?.street??"",primaryCity:e.primaryGuardian?.address?.city??"",primaryState:e.primaryGuardian?.address?.state??"",primaryZipCode:e.primaryGuardian?.address?.zipCode??"",secondaryFirstName:e.secondaryGuardian?.firstName??"",secondaryLastName:e.secondaryGuardian?.lastName??"",secondaryEmail:e.secondaryGuardian?.email??"",secondaryPhone:e.secondaryGuardian?.phone??"",secondaryWechatId:e.secondaryGuardian?.wechatId??"",secondaryWechatName:e.secondaryGuardian?.wechatName??"",secondaryEmployer:e.secondaryGuardian?.employer??"",secondarySameAddress:e.secondaryGuardian?.sameAddressAsPrimary?"Yes":"",secondaryStreet:e.secondaryGuardian?.address?.street??"",secondaryCity:e.secondaryGuardian?.address?.city??"",secondaryState:e.secondaryGuardian?.address?.state??"",secondaryZipCode:e.secondaryGuardian?.address?.zipCode??"",emergencyName:e.emergencyContact?.name??"",emergencyPhone:e.emergencyContact?.phone??"",emergencyRelationship:e.emergencyContact?.relationship??"",couponIds:(e.couponIds??[]).join(", "),referredStudentIds:(e.referredStudentIds??[]).join(", "),createdAt:e.timestamps.createdAt,updatedAt:e.timestamps.updatedAt}}function We(e){let n=[...e.values()].sort((r,o)=>r.displayId.localeCompare(o.displayId)),t=Object.values(Ke),s=n.map(r=>Object.values(Qe(r)));return[t,...s]}var Xe={studentId:"Student ID",studentFirstName:"Student First Name",studentLastName:"Student Last Name",studentDob:"Student DOB",studentGender:"Student Gender",studentAllergies:"Student Allergies",studentDietaryNotes:"Student Dietary Notes",studentMedicalNotes:"Student Medical Notes",studentSchool:"Student School",studentLastCampYear:"Student Last Camp Year",studentGrade:"Student Grade",studentReferCode:"Student Refer Code",parentDisplayId:"Parent Display ID",parentEmail:"Parent Email",parentDisplayName:"Parent Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryPhone:"Secondary Phone",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship"};function et(e,n){return{studentId:e.id,studentFirstName:e.firstName,studentLastName:e.lastName,studentDob:e.dob,studentGender:e.gender,studentAllergies:e.allergies,studentDietaryNotes:e.dietaryNotes??"",studentMedicalNotes:e.medicalNotes??"",studentSchool:e.school??"",studentLastCampYear:e.lastCampYear??"",studentGrade:e.grade??"",studentReferCode:e.referCode??"",parentDisplayId:n.displayId,parentEmail:n.email,parentDisplayName:n.displayName,primaryFirstName:n.primaryGuardian?.firstName??"",primaryLastName:n.primaryGuardian?.lastName??"",primaryPhone:n.primaryGuardian?.phone??"",primaryWechatId:n.primaryGuardian?.wechatId??"",primaryWechatName:n.primaryGuardian?.wechatName??"",secondaryFirstName:n.secondaryGuardian?.firstName??"",secondaryLastName:n.secondaryGuardian?.lastName??"",secondaryPhone:n.secondaryGuardian?.phone??"",emergencyName:n.emergencyContact?.name??"",emergencyPhone:n.emergencyContact?.phone??"",emergencyRelationship:n.emergencyContact?.relationship??""}}function Be(e){let n=[];for(let r of e.values())for(let o of r.students??[])n.push({student:o,user:r});n.sort((r,o)=>{let a=r.user.displayId.localeCompare(o.user.displayId);return a!==0?a:r.student.id.localeCompare(o.student.id)});let t=Object.values(Xe),s=n.map(({student:r,user:o})=>Object.values(et(r,o)));return[t,...s]}var tt={isSystemInitialized:"System Initialized",currentDate:"Current Date",currentTime:"Current Time",allowEnrollment:"Allow Enrollment",maintenanceMode:"Maintenance Mode",paymentInstructions:"Payment Instructions",returnInstructions:"Return Instructions",contactEmail:"Contact Email",contactPhone:"Contact Phone",contactAddress:"Contact Address",waitlistLastRecalculationAt:"Waitlist Last Recalculation"};function nt(e){return{isSystemInitialized:e.isSystemInitialized?"Yes":"No",currentDate:e.currentDate,currentTime:e.currentTime,allowEnrollment:e.systemSwitch.allowEnrollment?"Yes":"No",maintenanceMode:e.systemSwitch.maintenanceMode?"Yes":"No",paymentInstructions:e.paymentInstructions.content,returnInstructions:e.returnInstructions?.content??"",contactEmail:e.contactInfo.email,contactPhone:e.contactInfo.phone,contactAddress:e.contactInfo.address??"",waitlistLastRecalculationAt:e.waitlist?.lastRecalculationAt??""}}function ze(e){let n=Object.values(tt),t=Object.values(nt(e));return[n,t]}var rt=(e,n)=>n.id,ot=(e,n)=>n.label;function st(e,n){e&1&&(l(0,"div",3),ce(1,"div",4),l(2,"p"),m(3,"Loading seasons..."),p()())}function at(e,n){if(e&1&&(l(0,"option",10),m(1),p()),e&2){let t=n.$implicit;O("value",t.id),g(),F(t.name)}}function it(e,n){e&1&&m(0," Exporting... ")}function dt(e,n){e&1&&m(0," Download JSON File ")}function ct(e,n){e&1&&m(0," Export to Google Sheets ")}function lt(e,n){e&1&&m(0," \u25CB ")}function pt(e,n){e&1&&m(0," \u25CC ")}function mt(e,n){e&1&&m(0," \u2713 ")}function ut(e,n){e&1&&m(0," \u2717 ")}function gt(e,n){if(e&1&&(l(0,"span",28),m(1),p()),e&2){let t=b().$implicit;g(),ue("(",t.detail,")")}}function yt(e,n){if(e&1&&(l(0,"div",25)(1,"span",26),I(2,lt,1,0)(3,pt,1,0)(4,mt,1,0)(5,ut,1,0),p(),l(6,"span",27),m(7),p(),I(8,gt,2,1,"span",28),p()),e&2){let t,s=n.$implicit;me("step-pending",s.status==="pending")("step-in-progress",s.status==="in-progress")("step-completed",s.status==="completed")("step-error",s.status==="error"),g(2),N((t=s.status)==="pending"?2:t==="in-progress"?3:t==="completed"?4:t==="error"?5:-1),g(5),F(s.label),g(),N(s.detail?8:-1)}}function ht(e,n){if(e&1&&(l(0,"div",17)(1,"h3"),m(2,"Export Progress"),p(),l(3,"div",23),K(4,yt,9,11,"div",24,ot),p()()),e&2){let t=b(2);g(4),Q(t.steps())}}function ft(e,n){e&1&&m(0," Importing... ")}function St(e,n){e&1&&m(0," Select JSON File to Import ")}function Ct(e,n){if(e&1&&(l(0,"div",21)(1,"div",29),m(2,"\u2713"),p(),l(3,"h3"),m(4,"Export Complete"),p(),l(5,"a",30),m(6," Open Spreadsheet \u2192 "),p()()),e&2){let t=b(2);g(5),O("href",t.spreadsheetUrl(),ie)}}function _t(e,n){e&1&&(l(0,"div",21)(1,"div",29),m(2,"\u2713"),p(),l(3,"h3"),m(4,"JSON Export Complete"),p(),l(5,"p"),m(6,"The file has been downloaded to your device."),p()())}function xt(e,n){if(e&1&&(l(0,"div",21)(1,"div",29),m(2,"\u2713"),p(),l(3,"h3"),m(4,"Import Complete"),p(),l(5,"p"),m(6),p()()),e&2){let t=b(2);g(6),F(t.importSummary())}}function Et(e,n){if(e&1&&(l(0,"div",22)(1,"p",31),m(2),p()()),e&2){let t=b(2);g(2),F(t.error())}}function vt(e,n){if(e&1){let t=le();l(0,"div",5)(1,"h3"),m(2,"Export Season Data"),p(),l(3,"div",6)(4,"label",7),m(5,"Select Season"),p(),l(6,"select",8),G("ngModelChange",function(r){R(t);let o=b();return M(o.onSeasonChange(r))}),l(7,"option",9),m(8,"-- Select a season --"),p(),K(9,at,2,2,"option",10,rt),p()(),l(11,"div",11)(12,"label"),m(13,"Export Format"),p(),l(14,"div",12)(15,"label",13)(16,"input",14),G("change",function(){R(t);let r=b();return M(r.onFormatChange("google-sheets"))}),p(),l(17,"span"),m(18,"Google Sheets"),p()(),l(19,"label",13)(20,"input",15),G("change",function(){R(t);let r=b();return M(r.onFormatChange("json"))}),p(),l(21,"span"),m(22,"JSON File"),p()()()(),l(23,"button",16),G("click",function(){R(t);let r=b();return M(r.startExport())}),I(24,it,1,0)(25,dt,1,0)(26,ct,1,0),p()(),I(27,ht,6,0,"div",17),l(28,"div",5)(29,"h3"),m(30,"Import from JSON"),p(),l(31,"p",18),m(32," Import season data from a previously exported JSON file. "),p(),l(33,"input",19,0),G("change",function(r){R(t);let o=b();return M(o.onFileSelected(r))}),p(),l(35,"button",20),G("click",function(){R(t);let r=pe(34);return M(r.click())}),I(36,ft,1,0)(37,St,1,0),p()(),I(38,Ct,7,1,"div",21),I(39,_t,7,0,"div",21),I(40,xt,7,1,"div",21),I(41,Et,3,1,"div",22)}if(e&2){let t=b();g(6),O("ngModel",t.selectedSeasonId()),g(3),Q(t.seasons()),g(7),O("checked",t.exportFormat()==="google-sheets"),g(4),O("checked",t.exportFormat()==="json"),g(3),O("disabled",!t.selectedSeasonId()||t.exporting()),g(),N(t.exporting()?24:t.exportFormat()==="json"?25:26),g(3),N(t.steps().length>0?27:-1),g(8),O("disabled",t.importing()),g(),N(t.importing()?36:37),g(2),N(t.spreadsheetUrl()?38:-1),g(),N(t.jsonExportComplete()?39:-1),g(),N(t.importComplete()?40:-1),g(),N(t.error()?41:-1)}}var Ve=class e{router=k(ye);userService=k(Ie);configService=k(we);seasonService=k(be);_steps=w([]);_selectedSeasonId=w(null);_exporting=w(!1);_spreadsheetUrl=w(null);_error=w(null);_loadingSeasons=w(!1);_exportFormat=w("google-sheets");_jsonExportComplete=w(!1);_importing=w(!1);_importComplete=w(!1);_importSummary=w("");steps=this._steps.asReadonly();selectedSeasonId=this._selectedSeasonId.asReadonly();exporting=this._exporting.asReadonly();spreadsheetUrl=this._spreadsheetUrl.asReadonly();error=this._error.asReadonly();loadingSeasons=this._loadingSeasons.asReadonly();exportFormat=this._exportFormat.asReadonly();jsonExportComplete=this._jsonExportComplete.asReadonly();importing=this._importing.asReadonly();importComplete=this._importComplete.asReadonly();importSummary=this._importSummary.asReadonly();seasons=this.seasonService.seasons;async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}this._loadingSeasons.set(!0);try{await this.seasonService.loadAllSeasons()}catch(n){this._error.set(n instanceof Error?n.message:"Failed to load seasons")}finally{this._loadingSeasons.set(!1)}}onSeasonChange(n){this._selectedSeasonId.set(n||null),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([]),this._jsonExportComplete.set(!1)}onFormatChange(n){this._exportFormat.set(n),this._spreadsheetUrl.set(null),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([])}async startExport(){return this._exportFormat()==="json"?this.startJsonExport():this.startGoogleSheetsExport()}async startJsonExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([{label:"Loading data from Firestore",status:"pending"},{label:"Generating JSON file",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=V(z()),r=await new W(t).loadAllData(n,u=>{this.updateStep(0,"in-progress",u.detail)});this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let o={exportedAt:new Date().toISOString(),year:2026,seasonId:n,season:r.season,orders:r.orders,users:Object.fromEntries(r.users),registration:r.registration,coupons:r.coupons,globalConfig:r.globalConfig},a=JSON.stringify(o,null,2),i=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(i),c=document.createElement("a");c.href=d,c.download=`${r.season.name.replace(/[^a-zA-Z0-9]/g,"-")}-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(d),this.updateStep(1,"completed"),this._jsonExportComplete.set(!0)}catch(t){let s=this._steps().findIndex(r=>r.status==="in-progress");s>=0&&this.updateStep(s,"error"),this._error.set(t instanceof Error?t.message:"Export failed")}finally{this._exporting.set(!1)}}}async startGoogleSheetsExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([{label:"Authenticating with Google",status:"pending"},{label:"Loading data from Firestore",status:"pending"},{label:"Building spreadsheet data",status:"pending"},{label:"Creating Google Spreadsheet",status:"pending"},{label:"Writing sheet data",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=new Z,s=await t.acquireAccessToken();this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let r=V(z()),a=await new W(r).loadAllData(n,y=>{this.updateStep(1,"in-progress",y.detail)});this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let i=q({Orders:ke(a.orders,a.users,a.season),Payments:Fe(a.orders,a.users),Coupons:$e(a.coupons,a.orders),Waitlist:Le(a.orders,a.users,a.season),Sessions:je(a.season,a.orders,a.registration,a.users),Users:We(a.users),Students:Be(a.users)},a.globalConfig?{SystemConfig:ze(a.globalConfig)}:{});this.updateStep(2,"completed"),this.updateStep(3,"in-progress");let d=`${a.season.name} \u2014 Export ${Ne(new Date().toISOString())}`,c=Object.keys(i),u=await t.createSpreadsheet(d,c,s);this.updateStep(3,"completed"),this.updateStep(4,"in-progress");for(let[y,_]of Object.entries(i))this.updateStep(4,"in-progress",`Writing ${y}...`),await t.writeSheetData(u.spreadsheetId,y,_,s);this.updateStep(4,"completed"),this._spreadsheetUrl.set(u.spreadsheetUrl)}catch(t){let s=this._steps().findIndex(r=>r.status==="in-progress");s>=0&&this.updateStep(s,"error"),this._error.set(t instanceof Error?t.message:"Export failed")}finally{this._exporting.set(!1)}}}updateStep(n,t,s){this._steps.update(r=>r.map((o,a)=>a===n?ae(q({},o),{status:t,detail:s}):o))}async onFileSelected(n){let t=n.target,s=t.files?.[0];if(s){this._importing.set(!0),this._importComplete.set(!1),this._error.set(null),this._steps.set([{label:"Reading JSON file",status:"pending"},{label:"Validating data structure",status:"pending"},{label:"Importing to Firestore",status:"pending"}]);try{this.updateStep(0,"in-progress");let r=await s.text(),o=JSON.parse(r);if(this.updateStep(0,"completed"),this.updateStep(1,"in-progress"),!o.season||!o.orders)throw new Error("Invalid export file: missing season or orders data");this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let a=V(z()),i=o.year??this.configService.activeYear(),{doc:d,setDoc:c,writeBatch:u}=await import("./chunk-YCY4SPTN.js"),y=d(a,`years/${i}/seasons`,o.season.id);await c(y,o.season),this.updateStep(2,"in-progress","Season imported");let _=o.orders,h=500,A=0;for(let S=0;S<_.length;S+=h){let x=u(a),E=_.slice(S,S+h);for(let v of E){let C=d(a,`years/${i}/seasons/${o.season.id}/orders`,v.userAuthId);x.set(C,v)}await x.commit(),A+=E.length,this.updateStep(2,"in-progress",`Imported ${A}/${_.length} orders`)}if(o.users&&typeof o.users=="object"){let S=Object.entries(o.users);for(let x=0;x<S.length;x+=h){let E=u(a),v=S.slice(x,x+h);for(let[C,T]of v){let D=d(a,"users",C);E.set(D,T,{merge:!0})}await E.commit()}this.updateStep(2,"in-progress",`Imported ${S.length} users`)}if(o.registration){let S=d(a,`years/${i}/registrations`,o.season.id);await c(S,o.registration)}this.updateStep(2,"completed"),this._importComplete.set(!0),this._importSummary.set(`Imported season "${o.season.name}" with ${_.length} orders.`)}catch(r){let o=this._steps().findIndex(a=>a.status==="in-progress");o>=0&&this.updateStep(o,"error"),this._error.set(r instanceof Error?r.message:"Import failed")}finally{this._importing.set(!1),t.value=""}}}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=de({type:e,selectors:[["app-admin-export"]],decls:4,vars:1,consts:[["fileInput",""],["pageTitle","Data Export","pageSubtitle","Export season data to spreadsheets"],[1,"admin-export"],[1,"loading-container"],[1,"spinner"],[1,"export-card"],[1,"form-group"],["for","season-select"],["id","season-select",1,"season-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"format-group"],[1,"format-options"],[1,"format-option"],["type","radio","name","format","value","google-sheets",3,"change","checked"],["type","radio","name","format","value","json",3,"change","checked"],[1,"btn-export",3,"click","disabled"],[1,"steps-card"],[1,"import-description"],["type","file","accept",".json",2,"display","none",3,"change"],[1,"btn-import",3,"click","disabled"],[1,"success-card"],[1,"error-card"],[1,"steps-list"],[1,"step",3,"step-pending","step-in-progress","step-completed","step-error"],[1,"step"],[1,"step-icon"],[1,"step-label"],[1,"step-detail"],[1,"success-icon"],["target","_blank","rel","noopener",1,"spreadsheet-link",3,"href"],[1,"error-message"]],template:function(t,s){t&1&&(l(0,"app-admin-layout",1)(1,"div",2),I(2,st,4,0,"div",3)(3,vt,42,12),p()()),t&2&&(g(2),N(s.loadingSeasons()?2:3))},dependencies:[ge,Me,De,Re,Oe,Pe,Ae,Ge],styles:[".admin-export[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:1.5rem}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem 2rem}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.export-card[_ngcontent-%COMP%], .steps-card[_ngcontent-%COMP%], .success-card[_ngcontent-%COMP%], .error-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.export-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.season-select[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;font-size:1rem;background:#fff}.format-group[_ngcontent-%COMP%]{margin-bottom:1rem}.format-group[_ngcontent-%COMP%] > label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.format-options[_ngcontent-%COMP%]{display:flex;gap:1.5rem}.format-option[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;font-weight:400}.format-option[_ngcontent-%COMP%]   input[type=radio][_ngcontent-%COMP%]{cursor:pointer}.import-description[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.btn-import[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-tertiary, #1976d2);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-import[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-tertiary-dark, #1565c0)}.btn-import[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.btn-export[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-export[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-export[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.steps-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.steps-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.step[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.5rem 0}.step-icon[_ngcontent-%COMP%]{font-size:1rem;width:1.25rem;text-align:center}.step-pending[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #999)}.step-in-progress[_ngcontent-%COMP%]{color:var(--sys-tertiary, #1976d2);font-weight:500}.step-completed[_ngcontent-%COMP%]{color:var(--sys-secondary, #2e7d32)}.step-error[_ngcontent-%COMP%]{color:var(--sys-error, #c62828)}.step-detail[_ngcontent-%COMP%]{font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.success-card[_ngcontent-%COMP%]{text-align:center;border-color:var(--sys-secondary, #2e7d32)}.success-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--sys-secondary, #2e7d32);margin-bottom:.5rem}.success-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-secondary, #2e7d32)}.spreadsheet-link[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1.5rem;background:var(--sys-secondary, #2e7d32);color:#fff;border-radius:8px;text-decoration:none;font-weight:500}.spreadsheet-link[_ngcontent-%COMP%]:hover{opacity:.9}.error-card[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}.error-message[_ngcontent-%COMP%]{margin:0;color:var(--sys-error, #c62828);font-weight:500}"]})};export{Ve as AdminExportComponent};
