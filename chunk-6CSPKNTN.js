import{A as O,B as _,C as h,D as T,E as B,F as D}from"./chunk-FN3HE72D.js";import{Ba as g,Da as y,F as I,_ as u,aa as l,db as f,gb as S,ha as L,jb as c}from"./chunk-CIPCES67.js";import{I as w}from"./chunk-CNMR2ZL6.js";import{a as d,b as E}from"./chunk-Q7L6LLAK.js";var N=["admin","email","templates",B],C=["admin","email","season_template_stats"],P=["admin","email","batch_jobs"],R="wechat_contact_html_secured_only",k="WECHAT_CONTACT_HTML_SECURED_ONLY",v=class A{firestore=L(I());buildSeasonTemplateStatsDocId(a,e,t){return`${a}__${e}__${t}`}async getTemplatesDocOrCreate(a){let e=l(this.firestore,...N),t=await f(e);if(!t.exists()){let p=D(a);return await c(e,p),p}let s=_.parse(t.data()),o=D(a),{merged:n,changed:r}=this.mergePlaceholderCatalog(s,o);return r&&await c(e,n),n}async saveTemplatesDoc(a){let e=_.parse(a),t=l(this.firestore,...N);await c(t,e)}async getSeasonTemplateStats(a,e,t){let s=O.parse(e),o=this.buildSeasonTemplateStatsDocId(a,s,t),n=l(this.firestore,...C,o),r=await f(n);return r.exists()?h.parse(r.data()):null}async listSeasonTemplateStats(a){let e=u(this.firestore,...C),t=g(e,y("seasonId","==",a));return(await S(t)).docs.map(o=>h.parse(o.data()))}async saveSeasonTemplateStats(a){let e=h.parse(a),t=this.buildSeasonTemplateStatsDocId(e.seasonId,e.notificationType,e.templateId),s=l(this.firestore,...C,t);await c(s,e)}async createBatchJob(a){let e=T.parse(a),t=l(this.firestore,...P,e.jobId);await c(t,e)}async updateBatchJob(a,e){let t=l(this.firestore,...P,a),s=await f(t);if(!s.exists())throw new Error(`Batch job ${a} not found`);let o=d(d({},s.data()),e),n=T.parse(o);await c(t,n)}async listSeasonBatchJobs(a){let e=u(this.firestore,...P),t=g(e,y("seasonId","==",a));return(await S(t)).docs.map(o=>T.parse(o.data()))}mergePlaceholderCatalog(a,e){let t=d({},a.placeholderCatalogByNotificationType),s=!1;for(let[o,n]of Object.entries(e.placeholderCatalogByNotificationType)){let r=t[o]??[],p=r.map(i=>i.key!==R?i:(s=!0,E(d({},i),{key:k,label:"WeChat Contact (HTML, Secured Only)",description:"WeChat QR and next-step message for orders with secured items and remaining balance. Empty for paid-off orders.",supportsHtml:!0,example:null}))),m=this.dedupePlaceholderDefs(p);m.length!==p.length&&(s=!0);let H=new Set(m.map(i=>i.key)),b=n.filter(i=>!H.has(i.key));if(b.length>0){t[o]=[...m,...b],s=!0;continue}(m.length!==r.length||m.some((i,J)=>i!==r[J]))&&(t[o]=m)}return s?{merged:E(d({},a),{updatedAt:new Date().toISOString(),updatedBy:e.updatedBy,placeholderCatalogByNotificationType:t}),changed:!0}:{merged:a,changed:!1}}dedupePlaceholderDefs(a){let e=[],t=new Set;for(let s of a)t.has(s.key)||(t.add(s.key),e.push(s));return e}static \u0275fac=function(e){return new(e||A)};static \u0275prov=w({token:A,factory:A.\u0275fac,providedIn:"root"})};export{v as a};
