import{a as f}from"./chunk-VYJPQB7B.js";import{Ba as S,Ca as A,Da as w,S as h,W as O,X as y,_ as C,na as m}from"./chunk-Z3TSPNBE.js";import{M as c,R as d,a as R,b as g,g as q,ha as p}from"./chunk-EVJ2WVWM.js";var b=class l{db=new S(y(h()));firestore=y(h());seasonDatastore=d(f);userDatastore=d(A);async getUserSeasonOrder(e,r){let s=`years/${e}/orders`,t=await this.db.getDocument(s,r);return t?m.parse(t):null}subscribeToOrder(e,r){return new q(s=>{let t=O(this.firestore,`years/${e}/orders`,r),i=C(t,o=>{if(!o.exists()){s.next(null);return}try{let u=g(R({},o.data()),{id:o.id}),n=m.parse(u);s.next(n)}catch(u){s.error(u)}},o=>{s.error(o)});return()=>i()})}async listSeasonOrders(e,r){let s=`years/${e}/orders`;return(await this.db.getDocuments(s,[{field:"seasonId",op:"==",value:r}])).map(i=>m.parse(i))}async listYearOrders(e){let r=`years/${e}/orders`;return(await this.db.getDocuments(r)).map(t=>m.parse(t))}async listOrdersWithSubmittedItems(e){return(await this.listYearOrders(e)).filter(s=>s.items.some(t=>t.status==="submitted"))}async listOverdueOrders(e,r){let s=await this.listOrdersWithSubmittedItems(e),t=new Date(r);return s.filter(i=>i.lockExpiresAt?new Date(i.lockExpiresAt)<t:!1)}async listOrdersWithChangeRequests(e){return(await this.listYearOrders(e)).filter(s=>s.changeRequests&&s.changeRequests.some(t=>t.status==="pending"))}async listAllWaitlistEntries(e){let r=await this.listYearOrders(e),s=await this.seasonDatastore.listAllSeasons(e),t=new Map;for(let n of s)for(let a of n.sessions??[])t.set(a.id,a.name);let i=await this.userDatastore.listAllUsers(),o=new Map;for(let n of i)o.set(n.uid,n.displayName);let u=[];for(let n of r)if(!(!n.waitlist||n.waitlist.length===0))for(let a of n.waitlist)u.push({userId:n.userAuthId,userName:o.get(n.userAuthId)??"Unknown User",sessionId:a.sessionId,className:t.get(a.sessionId)??"Unknown Class",joinedAt:a.joinedAt??"",isPromoted:a.isPromoted,promotedAt:a.promotedAt,notes:a.notes});return u.sort((n,a)=>n.joinedAt.localeCompare(a.joinedAt)),u}async listWaitlistByClass(e,r){return(await this.listAllWaitlistEntries(e)).filter(t=>t.sessionId===r)}static \u0275fac=function(r){return new(r||l)};static \u0275prov=c({token:l,factory:l.\u0275fac,providedIn:"root"})};var U=class l{functions=d(w);_loading=p(!1);_error=p(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async submitItems(e){return this.wrapApiCall("submitOrderItems",e)}async recordPayment(e){return this.wrapApiCall("recordOrderPayment",e)}async cancelItems(e){return this.wrapCall("cancelOrderItems",e)}async joinWaitlist(e){return this.wrapApiCall("joinWaitlist",e)}async leaveWaitlist(e){return this.wrapApiCall("leaveWaitlist",e)}async promoteWaitlistEntry(e){return this.wrapApiCall("promoteWaitlistEntry",e)}async removeSubmittedItems(e){return this.wrapApiCall("removeSubmittedItems",e)}async applySubmittedChanges(e){return this.wrapApiCall("applySubmittedChanges",e)}async requestOrderChange(e){return this.wrapApiCall("requestChange",e)}async updateChangeRequest(e){return this.wrapApiCall("updateChangeRequest",e)}async approveChangeRequest(e){return this.wrapApiCall("approveChange",e)}async denyChangeRequest(e){return this.wrapApiCall("denyChange",e)}async listAllOrders(e,r){return this.wrapCall("listAllOrders",{status:e,limit:r})}async listOverdueOrders(){return this.wrapCall("listOverdueOrders",void 0)}async listChangeRequests(){return this.wrapCall("listChangeRequests",void 0)}async confirmPayment(e,r,s,t,i){return this.wrapApiCall("confirmOrderPayment",{year:e,userAuthId:r,amount:s,reference:t,method:i})}async adminCancelOrder(e,r,s){await this.wrapApiCall("cancelOrder",{userAuthId:e,itemsToCancel:r,reason:s})}async getOrder(e){return this.wrapCall("getOrder",{userAuthId:e})}async listAllWaitlistEntries(){return this.wrapCall("listAllWaitlistEntries",{})}async listWaitlistByClass(e){return this.wrapCall("listWaitlistByClass",{sessionId:e})}clearError(){this._error.set(null)}async wrapCall(e,r){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,r)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async wrapApiCall(e,r){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,r)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||l)};static \u0275prov=c({token:l,factory:l.\u0275fac,providedIn:"root"})};export{b as a,U as b};
