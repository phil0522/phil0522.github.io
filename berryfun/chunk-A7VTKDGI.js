import{a as V,d as pe,g as Me}from"./chunk-HNEAA2ZM.js";import{c as xe,f as Ce,i as ye,j as ve,k as be,r as we}from"./chunk-U4YJGQVE.js";import"./chunk-OD6KCV5K.js";import{a as _e}from"./chunk-FYGYBRKK.js";import"./chunk-NR6WXTS5.js";import"./chunk-L5OFKJS2.js";import{a as he}from"./chunk-EUESG25O.js";import{b as Se}from"./chunk-3NM435RE.js";import{$ as Y,S as le,V as J,W as T,X as ue,Y as me,Z as R,_ as k,aa as Z,ba as ge,ca as N,d as ae,da as K,j as de,ja as fe,k as ce}from"./chunk-UIQMLXH2.js";import{Bb as m,Cb as U,Db as ie,Fa as te,Ia as h,R as I,Ta as ne,W as G,X as L,a as X,b as ee,bb as w,cb as M,eb as W,fb as z,gb as A,ha as P,hb as g,ib as u,jb as oe,nb as se,pb as q,rb as E,zb as re}from"./chunk-6GAPJCXB.js";var ke=50,Ne=30,$=class{constructor(t){this.firestore=t}async loadSeason(t,e){let n=T(this.firestore,`years/${t}/seasons`,e),o=await N(n);if(!o.exists())throw new Error(`Season ${e} not found`);let i=o.data();return fe(i)}async loadOrders(t,e,n,o=ke){let i=[],a=J(this.firestore,`years/${t}/orders`),s=null,d=0;for(;;){d++,n({step:"Loading orders...",detail:`batch ${d}`});let l=s?R(a,k("seasonId","==",e),Y("userAuthId"),Z(o),ge(s)):R(a,k("seasonId","==",e),Y("userAuthId"),Z(o)),c=await K(l);for(let p of c.docs)i.push(p.data());if(c.size<o)break;s=c.docs[c.docs.length-1]}return i}async loadUsers(t,e,n=Ne){let o=new Map,i=[...new Set(t)];if(i.length===0)return o;let a=J(this.firestore,"users"),s=Math.ceil(i.length/n);for(let d=0;d<i.length;d+=n){let l=Math.floor(d/n)+1;e({step:"Loading user data...",detail:`batch ${l} of ${s}`});let c=i.slice(d,d+n),p=R(a,k(me(),"in",c)),_=await K(p);for(let C of _.docs){let b=C.data();o.set(b.uid,b)}}return o}async loadRegistration(t,e){let n=T(this.firestore,`years/${t}/registrations`,e),o=await N(n);return o.exists()?o.data():null}async loadCoupons(t,e){let n=[...t.coupons??[]],o=new Set(n.map(a=>a.id)),i=new Set;for(let a of e)for(let s of a.appliedCouponIds??[])o.has(s)||i.add(s);for(let a of i){let s=T(this.firestore,"coupons",a),d=await N(s);d.exists()&&n.push(d.data())}return n}async loadAllData(t,e,n){n({step:"Loading season data..."});let o=await this.loadSeason(t,e),i=await this.loadOrders(t,e,n),a=i.map(c=>c.userAuthId),s=await this.loadUsers(a,n);n({step:"Loading registration data..."});let d=await this.loadRegistration(t,e);n({step:"Loading coupon data..."});let l=await this.loadCoupons(o,i);return{season:o,orders:i,users:s,registration:d,coupons:l}}};var Ee="https://sheets.googleapis.com/v4/spreadsheets",F=class{async acquireAccessToken(){let t=new V;t.addScope("https://www.googleapis.com/auth/spreadsheets");let e=await pe(Me,t),n=V.credentialFromResult(e);if(!n)throw new Error("Failed to obtain Google credentials");let o=n.accessToken;if(!o)throw new Error("Failed to obtain access token");return o}async createSpreadsheet(t,e,n){let o=await fetch(Ee,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:t},sheets:e.map(a=>({properties:{title:a}}))})});if(!o.ok){let a=await o.text();throw new Error(`Google Sheets API error (${o.status}): ${a}`)}let i=await o.json();return{spreadsheetId:i.spreadsheetId,spreadsheetUrl:i.spreadsheetUrl}}async writeSheetData(t,e,n,o){let i=encodeURIComponent(e),a=`${Ee}/${t}/values/${i}?valueInputOption=RAW`,s=await fetch(a,{method:"PUT",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({range:e,majorDimension:"ROWS",values:n})});if(!s.ok){let d=await s.text();throw new Error(`Google Sheets API error (${s.status}): ${d}`)}}};function x(r){return`$${(r/100).toFixed(2)}`}function Q(r,t,e){let n=r.get(t);return n?(n.students??[]).find(o=>o.id===e)??null:null}function $e(r,t){return r.sessions.find(e=>e.id===t)?.name??t}function Oe(r,t,e){let o=["Order User Display ID","Parent Name","Parent Email","Parent Phone","Student Name","Student DOB","Student Gender","Student School","Student Allergies",...e.sessions.map(s=>s.name),"Student Subtotal","Order Discount","Order Total"],i=[];for(let s of r){let d=t.get(s.userAuthId),l=d?.displayName??"",c=s.items.filter(S=>S.status!=="cancelled"),p=new Map;for(let S of c){let v=p.get(S.studentId)??[];v.push(S),p.set(S.studentId,v)}if(p.size===0)continue;let _=(s.pricing?.discounts??[]).reduce((S,v)=>S+v.amount,0),C=s.pricing?.subtotal??0,b=Math.max(0,C+_),f=[...p.keys()].sort((S,v)=>{let O=Q(t,s.userAuthId,S)?.fullName??"",H=Q(t,s.userAuthId,v)?.fullName??"";return O.localeCompare(H)}),y=[],B=!0;for(let S of f){let v=p.get(S),O=Q(t,s.userAuthId,S),H=e.sessions.map(j=>{let D=v.find(Re=>Re.sessionId===j.id);return D?x(D.snapshot.priceSnapshot.itemTotal):""}),Te=v.reduce((j,D)=>j+D.snapshot.priceSnapshot.itemTotal,0);y.push([s.userDisplayId,l,d?.email??"",d?.contactInfo?.phone??"",O?.fullName??"",O?.dob??"",O?.gender??"",O?.school??"",O?.allergies??"",...H,x(Te),B?x(Math.abs(_)):"",B?x(b):""]),B=!1}i.push({parentName:l,rows:y})}i.sort((s,d)=>s.parentName.localeCompare(d.parentName));let a=i.flatMap(s=>s.rows);return[o,...a]}function Pe(r,t){let e=["User Display ID","Parent Name","Parent Email","Order Total","Coupon Discount","Total Paid","Balance Due","Payment Count","Payment Details","Refund Total"],n=[];for(let o of r){if(!o.items.some(f=>f.status==="submitted"||f.status==="paid"))continue;let a=t.get(o.userAuthId),s=o.pricing?.subtotal??0,d=(o.pricing?.discounts??[]).reduce((f,y)=>f+y.amount,0),l=Math.max(0,s+d),c=o.couponDiscount??0,p=o.totalPaid??0,_=(o.refunds??[]).reduce((f,y)=>f+y.amount,0),C=Math.max(0,l-p-_),b=(o.payments??[]).map(f=>`${f.method} ${x(f.amount)} ${f.recordedAt}${f.reference?` ref:${f.reference}`:""}`).join("; ");n.push([o.userDisplayId,a?.displayName??"",a?.email??"",x(l),x(c),x(p),x(C),String((o.payments??[]).length),b,x(_)])}return[e,...n]}function Ie(r,t){let e=["Coupon ID","Name","Description","Type","Max Credit (cents)","Eligible Emails","Used By (Order Count)"],n=new Map;for(let i of t)for(let a of i.appliedCouponIds??[])n.set(a,(n.get(a)??0)+1);let o=r.map(i=>[i.id,i.name,i.description,i.coupon_type,String(i.maxCreditCents),(i.eligible_emails??[]).join(", "),String(n.get(i.id)??0)]);return[e,...o]}function Ae(r,t,e){let n=["User Display ID","Parent Name","Parent Email","Session ID","Session Name","Joined At","Is Promoted","Promoted At","Notes"],o=[];for(let i of r){let a=t.get(i.userAuthId);for(let s of i.waitlist??[])o.push([i.userDisplayId,a?.displayName??"",a?.email??"",s.sessionId,$e(e,s.sessionId),s.joinedAt,s.isPromoted?"Yes":"No",s.promotedAt??"",s.notes??""])}return[n,...o]}function De(r,t,e,n){let o=["Session ID","Session Name","Start Date","End Date","Capacity","Enrolled Count","Waitlisted Count","Available Spots","Enrolled Students"],i=new Map,a=new Map;for(let l of t){for(let c of l.items){if(c.status==="cancelled")continue;let p=i.get(c.sessionId)??[];p.push(c.studentId),i.set(c.sessionId,p)}for(let c of l.waitlist??[])a.set(c.sessionId,(a.get(c.sessionId)??0)+1)}let s=new Map;if(n)for(let l of n.values())for(let c of l.students??[])s.set(c.id,c.fullName);let d=r.sessions.map(l=>{let c=i.get(l.id)??[],p=c.length,_=a.get(l.id)??0,C=Math.max(0,l.capacity-p),b=c.map(f=>{let y=s.get(f);return y?`${y} (${f})`:f}).join(", ");return[l.id,l.name,l.startDate,l.endDate,String(l.capacity),String(p),String(_),String(C),b]});return[o,...d]}var Fe=(r,t)=>t.id,Be=(r,t)=>t.label;function He(r,t){r&1&&(g(0,"div",4),oe(1,"div",5),g(2,"p"),m(3,"Loading seasons..."),u()())}function je(r,t){if(r&1&&(g(0,"option",11),m(1),u()),r&2){let e=t.$implicit;A("value",e.id),h(),U(e.name)}}function Ge(r,t){r&1&&m(0," Exporting... ")}function Le(r,t){r&1&&m(0," Export to Google Sheets ")}function We(r,t){r&1&&m(0," \u25CB ")}function ze(r,t){r&1&&m(0," \u25CC ")}function qe(r,t){r&1&&m(0," \u2713 ")}function Ve(r,t){r&1&&m(0," \u2717 ")}function Je(r,t){if(r&1&&(g(0,"span",21),m(1),u()),r&2){let e=E().$implicit;h(),ie("(",e.detail,")")}}function Ye(r,t){if(r&1&&(g(0,"div",18)(1,"span",19),w(2,We,1,0)(3,ze,1,0)(4,qe,1,0)(5,Ve,1,0),u(),g(6,"span",20),m(7),u(),w(8,Je,2,1,"span",21),u()),r&2){let e,n=t.$implicit;re("step-pending",n.status==="pending")("step-in-progress",n.status==="in-progress")("step-completed",n.status==="completed")("step-error",n.status==="error"),h(2),M((e=n.status)==="pending"?2:e==="in-progress"?3:e==="completed"?4:e==="error"?5:-1),h(5),U(n.label),h(),M(n.detail?8:-1)}}function Ze(r,t){if(r&1&&(g(0,"div",13)(1,"h3"),m(2,"Export Progress"),u(),g(3,"div",16),W(4,Ye,9,11,"div",17,Be),u()()),r&2){let e=E(2);h(4),z(e.steps())}}function Ke(r,t){if(r&1&&(g(0,"div",14)(1,"div",22),m(2,"\u2713"),u(),g(3,"h3"),m(4,"Export Complete"),u(),g(5,"a",23),m(6," Open Spreadsheet \u2192 "),u()()),r&2){let e=E(2);h(5),A("href",e.spreadsheetUrl(),te)}}function Qe(r,t){if(r&1&&(g(0,"div",15)(1,"p",24),m(2),u()()),r&2){let e=E(2);h(2),U(e.error())}}function Xe(r,t){if(r&1){let e=se();g(0,"div",6)(1,"div",7)(2,"label",8),m(3,"Select Season"),u(),g(4,"select",9),q("ngModelChange",function(o){G(e);let i=E();return L(i.onSeasonChange(o))}),g(5,"option",10),m(6,"-- Select a season --"),u(),W(7,je,2,2,"option",11,Fe),u()(),g(9,"button",12),q("click",function(){G(e);let o=E();return L(o.startExport())}),w(10,Ge,1,0)(11,Le,1,0),u()(),w(12,Ze,6,0,"div",13),w(13,Ke,7,1,"div",14),w(14,Qe,3,1,"div",15)}if(r&2){let e=E();h(4),A("ngModel",e.selectedSeasonId()),h(3),z(e.seasons()),h(2),A("disabled",!e.selectedSeasonId()||e.exporting()),h(),M(e.exporting()?10:11),h(2),M(e.steps().length>0?12:-1),h(),M(e.spreadsheetUrl()?13:-1),h(),M(e.error()?14:-1)}}var Ue=class r{router=I(de);userService=I(Se);configService=I(he);seasonService=I(_e);_steps=P([]);_selectedSeasonId=P(null);_exporting=P(!1);_spreadsheetUrl=P(null);_error=P(null);_loadingSeasons=P(!1);steps=this._steps.asReadonly();selectedSeasonId=this._selectedSeasonId.asReadonly();exporting=this._exporting.asReadonly();spreadsheetUrl=this._spreadsheetUrl.asReadonly();error=this._error.asReadonly();loadingSeasons=this._loadingSeasons.asReadonly();seasons=this.seasonService.seasons;async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}this._loadingSeasons.set(!0);try{let t=this.configService.currentActiveYear();await this.seasonService.loadAllSeasons(t)}catch(t){this._error.set(t instanceof Error?t.message:"Failed to load seasons")}finally{this._loadingSeasons.set(!1)}}onSeasonChange(t){this._selectedSeasonId.set(t||null),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([])}async startExport(){let t=this._selectedSeasonId();if(t){this._exporting.set(!0),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([{label:"Authenticating with Google",status:"pending"},{label:"Loading data from Firestore",status:"pending"},{label:"Building spreadsheet data",status:"pending"},{label:"Creating Google Spreadsheet",status:"pending"},{label:"Writing sheet data",status:"pending"}]);try{this.updateStep(0,"in-progress");let e=new F,n=await e.acquireAccessToken();this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let o=this.configService.currentActiveYear(),i=ue(le()),s=await new $(i).loadAllData(o,t,_=>{this.updateStep(1,"in-progress",_.detail)});this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let d={Orders:Oe(s.orders,s.users,s.season),Payments:Pe(s.orders,s.users),Coupons:Ie(s.coupons,s.orders),Waitlist:Ae(s.orders,s.users,s.season),Sessions:De(s.season,s.orders,s.registration,s.users)};this.updateStep(2,"completed"),this.updateStep(3,"in-progress");let l=`${s.season.name} \u2014 Export ${new Date().toLocaleDateString()}`,c=Object.keys(d),p=await e.createSpreadsheet(l,c,n);this.updateStep(3,"completed"),this.updateStep(4,"in-progress");for(let[_,C]of Object.entries(d))this.updateStep(4,"in-progress",`Writing ${_}...`),await e.writeSheetData(p.spreadsheetId,_,C,n);this.updateStep(4,"completed"),this._spreadsheetUrl.set(p.spreadsheetUrl)}catch(e){let n=this._steps().findIndex(o=>o.status==="in-progress");n>=0&&this.updateStep(n,"error"),this._error.set(e instanceof Error?e.message:"Export failed")}finally{this._exporting.set(!1)}}}updateStep(t,e,n){this._steps.update(o=>o.map((i,a)=>a===t?ee(X({},i),{status:e,detail:n}):i))}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=ne({type:r,selectors:[["app-admin-export"]],decls:10,vars:1,consts:[[1,"admin-export"],[1,"page-header"],["routerLink","/admin",1,"back-link"],[1,"subtitle"],[1,"loading-container"],[1,"spinner"],[1,"export-card"],[1,"form-group"],["for","season-select"],["id","season-select",1,"season-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"btn-export",3,"click","disabled"],[1,"steps-card"],[1,"success-card"],[1,"error-card"],[1,"steps-list"],[1,"step",3,"step-pending","step-in-progress","step-completed","step-error"],[1,"step"],[1,"step-icon"],[1,"step-label"],[1,"step-detail"],[1,"success-icon"],["target","_blank","rel","noopener",1,"spreadsheet-link",3,"href"],[1,"error-message"]],template:function(e,n){e&1&&(g(0,"div",0)(1,"header",1)(2,"a",2),m(3,"\u2190 Back to Console"),u(),g(4,"h1"),m(5,"Data Export"),u(),g(6,"p",3),m(7,"Export season data to Google Sheets"),u()(),w(8,He,4,0,"div",4)(9,Xe,15,6),u()),e&2&&(h(8),M(n.loadingSeasons()?8:9))},dependencies:[ae,we,ve,be,ye,xe,Ce,ce],styles:[".admin-export[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:1.5rem}.page-header[_ngcontent-%COMP%]{margin-bottom:2rem}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1.75rem;color:var(--sys-on-surface, #212121)}.page-header[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{margin:0;color:var(--sys-on-surface-variant, #666)}.back-link[_ngcontent-%COMP%]{display:inline-block;margin-bottom:1rem;color:var(--sys-primary, #c62828);text-decoration:none;font-size:.875rem}.back-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem 2rem}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.export-card[_ngcontent-%COMP%], .steps-card[_ngcontent-%COMP%], .success-card[_ngcontent-%COMP%], .error-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.season-select[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;font-size:1rem;background:#fff}.btn-export[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-export[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-export[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.steps-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.steps-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.step[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.5rem 0}.step-icon[_ngcontent-%COMP%]{font-size:1rem;width:1.25rem;text-align:center}.step-pending[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #999)}.step-in-progress[_ngcontent-%COMP%]{color:var(--sys-tertiary, #1976d2);font-weight:500}.step-completed[_ngcontent-%COMP%]{color:var(--sys-secondary, #2e7d32)}.step-error[_ngcontent-%COMP%]{color:var(--sys-error, #c62828)}.step-detail[_ngcontent-%COMP%]{font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.success-card[_ngcontent-%COMP%]{text-align:center;border-color:var(--sys-secondary, #2e7d32)}.success-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--sys-secondary, #2e7d32);margin-bottom:.5rem}.success-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-secondary, #2e7d32)}.spreadsheet-link[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1.5rem;background:var(--sys-secondary, #2e7d32);color:#fff;border-radius:8px;text-decoration:none;font-weight:500}.spreadsheet-link[_ngcontent-%COMP%]:hover{opacity:.9}.error-card[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}.error-message[_ngcontent-%COMP%]{margin:0;color:var(--sys-error, #c62828);font-weight:500}"]})};export{Ue as AdminExportComponent};
