import{$ as M,H as _,I,L as b,X as E,Y as D,Z as w,_ as A,aa as P}from"./chunk-7OLI4QWT.js";import{I as C,N as p,Rb as d,da as l,ea as y}from"./chunk-WXZFQYIJ.js";import{a as g,b as m}from"./chunk-Q7L6LLAK.js";function N(){return`cart-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function L(i,e){let t=new Date(i),s=new Date(e),r=t.toLocaleDateString("en-US",{month:"short",day:"numeric"}),n=s.toLocaleDateString("en-US",{month:"short",day:"numeric"});return`${r} - ${n}`}function $(i){if(!i||typeof i!="object")return!1;let e=i;if(e.details?.code==="CAPACITY_EXCEEDED")return!0;if(!(e.message??e.error?.message??"").toLowerCase().includes("full"))return!1;let s=(e.code??"").toLowerCase(),r=(e.status??e.error?.status??"").toLowerCase().replace(/_/g,"-");return s==="resource-exhausted"||s==="functions/resource-exhausted"||s==="failed-precondition"||r==="resource-exhausted"}function K(i){return!i||typeof i!="object"?[]:i.details?.failedItems??[]}function Y(i){if(!i||typeof i!="object")return"";let e=i;return e.message??e.error?.message??""}var v=class i{functions=p(E);_seasonCoupons=l([]);_userCoupons=l([]);_selectedUserCouponIds=l([]);_loading=l(!1);_validating=l(!1);_error=l(null);seasonCoupons=this._seasonCoupons.asReadonly();userCoupons=this._userCoupons.asReadonly();selectedUserCouponIds=this._selectedUserCouponIds.asReadonly();loading=this._loading.asReadonly();validating=this._validating.asReadonly();error=this._error.asReadonly();couponsToApply=d(()=>[...this._seasonCoupons(),...this._userCoupons().filter(e=>this._selectedUserCouponIds().includes(e.id))]);totalCouponCredit=d(()=>this.couponsToApply().reduce((e,t)=>e+t.maxCreditCents,0));hasAvailableCoupons=d(()=>this._seasonCoupons().length>0||this._userCoupons().length>0);async loadCoupons(e){this._loading.set(!0),this._error.set(null);try{let t=await this.functions.callApi("getUserAvailableCoupons",{seasonId:e});this._seasonCoupons.set(t.seasonCoupons),this._userCoupons.set(t.userCoupons),this._selectedUserCouponIds.set(t.userCoupons.map(s=>s.id))}catch(t){console.error("Failed to load coupons:",t),this._error.set("Failed to load coupons"),this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([])}finally{this._loading.set(!1)}}toggleCoupon(e){let t=this._selectedUserCouponIds();t.includes(e)?this._selectedUserCouponIds.set(t.filter(s=>s!==e)):this._selectedUserCouponIds.set([...t,e])}isCouponSelected(e){return this._selectedUserCouponIds().includes(e)}clearCoupons(){this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([]),this._error.set(null)}getSelectedCouponIds(){return this._selectedUserCouponIds()}async validateAndAddCoupon(e){this._validating.set(!0);try{let s=(await this.functions.callApi("validateAndAddCoupon",{couponId:e})).coupon;return this._userCoupons().map(n=>n.id).includes(s.id)||(this._userCoupons.update(n=>[...n,s]),this._selectedUserCouponIds.update(n=>[...n,s.id])),{success:!0,coupon:s}}catch(t){return{success:!1,error:t.message||"Failed to validate coupon"}}finally{this._validating.set(!1)}}static \u0275fac=function(t){return new(t||i)};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};var F="berryfun_cart_",R="__berryfun_storage_test__",S=class i{getStorageKey(e,t){return`${F}${e}_${t}`}saveCart(e,t,s){try{let r={items:s,savedAt:Date.now()},n=this.getStorageKey(e,t);localStorage.setItem(n,JSON.stringify(r))}catch(r){console.warn("Failed to save cart to localStorage:",r)}}loadCart(e,t){try{let s=this.getStorageKey(e,t),r=localStorage.getItem(s);if(!r)return null;let n=JSON.parse(r);return this.isValidPersistedCartData(n)?n:(this.clearCart(e,t),null)}catch(s){console.warn("Failed to load cart from localStorage:",s);try{this.clearCart(e,t)}catch{}return null}}clearCart(e,t){try{let s=this.getStorageKey(e,t);localStorage.removeItem(s)}catch(s){console.warn("Failed to clear cart from localStorage:",s)}}isStorageAvailable(){try{return localStorage.setItem(R,"test"),localStorage.removeItem(R),!0}catch{return!1}}isValidPersistedCartData(e){if(typeof e!="object"||e===null)return!1;let t=e;return!(!Array.isArray(t.items)||typeof t.savedAt!="number")}static \u0275fac=function(t){return new(t||i)};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};var T=class i{orderRpc=p(D);orderService=p(M);seasonService=p(A);configService=p(w);couponService=p(v);persistenceService=p(S);userService=p(P);_items=l([]);_pricing=l(null);_pricingLoading=l(!1);_pricingError=l(null);_submitting=l(!1);_submitError=l(null);currentSeason=d(()=>this.seasonService.selectedSeason());currentUserId=d(()=>this.userService.currentUser()?.uid??null);previousUserId=null;previousSeasonId=null;constructor(){y(()=>{let e=this.currentUserId(),t=this.currentSeason()?.id??null;if(!e||!t){this.previousUserId=e,this.previousSeasonId=t;return}let s=this.previousUserId!==e,r=this.previousSeasonId!==t;(s||r)&&this.loadCartFromStorage(e,t),this.previousUserId=e,this.previousSeasonId=t}),y(()=>{let e=this.orderService.order(),t=this._items();if(!e||t.length===0)return;let s=t.map(r=>{let n=r.students.filter(o=>!this.orderService.hasActiveEnrollment(r.class.id,o.id));return m(g({},r),{students:n})}).filter((r,n)=>{let o=t[n];return!(o&&o.students.length>0&&r.students.length===0)});(s.length!==t.length||s.some((r,n)=>r.students.length!==t[n]?.students.length))&&(this._items.set(s),this.persistCart())})}items=this._items.asReadonly();pricing=this._pricing.asReadonly();pricingLoading=this._pricingLoading.asReadonly();pricingError=this._pricingError.asReadonly();submitting=this._submitting.asReadonly();submitError=this._submitError.asReadonly();loading=this.orderRpc.loading;seasonCoupons=this.couponService.seasonCoupons;userCoupons=this.couponService.userCoupons;selectedCouponIds=this.couponService.selectedUserCouponIds;couponsLoading=this.couponService.loading;couponsValidating=this.couponService.validating;couponsError=this.couponService.error;hasAvailableCoupons=this.couponService.hasAvailableCoupons;couponsToApply=this.couponService.couponsToApply;totalCouponCredit=this.couponService.totalCouponCredit;_couponValidationError=l(null);_couponValidationSuccess=l(null);couponValidationError=this._couponValidationError.asReadonly();couponValidationSuccess=this._couponValidationSuccess.asReadonly();itemCount=d(()=>this._items().length);hasItems=d(()=>this._items().length>0);isEmpty=d(()=>this._items().length===0);uniqueClassCount=d(()=>new Set(this._items().map(t=>t.class.id)).size);uniqueStudentCount=d(()=>new Set(this._items().flatMap(t=>t.students.map(s=>s.id))).size);totalEnrollmentCount=d(()=>this._items().reduce((e,t)=>e+t.students.length,0));itemsMissingStudents=d(()=>this._items().filter(e=>e.students.length===0));itemsMissingStudentsCount=d(()=>this.itemsMissingStudents().length);allStudentsAssigned=d(()=>this._items().every(e=>e.students.length>0));isReadyToSubmit=d(()=>this.hasItems()&&this.allStudentsAssigned()&&!this._submitting());subtotal=d(()=>this._pricing()?.subtotal??0);discounts=d(()=>this._pricing()?.discounts??[]);totalDiscountAmount=d(()=>_(this.discounts()));total=d(()=>{let e=this._pricing();return e?I(e.subtotal,e.discounts):0});addToCart(e,t=[],s={lunch:!0,extendedCare:!1}){let r=this.currentSeason()?.id??"";if(e.seasonId!==r)throw new Error("Cannot add classes from different seasons. Please complete or clear your current cart first.");if(this.isClassInCart(e.id))throw new Error("This class is already in your cart");for(let o of t)this.validateStudentNotEnrolled(e.id,o.id);let n={id:N(),class:e,students:t,options:s};return this._items.update(o=>[...o,n]),this.persistCart(),t.length>0&&this.refreshPricing(),n.id}removeFromCart(e){this._items.update(t=>t.filter(s=>s.id!==e)),this.persistCart(),this._items().length>0?this.refreshPricing():this._pricing.set(null)}toggleStudent(e,t){let s=this._items().find(n=>n.id===e);if(!s)return;let r=s.students.some(n=>n.id===t.id);if(!r&&(this.validateStudentNotEnrolled(s.class.id,t.id),this.isStudentInCartForClass(s.class.id,t.id)))throw new Error("This student is already in the cart for this class");this._items.update(n=>n.map(o=>{if(o.id!==e)return o;let c=r?o.students.filter(u=>u.id!==t.id):[...o.students,t];return m(g({},o),{students:c})})),this.persistCart(),this.refreshPricing()}updateItemOptions(e,t){this._items.update(s=>s.map(r=>r.id===e?m(g({},r),{options:g(g({},r.options),t)}):r)),this.persistCart(),this.refreshPricing()}clearCart(){this._items.set([]),this._pricing.set(null),this._pricingError.set(null),this._submitError.set(null),this.couponService.clearCoupons(),this.persistCart()}async loadCoupons(){let e=this.currentSeason()?.id;e&&await this.couponService.loadCoupons(e)}toggleCoupon(e){this.couponService.toggleCoupon(e)}isCouponSelected(e){return this.couponService.isCouponSelected(e)}async validateAndAddCoupon(e){this._couponValidationError.set(null),this._couponValidationSuccess.set(null);let t=await this.couponService.validateAndAddCoupon(e);t.success&&t.coupon?(this._couponValidationSuccess.set(`Coupon "${t.coupon.name}" added!`),setTimeout(()=>this._couponValidationSuccess.set(null),3e3),this.refreshPricing()):(this._couponValidationError.set(t.error||"Failed to add coupon"),setTimeout(()=>this._couponValidationError.set(null),5e3))}isClassInCart(e){return this._items().some(t=>t.class.id===e)}isStudentInCartForClass(e,t){return this._items().some(s=>s.class.id===e&&s.students.some(r=>r.id===t))}isStudentSelected(e,t){return this._items().find(r=>r.id===e)?.students.some(r=>r.id===t)??!1}getCartItem(e){return this._items().find(t=>t.id===e)??null}getCartItemForClass(e){return this._items().find(t=>t.class.id===e)??null}refreshPricing(){let e=this._items();if(e.length===0){this._pricing.set(null);return}if(!this.allStudentsAssigned()){this._pricing.set(null);return}let t=this.currentSeason();if(!t){this._pricingError.set("Season not set");return}this._pricingError.set(null);try{let s=new Map;for(let a of e)s.has(a.class.id)||s.set(a.class.id,{id:a.class.id,name:a.class.name,basePrice:a.class.basePrice,lunchPrice:a.class.lunchPrice,extendedCarePrice:a.class.extendedCarePrice,earlyBirdTiers:a.class.earlyBirdTiers??[]});let r=e.flatMap(a=>a.students.map(f=>({sessionId:a.class.id,studentId:f.id,options:a.options}))),n=new Set;for(let a of this.userService.students())a.lastCampYear&&n.add(a.id);let o=this.userService.students()[0]?.id,c=new Map(this.userService.students().map(a=>[a.id,a])),u=new Set;for(let a of r){let f=c.get(a.studentId);f?.referCode&&!f.lastCampYear&&u.add(a.studentId)}let h=u.size,x=b({items:r,sessionLookup:s,currentDate:this.configService.currentDate(),discountConfig:m(g({siblingDiscountPerWeek:t.siblingDiscountPerWeek??0,multiSessionDiscountTiers:t.multiSessionDiscounts??[],returningStudentIds:n},o!==void 0&&{firstStudentId:o}),{referredStudentCount:h})});this._pricing.set(x)}catch(s){let r=s instanceof Error?s.message:String(s);this._pricingError.set(r)}}async submit(){let e=this._items();if(e.length===0)throw new Error("Cart is empty");if(!this.allStudentsAssigned())throw new Error("Please select a student for all classes");let t=this.currentSeason()?.id;if(!t)throw new Error("Season not set");this._submitting.set(!0),this._submitError.set(null);try{let s=e.flatMap(o=>o.students.map(c=>({sessionId:o.class.id,studentId:c.id,options:o.options}))),r=this.couponService.getSelectedCouponIds(),n=await this.orderRpc.lockSessions({seasonId:t,items:s,selectedCouponIds:r});return this.clearPersistedCart(),this.clearCart(),n}catch(s){let r=s instanceof Error?s.message:String(s);throw this._submitError.set(r),s}finally{this._submitting.set(!1)}}clearPricingError(){this._pricingError.set(null)}clearSubmitError(){this._submitError.set(null)}clearAllErrors(){this._pricingError.set(null),this._submitError.set(null)}validateStudentNotEnrolled(e,t){if(this.orderService.hasActiveEnrollment(e,t))throw new Error("This student is already enrolled in this class")}loadCartFromStorage(e,t){let s=this.persistenceService.loadCart(e,t);if(s&&s.items.length>0){let r=this.validateCartItems(s.items);this._items.set(r);let n=s.items.reduce((u,h)=>u+(h.students?.length??0),0),o=r.reduce((u,h)=>u+h.students.length,0);(r.length!==s.items.length||o!==n)&&this.persistCart(),r.some(u=>u.students.length>0)&&this.refreshPricing()}else this._items.set([]),this._pricing.set(null)}validateCartItems(e){let t=this.currentSeason(),s=new Set(t?.sessions?.map(n=>n.id)??[]),r=s.size>0;return e.filter(n=>!(!n||!n.class||!n.class.id||r&&!s.has(n.class.id))).map(n=>{let o=n.students.filter(c=>!this.orderService.hasActiveEnrollment(n.class.id,c.id));return m(g({},n),{students:o})}).filter(n=>{let o=e.find(h=>h.id===n.id);return o&&o.students.length>0&&n.students.length===0?(console.info(`[CartStore] Removing cart item for class "${n.class.name}" - all students already enrolled`),!1):!0})}persistCart(){let e=this.currentUserId(),t=this.currentSeason()?.id;!e||!t||this.persistenceService.saveCart(e,t,this._items())}clearPersistedCart(){let e=this.currentUserId(),t=this.currentSeason()?.id;!e||!t||this.persistenceService.clearCart(e,t)}static \u0275fac=function(t){return new(t||i)};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};export{L as a,$ as b,K as c,Y as d,T as e};
