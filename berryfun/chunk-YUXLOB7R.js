import{a as T}from"./chunk-6B5SPXH3.js";import{$ as E,Na as R,Qa as M,U as m,X as P,Y as w,Z as f,aa as H,ha as _,la as y,ma as u,ta as D}from"./chunk-B4PSB7QN.js";import{M as h,R as g,Vb as C,g as p,ha as l}from"./chunk-VKJSCVXY.js";var b=class c{db=new R(f(m()));async getSeason(e,s){let t=`years/${e}/seasons`,r=await this.db.getDocument(t,s);return r?u(y.parse(r)):null}async listActiveSeasons(e){let s=`years/${e}/seasons`;return(await this.db.getDocuments(s,[{field:"isActive",op:"==",value:!0}])).map(r=>u(y.parse(r))).sort((r,a)=>r.startDate.localeCompare(a.startDate))}async listAllSeasons(e){let s=`years/${e}/seasons`;return(await this.db.getDocuments(s)).map(r=>u(y.parse(r))).sort((r,a)=>r.startDate.localeCompare(a.startDate))}async getRegistration(e,s){let t=`years/${e}/registrations`,r=await this.db.getDocument(t,s);return r?D.parse(r):null}subscribeToRegistration(e,s){let t=f(m());return new p(r=>{let a=w(t,`years/${e}/registrations`,s),n=_(a,o=>{if(!o.exists()){r.next(null);return}try{let i=o.data(),d=D.parse(i);r.next(d)}catch(i){console.error("Failed to parse registration:",i),r.error(i)}},o=>{console.error("Registration subscription error:",o),r.error(o)});return()=>n()})}subscribeToSeason(e,s){let t=f(m());return new p(r=>{let a=w(t,`years/${e}/seasons`,s),n=_(a,o=>{if(!o.exists()){r.next(null);return}try{let i=o.data(),d=u(y.parse(i));r.next(d)}catch(i){console.error("Failed to parse season:",i),r.error(i)}},o=>{console.error("Season subscription error:",o),r.error(o)});return()=>n()})}subscribeToActiveSeasons(e){let s=f(m());return new p(t=>{let r=P(s,`years/${e}/seasons`),a=E(r,H("isActive","==",!0)),n=_(a,o=>{try{let i=[];o.docs.forEach(d=>{try{let S=u(y.parse(d.data()));i.push(S)}catch(S){console.error("Failed to parse season document:",S)}}),i.sort((d,S)=>d.startDate.localeCompare(S.startDate)),t.next(i)}catch(i){console.error("Failed to process seasons snapshot:",i),t.error(i)}},o=>{console.error("Active seasons subscription error:",o),t.error(o)});return()=>n()})}async getClass(e,s){let t=await this.listAllSeasons(e);for(let r of t){let a=r.sessions?.find(n=>n.id===s);if(a)return a}return null}async listClassesBySeason(e,s,t=!0){let r=await this.getSeason(e,s);if(!r||!r.sessions)return[];let a=r.sessions;return t&&(a=a.filter(n=>n.isActive)),a.sort((n,o)=>n.startDate.localeCompare(o.startDate))}async listClassesByYear(e,s=!0){let t=await this.listAllSeasons(e),r=[];for(let a of t)if(a.sessions)for(let n of a.sessions)(!s||n.isActive)&&r.push(n);return r.sort((a,n)=>a.startDate.localeCompare(n.startDate))}static \u0275fac=function(s){return new(s||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};var v=class c{functions=g(M);_loading=l(!1);_error=l(null);loading=this._loading.asReadonly();error=this._error.asReadonly();clearError(){this._error.set(null)}async wrapCall(e,s){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,s)}catch(t){let r=t instanceof Error?t.message:String(t);throw this._error.set(r),t}finally{this._loading.set(!1)}}async wrapApiCall(e,s){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,s)}catch(t){let r=t instanceof Error?t.message:String(t);throw this._error.set(r),t}finally{this._loading.set(!1)}}async listAllSeasons(e){return this.wrapCall("listAllSeasons",{year:e})}async listAllClasses(e){return this.wrapCall("listAllClasses",{year:e})}async createSeason(e){return this.wrapApiCall("createSeason",e)}async updateSeason(e,s){return this.wrapApiCall("updateSeason",{seasonId:e,updates:s})}async createClass(e){return this.wrapApiCall("createClass",e)}async updateClass(e,s){return this.wrapApiCall("updateClass",{sessionId:e,updates:s})}static \u0275fac=function(s){return new(s||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};var A="berryfun_selected_season",x=class c{datastore=g(b);rpc=g(v);configService=g(T);seasonsSubscription=null;subscribedYear=null;get currentYear(){return this.configService.currentActiveYear()}_seasons=l([]);_classes=l([]);_selectedSeason=l(null);_selectedClass=l(null);_loading=l(!1);_error=l(null);_actionLoading=l(!1);_actionError=l(null);seasons=this._seasons.asReadonly();classes=this._classes.asReadonly();selectedSeason=this._selectedSeason.asReadonly();selectedClass=this._selectedClass.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();hasSeasons=C(()=>this._seasons().length>0);hasClasses=C(()=>this._classes().length>0);ngOnDestroy(){this.unsubscribeAll()}unsubscribeAll(){this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=null}async loadSeasons(e){if(!(this.subscribedYear===e&&this.seasonsSubscription))return this._loading.set(!0),this._error.set(null),this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=e,new Promise((s,t)=>{let r=!0;this.seasonsSubscription=this.datastore.subscribeToActiveSeasons(e).subscribe({next:a=>{this._seasons.set(a),this._loading.set(!1),!this._selectedSeason()&&a.length>0&&this._selectedSeason.set(a[0]);let n=this._selectedSeason();if(n){let o=a.find(i=>i.id===n.id);o?(this._selectedSeason.set(o),this._classes.set(o.sessions?.filter(i=>i.isActive).sort((i,d)=>i.startDate.localeCompare(d.startDate))||[])):this._selectedSeason.set(a[0]||null)}r&&(r=!1,s())},error:a=>{let n=a instanceof Error?a.message:String(a);this._error.set(n),this._loading.set(!1),r&&(r=!1,t(a))}})})}async loadClassesBySeason(e,s){if(this.subscribedYear===s&&this.seasonsSubscription){let t=this._seasons().find(r=>r.id===e);if(t){let r=t.sessions?.filter(a=>a.isActive).sort((a,n)=>a.startDate.localeCompare(n.startDate))||[];this._classes.set(r);return}}this._loading.set(!0),this._error.set(null);try{let t=await this.datastore.listClassesBySeason(s,e);this._classes.set(t)}catch(t){let r=t instanceof Error?t.message:String(t);throw this._error.set(r),t}finally{this._loading.set(!1)}}async loadClassesByYear(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listClassesByYear(e);this._classes.set(s)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async loadClass(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.getClass(this.currentYear,e);if(s)this._selectedClass.set(s);else throw new Error(`Class not found: ${e}`)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}selectSeason(e){this._selectedSeason.set(e),this.saveSelectedSeasonId(e?.id??null)}getLastSelectedSeasonId(){try{return localStorage.getItem(A)}catch{return null}}saveSelectedSeasonId(e){try{e?localStorage.setItem(A,e):localStorage.removeItem(A)}catch{}}selectClass(e){this._selectedClass.set(e)}async getClassById(e){let s=this._classes().find(t=>t.id===e);if(s)return s;try{return await this.datastore.getClass(this.currentYear,e)}catch{return null}}calculatePrice(e,s){let r=this.configService.config().currentDate,a=e.basePrice;if(e.earlyBirdTiers&&e.earlyBirdTiers.length>0){let n=e.earlyBirdTiers.find(o=>r<=o.deadline);n&&(a=n.price)}return s.includeLunch&&(a+=e.lunchPrice),s.includeExtendedCare&&(a+=e.extendedCarePrice),a}formatPrice(e){return`$${(e/100).toFixed(2)}`}clearError(){this._error.set(null)}reset(){this.unsubscribeAll(),this._seasons.set([]),this._classes.set([]),this._selectedSeason.set(null),this._selectedClass.set(null),this._error.set(null)}async refreshCatalog(){let e=this.subscribedYear||this.currentYear;this.subscribedYear=null,await this.loadSeasons(e)}async loadAllSeasons(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listAllSeasons(e);this._seasons.set(s)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async loadAllClasses(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listClassesByYear(e,!1);this._classes.set(s)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async createSeason(e){this._actionLoading.set(!0),this._actionError.set(null);try{let s=await this.rpc.createSeason(e),t=u(s);return this._seasons.update(r=>[...r,t]),t}catch(s){let t=s instanceof Error?s.message:String(s);throw this._actionError.set(t),s}finally{this._actionLoading.set(!1)}}async updateSeason(e,s){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateSeason(e,s),r=u(t);return this._seasons.update(a=>a.map(n=>n.id===e?r:n)),r}catch(t){let r=t instanceof Error?t.message:String(t);throw this._actionError.set(r),t}finally{this._actionLoading.set(!1)}}async createClass(e){this._actionLoading.set(!0),this._actionError.set(null);try{let s=await this.rpc.createClass(e);return this._classes.update(t=>[...t,s]),s}catch(s){let t=s instanceof Error?s.message:String(s);throw this._actionError.set(t),s}finally{this._actionLoading.set(!1)}}async updateClass(e,s){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateClass(e,s);return this._classes.update(r=>r.map(a=>a.id===e?t:a)),t}catch(t){let r=t instanceof Error?t.message:String(t);throw this._actionError.set(r),t}finally{this._actionLoading.set(!1)}}async toggleSeasonActive(e){let s=this._seasons().find(t=>t.id===e);s&&await this.updateSeason(e,{isActive:!s.isActive})}async toggleClassActive(e){let s=this._classes().find(t=>t.id===e);s&&await this.updateClass(e,{isActive:!s.isActive})}getSeason(e){return this._seasons().find(s=>s.id===e)}getClass(e){return this._classes().find(s=>s.id===e)}static \u0275fac=function(s){return new(s||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{b as a,x as b};
