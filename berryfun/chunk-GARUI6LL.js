import{c as Ne,f as Pe,i as Oe,j as Ae,k as De,q as Me}from"./chunk-ZYT4DFHL.js";import{H as xe,I as Ee,P as ve,Q as re,Z as be,_ as we,aa as Ie,d as ue,da as Re,j as ge,k as ye,m as Q,p as he,x as _e}from"./chunk-WJBNKXS2.js";import{Ba as V,Da as Se,F as B,Ia as ee,Ka as te,Oa as Ce,_ as X,aa as F,db as $,gb as ne,ha as z,wa as fe}from"./chunk-UYHN5VVP.js";import{Ab as me,Ba as ae,Ea as g,N as k,Pa as ie,S as D,T as M,Za as w,_a as I,bb as q,cb as K,da as v,db as O,eb as p,fb as c,gb as de,kb as le,mb as R,ob as b,ub as ce,wb as pe,yb as m,zb as U}from"./chunk-DU5POHF6.js";import{a as Z,b as se}from"./chunk-Q7L6LLAK.js";var ze=50,Ve=30,j=class{constructor(n){this.firestore=n}async loadSeason(n){let t=F(this.firestore,`years/${2026}/seasons`,n),o=await $(t);if(!o.exists())throw new Error(`Season ${n} not found`);let r=o.data();return _e(r)}async loadOrders(n,t,o=ze){let r=[],s=X(this.firestore,`years/${2026}/seasons/${n}/orders`),a=null,i=0;for(;;){i++,t({step:"Loading orders...",detail:`batch ${i}`});let d=a?V(s,ee("userAuthId"),te(o),Ce(a)):V(s,ee("userAuthId"),te(o)),l=await ne(d);for(let u of l.docs)r.push(u.data());if(l.size<o)break;a=l.docs[l.docs.length-1]}return r}async loadUsers(n,t,o=Ve){let r=new Map,s=[...new Set(n)];if(s.length===0)return r;let a=X(this.firestore,"users"),i=Math.ceil(s.length/o);for(let d=0;d<s.length;d+=o){let l=Math.floor(d/o)+1;t({step:"Loading user data...",detail:`batch ${l} of ${i}`});let u=s.slice(d,d+o),y=V(a,Se(fe(),"in",u)),C=await ne(y);for(let h of C.docs){let P=h.data();r.set(P.uid,P)}}return r}async loadRegistration(n){let t=F(this.firestore,`years/${2026}/registrations`,n),o=await $(t);return o.exists()?o.data():null}async loadGlobalConfig(){let n=F(this.firestore,"global","config"),t=await $(n);return t.exists()?t.data():null}async loadCoupons(n,t){let o=[...n.coupons??[]],r=new Set(o.map(a=>a.id)),s=new Set;for(let a of t)for(let i of a.appliedCouponIds??[])r.has(i)||s.add(i);for(let a of s){let i=F(this.firestore,"coupons",a),d=await $(i);d.exists()&&o.push(d.data())}return o}async loadAllData(n,t){t({step:"Loading season data..."});let o=await this.loadSeason(n),r=await this.loadOrders(n,t),s=r.map(u=>u.userAuthId),a=await this.loadUsers(s,t);t({step:"Loading registration data..."});let i=await this.loadRegistration(n);t({step:"Loading coupon data..."});let d=await this.loadCoupons(o,r);t({step:"Loading system config..."});let l=await this.loadGlobalConfig();return{season:o,orders:r,users:a,registration:i,coupons:d,globalConfig:l}}};var Ge="https://sheets.googleapis.com/v4/spreadsheets",H=null,J=0,He=3300*1e3;var Y=class{async acquireAccessToken(){if(H&&Date.now()<J)return console.log("[GoogleSheets] Using cached access token (expires in",Math.round((J-Date.now())/1e3/60),"minutes)"),H;console.log("[GoogleSheets] Acquiring new access token via OAuth popup...");let n=new Q;n.addScope("https://www.googleapis.com/auth/spreadsheets"),console.log("[GoogleSheets] Opening sign-in popup...");let t=await he(Re,n);console.log("[GoogleSheets] Sign-in popup completed, user:",t.user?.email);let o=Q.credentialFromResult(t);if(console.log("[GoogleSheets] Credential extracted:",o?"success":"null"),!o)throw console.error("[GoogleSheets] Failed to obtain Google credentials from result:",t),new Error("Failed to obtain Google credentials");let r=o.accessToken;if(console.log("[GoogleSheets] Access token present:",!!r),!r)throw console.error("[GoogleSheets] Credential has no accessToken. Credential type:",o.providerId),new Error("Failed to obtain access token");return H=r,J=Date.now()+He,console.log("[GoogleSheets] Access token cached successfully"),r}clearCachedToken(){console.log("[GoogleSheets] Clearing cached access token"),H=null,J=0}async createSpreadsheet(n,t,o){console.log("[GoogleSheets] Creating spreadsheet:",{title:n,sheetNames:t}),console.log("[GoogleSheets] Access token length:",o?.length||0);let r={properties:{title:n},sheets:t.map(i=>({properties:{title:i}}))};console.log("[GoogleSheets] Request body:",JSON.stringify(r));let s;try{s=await fetch(Ge,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(r)})}catch(i){throw console.error("[GoogleSheets] Network error during createSpreadsheet:",i),new Error(`Network error creating spreadsheet: ${i instanceof Error?i.message:String(i)}`)}if(console.log("[GoogleSheets] createSpreadsheet response status:",s.status,s.statusText),!s.ok){let i=await s.text();throw console.error("[GoogleSheets] createSpreadsheet API error:",{status:s.status,statusText:s.statusText,errorText:i,headers:Object.fromEntries(s.headers.entries())}),(s.status===401||s.status===403)&&(console.log("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${s.status}): ${i}`)}let a=await s.json();return console.log("[GoogleSheets] Spreadsheet created successfully:",{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}),{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}}async writeSheetData(n,t,o,r){console.log("[GoogleSheets] Writing sheet data:",{spreadsheetId:n,sheetName:t,rowCount:o.length,columnCount:o[0]?.length||0});let s=encodeURIComponent(t),a=`${Ge}/${n}/values/${s}?valueInputOption=RAW`,i;try{i=await fetch(a,{method:"PUT",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({range:t,majorDimension:"ROWS",values:o})})}catch(d){throw console.error("[GoogleSheets] Network error during writeSheetData:",d),new Error(`Network error writing sheet data: ${d instanceof Error?d.message:String(d)}`)}if(console.log("[GoogleSheets] writeSheetData response status:",i.status,i.statusText),!i.ok){let d=await i.text();throw console.error("[GoogleSheets] writeSheetData API error:",{status:i.status,statusText:i.statusText,errorText:d,sheetName:t}),(i.status===401||i.status===403)&&(console.log("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${i.status}): ${d}`)}console.log("[GoogleSheets] Sheet data written successfully:",t)}};function N(e){return`$${(e/100).toFixed(2)}`}function oe(e,n,t){let o=e.get(n);return o?(o.students??[]).find(r=>r.id===t)??null:null}function Je(e,n){return e.sessions.find(t=>t.id===n)?.name??n}function Te(e,n,t){let r=["Order User Display ID","Parent Name","Parent Email","Parent Phone","Student Name","Student DOB","Student Gender","Student School","Student Allergies",...t.sessions.map(i=>i.name),"Student Subtotal","Order Discount","Order Total"],s=[];for(let i of e){let d=n.get(i.userAuthId),l=d?.displayName??"",u=i.items,y=new Map;for(let x of u){let E=y.get(x.studentId)??[];E.push(x),y.set(x.studentId,E)}if(y.size===0)continue;let C=Ee(i.pricing?.discounts??[]),h=re(i),P=[...y.keys()].sort((x,E)=>{let S=oe(n,i.userAuthId,x),G=S?`${S.firstName} ${S.lastName}`.trim():"",A=oe(n,i.userAuthId,E),T=A?`${A.firstName} ${A.lastName}`.trim():"";return G.localeCompare(T)}),f=[],_=!0;for(let x of P){let E=y.get(x),S=oe(n,i.userAuthId,x),G=t.sessions.map(T=>{let W=E.find(Be=>Be.sessionId===T.id);return W?N(W.snapshot.priceSnapshot.itemTotal):""}),A=E.reduce((T,W)=>T+W.snapshot.priceSnapshot.itemTotal,0);f.push([i.userDisplayId,l,d?.email??"",d?.primaryGuardian?.phone??"",S?`${S.firstName} ${S.lastName}`.trim():"",S?.dob??"",S?.gender??"",S?.school??"",S?.allergies??"",...G,N(A),_?N(Math.abs(C)):"",_?N(h):""]),_=!1}s.push({parentName:l,rows:f})}s.sort((i,d)=>i.parentName.localeCompare(d.parentName));let a=s.flatMap(i=>i.rows);return[r,...a]}function ke(e,n){let t=["User Display ID","Parent Name","Parent Email","Order Total","Coupon Discount","Total Paid","Balance Due","Payment Count","Payment Details","Refund Total"],o=[];for(let r of e){if(!r.items.some(h=>h.status==="submitted"||h.status==="paid"))continue;let a=n.get(r.userAuthId),i=re(r),d=r.couponDiscount??0,l=r.totalPaid??0,u=ve(r),y=xe(r),C=(r.payments??[]).map(h=>`${h.method} ${N(h.amount)} ${h.recordedAt}${h.reference?` ref:${h.reference}`:""}`).join("; ");o.push([r.userDisplayId,a?.displayName??"",a?.email??"",N(i),N(d),N(l),N(y),String((r.payments??[]).length),C,N(u)])}return[t,...o]}function Ue(e,n){let t=["Coupon ID","Name","Description","Type","Max Credit (cents)","Eligible Emails","Used By (Order Count)"],o=new Map;for(let s of n)for(let a of s.appliedCouponIds??[])o.set(a,(o.get(a)??0)+1);let r=e.map(s=>[s.id,s.name,s.description,s.coupon_type,String(s.maxCreditCents),(s.eligible_emails??[]).join(", "),String(o.get(s.id)??0)]);return[t,...r]}function Fe(e,n,t){let o=["User Display ID","Parent Name","Parent Email","Session ID","Session Name","Joined At"],r=[];for(let s of e){let a=n.get(s.userAuthId);for(let i of s.waitlist??[])r.push([s.userDisplayId,a?.displayName??"",a?.email??"",i.sessionId,Je(t,i.sessionId),i.joinedAt])}return[o,...r]}function $e(e,n,t,o){let r=["Session ID","Session Name","Start Date","End Date","Capacity","Enrolled Count","Waitlisted Count","Available Spots","Enrolled Students"],s=new Map,a=new Map;for(let l of n){for(let u of l.items){let y=s.get(u.sessionId)??[];y.push(u.studentId),s.set(u.sessionId,y)}for(let u of l.waitlist??[])a.set(u.sessionId,(a.get(u.sessionId)??0)+1)}let i=new Map;if(o)for(let l of o.values())for(let u of l.students??[])i.set(u.id,`${u.firstName} ${u.lastName}`.trim());let d=e.sessions.map(l=>{let u=s.get(l.id)??[],y=u.length,C=a.get(l.id)??0,h=Math.max(0,l.capacity-y),P=u.map(f=>{let _=i.get(f);return _?`${_} (${f})`:f}).join(", ");return[l.id,l.name,l.startDate,l.endDate,String(l.capacity),String(y),String(C),String(h),P]});return[r,...d]}var Ye={uid:"UID",displayId:"Display ID",email:"Email",displayName:"Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryEmail:"Primary Email",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",primaryEmployer:"Primary Employer",primaryStreet:"Primary Street",primaryCity:"Primary City",primaryState:"Primary State",primaryZipCode:"Primary Zip Code",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryEmail:"Secondary Email",secondaryPhone:"Secondary Phone",secondaryWechatId:"Secondary WeChat ID",secondaryWechatName:"Secondary WeChat Name",secondaryEmployer:"Secondary Employer",secondarySameAddress:"Secondary Same Address",secondaryStreet:"Secondary Street",secondaryCity:"Secondary City",secondaryState:"Secondary State",secondaryZipCode:"Secondary Zip Code",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship",couponIds:"Coupon IDs",referredStudentIds:"Referred Student IDs",createdAt:"Created At",updatedAt:"Updated At"};function Ze(e){return{uid:e.uid,displayId:e.displayId,email:e.email,displayName:e.displayName,primaryFirstName:e.primaryGuardian?.firstName??"",primaryLastName:e.primaryGuardian?.lastName??"",primaryEmail:e.primaryGuardian?.email??"",primaryPhone:e.primaryGuardian?.phone??"",primaryWechatId:e.primaryGuardian?.wechatId??"",primaryWechatName:e.primaryGuardian?.wechatName??"",primaryEmployer:e.primaryGuardian?.employer??"",primaryStreet:e.primaryGuardian?.address?.street??"",primaryCity:e.primaryGuardian?.address?.city??"",primaryState:e.primaryGuardian?.address?.state??"",primaryZipCode:e.primaryGuardian?.address?.zipCode??"",secondaryFirstName:e.secondaryGuardian?.firstName??"",secondaryLastName:e.secondaryGuardian?.lastName??"",secondaryEmail:e.secondaryGuardian?.email??"",secondaryPhone:e.secondaryGuardian?.phone??"",secondaryWechatId:e.secondaryGuardian?.wechatId??"",secondaryWechatName:e.secondaryGuardian?.wechatName??"",secondaryEmployer:e.secondaryGuardian?.employer??"",secondarySameAddress:e.secondaryGuardian?.sameAddressAsPrimary?"Yes":"",secondaryStreet:e.secondaryGuardian?.address?.street??"",secondaryCity:e.secondaryGuardian?.address?.city??"",secondaryState:e.secondaryGuardian?.address?.state??"",secondaryZipCode:e.secondaryGuardian?.address?.zipCode??"",emergencyName:e.emergencyContact?.name??"",emergencyPhone:e.emergencyContact?.phone??"",emergencyRelationship:e.emergencyContact?.relationship??"",couponIds:(e.couponIds??[]).join(", "),referredStudentIds:(e.referredStudentIds??[]).join(", "),createdAt:e.timestamps.createdAt,updatedAt:e.timestamps.updatedAt}}function Le(e){let n=[...e.values()].sort((r,s)=>r.displayId.localeCompare(s.displayId)),t=Object.values(Ye),o=n.map(r=>Object.values(Ze(r)));return[t,...o]}var qe={isSystemInitialized:"System Initialized",currentDate:"Current Date",currentTime:"Current Time",allowEnrollment:"Allow Enrollment",maintenanceMode:"Maintenance Mode",paymentInstructions:"Payment Instructions",returnInstructions:"Return Instructions",contactEmail:"Contact Email",contactPhone:"Contact Phone",contactAddress:"Contact Address",waitlistLastRecalculationAt:"Waitlist Last Recalculation"};function Ke(e){return{isSystemInitialized:e.isSystemInitialized?"Yes":"No",currentDate:e.currentDate,currentTime:e.currentTime,allowEnrollment:e.systemSwitch.allowEnrollment?"Yes":"No",maintenanceMode:e.systemSwitch.maintenanceMode?"Yes":"No",paymentInstructions:e.paymentInstructions.content,returnInstructions:e.returnInstructions?.content??"",contactEmail:e.contactInfo.email,contactPhone:e.contactInfo.phone,contactAddress:e.contactInfo.address??"",waitlistLastRecalculationAt:e.waitlist?.lastRecalculationAt??""}}function je(e){let n=Object.values(qe),t=Object.values(Ke(e));return[n,t]}var Qe=(e,n)=>n.id,Xe=(e,n)=>n.label;function et(e,n){e&1&&(p(0,"div",5),de(1,"div",6),p(2,"p"),m(3,"Loading seasons..."),c()())}function tt(e,n){if(e&1&&(p(0,"option",12),m(1),c()),e&2){let t=n.$implicit;O("value",t.id),g(),U(t.name)}}function nt(e,n){e&1&&m(0," Exporting... ")}function rt(e,n){e&1&&m(0," Download JSON File ")}function ot(e,n){e&1&&m(0," Export to Google Sheets ")}function st(e,n){e&1&&m(0," \u25CB ")}function at(e,n){e&1&&m(0," \u25CC ")}function it(e,n){e&1&&m(0," \u2713 ")}function dt(e,n){e&1&&m(0," \u2717 ")}function lt(e,n){if(e&1&&(p(0,"span",30),m(1),c()),e&2){let t=b().$implicit;g(),me("(",t.detail,")")}}function ct(e,n){if(e&1&&(p(0,"div",27)(1,"span",28),w(2,st,1,0)(3,at,1,0)(4,it,1,0)(5,dt,1,0),c(),p(6,"span",29),m(7),c(),w(8,lt,2,1,"span",30),c()),e&2){let t,o=n.$implicit;pe("step-pending",o.status==="pending")("step-in-progress",o.status==="in-progress")("step-completed",o.status==="completed")("step-error",o.status==="error"),g(2),I((t=o.status)==="pending"?2:t==="in-progress"?3:t==="completed"?4:t==="error"?5:-1),g(5),U(o.label),g(),I(o.detail?8:-1)}}function pt(e,n){if(e&1&&(p(0,"div",19)(1,"h3"),m(2,"Export Progress"),c(),p(3,"div",25),q(4,ct,9,11,"div",26,Xe),c()()),e&2){let t=b(2);g(4),K(t.steps())}}function mt(e,n){e&1&&m(0," Importing... ")}function ut(e,n){e&1&&m(0," Select JSON File to Import ")}function gt(e,n){if(e&1&&(p(0,"div",23)(1,"div",31),m(2,"\u2713"),c(),p(3,"h3"),m(4,"Export Complete"),c(),p(5,"a",32),m(6," Open Spreadsheet \u2192 "),c()()),e&2){let t=b(2);g(5),O("href",t.spreadsheetUrl(),ae)}}function yt(e,n){e&1&&(p(0,"div",23)(1,"div",31),m(2,"\u2713"),c(),p(3,"h3"),m(4,"JSON Export Complete"),c(),p(5,"p"),m(6,"The file has been downloaded to your device."),c()())}function ht(e,n){if(e&1&&(p(0,"div",23)(1,"div",31),m(2,"\u2713"),c(),p(3,"h3"),m(4,"Import Complete"),c(),p(5,"p"),m(6),c()()),e&2){let t=b(2);g(6),U(t.importSummary())}}function ft(e,n){if(e&1&&(p(0,"div",24)(1,"p",33),m(2),c()()),e&2){let t=b(2);g(2),U(t.error())}}function St(e,n){if(e&1){let t=le();p(0,"div",7)(1,"h3"),m(2,"Export Season Data"),c(),p(3,"div",8)(4,"label",9),m(5,"Select Season"),c(),p(6,"select",10),R("ngModelChange",function(r){D(t);let s=b();return M(s.onSeasonChange(r))}),p(7,"option",11),m(8,"-- Select a season --"),c(),q(9,tt,2,2,"option",12,Qe),c()(),p(11,"div",13)(12,"label"),m(13,"Export Format"),c(),p(14,"div",14)(15,"label",15)(16,"input",16),R("change",function(){D(t);let r=b();return M(r.onFormatChange("google-sheets"))}),c(),p(17,"span"),m(18,"Google Sheets"),c()(),p(19,"label",15)(20,"input",17),R("change",function(){D(t);let r=b();return M(r.onFormatChange("json"))}),c(),p(21,"span"),m(22,"JSON File"),c()()()(),p(23,"button",18),R("click",function(){D(t);let r=b();return M(r.startExport())}),w(24,nt,1,0)(25,rt,1,0)(26,ot,1,0),c()(),w(27,pt,6,0,"div",19),p(28,"div",7)(29,"h3"),m(30,"Import from JSON"),c(),p(31,"p",20),m(32," Import season data from a previously exported JSON file. "),c(),p(33,"input",21,0),R("change",function(r){D(t);let s=b();return M(s.onFileSelected(r))}),c(),p(35,"button",22),R("click",function(){D(t);let r=ce(34);return M(r.click())}),w(36,mt,1,0)(37,ut,1,0),c()(),w(38,gt,7,1,"div",23),w(39,yt,7,0,"div",23),w(40,ht,7,1,"div",23),w(41,ft,3,1,"div",24)}if(e&2){let t=b();g(6),O("ngModel",t.selectedSeasonId()),g(3),K(t.seasons()),g(7),O("checked",t.exportFormat()==="google-sheets"),g(4),O("checked",t.exportFormat()==="json"),g(3),O("disabled",!t.selectedSeasonId()||t.exporting()),g(),I(t.exporting()?24:t.exportFormat()==="json"?25:26),g(3),I(t.steps().length>0?27:-1),g(8),O("disabled",t.importing()),g(),I(t.importing()?36:37),g(2),I(t.spreadsheetUrl()?38:-1),g(),I(t.jsonExportComplete()?39:-1),g(),I(t.importComplete()?40:-1),g(),I(t.error()?41:-1)}}var We=class e{router=k(ge);userService=k(Ie);configService=k(be);seasonService=k(we);_steps=v([]);_selectedSeasonId=v(null);_exporting=v(!1);_spreadsheetUrl=v(null);_error=v(null);_loadingSeasons=v(!1);_exportFormat=v("google-sheets");_jsonExportComplete=v(!1);_importing=v(!1);_importComplete=v(!1);_importSummary=v("");steps=this._steps.asReadonly();selectedSeasonId=this._selectedSeasonId.asReadonly();exporting=this._exporting.asReadonly();spreadsheetUrl=this._spreadsheetUrl.asReadonly();error=this._error.asReadonly();loadingSeasons=this._loadingSeasons.asReadonly();exportFormat=this._exportFormat.asReadonly();jsonExportComplete=this._jsonExportComplete.asReadonly();importing=this._importing.asReadonly();importComplete=this._importComplete.asReadonly();importSummary=this._importSummary.asReadonly();seasons=this.seasonService.seasons;async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}this._loadingSeasons.set(!0);try{await this.seasonService.loadAllSeasons()}catch(n){this._error.set(n instanceof Error?n.message:"Failed to load seasons")}finally{this._loadingSeasons.set(!1)}}onSeasonChange(n){this._selectedSeasonId.set(n||null),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([]),this._jsonExportComplete.set(!1)}onFormatChange(n){this._exportFormat.set(n),this._spreadsheetUrl.set(null),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([])}async startExport(){return this._exportFormat()==="json"?this.startJsonExport():this.startGoogleSheetsExport()}async startJsonExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([{label:"Loading data from Firestore",status:"pending"},{label:"Generating JSON file",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=z(B()),r=await new j(t).loadAllData(n,u=>{this.updateStep(0,"in-progress",u.detail)});this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let s={exportedAt:new Date().toISOString(),year:2026,seasonId:n,season:r.season,orders:r.orders,users:Object.fromEntries(r.users),registration:r.registration,coupons:r.coupons,globalConfig:r.globalConfig},a=JSON.stringify(s,null,2),i=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(i),l=document.createElement("a");l.href=d,l.download=`${r.season.name.replace(/[^a-zA-Z0-9]/g,"-")}-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(d),this.updateStep(1,"completed"),this._jsonExportComplete.set(!0)}catch(t){let o=this._steps().findIndex(r=>r.status==="in-progress");o>=0&&this.updateStep(o,"error"),this._error.set(t instanceof Error?t.message:"Export failed")}finally{this._exporting.set(!1)}}}async startGoogleSheetsExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([{label:"Authenticating with Google",status:"pending"},{label:"Loading data from Firestore",status:"pending"},{label:"Building spreadsheet data",status:"pending"},{label:"Creating Google Spreadsheet",status:"pending"},{label:"Writing sheet data",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=new Y,o=await t.acquireAccessToken();this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let r=z(B()),a=await new j(r).loadAllData(n,y=>{this.updateStep(1,"in-progress",y.detail)});this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let i=Z({Orders:Te(a.orders,a.users,a.season),Payments:ke(a.orders,a.users),Coupons:Ue(a.coupons,a.orders),Waitlist:Fe(a.orders,a.users,a.season),Sessions:$e(a.season,a.orders,a.registration,a.users),Users:Le(a.users)},a.globalConfig?{SystemConfig:je(a.globalConfig)}:{});this.updateStep(2,"completed"),this.updateStep(3,"in-progress");let d=`${a.season.name} \u2014 Export ${new Date().toLocaleDateString()}`,l=Object.keys(i),u=await t.createSpreadsheet(d,l,o);this.updateStep(3,"completed"),this.updateStep(4,"in-progress");for(let[y,C]of Object.entries(i))this.updateStep(4,"in-progress",`Writing ${y}...`),await t.writeSheetData(u.spreadsheetId,y,C,o);this.updateStep(4,"completed"),this._spreadsheetUrl.set(u.spreadsheetUrl)}catch(t){let o=this._steps().findIndex(r=>r.status==="in-progress");o>=0&&this.updateStep(o,"error"),this._error.set(t instanceof Error?t.message:"Export failed")}finally{this._exporting.set(!1)}}}updateStep(n,t,o){this._steps.update(r=>r.map((s,a)=>a===n?se(Z({},s),{status:t,detail:o}):s))}async onFileSelected(n){let t=n.target,o=t.files?.[0];if(o){this._importing.set(!0),this._importComplete.set(!1),this._error.set(null),this._steps.set([{label:"Reading JSON file",status:"pending"},{label:"Validating data structure",status:"pending"},{label:"Importing to Firestore",status:"pending"}]);try{this.updateStep(0,"in-progress");let r=await o.text(),s=JSON.parse(r);if(this.updateStep(0,"completed"),this.updateStep(1,"in-progress"),!s.season||!s.orders)throw new Error("Invalid export file: missing season or orders data");this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let a=z(B()),i=s.year??this.configService.activeYear(),{doc:d,setDoc:l,writeBatch:u}=await import("./chunk-YCY4SPTN.js"),y=d(a,`years/${i}/seasons`,s.season.id);await l(y,s.season),this.updateStep(2,"in-progress","Season imported");let C=s.orders,h=500,P=0;for(let f=0;f<C.length;f+=h){let _=u(a),x=C.slice(f,f+h);for(let E of x){let S=d(a,`years/${i}/seasons/${s.season.id}/orders`,E.userAuthId);_.set(S,E)}await _.commit(),P+=x.length,this.updateStep(2,"in-progress",`Imported ${P}/${C.length} orders`)}if(s.users&&typeof s.users=="object"){let f=Object.entries(s.users);for(let _=0;_<f.length;_+=h){let x=u(a),E=f.slice(_,_+h);for(let[S,G]of E){let A=d(a,"users",S);x.set(A,G,{merge:!0})}await x.commit()}this.updateStep(2,"in-progress",`Imported ${f.length} users`)}if(s.registration){let f=d(a,`years/${i}/registrations`,s.season.id);await l(f,s.registration)}this.updateStep(2,"completed"),this._importComplete.set(!0),this._importSummary.set(`Imported season "${s.season.name}" with ${C.length} orders.`)}catch(r){let s=this._steps().findIndex(a=>a.status==="in-progress");s>=0&&this.updateStep(s,"error"),this._error.set(r instanceof Error?r.message:"Import failed")}finally{this._importing.set(!1),t.value=""}}}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=ie({type:e,selectors:[["app-admin-export"]],decls:10,vars:1,consts:[["fileInput",""],[1,"admin-export"],[1,"page-header"],["routerLink","/admin",1,"back-link"],[1,"subtitle"],[1,"loading-container"],[1,"spinner"],[1,"export-card"],[1,"form-group"],["for","season-select"],["id","season-select",1,"season-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"format-group"],[1,"format-options"],[1,"format-option"],["type","radio","name","format","value","google-sheets",3,"change","checked"],["type","radio","name","format","value","json",3,"change","checked"],[1,"btn-export",3,"click","disabled"],[1,"steps-card"],[1,"import-description"],["type","file","accept",".json",2,"display","none",3,"change"],[1,"btn-import",3,"click","disabled"],[1,"success-card"],[1,"error-card"],[1,"steps-list"],[1,"step",3,"step-pending","step-in-progress","step-completed","step-error"],[1,"step"],[1,"step-icon"],[1,"step-label"],[1,"step-detail"],[1,"success-icon"],["target","_blank","rel","noopener",1,"spreadsheet-link",3,"href"],[1,"error-message"]],template:function(t,o){t&1&&(p(0,"div",1)(1,"header",2)(2,"a",3),m(3,"\u2190 Back to Console"),c(),p(4,"h1"),m(5,"Data Export"),c(),p(6,"p",4),m(7,"Export and import season data"),c()(),w(8,et,4,0,"div",5)(9,St,42,12),c()),t&2&&(g(8),I(o.loadingSeasons()?8:9))},dependencies:[ue,Me,Ae,De,Oe,Ne,Pe,ye],styles:[".admin-export[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:1.5rem}.page-header[_ngcontent-%COMP%]{margin-bottom:2rem}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1.75rem;color:var(--sys-on-surface, #212121)}.page-header[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{margin:0;color:var(--sys-on-surface-variant, #666)}.back-link[_ngcontent-%COMP%]{display:inline-block;margin-bottom:1rem;color:var(--sys-primary, #c62828);text-decoration:none;font-size:.875rem}.back-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem 2rem}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.export-card[_ngcontent-%COMP%], .steps-card[_ngcontent-%COMP%], .success-card[_ngcontent-%COMP%], .error-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.export-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.season-select[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;font-size:1rem;background:#fff}.format-group[_ngcontent-%COMP%]{margin-bottom:1rem}.format-group[_ngcontent-%COMP%] > label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.format-options[_ngcontent-%COMP%]{display:flex;gap:1.5rem}.format-option[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;font-weight:400}.format-option[_ngcontent-%COMP%]   input[type=radio][_ngcontent-%COMP%]{cursor:pointer}.import-description[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.btn-import[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-tertiary, #1976d2);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-import[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-tertiary-dark, #1565c0)}.btn-import[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.btn-export[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-export[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-export[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.steps-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.steps-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.step[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.5rem 0}.step-icon[_ngcontent-%COMP%]{font-size:1rem;width:1.25rem;text-align:center}.step-pending[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #999)}.step-in-progress[_ngcontent-%COMP%]{color:var(--sys-tertiary, #1976d2);font-weight:500}.step-completed[_ngcontent-%COMP%]{color:var(--sys-secondary, #2e7d32)}.step-error[_ngcontent-%COMP%]{color:var(--sys-error, #c62828)}.step-detail[_ngcontent-%COMP%]{font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.success-card[_ngcontent-%COMP%]{text-align:center;border-color:var(--sys-secondary, #2e7d32)}.success-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--sys-secondary, #2e7d32);margin-bottom:.5rem}.success-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-secondary, #2e7d32)}.spreadsheet-link[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1.5rem;background:var(--sys-secondary, #2e7d32);color:#fff;border-radius:8px;text-decoration:none;font-weight:500}.spreadsheet-link[_ngcontent-%COMP%]:hover{opacity:.9}.error-card[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}.error-message[_ngcontent-%COMP%]{margin:0;color:var(--sys-error, #c62828);font-weight:500}"]})};export{We as AdminExportComponent};
