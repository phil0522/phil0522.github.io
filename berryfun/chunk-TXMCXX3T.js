import{a as m,b as y}from"./chunk-RDKP2ZJK.js";import{b as p}from"./chunk-YUXLOB7R.js";import{a as f}from"./chunk-6B5SPXH3.js";import{Ha as _,Ia as v,Ma as h}from"./chunk-B4PSB7QN.js";import{M as u,R as c,Vb as d,ha as a}from"./chunk-VKJSCVXY.js";var S=15,O=class g{datastore=c(m);rpc=c(y);configService=c(f);seasonService=c(p);_orders=a([]);_loading=a(!1);_error=a(null);_activeFilter=a("all");_cursor=a(null);_hasMore=a(!1);_loadingMore=a(!1);_actionLoading=a(!1);_actionError=a(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();orderCount=d(()=>this._orders().length);lockedCount=d(()=>this._orders().filter(e=>h(e)==="locked").length);submittedCount=d(()=>this._orders().filter(e=>h(e)==="submitted").length);overdueCount=d(()=>this._orders().filter(e=>this.isOverdue(e)).length);changeRequestCount=d(()=>this._orders().filter(e=>e.changeRequests&&e.changeRequests.some(r=>r.status==="pending")).length);paidCount=d(()=>this._orders().filter(e=>h(e)==="paid").length);filteredOrders=this._orders.asReadonly();setFilter(e){this._activeFilter.set(e),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(e){this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let r=this.configService.currentActiveYear(),t=e??this.getActiveSeasonId();if(!t){this._orders.set([]);return}let s=await this.queryOrders(r,t,S);this._orders.set(s.orders),this._cursor.set(s.lastDoc),this._hasMore.set(s.hasMore)}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loading.set(!1)}}async loadMore(e){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let r=this.configService.currentActiveYear(),t=e??this.getActiveSeasonId();if(!t)return;let s=this._cursor(),o=await this.queryOrders(r,t,S,s);this._orders.update(n=>[...n,...o.orders]),this._cursor.set(o.lastDoc),this._hasMore.set(o.hasMore)}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loadingMore.set(!1)}}}queryOrders(e,r,t,s){let o=this._activeFilter();switch(o){case"overdue":return this.datastore.listOverdueOrdersPaginated(e,r,this._cachedServerTime(),t,s);case"locked":case"submitted":case"paid":return this.datastore.listOrdersByStatusPaginated(e,r,o,t,s);case"all":return this.datastore.listOrdersPaginated(e,r,t,s)}}getActiveSeasonId(){return this.seasonService.selectedSeason()?.id??null}async loadAllOrders(e,r){this._loading.set(!0),this._error.set(null);try{let t=this.configService.currentActiveYear(),s=this.getActiveSeasonId();if(!s){this._orders.set([]);return}let o=await this.datastore.listSeasonOrders(t,s);e&&(o=o.filter(n=>h(n)===e)),o.sort((n,i)=>new Date(i.createdAt).getTime()-new Date(n.createdAt).getTime()),r&&r>0&&(o=o.slice(0,r)),this._orders.set(o)}catch(t){let s=t instanceof Error?t.message:String(t);throw this._error.set(s),t}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let e=this.configService.currentActiveYear(),r=this.getActiveSeasonId();if(!r){this._orders.set([]);return}let t=this.configService.currentTime(),s=await this.datastore.listOverdueOrders(e,r,t);this._orders.set(s),this._activeFilter.set("overdue")}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async recordPayment(e,r,t,s,o="zelle",n){this._actionLoading.set(!0),this._actionError.set(null);try{let i=this.getActiveSeasonId();if(!i)throw new Error("No season selected");await this.rpc.recordPayment({year:e,seasonId:i,userAuthId:r,amount:t,reference:s,method:o,notes:n}),await this.loadAllOrders()}catch(i){let l=i instanceof Error?i.message:String(i);throw this._actionError.set(l),i}finally{this._actionLoading.set(!1)}}async cancelOrder(e,r,t){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(e,r,t),await this.loadAllOrders()}catch(s){let o=s instanceof Error?s.message:String(s);throw this._actionError.set(o),s}finally{this._actionLoading.set(!1)}}isOverdue(e){return _(e,this._cachedServerTime())}getRemainingLockTime(e){return v(e,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}async getOrder(e,r=!1){if(!r){let t=this._orders().find(s=>s.userAuthId===e);if(t)return t}this._loading.set(!0),this._error.set(null);try{let t=this.configService.currentActiveYear(),s=this.getActiveSeasonId();if(!s)throw new Error("No season selected");let o=await this.datastore.getUserSeasonOrder(t,s,e);if(!o)throw new Error(`Order not found for user: ${e}`);if(r){let n=this._orders(),i=n.findIndex(l=>l.userAuthId===e);if(i>=0){let l=[...n];l[i]=o,this._orders.set(l)}}return o}catch(t){let s=t instanceof Error?t.message:String(t);throw this._error.set(s),t}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||g)};static \u0275prov=u({token:g,factory:g.\u0275fac,providedIn:"root"})};export{O as a};
