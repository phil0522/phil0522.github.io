import{a as D}from"./chunk-OTRDOZHQ.js";import{l as E,m as k}from"./chunk-K4JQJ6QW.js";import{Ba as S,C as U,Ia as W,W as d,Y as u,ba as p,da as h,ha as f,t as O,v as b}from"./chunk-HB4R6T7X.js";import{A as c,V as T}from"./chunk-GQT55FUQ.js";import{K as w}from"./chunk-2NRCXSDQ.js";import{I as q,N as R,c as I,da as C}from"./chunk-WXZFQYIJ.js";import{a as v,b as P}from"./chunk-Q7L6LLAK.js";var j=30,_=class m{db=new E(U(w()));firestore=U(w());seasonDatastore=R(D);userDatastore=R(k);async getUserSeasonOrder(e,t){let s=`years/${2026}/seasons/${e}/orders`,r=await this.db.getDocument(s,t);return r?c.parse(r):null}subscribeToOrder(e,t){return new I(s=>{let r=b(this.firestore,`years/${2026}/seasons/${e}/orders`,t),n=W(r,o=>{if(!o.exists()){s.next(null);return}try{let i=P(v({},o.data()),{id:o.id}),a=c.parse(i);s.next(a)}catch(i){s.error(i)}},o=>{s.error(o)});return()=>n()})}async listSeasonOrders(e){let s=`years/${2026}/seasons/${e}/orders`;return(await this.db.getDocuments(s)).map(n=>c.parse(n))}async listOrdersWithSubmittedItems(e){return(await this.listSeasonOrders(e)).filter(s=>s.items.some(r=>r.status==="submitted"))}async listOverdueOrders(e,t){let s=await this.listOrdersWithSubmittedItems(e),r=new Date(t);return s.filter(n=>n.lockExpiresAt?new Date(n.lockExpiresAt)<r:!1)}async listOrdersWithChangeRequests(e){return(await this.listSeasonOrders(e)).filter(s=>s.changeRequests&&s.changeRequests.some(r=>r.status==="pending"))}async listAllWaitlistEntries(e){let t=await this.listSeasonOrders(e),s=await this.seasonDatastore.listAllSeasons(),r=new Map;for(let a of s)for(let l of a.sessions??[])r.set(l.id,l.name);let n=await this.userDatastore.listAllUsers(),o=new Map;for(let a of n)o.set(a.uid,a.displayName);let i=[];for(let a of t)if(!(!a.waitlist||a.waitlist.length===0))for(let l of a.waitlist)i.push({userId:a.userAuthId,userName:o.get(a.userAuthId)??"Unknown User",sessionId:l.sessionId,className:r.get(l.sessionId)??"Unknown Class",joinedAt:l.joinedAt??""});return i.sort((a,l)=>a.joinedAt.localeCompare(l.joinedAt)),i}async listWaitlistByClass(e,t){return(await this.listAllWaitlistEntries(e)).filter(r=>r.sessionId===t)}async listOrdersPaginated(e,t,s){let r=O(this.firestore,`years/${2026}/seasons/${e}/orders`),n=s?d(r,p("updatedAt","desc"),f(s),h(t)):d(r,p("updatedAt","desc"),h(t)),o=await S(n),i=o.docs.map(y=>c.parse(y.data())),a=o.size>=t,l=a?o.docs[o.docs.length-1]:null;return{orders:i,lastDoc:l,hasMore:a}}async listOverdueOrdersPaginated(e,t,s,r){let n=O(this.firestore,`years/${2026}/seasons/${e}/orders`),o=r?d(n,u("orderStatus","==","submitted"),u("lockExpiresAt","<",t),p("lockExpiresAt","desc"),f(r),h(s)):d(n,u("orderStatus","==","submitted"),u("lockExpiresAt","<",t),p("lockExpiresAt","desc"),h(s)),i=await S(o),a=i.docs.map(A=>c.parse(A.data())),l=i.size>=s,y=l?i.docs[i.docs.length-1]:null;return{orders:a,lastDoc:y,hasMore:l}}async listOrdersByStatusPaginated(e,t,s,r){let n=O(this.firestore,`years/${2026}/seasons/${e}/orders`),o=r?d(n,u("orderStatus","==",t),p("updatedAt","desc"),f(r),h(s)):d(n,u("orderStatus","==",t),p("updatedAt","desc"),h(s)),i=await S(o),a=i.docs.map(A=>c.parse(A.data())),l=i.size>=s,y=l?i.docs[i.docs.length-1]:null;return{orders:a,lastDoc:y,hasMore:l}}async listOrdersByUserIds(e,t){if(t.length===0)return[];let s=O(this.firestore,`years/${2026}/seasons/${e}/orders`),r=[];for(let n=0;n<t.length;n+=j){let o=t.slice(n,n+j),i=d(s,u("userAuthId","in",o)),a=await S(i);for(let l of a.docs)r.push(c.parse(l.data()))}return r}async listOrdersBySessionId(e,t){return(await this.listSeasonOrders(e)).filter(r=>r.items.some(n=>n.sessionId===t))}static \u0275fac=function(t){return new(t||m)};static \u0275prov=q({token:m,factory:m.\u0275fac,providedIn:"root"})};var $=class m{functions=R(T);_loading=C(!1);_error=C(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async lockSessions(e){return this.wrapApiCall("lockSessions",e)}async recordPayment(e){return this.wrapApiCall("recordOrderPayment",e)}async placeOrder(e){return this.wrapApiCall("placeOrder",e)}async cancelItems(e){return this.wrapApiCall("cancelOrderItems",e)}async joinWaitlist(e){return this.wrapApiCall("joinWaitlist",e)}async leaveWaitlist(e){return this.wrapApiCall("leaveWaitlist",e)}async removeWaitlistEntry(e){return this.wrapApiCall("removeWaitlistEntry",e)}async removeSubmittedItems(e){return this.wrapApiCall("removeSubmittedItems",e)}async applySubmittedChanges(e){return this.wrapApiCall("applySubmittedChanges",e)}async requestOrderChange(e){return this.wrapApiCall("requestChange",e)}async updateChangeRequest(e){return this.wrapApiCall("updateChangeRequest",e)}async approveChangeRequest(e){return this.wrapApiCall("approveChange",e)}async denyChangeRequest(e){return this.wrapApiCall("denyChange",e)}async addAdjustment(e){return this.wrapApiCall("addAdjustment",e)}async listAllOrders(e,t){return this.wrapCall("listAllOrders",{status:e,limit:t})}async listOverdueOrders(){return this.wrapCall("listOverdueOrders",void 0)}async listChangeRequests(){return this.wrapCall("listChangeRequests",void 0)}async adminCancelOrder(e,t,s){await this.wrapApiCall("cancelOrder",{userAuthId:e,itemsToCancel:t,reason:s})}async getOrder(e){return this.wrapCall("getOrder",{userAuthId:e})}async listAllWaitlistEntries(){return this.wrapCall("listAllWaitlistEntries",{})}async listWaitlistByClass(e){return this.wrapCall("listWaitlistByClass",{sessionId:e})}clearError(){this._error.set(null)}async wrapCall(e,t){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,t)}catch(s){let r=s instanceof Error?s.message:String(s);throw this._error.set(r),s}finally{this._loading.set(!1)}}async wrapApiCall(e,t){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,t)}catch(s){let r=s instanceof Error?s.message:String(s);throw this._error.set(r),s}finally{this._loading.set(!1)}}static \u0275fac=function(t){return new(t||m)};static \u0275prov=q({token:m,factory:m.\u0275fac,providedIn:"root"})};export{_ as a,$ as b};
