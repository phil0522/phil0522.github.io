import{u as g,v as h,w as m,y as o,z as _}from"./chunk-6E4VX3TQ.js";import{Y as f}from"./chunk-NA25QKA5.js";import{L as u,Q as c,Qb as n,ga as i}from"./chunk-C26OXKSD.js";var v=class l{functionsClient=c(f);configService=c(_);_orders=i([]);_loading=i(!1);_error=i(null);_activeFilter=i("all");_actionLoading=i(!1);_actionError=i(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();orderCount=n(()=>this._orders().length);pendingCount=n(()=>this._orders().filter(e=>o(e)==="submitted").length);overdueCount=n(()=>this._orders().filter(e=>this.isOverdue(e)).length);changeRequestCount=n(()=>this._orders().filter(e=>e.changeRequests&&e.changeRequests.some(t=>t.status==="pending")).length);paidCount=n(()=>this._orders().filter(e=>o(e)==="paid").length);cancelledCount=n(()=>this._orders().filter(e=>{let t=o(e);return t==="cancelled"||t==="refunded"}).length);filteredOrders=n(()=>{let e=this._orders();switch(this._activeFilter()){case"pending":return e.filter(r=>o(r)==="submitted");case"overdue":return e.filter(r=>this.isOverdue(r));case"change_requested":return e.filter(r=>r.changeRequests&&r.changeRequests.some(s=>s.status==="pending"));case"paid":return e.filter(r=>o(r)==="paid");case"cancelled":return e.filter(r=>{let s=o(r);return s==="cancelled"||s==="refunded"});default:return e}});setFilter(e){this._activeFilter.set(e)}async loadAllOrders(e,t){this._loading.set(!0),this._error.set(null);try{let r=await this.functionsClient.call("listAllOrders",{status:e,limit:t});r.sort((s,a)=>new Date(a.createdAt).getTime()-new Date(s.createdAt).getTime()),this._orders.set(r)}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let e=await this.functionsClient.call("listOverdueOrders",void 0);this._orders.set(e),this._activeFilter.set("overdue")}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async loadChangeRequests(){this._loading.set(!0),this._error.set(null);try{let e=await this.functionsClient.call("listChangeRequests",void 0);this._orders.set(e),this._activeFilter.set("change_requested")}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async confirmPayment(e,t,r,s,a="zelle"){this._actionLoading.set(!0),this._actionError.set(null);try{await this.functionsClient.call("confirmPayment",{year:e,userAuthId:t,amount:r,reference:s,method:a}),await this.loadAllOrders()}catch(d){let y=d instanceof Error?d.message:String(d);throw this._actionError.set(y),d}finally{this._actionLoading.set(!1)}}async cancelOrder(e,t,r){this._actionLoading.set(!0),this._actionError.set(null);try{await this.functionsClient.call("cancelOrder",{userAuthId:e,itemsToCancel:t,reason:r}),await this.loadAllOrders()}catch(s){let a=s instanceof Error?s.message:String(s);throw this._actionError.set(a),s}finally{this._actionLoading.set(!1)}}isOverdue(e){return g(e,this._cachedServerTime())}isLockExpiringSoon(e){return h(e,this._cachedServerTime(),12)}getRemainingLockTime(e){return m(e,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all")}async getOrder(e){let t=this._orders().find(r=>r.userAuthId===e);if(t)return t;this._loading.set(!0),this._error.set(null);try{return await this.functionsClient.call("getOrder",{userAuthId:e})}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}static \u0275fac=function(t){return new(t||l)};static \u0275prov=u({token:l,factory:l.\u0275fac,providedIn:"root"})};export{v as a};
