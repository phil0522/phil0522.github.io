import{a as m,b as v}from"./chunk-MPFEXNQ6.js";import{b as f}from"./chunk-JMHFOYHT.js";import{a as y}from"./chunk-EPAU2WC6.js";import{M as u,N as _,R as c}from"./chunk-RLRP2YP4.js";import{I as g,N as l,Rb as n,da as a}from"./chunk-WXZFQYIJ.js";var p=15,O=class h{datastore=l(m);rpc=l(v);configService=l(y);seasonService=l(f);_orders=a([]);_loading=a(!1);_error=a(null);_activeFilter=a("all");_cursor=a(null);_hasMore=a(!1);_loadingMore=a(!1);_actionLoading=a(!1);_actionError=a(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();orderCount=n(()=>this._orders().length);lockedCount=n(()=>this._orders().filter(e=>c(e)==="locked").length);submittedCount=n(()=>this._orders().filter(e=>c(e)==="submitted").length);overdueCount=n(()=>this._orders().filter(e=>this.isOverdue(e)).length);changeRequestCount=n(()=>this._orders().filter(e=>e.changeRequests&&e.changeRequests.some(r=>r.status==="pending")).length);paidCount=n(()=>this._orders().filter(e=>c(e)==="paid").length);filteredOrders=this._orders.asReadonly();setFilter(e){this._activeFilter.set(e),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(e){this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let r=e??this.getActiveSeasonId();if(!r){this._orders.set([]);return}let t=await this.queryOrders(r,p);this._orders.set(t.orders),this._cursor.set(t.lastDoc),this._hasMore.set(t.hasMore)}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loading.set(!1)}}async loadMore(e){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let r=e??this.getActiveSeasonId();if(!r)return;let t=this._cursor(),s=await this.queryOrders(r,p,t);this._orders.update(o=>[...o,...s.orders]),this._cursor.set(s.lastDoc),this._hasMore.set(s.hasMore)}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loadingMore.set(!1)}}}queryOrders(e,r,t){let s=this._activeFilter();switch(s){case"overdue":return this.datastore.listOverdueOrdersPaginated(e,this._cachedServerTime(),r,t);case"locked":case"submitted":case"paid":return this.datastore.listOrdersByStatusPaginated(e,s,r,t);case"all":return this.datastore.listOrdersPaginated(e,r,t)}}getActiveSeasonId(){return this.seasonService.selectedSeason()?.id??null}async loadAllOrders(e,r){this._loading.set(!0),this._error.set(null);try{let t=this.getActiveSeasonId();if(!t){this._orders.set([]);return}let s=await this.datastore.listSeasonOrders(t);e&&(s=s.filter(o=>c(o)===e)),s.sort((o,i)=>new Date(i.createdAt).getTime()-new Date(o.createdAt).getTime()),r&&r>0&&(s=s.slice(0,r)),this._orders.set(s)}catch(t){let s=t instanceof Error?t.message:String(t);throw this._error.set(s),t}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let e=this.getActiveSeasonId();if(!e){this._orders.set([]);return}let r=this.configService.currentTime(),t=await this.datastore.listOverdueOrders(e,r);this._orders.set(t),this._activeFilter.set("overdue")}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async recordPayment(e,r,t,s="zelle",o){this._actionLoading.set(!0),this._actionError.set(null);try{let i=this.getActiveSeasonId();if(!i)throw new Error("No season selected");await this.rpc.recordPayment({year:2026,seasonId:i,userAuthId:e,amount:r,reference:t,method:s,notes:o}),await this.loadAllOrders()}catch(i){let d=i instanceof Error?i.message:String(i);throw this._actionError.set(d),i}finally{this._actionLoading.set(!1)}}async cancelOrder(e,r,t){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(e,r,t),await this.loadAllOrders()}catch(s){let o=s instanceof Error?s.message:String(s);throw this._actionError.set(o),s}finally{this._actionLoading.set(!1)}}isOverdue(e){return u(e,this._cachedServerTime())}getRemainingLockTime(e){return _(e,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}async getOrder(e,r=!1){if(!r){let t=this._orders().find(s=>s.userAuthId===e);if(t)return t}this._loading.set(!0),this._error.set(null);try{let t=this.getActiveSeasonId();if(!t)throw new Error("No season selected");let s=await this.datastore.getUserSeasonOrder(t,e);if(!s)throw new Error(`Order not found for user: ${e}`);if(r){let o=this._orders(),i=o.findIndex(d=>d.userAuthId===e);if(i>=0){let d=[...o];d[i]=s,this._orders.set(d)}}return s}catch(t){let s=t instanceof Error?t.message:String(t);throw this._error.set(s),t}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||h)};static \u0275prov=g({token:h,factory:h.\u0275fac,providedIn:"root"})};export{O as a};
