import{L as g,M as _,Q as l,U as m,X as f,Y as v,Z as S}from"./chunk-UHLAHZJO.js";import{I as u,N as d,da as n}from"./chunk-DU5POHF6.js";var h=15,O=class c{datastore=d(m);rpc=d(f);configService=d(v);seasonService=d(S);subscription=null;orderSubscription=null;_orders=n([]);_loading=n(!1);_error=n(null);_activeFilter=n("all");_selectedSeasonIds=n([]);_cursor=n(null);_hasMore=n(!1);_loadingMore=n(!1);_actionLoading=n(!1);_actionError=n(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();selectedSeasonIds=this._selectedSeasonIds.asReadonly();filteredOrders=this._orders.asReadonly();setSelectedSeasons(s){console.log("[AdminOrdersStore] setSelectedSeasons:",s.length===0?"all":s),this._selectedSeasonIds.set(s)}toggleSeasonSelection(s){let e=this._selectedSeasonIds();e.includes(s)?this._selectedSeasonIds.set(e.filter(r=>r!==s)):this._selectedSeasonIds.set([...e,s]),console.log("[AdminOrdersStore] toggleSeasonSelection:",this._selectedSeasonIds())}setFilter(s){this._activeFilter.set(s),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(s){console.log("[AdminOrdersStore] loadPage called, seasonId param:",s),this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let e=s??this.getActiveSeasonId();if(console.log("[AdminOrdersStore] loadPage: resolved seasonId =",e),!e){console.warn("[AdminOrdersStore] loadPage: no seasonId, setting empty orders"),this._orders.set([]);return}let r=await this.queryOrders(e,h);console.log("[AdminOrdersStore] loadPage: fetched",r.orders.length,"orders, hasMore:",r.hasMore),this._orders.set(r.orders),this._cursor.set(r.lastDoc),this._hasMore.set(r.hasMore)}catch(e){console.error("[AdminOrdersStore] loadPage error:",e);let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async loadMore(s){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let e=s??this.getActiveSeasonId();if(!e)return;let r=this._cursor(),t=await this.queryOrders(e,h,r);this._orders.update(o=>[...o,...t.orders]),this._cursor.set(t.lastDoc),this._hasMore.set(t.hasMore)}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loadingMore.set(!1)}}}queryOrders(s,e,r){let t=this._activeFilter();switch(t){case"overdue":return this.datastore.listOverdueOrdersPaginated(s,this._cachedServerTime(),e,r);case"locked":case"submitted":case"paid":return this.datastore.listOrdersByStatusPaginated(s,t,e,r);case"all":return this.datastore.listOrdersPaginated(s,e,r)}}getActiveSeasonId(){let e=this.seasonService.selectedSeason()?.id??null;return console.log("[AdminOrdersStore] getActiveSeasonId:",e),e}async loadAllOrders(s,e){console.log("[AdminOrdersStore] loadAllOrders called, status:",s,"limit:",e),this._loading.set(!0),this._error.set(null);try{let r=this._selectedSeasonIds(),t=r.length>0?r:void 0;console.log("[AdminOrdersStore] loadAllOrders: seasonFilter =",t??"all seasons");let o=await this.datastore.listAllSeasonOrders(t);console.log("[AdminOrdersStore] loadAllOrders: fetched",o.length,"orders from datastore"),s&&(o=o.filter(a=>l(a)===s)),o.sort((a,i)=>new Date(i.createdAt).getTime()-new Date(a.createdAt).getTime()),e&&e>0&&(o=o.slice(0,e)),this._orders.set(o)}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let s=this.getActiveSeasonId();if(!s){this._orders.set([]);return}let e=this.configService.currentTime(),r=await this.datastore.listOverdueOrders(s,e);this._orders.set(r),this._activeFilter.set("overdue")}catch(s){let e=s instanceof Error?s.message:String(s);throw this._error.set(e),s}finally{this._loading.set(!1)}}async recordPayment(s,e,r,t="zelle",o,a=!1){this._actionLoading.set(!0),this._actionError.set(null);try{let i=this.getActiveSeasonId();if(!i)throw new Error("No season selected");await this.rpc.recordPayment({year:2026,seasonId:i,userAuthId:s,amount:e,reference:r??null,method:t,notes:o??null,isDepositConfirmation:a,itemKeys:null}),await this.loadAllOrders()}catch(i){let b=i instanceof Error?i.message:String(i);throw this._actionError.set(b),i}finally{this._actionLoading.set(!1)}}async cancelOrder(s,e,r){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(s,e,r),await this.loadAllOrders()}catch(t){let o=t instanceof Error?t.message:String(t);throw this._actionError.set(o),t}finally{this._actionLoading.set(!1)}}isOverdue(s){return g(s,this._cachedServerTime())}getRemainingLockTime(s){return _(s,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this.unsubscribe(),this.unsubscribeOrder(),this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}subscribeToOrders(s){console.log("[AdminOrdersStore] subscribeToOrders called, seasonId param:",s),this.unsubscribe();let e=s??this.getActiveSeasonId();if(console.log("[AdminOrdersStore] subscribeToOrders: resolved seasonId =",e),!e){console.warn("[AdminOrdersStore] subscribeToOrders: no seasonId, setting empty orders"),this._orders.set([]);return}this._loading.set(!0),this._error.set(null),console.log("[AdminOrdersStore] subscribeToOrders: creating subscription for season",e),this.subscription=this.datastore.subscribeToSeasonOrders(e,h).subscribe({next:r=>{console.log("[AdminOrdersStore] subscribeToOrders: received",r.length,"orders");let t=this.filterOrders(r);console.log("[AdminOrdersStore] subscribeToOrders: after filter:",t.length,"orders (filter:",this._activeFilter(),")"),this._orders.set(t),this._loading.set(!1)},error:r=>{console.error("[AdminOrdersStore] subscribeToOrders error:",r);let t=r instanceof Error?r.message:String(r);this._error.set(t),this._loading.set(!1)}})}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}subscribeToOrder(s,e,r){this.unsubscribeOrder();let t=this.getActiveSeasonId();return t?(this.orderSubscription=this.datastore.subscribeToOrder(t,s).subscribe({next:e,error:r}),()=>this.unsubscribeOrder()):(r(new Error("No season selected")),()=>{})}unsubscribeOrder(){this.orderSubscription&&(this.orderSubscription.unsubscribe(),this.orderSubscription=null)}filterOrders(s){let e=this._activeFilter(),r=this._cachedServerTime();switch(e){case"overdue":return s.filter(t=>l(t)!=="submitted"||!t.lockExpiresAt?!1:new Date(t.lockExpiresAt)<new Date(r));case"locked":case"submitted":case"paid":return s.filter(t=>l(t)===e);case"all":default:return s}}async getOrder(s,e=!1){if(!e){let r=this._orders().find(t=>t.userAuthId===s);if(r)return r}this._loading.set(!0),this._error.set(null);try{let r=this.getActiveSeasonId();if(!r)throw new Error("No season selected");let t=await this.datastore.getUserSeasonOrder(r,s);if(!t)throw new Error(`Order not found for user: ${s}`);if(e){let o=this._orders(),a=o.findIndex(i=>i.userAuthId===s);if(a>=0){let i=[...o];i[a]=t,this._orders.set(i)}}return t}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loading.set(!1)}}static \u0275fac=function(e){return new(e||c)};static \u0275prov=u({token:c,factory:c.\u0275fac,providedIn:"root"})};export{O as a};
