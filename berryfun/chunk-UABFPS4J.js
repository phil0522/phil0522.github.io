import{a as U,b as T}from"./chunk-U2XZRBUO.js";import{a as A}from"./chunk-2JJ6EU5R.js";import{a as W}from"./chunk-EPAUVA6W.js";import{a as q}from"./chunk-6IBDFWE3.js";import{la as _,ma as N,oa as R,pa as O,qa as C,ra as j,sa as k,ta as P}from"./chunk-MC2IQD7Q.js";import{G as S,H as w,J as p,M as E,R as a,Rb as n,V as M,_ as g,a as m,aa as c,b,g as v,ha as d,ia as x,j as D,ja as h,n as I}from"./chunk-EVJ2WVWM.js";function B(i){switch(i){case"submitted":return"Pending Payment";case"paid":return"Paid";case"cancelled":return"Cancelled";case"change_requested":return"Change Requested";case"refunded":return"Refunded";case"partial":return"Partially Paid";case"empty":return"Empty";default:return i}}function H(i){switch(i){case"submitted":return"Pending";case"paid":return"Paid";case"cancelled":return"Cancelled";case"refunded":return"Refunded";default:return i}}function J(i){return`$${(i/100).toFixed(2)}`}function V(i){return new Date(i).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}function G(i,e){let t=new Date(i),r=new Date(e),o=t.toLocaleDateString("en-US",{month:"short",day:"numeric"}),s=r.toLocaleDateString("en-US",{month:"short",day:"numeric"});return`${o} - ${s}`}var $=23;function F(i,e,t=$){if(i.isPromoted)return{isEligible:!0,hoursUntilEligible:null,reason:"promoted"};let r=new Date(i.joinedAt),s=(new Date(e).getTime()-r.getTime())/(1e3*60*60);return s>=t?{isEligible:!0,hoursUntilEligible:null,reason:"mature"}:{isEligible:!1,hoursUntilEligible:Math.ceil(t-s),reason:"not_mature"}}function y(i){i||(i=a(c));let e=new v(t=>{if(i.destroyed){t.next();return}return i.onDestroy(t.next.bind(t))});return t=>t.pipe(w(e))}function L(i,e){let t=e?.injector??a(g),r=new D(1),o=x(()=>{let s;try{s=i()}catch(u){h(()=>r.error(u));return}h(()=>r.next(s))},{injector:t,manualCleanup:!0});return t.get(c).onDestroy(()=>{o.destroy(),r.complete()}),r.asObservable()}function ae(i,e){let r=!e?.manualCleanup?e?.injector?.get(c)??a(c):null,o=z(e?.equal),s;e?.requireSync?s=d({kind:0},{equal:o}):s=d({kind:1,value:e?.initialValue},{equal:o});let u,f=i.subscribe({next:l=>s.set({kind:1,value:l}),error:l=>{s.set({kind:2,error:l}),u?.()},complete:()=>{u?.()}});if(e?.requireSync&&s().kind===0)throw new p(601,!1);return u=r?.onDestroy(f.unsubscribe.bind(f)),n(()=>{let l=s();switch(l.kind){case 1:return l.value;case 2:throw l.error;case 0:throw new p(601,!1)}},{equal:e?.equal})}function z(i=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&i(e.value,t.value)}var Y=class i{datastore=a(U);rpc=a(T);seasonDatastore=a(W);seasonService=a(A);configService=a(q);destroyRef=a(c);injector=a(g);_order=d(null);_registration=d(null);_loading=d(!1);_error=d(null);_currentTime=n(()=>this.configService.currentTime());currentSeasonId=n(()=>this.seasonService.selectedSeason()?.id??null);orderSubscription=null;registrationSubscription=null;currentYear=null;currentUserAuthId=null;order=this._order.asReadonly();registration=this._registration.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();items=n(()=>this._order()?.items??[]);submittedItems=n(()=>{let e=this._order();return e?R(e):[]});paidItems=n(()=>{let e=this._order();return e?O(e):[]});cancelledItems=n(()=>this.items().filter(e=>e.status==="cancelled"));submittedCount=n(()=>this.submittedItems().length);paidCount=n(()=>this.paidItems().length);hasSubmittedItems=n(()=>this.submittedItems().length>0);hasPaidItems=n(()=>this.paidItems().length>0);waitlistEntries=n(()=>this._order()?.waitlist??[]);waitlistEntriesWithEligibility=n(()=>{let e=this.waitlistEntries(),t=this._registration(),r=this._currentTime();return e.map(o=>{let s=F(o,r),u=t?_(t,o.sessionId):0;return b(m({},o),{eligibility:s,isClaimable:s.isEligible&&u>0,claimableSpots:u})})});eligibleWaitlistEntries=n(()=>this.waitlistEntriesWithEligibility().filter(e=>e.eligibility.isEligible));claimableWaitlistEntries=n(()=>this.waitlistEntriesWithEligibility().filter(e=>e.isClaimable));waitlistCount=n(()=>this.waitlistEntries().length);claimableCount=n(()=>this.claimableWaitlistEntries().length);pricing=n(()=>this._order()?.pricing??null);totalDue=n(()=>{let e=this.pricing();return e?N(e):0});totalDiscountAmount=n(()=>{let e=this.pricing();return e?e.discounts.reduce((t,r)=>t+r.amount,0):0});totalPaid=n(()=>this._order()?.totalPaid??0);totalRefunded=n(()=>{let e=this._order();return e?(e.refunds??[]).reduce((t,r)=>t+r.amount,0):0});amountDue=n(()=>{let e=this._order();return e?k(e):0});payments=n(()=>this._order()?.payments??[]);isFullyPaid=n(()=>this.amountDue()<=0&&this.totalPaid()>0);lockExpiresAt=n(()=>this._order()?.lockExpiresAt??null);isOverdue=n(()=>{let e=this._order();return e?P(e,this._currentTime()):!1});hoursUntilLockExpires=n(()=>{let e=this.lockExpiresAt();if(!e)return null;let t=new Date(this._currentTime()),o=(new Date(e).getTime()-t.getTime())/(1e3*60*60);return o>0?Math.ceil(o):null});initialize(e,t){this.cleanup(),this.currentYear=e,this.currentUserAuthId=t,this._loading.set(!0),this._error.set(null),this.orderSubscription=this.datastore.subscribeToOrder(e,t).pipe(y(this.destroyRef)).subscribe({next:r=>{this._order.set(r),this._loading.set(!1)},error:r=>{this._error.set(r.message),this._loading.set(!1)}}),M(this.injector,()=>{this.registrationSubscription=L(this.seasonService.selectedSeason).pipe(y(this.destroyRef),S(r=>r?this.seasonDatastore.subscribeToRegistration(e,r.id):I(null))).subscribe({next:r=>{this._registration.set(r)},error:r=>{console.error("Failed to load registration:",r)}})})}cleanup(){this.orderSubscription?.unsubscribe(),this.orderSubscription=null,this.registrationSubscription?.unsubscribe(),this.registrationSubscription=null,this._order.set(null),this._registration.set(null),this.currentYear=null,this.currentUserAuthId=null}hasActiveEnrollment(e,t){let r=this._order();return r?C(r,e,t):!1}isOnWaitlist(e){let t=this._order();return t?j(t,e):!1}getWaitlistEntry(e){return this.waitlistEntries().find(t=>t.sessionId===e)??null}getEnrolledSessionIds(e){return this.items().filter(t=>t.studentId===e&&(t.status==="submitted"||t.status==="paid")).map(t=>t.sessionId)}getOrderItem(e,t){return this.items().find(r=>r.sessionId===e&&r.studentId===t)??null}async recordPayment(e,t,r,o){if(!this.currentYear||!this.currentUserAuthId)throw new Error("Order not initialized");let s={year:this.currentYear,userAuthId:this.currentUserAuthId,amount:e,reference:t,method:r,notes:o};await this.rpc.recordPayment(s)}async cancelItems(e,t){if(!this.currentYear)throw new Error("Order not initialized");let r={year:this.currentYear,items:e,reason:t};await this.rpc.cancelItems(r)}async joinWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.joinWaitlist({seasonId:t,sessionId:e})}async leaveWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.leaveWaitlist({seasonId:t,sessionId:e})}clearError(){this._error.set(null)}static \u0275fac=function(t){return new(t||i)};static \u0275prov=E({token:i,factory:i.\u0275fac,providedIn:"root"})};export{y as a,ae as b,B as c,H as d,J as e,V as f,G as g,Y as h};
