import{a as q,b as T}from"./chunk-RDKP2ZJK.js";import{a as P,b as A}from"./chunk-YUXLOB7R.js";import{a as U}from"./chunk-6B5SPXH3.js";import{Aa as R,Ba as E,Ca as j,Ka as C,ua as _,wa as N,xa as k,ya as x,za as O}from"./chunk-B4PSB7QN.js";import{G as I,H as D,J as m,M as S,R as i,V as w,Vb as r,_ as g,aa as l,g as v,ha as d,ia as M,j as y,ja as p,n as f}from"./chunk-VKJSCVXY.js";function h(o){o||(o=i(l));let e=new v(t=>{if(o.destroyed){t.next();return}return o.onDestroy(t.next.bind(t))});return t=>t.pipe(D(e))}function W(o,e){let t=e?.injector??i(g),n=new y(1),s=M(()=>{let a;try{a=o()}catch(c){p(()=>n.error(c));return}p(()=>n.next(a))},{injector:t,manualCleanup:!0});return t.get(l).onDestroy(()=>{s.destroy(),n.complete()}),n.asObservable()}function ee(o,e){let n=!e?.manualCleanup?e?.injector?.get(l)??i(l):null,s=L(e?.equal),a;e?.requireSync?a=d({kind:0},{equal:s}):a=d({kind:1,value:e?.initialValue},{equal:s});let c,b=o.subscribe({next:u=>a.set({kind:1,value:u}),error:u=>{a.set({kind:2,error:u}),c?.()},complete:()=>{c?.()}});if(e?.requireSync&&a().kind===0)throw new m(601,!1);return c=n?.onDestroy(b.unsubscribe.bind(b)),r(()=>{let u=a();switch(u.kind){case 1:return u.value;case 2:throw u.error;case 0:throw new m(601,!1)}},{equal:e?.equal})}function L(o=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&o(e.value,t.value)}var F=class o{datastore=i(q);rpc=i(T);seasonDatastore=i(P);seasonService=i(A);configService=i(U);destroyRef=i(l);injector=i(g);_order=d(null);_registration=d(null);_loading=d(!1);_error=d(null);_currentTime=r(()=>this.configService.currentTime());currentSeasonId=r(()=>this.seasonService.selectedSeason()?.id??null);orderSubscription=null;registrationSubscription=null;currentYear=null;_currentSeasonId=null;currentUserAuthId=null;order=this._order.asReadonly();registration=this._registration.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();items=r(()=>this._order()?.items??[]);submittedItems=r(()=>{let e=this._order();return e?N(e):[]});paidItems=r(()=>{let e=this._order();return e?k(e):[]});lockedItems=r(()=>this.items().filter(e=>e.status==="locked"));lockedCount=r(()=>this.lockedItems().length);submittedCount=r(()=>this.submittedItems().length);paidCount=r(()=>this.paidItems().length);hasLockedItems=r(()=>this.lockedItems().length>0);hasSubmittedItems=r(()=>this.submittedItems().length>0);hasPaidItems=r(()=>this.paidItems().length>0);waitlistEntries=r(()=>this._order()?.waitlist??[]);waitlistCount=r(()=>this.waitlistEntries().length);pricing=r(()=>this._order()?.pricing??null);totalDue=r(()=>{let e=this.pricing();return e?_(e):0});totalDiscountAmount=r(()=>{let e=this.pricing();return e?j(e.discounts):0});totalPaid=r(()=>this._order()?.totalPaid??0);totalRefunded=r(()=>{let e=this._order();return e?C(e):0});amountDue=r(()=>{let e=this._order();return e?R(e):0});paymentScreenshots=r(()=>this._order()?.paymentScreenshots??[]);payments=r(()=>this._order()?.payments??[]);isFullyPaid=r(()=>this.amountDue()<=0&&this.totalPaid()>0);lockExpiresAt=r(()=>this._order()?.lockExpiresAt??null);isOverdue=r(()=>{let e=this._order();return e?E(e,this._currentTime()):!1});hoursUntilLockExpires=r(()=>{let e=this.lockExpiresAt();if(!e)return null;let t=new Date(this._currentTime()),s=(new Date(e).getTime()-t.getTime())/(1e3*60*60);return s>0?Math.ceil(s):null});initialize(e,t,n){this.cleanup(),this.currentYear=e,this._currentSeasonId=t,this.currentUserAuthId=n,this._loading.set(!0),this._error.set(null),this.orderSubscription=this.datastore.subscribeToOrder(e,t,n).pipe(h(this.destroyRef)).subscribe({next:s=>{this._order.set(s),this._loading.set(!1)},error:s=>{this._error.set(s.message),this._loading.set(!1)}}),w(this.injector,()=>{this.registrationSubscription=W(this.seasonService.selectedSeason).pipe(h(this.destroyRef),I(s=>s?this.seasonDatastore.subscribeToRegistration(e,s.id):f(null))).subscribe({next:s=>{this._registration.set(s)},error:s=>{console.error("Failed to load registration:",s)}})})}cleanup(){this.orderSubscription?.unsubscribe(),this.orderSubscription=null,this.registrationSubscription?.unsubscribe(),this.registrationSubscription=null,this._order.set(null),this._registration.set(null),this.currentYear=null,this._currentSeasonId=null,this.currentUserAuthId=null}hasActiveEnrollment(e,t){let n=this._order();return n?x(n,e,t):!1}isOnWaitlist(e){let t=this._order();return t?O(t,e):!1}getWaitlistEntry(e){return this.waitlistEntries().find(t=>t.sessionId===e)??null}getEnrolledSessionIds(e){return this.items().filter(t=>t.studentId===e&&(t.status==="locked"||t.status==="submitted"||t.status==="paid")).map(t=>t.sessionId)}getOrderItem(e,t){return this.items().find(n=>n.sessionId===e&&n.studentId===t)??null}async recordPayment(e,t,n,s){if(!this.currentYear||!this._currentSeasonId||!this.currentUserAuthId)throw new Error("Order not initialized");let a={year:this.currentYear,seasonId:this._currentSeasonId,userAuthId:this.currentUserAuthId,amount:e,reference:t,method:n,notes:s||null};await this.rpc.recordPayment(a)}async cancelItems(e,t){if(!this.currentYear||!this._currentSeasonId)throw new Error("Order not initialized");let n={year:this.currentYear,seasonId:this._currentSeasonId,items:e,reason:t};await this.rpc.cancelItems(n)}async joinWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.joinWaitlist({seasonId:t,sessionId:e})}async leaveWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.leaveWaitlist({seasonId:t,sessionId:e})}async placeOrder(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.placeOrder({seasonId:t,screenshotPath:e})}clearError(){this._error.set(null)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"})};export{h as a,ee as b,F as c};
