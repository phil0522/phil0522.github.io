import{a as A,b as T}from"./chunk-JOW6DMZI.js";import{a as P,b as U}from"./chunk-OTRDOZHQ.js";import{a as q}from"./chunk-R6KVQD4W.js";import{B as N,C as k,D as x,E as O,F as R,G as E,H as j,P as C,z as _}from"./chunk-GQT55FUQ.js";import{C as I,D,F as m,I as S,N as s,R as w,Rb as n,W as g,Y as l,c as v,da as d,ea as M,f as y,fa as p,j as f}from"./chunk-WXZFQYIJ.js";function h(o){o||(o=s(l));let e=new v(t=>{if(o.destroyed){t.next();return}return o.onDestroy(t.next.bind(t))});return t=>t.pipe(D(e))}function W(o,e){let t=e?.injector??s(g),r=new y(1),a=M(()=>{let i;try{i=o()}catch(c){p(()=>r.error(c));return}p(()=>r.next(i))},{injector:t,manualCleanup:!0});return t.get(l).onDestroy(()=>{a.destroy(),r.complete()}),r.asObservable()}function te(o,e){let r=!e?.manualCleanup?e?.injector?.get(l)??s(l):null,a=V(e?.equal),i;e?.requireSync?i=d({kind:0},{equal:a}):i=d({kind:1,value:e?.initialValue},{equal:a});let c,b=o.subscribe({next:u=>i.set({kind:1,value:u}),error:u=>{i.set({kind:2,error:u}),c?.()},complete:()=>{c?.()}});if(e?.requireSync&&i().kind===0)throw new m(601,!1);return c=r?.onDestroy(b.unsubscribe.bind(b)),n(()=>{let u=i();switch(u.kind){case 1:return u.value;case 2:throw u.error;case 0:throw new m(601,!1)}},{equal:e?.equal})}function V(o=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&o(e.value,t.value)}var L=class o{datastore=s(A);rpc=s(T);seasonDatastore=s(P);seasonService=s(U);configService=s(q);destroyRef=s(l);injector=s(g);_order=d(null);_registration=d(null);_loading=d(!1);_error=d(null);_currentTime=n(()=>this.configService.currentTime());currentSeasonId=n(()=>this.seasonService.selectedSeason()?.id??null);orderSubscription=null;registrationSubscription=null;_currentSeasonId=null;currentUserAuthId=null;order=this._order.asReadonly();registration=this._registration.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();items=n(()=>this._order()?.items??[]);submittedItems=n(()=>{let e=this._order();return e?N(e):[]});paidItems=n(()=>{let e=this._order();return e?k(e):[]});lockedItems=n(()=>this.items().filter(e=>e.status==="locked"));lockedCount=n(()=>this.lockedItems().length);submittedCount=n(()=>this.submittedItems().length);paidCount=n(()=>this.paidItems().length);hasLockedItems=n(()=>this.lockedItems().length>0);hasSubmittedItems=n(()=>this.submittedItems().length>0);hasPaidItems=n(()=>this.paidItems().length>0);waitlistEntries=n(()=>this._order()?.waitlist??[]);waitlistCount=n(()=>this.waitlistEntries().length);pricing=n(()=>this._order()?.pricing??null);totalDue=n(()=>{let e=this.pricing();return e?_(e):0});totalDiscountAmount=n(()=>{let e=this.pricing();return e?j(e.discounts):0});totalPaid=n(()=>this._order()?.totalPaid??0);totalRefunded=n(()=>{let e=this._order();return e?C(e):0});amountDue=n(()=>{let e=this._order();return e?R(e):0});paymentScreenshots=n(()=>this._order()?.paymentScreenshots??[]);payments=n(()=>this._order()?.payments??[]);isFullyPaid=n(()=>this.amountDue()<=0&&this.totalPaid()>0);lockExpiresAt=n(()=>this._order()?.lockExpiresAt??null);isOverdue=n(()=>{let e=this._order();return e?E(e,this._currentTime()):!1});hoursUntilLockExpires=n(()=>{let e=this.lockExpiresAt();if(!e)return null;let t=new Date(this._currentTime()),a=(new Date(e).getTime()-t.getTime())/(1e3*60*60);return a>0?Math.ceil(a):null});initialize(e,t){this.cleanup(),this._currentSeasonId=e,this.currentUserAuthId=t,this._loading.set(!0),this._error.set(null),this.orderSubscription=this.datastore.subscribeToOrder(e,t).pipe(h(this.destroyRef)).subscribe({next:r=>{this._order.set(r),this._loading.set(!1)},error:r=>{this._error.set(r.message),this._loading.set(!1)}}),w(this.injector,()=>{this.registrationSubscription=W(this.seasonService.selectedSeason).pipe(h(this.destroyRef),I(r=>r?this.seasonDatastore.subscribeToRegistration(r.id):f(null))).subscribe({next:r=>{this._registration.set(r)},error:r=>{console.error("Failed to load registration:",r)}})})}cleanup(){this.orderSubscription?.unsubscribe(),this.orderSubscription=null,this.registrationSubscription?.unsubscribe(),this.registrationSubscription=null,this._order.set(null),this._registration.set(null),this._currentSeasonId=null,this.currentUserAuthId=null}hasActiveEnrollment(e,t){let r=this._order();return r?x(r,e,t):!1}isOnWaitlist(e){let t=this._order();return t?O(t,e):!1}getWaitlistEntry(e){return this.waitlistEntries().find(t=>t.sessionId===e)??null}getEnrolledSessionIds(e){return this.items().filter(t=>t.studentId===e&&(t.status==="locked"||t.status==="submitted"||t.status==="paid")).map(t=>t.sessionId)}getOrderItem(e,t){return this.items().find(r=>r.sessionId===e&&r.studentId===t)??null}async recordPayment(e,t,r,a){if(!this._currentSeasonId||!this.currentUserAuthId)throw new Error("Order not initialized");let i={year:2026,seasonId:this._currentSeasonId,userAuthId:this.currentUserAuthId,amount:e,reference:t,method:r,notes:a||null};await this.rpc.recordPayment(i)}async cancelItems(e,t){if(!this._currentSeasonId)throw new Error("Order not initialized");let r={year:2026,seasonId:this._currentSeasonId,items:e,reason:t};await this.rpc.cancelItems(r)}async joinWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.joinWaitlist({seasonId:t,sessionId:e})}async leaveWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.leaveWaitlist({seasonId:t,sessionId:e})}async placeOrder(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.placeOrder({seasonId:t,screenshotPath:e})}clearError(){this._error.set(null)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"})};export{h as a,te as b,L as c};
