import{a as f}from"./chunk-URCISTJ5.js";import{$ as S,Ca as C,Da as A,Fa as w,S as h,W as q,X as y,oa as m}from"./chunk-TX2MCR52.js";import{M as c,R as d,a as R,b as g,g as O,ha as p}from"./chunk-EVJ2WVWM.js";var U=class l{db=new C(y(h()));firestore=y(h());seasonDatastore=d(f);userDatastore=d(A);async getUserSeasonOrder(e,t){let s=`years/${e}/orders`,r=await this.db.getDocument(s,t);return r?m.parse(r):null}subscribeToOrder(e,t){return new O(s=>{let r=q(this.firestore,`years/${e}/orders`,t),i=S(r,o=>{if(!o.exists()){s.next(null);return}try{let u=g(R({},o.data()),{id:o.id}),n=m.parse(u);s.next(n)}catch(u){s.error(u)}},o=>{s.error(o)});return()=>i()})}async listSeasonOrders(e,t){let s=`years/${e}/orders`;return(await this.db.getDocuments(s,[{field:"seasonId",op:"==",value:t}])).map(i=>m.parse(i))}async listYearOrders(e){let t=`years/${e}/orders`;return(await this.db.getDocuments(t)).map(r=>m.parse(r))}async listOrdersWithSubmittedItems(e){return(await this.listYearOrders(e)).filter(s=>s.items.some(r=>r.status==="submitted"))}async listOverdueOrders(e,t){let s=await this.listOrdersWithSubmittedItems(e),r=new Date(t);return s.filter(i=>i.lockExpiresAt?new Date(i.lockExpiresAt)<r:!1)}async listOrdersWithChangeRequests(e){return(await this.listYearOrders(e)).filter(s=>s.changeRequests&&s.changeRequests.some(r=>r.status==="pending"))}async listAllWaitlistEntries(e){let t=await this.listYearOrders(e),s=await this.seasonDatastore.listAllSeasons(e),r=new Map;for(let n of s)for(let a of n.sessions??[])r.set(a.id,a.name);let i=await this.userDatastore.listAllUsers(),o=new Map;for(let n of i)o.set(n.uid,n.displayName);let u=[];for(let n of t)if(!(!n.waitlist||n.waitlist.length===0))for(let a of n.waitlist)u.push({userId:n.userAuthId,userName:o.get(n.userAuthId)??"Unknown User",sessionId:a.sessionId,className:r.get(a.sessionId)??"Unknown Class",joinedAt:a.joinedAt??"",isPromoted:a.isPromoted,promotedAt:a.promotedAt,notes:a.notes});return u.sort((n,a)=>n.joinedAt.localeCompare(a.joinedAt)),u}async listWaitlistByClass(e,t){return(await this.listAllWaitlistEntries(e)).filter(r=>r.sessionId===t)}static \u0275fac=function(t){return new(t||l)};static \u0275prov=c({token:l,factory:l.\u0275fac,providedIn:"root"})};var b=class l{functions=d(w);_loading=p(!1);_error=p(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async submitItems(e){return this.wrapApiCall("submitOrderItems",e)}async recordPayment(e){return this.wrapApiCall("recordOrderPayment",e)}async cancelItems(e){return this.wrapCall("cancelOrderItems",e)}async joinWaitlist(e){return this.wrapApiCall("joinWaitlist",e)}async leaveWaitlist(e){return this.wrapApiCall("leaveWaitlist",e)}async promoteWaitlistEntry(e){return this.wrapApiCall("promoteWaitlistEntry",e)}async removeSubmittedItems(e){return this.wrapApiCall("removeSubmittedItems",e)}async applySubmittedChanges(e){return this.wrapApiCall("applySubmittedChanges",e)}async requestOrderChange(e){return this.wrapApiCall("requestChange",e)}async updateChangeRequest(e){return this.wrapApiCall("updateChangeRequest",e)}async approveChangeRequest(e){return this.wrapApiCall("approveChange",e)}async denyChangeRequest(e){return this.wrapApiCall("denyChange",e)}async listAllOrders(e,t){return this.wrapCall("listAllOrders",{status:e,limit:t})}async listOverdueOrders(){return this.wrapCall("listOverdueOrders",void 0)}async listChangeRequests(){return this.wrapCall("listChangeRequests",void 0)}async adminCancelOrder(e,t,s){await this.wrapApiCall("cancelOrder",{userAuthId:e,itemsToCancel:t,reason:s})}async getOrder(e){return this.wrapCall("getOrder",{userAuthId:e})}async listAllWaitlistEntries(){return this.wrapCall("listAllWaitlistEntries",{})}async listWaitlistByClass(e){return this.wrapCall("listWaitlistByClass",{sessionId:e})}clearError(){this._error.set(null)}async wrapCall(e,t){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,t)}catch(s){let r=s instanceof Error?s.message:String(s);throw this._error.set(r),s}finally{this._loading.set(!1)}}async wrapApiCall(e,t){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,t)}catch(s){let r=s instanceof Error?s.message:String(s);throw this._error.set(r),s}finally{this._loading.set(!1)}}static \u0275fac=function(t){return new(t||l)};static \u0275prov=c({token:l,factory:l.\u0275fac,providedIn:"root"})};export{U as a,b};
