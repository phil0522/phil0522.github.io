import{h as E}from"./chunk-VAP7UJLN.js";import{b as _}from"./chunk-2UR2POCV.js";import{a as I}from"./chunk-D3KXLHLP.js";import{a as b}from"./chunk-WCUSQBFW.js";import{b as D}from"./chunk-DS6FZ4JQ.js";import{Fa as S,wa as y}from"./chunk-TX2MCR52.js";import{M as g,R as u,Rb as a,a as p,b as h,ha as d,ia as v}from"./chunk-EVJ2WVWM.js";function M(){return`cart-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function R(i){let e=i<0,s=`$${(Math.abs(i)/100).toFixed(2)}`;return e?`-${s}`:s}function U(i,e){let t=new Date(i),s=new Date(e),r=t.toLocaleDateString("en-US",{month:"short",day:"numeric"}),n=s.toLocaleDateString("en-US",{month:"short",day:"numeric"});return`${r} - ${n}`}function x(i){if(!i||typeof i!="object")return!1;let e=i;if(e.details?.code==="CAPACITY_EXCEEDED")return!0;if(!(e.message??e.error?.message??"").toLowerCase().includes("full"))return!1;let s=(e.code??"").toLowerCase(),r=(e.status??e.error?.status??"").toLowerCase().replace(/_/g,"-");return s==="resource-exhausted"||s==="functions/resource-exhausted"||s==="failed-precondition"||r==="resource-exhausted"}function F(i){return!i||typeof i!="object"?[]:i.details?.failedItems??[]}function T(i){if(!i||typeof i!="object")return"";let e=i;return e.message??e.error?.message??""}function V(i){return{returning_family:"\u{1F3E0}",sibling:"\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F466}",multi_session:"\u{1F4C5}",coupon:"\u{1F39F}\uFE0F",manual:"\u270F\uFE0F",early_bird:"\u{1F426}"}[i]??"\u{1F4B0}"}var C=class i{functions=u(S);_seasonCoupons=d([]);_userCoupons=d([]);_selectedUserCouponIds=d([]);_loading=d(!1);_validating=d(!1);_error=d(null);seasonCoupons=this._seasonCoupons.asReadonly();userCoupons=this._userCoupons.asReadonly();selectedUserCouponIds=this._selectedUserCouponIds.asReadonly();loading=this._loading.asReadonly();validating=this._validating.asReadonly();error=this._error.asReadonly();couponsToApply=a(()=>[...this._seasonCoupons(),...this._userCoupons().filter(e=>this._selectedUserCouponIds().includes(e.id))]);totalCouponCredit=a(()=>this.couponsToApply().reduce((e,t)=>e+t.maxCreditCents,0));hasAvailableCoupons=a(()=>this._seasonCoupons().length>0||this._userCoupons().length>0);async loadCoupons(e){this._loading.set(!0),this._error.set(null);try{let t=await this.functions.callApi("getUserAvailableCoupons",{seasonId:e});this._seasonCoupons.set(t.seasonCoupons),this._userCoupons.set(t.userCoupons),this._selectedUserCouponIds.set(t.userCoupons.map(s=>s.id))}catch(t){console.error("Failed to load coupons:",t),this._error.set("Failed to load coupons"),this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([])}finally{this._loading.set(!1)}}toggleCoupon(e){let t=this._selectedUserCouponIds();t.includes(e)?this._selectedUserCouponIds.set(t.filter(s=>s!==e)):this._selectedUserCouponIds.set([...t,e])}isCouponSelected(e){return this._selectedUserCouponIds().includes(e)}clearCoupons(){this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([]),this._error.set(null)}getSelectedCouponIds(){return this._selectedUserCouponIds()}async validateAndAddCoupon(e){this._validating.set(!0);try{let s=(await this.functions.callApi("validateAndAddCoupon",{couponId:e})).coupon;return this._userCoupons().map(n=>n.id).includes(s.id)||(this._userCoupons.update(n=>[...n,s]),this._selectedUserCouponIds.update(n=>[...n,s.id])),{success:!0,coupon:s}}catch(t){return{success:!1,error:t.message||"Failed to validate coupon"}}finally{this._validating.set(!1)}}static \u0275fac=function(t){return new(t||i)};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};var N="berryfun_cart_",w="__berryfun_storage_test__",f=class i{getStorageKey(e,t){return`${N}${e}_${t}`}saveCart(e,t,s){try{let r={items:s,savedAt:Date.now()},n=this.getStorageKey(e,t);localStorage.setItem(n,JSON.stringify(r))}catch(r){console.warn("Failed to save cart to localStorage:",r)}}loadCart(e,t){try{let s=this.getStorageKey(e,t),r=localStorage.getItem(s);if(!r)return null;let n=JSON.parse(r);return this.isValidPersistedCartData(n)?n:(this.clearCart(e,t),null)}catch(s){console.warn("Failed to load cart from localStorage:",s);try{this.clearCart(e,t)}catch{}return null}}clearCart(e,t){try{let s=this.getStorageKey(e,t);localStorage.removeItem(s)}catch(s){console.warn("Failed to clear cart from localStorage:",s)}}isStorageAvailable(){try{return localStorage.setItem(w,"test"),localStorage.removeItem(w),!0}catch{return!1}}isValidPersistedCartData(e){if(typeof e!="object"||e===null)return!1;let t=e;return!(!Array.isArray(t.items)||typeof t.savedAt!="number")}static \u0275fac=function(t){return new(t||i)};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};var P=class i{orderRpc=u(_);orderService=u(E);seasonService=u(I);configService=u(b);couponService=u(C);persistenceService=u(f);userService=u(D);_items=d([]);_pricing=d(null);_pricingLoading=d(!1);_pricingError=d(null);_submitting=d(!1);_submitError=d(null);currentSeason=a(()=>this.seasonService.selectedSeason());currentUserId=a(()=>this.userService.currentUser()?.uid??null);previousUserId=null;previousSeasonId=null;constructor(){v(()=>{let e=this.currentUserId(),t=this.currentSeason()?.id??null;if(!e||!t){this.previousUserId=e,this.previousSeasonId=t;return}let s=this.previousUserId!==e,r=this.previousSeasonId!==t;(s||r)&&this.loadCartFromStorage(e,t),this.previousUserId=e,this.previousSeasonId=t})}items=this._items.asReadonly();pricing=this._pricing.asReadonly();pricingLoading=this._pricingLoading.asReadonly();pricingError=this._pricingError.asReadonly();submitting=this._submitting.asReadonly();submitError=this._submitError.asReadonly();loading=this.orderRpc.loading;seasonCoupons=this.couponService.seasonCoupons;userCoupons=this.couponService.userCoupons;selectedCouponIds=this.couponService.selectedUserCouponIds;couponsLoading=this.couponService.loading;couponsValidating=this.couponService.validating;couponsError=this.couponService.error;hasAvailableCoupons=this.couponService.hasAvailableCoupons;couponsToApply=this.couponService.couponsToApply;totalCouponCredit=this.couponService.totalCouponCredit;_couponValidationError=d(null);_couponValidationSuccess=d(null);couponValidationError=this._couponValidationError.asReadonly();couponValidationSuccess=this._couponValidationSuccess.asReadonly();itemCount=a(()=>this._items().length);hasItems=a(()=>this._items().length>0);isEmpty=a(()=>this._items().length===0);uniqueClassCount=a(()=>new Set(this._items().map(t=>t.class.id)).size);uniqueStudentCount=a(()=>new Set(this._items().flatMap(t=>t.students.map(s=>s.id))).size);totalEnrollmentCount=a(()=>this._items().reduce((e,t)=>e+t.students.length,0));itemsMissingStudents=a(()=>this._items().filter(e=>e.students.length===0));itemsMissingStudentsCount=a(()=>this.itemsMissingStudents().length);allStudentsAssigned=a(()=>this._items().every(e=>e.students.length>0));isReadyToSubmit=a(()=>this.hasItems()&&this.allStudentsAssigned()&&!this._submitting());subtotal=a(()=>this._pricing()?.subtotal??0);discounts=a(()=>this._pricing()?.discounts??[]);totalDiscountAmount=a(()=>this.discounts().reduce((e,t)=>e+t.amount,0));total=a(()=>{let e=this._pricing();if(!e)return 0;let t=e.discounts.reduce((s,r)=>s+r.amount,0);return Math.max(0,e.subtotal+t)});addToCart(e,t=[],s={lunch:!0,extendedCare:!1},r=!1){let n=this.currentSeason()?.id??"";if(e.seasonId!==n)throw new Error("Cannot add classes from different seasons. Please complete or clear your current cart first.");if(this.isClassInCart(e.id))throw new Error("This class is already in your cart");for(let l of t)this.validateStudentNotEnrolled(e.id,l.id);let o=p({id:M(),class:e,students:t,options:s},r&&{isWaitlistClaim:!0});return this._items.update(l=>[...l,o]),this.persistCart(),t.length>0&&this.refreshPricing(),o.id}removeFromCart(e){this._items.update(t=>t.filter(s=>s.id!==e)),this.persistCart(),this._items().length>0?this.refreshPricing():this._pricing.set(null)}toggleStudent(e,t){let s=this._items().find(n=>n.id===e);if(!s)return;let r=s.students.some(n=>n.id===t.id);if(!r&&(this.validateStudentNotEnrolled(s.class.id,t.id),this.isStudentInCartForClass(s.class.id,t.id)))throw new Error("This student is already in the cart for this class");this._items.update(n=>n.map(o=>{if(o.id!==e)return o;let l=r?o.students.filter(c=>c.id!==t.id):[...o.students,t];return h(p({},o),{students:l})})),this.persistCart(),this.refreshPricing()}updateItemOptions(e,t){this._items.update(s=>s.map(r=>r.id===e?h(p({},r),{options:p(p({},r.options),t)}):r)),this.persistCart(),this.refreshPricing()}clearCart(){this._items.set([]),this._pricing.set(null),this._pricingError.set(null),this._submitError.set(null),this.couponService.clearCoupons(),this.persistCart()}async loadCoupons(){let e=this.currentSeason()?.id;e&&await this.couponService.loadCoupons(e)}toggleCoupon(e){this.couponService.toggleCoupon(e)}isCouponSelected(e){return this.couponService.isCouponSelected(e)}async validateAndAddCoupon(e){this._couponValidationError.set(null),this._couponValidationSuccess.set(null);let t=await this.couponService.validateAndAddCoupon(e);t.success&&t.coupon?(this._couponValidationSuccess.set(`Coupon "${t.coupon.name}" added!`),setTimeout(()=>this._couponValidationSuccess.set(null),3e3),this.refreshPricing()):(this._couponValidationError.set(t.error||"Failed to add coupon"),setTimeout(()=>this._couponValidationError.set(null),5e3))}isClassInCart(e){return this._items().some(t=>t.class.id===e)}isStudentInCartForClass(e,t){return this._items().some(s=>s.class.id===e&&s.students.some(r=>r.id===t))}isStudentSelected(e,t){return this._items().find(r=>r.id===e)?.students.some(r=>r.id===t)??!1}getCartItem(e){return this._items().find(t=>t.id===e)??null}getCartItemForClass(e){return this._items().find(t=>t.class.id===e)??null}refreshPricing(){let e=this._items();if(e.length===0){this._pricing.set(null);return}if(!this.allStudentsAssigned()){this._pricing.set(null);return}let t=this.currentSeason();if(!t){this._pricingError.set("Season not set");return}this._pricingError.set(null);try{let s=new Map;for(let o of e)s.has(o.class.id)||s.set(o.class.id,{id:o.class.id,basePrice:o.class.basePrice,lunchPrice:o.class.lunchPrice,extendedCarePrice:o.class.extendedCarePrice,earlyBirdTiers:o.class.earlyBirdTiers??[]});let r=e.flatMap(o=>o.students.map(l=>({sessionId:o.class.id,studentId:l.id,options:o.options}))),n=y.calculateCartPricing({items:r,sessionLookup:s,currentDate:this.configService.currentDate(),discountConfig:{siblingDiscountPerWeek:t.siblingDiscountPerWeek??0,multiSessionDiscountTiers:t.multiSessionDiscounts??[]}});this._pricing.set(n)}catch(s){let r=s instanceof Error?s.message:String(s);this._pricingError.set(r)}}async submit(){let e=this._items();if(e.length===0)throw new Error("Cart is empty");if(!this.allStudentsAssigned())throw new Error("Please select a student for all classes");let t=this.currentSeason()?.id;if(!t)throw new Error("Season not set");this._submitting.set(!0),this._submitError.set(null);try{let s=e.flatMap(o=>o.students.map(l=>({sessionId:o.class.id,studentId:l.id,options:o.options}))),r=this.couponService.getSelectedCouponIds(),n=await this.orderRpc.submitItems({seasonId:t,items:s,selectedCouponIds:r});return this.clearPersistedCart(),this.clearCart(),n}catch(s){let r=s instanceof Error?s.message:String(s);throw this._submitError.set(r),s}finally{this._submitting.set(!1)}}clearPricingError(){this._pricingError.set(null)}clearSubmitError(){this._submitError.set(null)}clearAllErrors(){this._pricingError.set(null),this._submitError.set(null)}validateStudentNotEnrolled(e,t){if(this.orderService.hasActiveEnrollment(e,t))throw new Error("This student is already enrolled in this class")}loadCartFromStorage(e,t){let s=this.persistenceService.loadCart(e,t);if(s&&s.items.length>0){let r=this.validateCartItems(s.items);this._items.set(r);let n=s.items.reduce((c,m)=>c+(m.students?.length??0),0),o=r.reduce((c,m)=>c+m.students.length,0);(r.length!==s.items.length||o!==n)&&this.persistCart(),r.some(c=>c.students.length>0)&&this.refreshPricing()}else this._items.set([]),this._pricing.set(null)}validateCartItems(e){let t=this.currentSeason(),s=new Set(t?.sessions?.map(n=>n.id)??[]),r=s.size>0;return e.filter(n=>!(!n||!n.class||!n.class.id||r&&!s.has(n.class.id))).map(n=>{let o=n.students.filter(l=>!this.orderService.hasActiveEnrollment(n.class.id,l.id));return h(p({},n),{students:o})}).filter(n=>{let o=e.find(m=>m.id===n.id);return o&&o.students.length>0&&n.students.length===0?(console.info(`[CartStore] Removing cart item for class "${n.class.name}" - all students already enrolled`),!1):!0})}persistCart(){let e=this.currentUserId(),t=this.currentSeason()?.id;!e||!t||this.persistenceService.saveCart(e,t,this._items())}clearPersistedCart(){let e=this.currentUserId(),t=this.currentSeason()?.id;!e||!t||this.persistenceService.clearCart(e,t)}static \u0275fac=function(t){return new(t||i)};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};export{R as a,U as b,x as c,F as d,T as e,V as f,P as g};
