import{Ma as z,Na as J,Oa as K}from"./chunk-UBU22GLA.js";import{M as V,R,Tb as v,a as A,b as C,ha as x}from"./chunk-UKFGIOHC.js";var $=class S{functions=R(K);_loading=x(!1);_error=x(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async createUser(i){return this.wrapApiCall("createUser",i)}async updateUser(i){return this.wrapApiCall("updateUser",i)}async createStudent(i){return this.wrapApiCall("addStudent",i)}async updateStudent(i){return this.wrapApiCall("updateStudent",i)}async deleteStudent(i){return this.wrapApiCall("deleteStudent",{studentId:i})}async getUserProfile(i){return this.wrapCall("getUserProfile",{uid:i})}async listAllUsers(i){return this.wrapCall("listAllUsers",{limit:i})}async searchUsers(i){return this.wrapCall("searchUsers",{query:i})}async getAdminUserDetails(i){return this.wrapCall("getAdminUserDetails",{uid:i})}async updateUserProfileAsAdmin(i,e){return this.wrapCall("updateUserProfile",{authId:i,updates:e})}clearError(){this._error.set(null)}async wrapCall(i,e){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(i,e)}catch(d){let c=d instanceof Error?d.message:String(d);throw this._error.set(c),d}finally{this._loading.set(!1)}}async wrapApiCall(i,e){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(i,e)}catch(d){let c=d instanceof Error?d.message:String(d);throw this._error.set(c),d}finally{this._loading.set(!1)}}static \u0275fac=function(e){return new(e||S)};static \u0275prov=V({token:S,factory:S.\u0275fac,providedIn:"root"})};var te=["43dfed9d3bb5faee2c59afaf60e2f0ca","de4e8cbf34b00cba9a1122ee97ea3b00","57cef514bb4351a206f20053503648c9","33ccd328349ed0605d8ca291609c15da"];function se(S){function i(r,u){return r<<u|r>>>32-u}function e(r,u){let l=r&2147483648,f=u&2147483648,h=r&1073741824,_=u&1073741824,m=(r&1073741823)+(u&1073741823);return h&_?m^2147483648^l^f:h|_?m&1073741824?m^3221225472^l^f:m^1073741824^l^f:m^l^f}function d(r,u,l){return r&u|~r&l}function c(r,u,l){return r&l|u&~l}function y(r,u,l){return r^u^l}function P(r,u,l){return u^(r|~l)}function g(r,u,l,f,h,_,m){return r=e(r,e(e(d(u,l,f),h),m)),e(i(r,_),u)}function b(r,u,l,f,h,_,m){return r=e(r,e(e(c(u,l,f),h),m)),e(i(r,_),u)}function p(r,u,l,f,h,_,m){return r=e(r,e(e(y(u,l,f),h),m)),e(i(r,_),u)}function U(r,u,l,f,h,_,m){return r=e(r,e(e(P(u,l,f),h),m)),e(i(r,_),u)}function ee(r){let u,l=r.length,f=l+8,_=((f-f%64)/64+1)*16,m=new Array(_-1),k=0,w=0;for(;w<l;)u=(w-w%4)/4,k=w%4*8,m[u]=m[u]|r.charCodeAt(w)<<k,w++;return u=(w-w%4)/4,k=w%4*8,m[u]=m[u]|128<<k,m[_-2]=l<<3,m[_-1]=l>>>29,m}function D(r){let u="",l="",f,h;for(h=0;h<=3;h++)f=r>>>h*8&255,l="0"+f.toString(16),u=u+l.substring(l.length-2);return u}let o=ee(S),t=1732584193,s=4023233417,n=2562383102,a=271733878,M=7,E=12,q=17,N=22,T=5,G=9,I=14,L=20,B=4,F=11,H=16,W=23,j=6,Q=10,O=15,Y=21;for(let r=0;r<o.length;r+=16){let u=t,l=s,f=n,h=a;t=g(t,s,n,a,o[r+0],M,3614090360),a=g(a,t,s,n,o[r+1],E,3905402710),n=g(n,a,t,s,o[r+2],q,606105819),s=g(s,n,a,t,o[r+3],N,3250441966),t=g(t,s,n,a,o[r+4],M,4118548399),a=g(a,t,s,n,o[r+5],E,1200080426),n=g(n,a,t,s,o[r+6],q,2821735955),s=g(s,n,a,t,o[r+7],N,4249261313),t=g(t,s,n,a,o[r+8],M,1770035416),a=g(a,t,s,n,o[r+9],E,2336552879),n=g(n,a,t,s,o[r+10],q,4294925233),s=g(s,n,a,t,o[r+11],N,2304563134),t=g(t,s,n,a,o[r+12],M,1804603682),a=g(a,t,s,n,o[r+13],E,4254626195),n=g(n,a,t,s,o[r+14],q,2792965006),s=g(s,n,a,t,o[r+15],N,1236535329),t=b(t,s,n,a,o[r+1],T,4129170786),a=b(a,t,s,n,o[r+6],G,3225465664),n=b(n,a,t,s,o[r+11],I,643717713),s=b(s,n,a,t,o[r+0],L,3921069994),t=b(t,s,n,a,o[r+5],T,3593408605),a=b(a,t,s,n,o[r+10],G,38016083),n=b(n,a,t,s,o[r+15],I,3634488961),s=b(s,n,a,t,o[r+4],L,3889429448),t=b(t,s,n,a,o[r+9],T,568446438),a=b(a,t,s,n,o[r+14],G,3275163606),n=b(n,a,t,s,o[r+3],I,4107603335),s=b(s,n,a,t,o[r+8],L,1163531501),t=b(t,s,n,a,o[r+13],T,2850285829),a=b(a,t,s,n,o[r+2],G,4243563512),n=b(n,a,t,s,o[r+7],I,1735328473),s=b(s,n,a,t,o[r+12],L,2368359562),t=p(t,s,n,a,o[r+5],B,4294588738),a=p(a,t,s,n,o[r+8],F,2272392833),n=p(n,a,t,s,o[r+11],H,1839030562),s=p(s,n,a,t,o[r+14],W,4259657740),t=p(t,s,n,a,o[r+1],B,2763975236),a=p(a,t,s,n,o[r+4],F,1272893353),n=p(n,a,t,s,o[r+7],H,4139469664),s=p(s,n,a,t,o[r+10],W,3200236656),t=p(t,s,n,a,o[r+13],B,681279174),a=p(a,t,s,n,o[r+0],F,3936430074),n=p(n,a,t,s,o[r+3],H,3572445317),s=p(s,n,a,t,o[r+6],W,76029189),t=p(t,s,n,a,o[r+9],B,3654602809),a=p(a,t,s,n,o[r+12],F,3873151461),n=p(n,a,t,s,o[r+15],H,530742520),s=p(s,n,a,t,o[r+2],W,3299628645),t=U(t,s,n,a,o[r+0],j,4096336452),a=U(a,t,s,n,o[r+7],Q,1126891415),n=U(n,a,t,s,o[r+14],O,2878612391),s=U(s,n,a,t,o[r+5],Y,4237533241),t=U(t,s,n,a,o[r+12],j,1700485571),a=U(a,t,s,n,o[r+3],Q,2399980690),n=U(n,a,t,s,o[r+10],O,4293915773),s=U(s,n,a,t,o[r+1],Y,2240044497),t=U(t,s,n,a,o[r+8],j,1873313359),a=U(a,t,s,n,o[r+15],Q,4264355552),n=U(n,a,t,s,o[r+6],O,2734768916),s=U(s,n,a,t,o[r+13],Y,1309151649),t=U(t,s,n,a,o[r+4],j,4149444226),a=U(a,t,s,n,o[r+11],Q,3174756917),n=U(n,a,t,s,o[r+2],O,718787259),s=U(s,n,a,t,o[r+9],Y,3951481745),t=e(t,u),s=e(s,l),n=e(n,f),a=e(a,h)}return(D(t)+D(s)+D(n)+D(a)).toLowerCase()}function X(S){if(!S)return!1;let i=se(S.toLowerCase().trim());return te.includes(i)}var Z=class S{datastore=R(z);rpc=R($);impersonationService=R(J);_currentUser=x(null);_loading=x(!1);_error=x(null);_isAdmin=x(!1);_users=x([]);_selectedUser=x(null);_searchQuery=x("");_actionLoading=x(!1);_actionError=x(null);currentUser=v(()=>this.impersonationService.impersonatedUser()??this._currentUser());loading=this._loading.asReadonly();error=this._error.asReadonly();actualUser=this._currentUser.asReadonly();users=this._users.asReadonly();selectedUser=this._selectedUser.asReadonly();searchQuery=this._searchQuery.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();isAuthenticated=v(()=>this._currentUser()!==null);userCount=v(()=>this._users().length);hasUsers=v(()=>this._users().length>0);students=v(()=>this.currentUser()?.students??[]);studentCount=v(()=>this.students().length);hasStudents=v(()=>this.students().length>0);isProfileComplete=v(()=>{let i=this.currentUser();if(!i)return!1;let e=i.primaryGuardian;if(!e)return!1;let d=!!e.phone,c=!!e.wechatId,y=!!e.address?.street&&!!e.address?.city&&!!e.address?.state&&!!e.address?.zipCode,P=!!i.emergencyContact?.name&&!!i.emergencyContact?.phone&&!!i.emergencyContact?.relationship;return d&&c&&y&&P});isAdmin=v(()=>this._isAdmin()&&!this.impersonationService.isImpersonating());async createUser(i){this._loading.set(!0),this._error.set(null);try{return await this.rpc.createUser(i)}catch(e){let d=e instanceof Error?e.message:String(e);throw this._error.set(d),e}finally{this._loading.set(!1)}}async updateProfile(i){this._loading.set(!0),this._error.set(null);try{let e=await this.rpc.updateUser({updates:i});this._currentUser.set(e)}catch(e){let d=e instanceof Error?e.message:String(e);throw this._error.set(d),e}finally{this._loading.set(!1)}}setCurrentUser(i){this._currentUser.set(i),i===null?this._isAdmin.set(!1):this._isAdmin.set(X(i.email))}clearUser(){this._currentUser.set(null),this._isAdmin.set(!1)}clearError(){this._error.set(null)}getStudentById(i){return this.students().find(e=>e.id===i)}getEligibleStudents(i){let e=new Date(i,0,1);return this.students().filter(d=>{let c=new Date(d.dob),y=e.getFullYear()-c.getFullYear(),g=new Date(e.getFullYear(),c.getMonth(),c.getDate())>e?y-1:y;return g>=5&&g<=12})}async createStudent(i){if(!this._currentUser())throw new Error("No current user");this._loading.set(!0),this._error.set(null);try{let d=await this.rpc.createStudent(i);return this._currentUser.update(c=>c&&C(A({},c),{students:[...c.students??[],d]})),d}catch(d){let c=d instanceof Error?d.message:String(d);throw this._error.set(c),d}finally{this._loading.set(!1)}}async updateStudent(i,e){this._loading.set(!0),this._error.set(null);try{let d=await this.rpc.updateStudent(A({studentId:i},e));this._currentUser.update(c=>c&&C(A({},c),{students:c.students?.map(y=>y.id===i?d:y)}))}catch(d){let c=d instanceof Error?d.message:String(d);throw this._error.set(c),d}finally{this._loading.set(!1)}}async deleteStudent(i){this._loading.set(!0),this._error.set(null);try{await this.rpc.deleteStudent(i),this._currentUser.update(e=>e&&C(A({},e),{students:e.students?.filter(d=>d.id!==i)}))}catch(e){let d=e instanceof Error?e.message:String(e);throw this._error.set(d),e}finally{this._loading.set(!1)}}async loadAllUsers(i){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.listAllUsers(i);this._users.set(e)}catch(e){let d=e instanceof Error?e.message:String(e);throw this._error.set(d),e}finally{this._loading.set(!1)}}async searchUsers(i){this._loading.set(!0),this._error.set(null),this._searchQuery.set(i);try{let e=await this.datastore.searchUsers(i);this._users.set(e)}catch(e){let d=e instanceof Error?e.message:String(e);throw this._error.set(d),e}finally{this._loading.set(!1)}}async getUserDetails(i){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.getUserByAuthId(i);if(!e)throw new Error(`User not found: ${i}`);return this._selectedUser.set(e),e}catch(e){let d=e instanceof Error?e.message:String(e);throw this._error.set(d),e}finally{this._loading.set(!1)}}async getUserByDisplayId(i){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.getUserByDisplayId(i);return e&&this._selectedUser.set(e),e}catch(e){let d=e instanceof Error?e.message:String(e);throw this._error.set(d),e}finally{this._loading.set(!1)}}async updateUserProfile(i,e){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.updateUserProfileAsAdmin(i,e),this._users.update(c=>c.map(y=>y.uid===i?C(A({},y),{primaryGuardian:e.primaryGuardian??y.primaryGuardian,secondaryGuardian:e.secondaryGuardian!==void 0?e.secondaryGuardian??void 0:y.secondaryGuardian,emergencyContact:e.emergencyContact??y.emergencyContact}):y));let d=this._selectedUser();d&&d.uid===i&&this._selectedUser.set(C(A({},d),{primaryGuardian:e.primaryGuardian??d.primaryGuardian,secondaryGuardian:e.secondaryGuardian!==void 0?e.secondaryGuardian??void 0:d.secondaryGuardian,emergencyContact:e.emergencyContact??d.emergencyContact}))}catch(d){let c=d instanceof Error?d.message:String(d);throw this._actionError.set(c),d}finally{this._actionLoading.set(!1)}}setSearchQuery(i){this._searchQuery.set(i)}clearSelectedUser(){this._selectedUser.set(null)}static \u0275fac=function(e){return new(e||S)};static \u0275prov=V({token:S,factory:S.\u0275fac,providedIn:"root"})};export{$ as a,Z as b};
