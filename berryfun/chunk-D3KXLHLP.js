import{a as y}from"./chunk-URCISTJ5.js";import{a as _}from"./chunk-WCUSQBFW.js";import{Fa as S,ea as h}from"./chunk-TX2MCR52.js";import{M as c,R as l,Rb as u,ha as i}from"./chunk-EVJ2WVWM.js";var d=class o{functions=l(S);_loading=i(!1);_error=i(null);loading=this._loading.asReadonly();error=this._error.asReadonly();clearError(){this._error.set(null)}async wrapCall(s,e){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(s,e)}catch(t){let a=t instanceof Error?t.message:String(t);throw this._error.set(a),t}finally{this._loading.set(!1)}}async wrapApiCall(s,e){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(s,e)}catch(t){let a=t instanceof Error?t.message:String(t);throw this._error.set(a),t}finally{this._loading.set(!1)}}async listAllSeasons(s){return this.wrapCall("listAllSeasons",{year:s})}async listAllClasses(s){return this.wrapCall("listAllClasses",{year:s})}async createSeason(s){return this.wrapApiCall("createSeason",s)}async updateSeason(s,e){return this.wrapApiCall("updateSeason",{seasonId:s,updates:e})}async createClass(s){return this.wrapApiCall("createClass",s)}async updateClass(s,e){return this.wrapApiCall("updateClass",{sessionId:s,updates:e})}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};var g="berryfun_selected_season",f=class o{datastore=l(y);rpc=l(d);configService=l(_);seasonsSubscription=null;subscribedYear=null;get currentYear(){return this.configService.currentActiveYear()}_seasons=i([]);_classes=i([]);_selectedSeason=i(null);_selectedClass=i(null);_loading=i(!1);_error=i(null);_actionLoading=i(!1);_actionError=i(null);seasons=this._seasons.asReadonly();classes=this._classes.asReadonly();selectedSeason=this._selectedSeason.asReadonly();selectedClass=this._selectedClass.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();hasSeasons=u(()=>this._seasons().length>0);hasClasses=u(()=>this._classes().length>0);ngOnDestroy(){this.unsubscribeAll()}unsubscribeAll(){this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=null}async loadSeasons(s){this.subscribedYear===s&&this.seasonsSubscription||(this._loading.set(!0),this._error.set(null),this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=s,this.seasonsSubscription=this.datastore.subscribeToActiveSeasons(s).subscribe({next:e=>{this._seasons.set(e),this._loading.set(!1),!this._selectedSeason()&&e.length>0&&this._selectedSeason.set(e[0]);let t=this._selectedSeason();if(t){let a=e.find(r=>r.id===t.id);a?(this._selectedSeason.set(a),this._classes.set(a.sessions?.filter(r=>r.isActive).sort((r,n)=>r.startDate.localeCompare(n.startDate))||[])):this._selectedSeason.set(e[0]||null)}},error:e=>{let t=e instanceof Error?e.message:String(e);this._error.set(t),this._loading.set(!1)}}))}async loadClassesBySeason(s,e){if(this.subscribedYear===e&&this.seasonsSubscription){let t=this._seasons().find(a=>a.id===s);if(t){let a=t.sessions?.filter(r=>r.isActive).sort((r,n)=>r.startDate.localeCompare(n.startDate))||[];this._classes.set(a);return}}this._loading.set(!0),this._error.set(null);try{let t=await this.datastore.listClassesBySeason(e,s);this._classes.set(t)}catch(t){let a=t instanceof Error?t.message:String(t);throw this._error.set(a),t}finally{this._loading.set(!1)}}async loadClassesByYear(s){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.listClassesByYear(s);this._classes.set(e)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async loadClass(s){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.getClass(this.currentYear,s);if(e)this._selectedClass.set(e);else throw new Error(`Class not found: ${s}`)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}selectSeason(s){this._selectedSeason.set(s),this.saveSelectedSeasonId(s?.id??null)}getLastSelectedSeasonId(){try{return localStorage.getItem(g)}catch{return null}}saveSelectedSeasonId(s){try{s?localStorage.setItem(g,s):localStorage.removeItem(g)}catch{}}selectClass(s){this._selectedClass.set(s)}async getClassById(s){let e=this._classes().find(t=>t.id===s);if(e)return e;try{return await this.datastore.getClass(this.currentYear,s)}catch{return null}}calculatePrice(s,e){let a=this.configService.config().currentDate,r=s.basePrice;if(s.earlyBirdTiers&&s.earlyBirdTiers.length>0){let n=s.earlyBirdTiers.find(m=>a<=m.deadline);n&&(r=n.price)}return e.includeLunch&&(r+=s.lunchPrice),e.includeExtendedCare&&(r+=s.extendedCarePrice),r}formatPrice(s){return`$${(s/100).toFixed(2)}`}clearError(){this._error.set(null)}reset(){this.unsubscribeAll(),this._seasons.set([]),this._classes.set([]),this._selectedSeason.set(null),this._selectedClass.set(null),this._error.set(null)}async refreshCatalog(){let s=this.subscribedYear||this.currentYear;this.subscribedYear=null,await this.loadSeasons(s)}async loadAllSeasons(s){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.listAllSeasons(s);this._seasons.set(e)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async loadAllClasses(s){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.listClassesByYear(s,!1);this._classes.set(e)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async createSeason(s){this._actionLoading.set(!0),this._actionError.set(null);try{let e=await this.rpc.createSeason(s),t=h(e);return this._seasons.update(a=>[...a,t]),t}catch(e){let t=e instanceof Error?e.message:String(e);throw this._actionError.set(t),e}finally{this._actionLoading.set(!1)}}async updateSeason(s,e){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateSeason(s,e),a=h(t);return this._seasons.update(r=>r.map(n=>n.id===s?a:n)),a}catch(t){let a=t instanceof Error?t.message:String(t);throw this._actionError.set(a),t}finally{this._actionLoading.set(!1)}}async createClass(s){this._actionLoading.set(!0),this._actionError.set(null);try{let e=await this.rpc.createClass(s);return this._classes.update(t=>[...t,e]),e}catch(e){let t=e instanceof Error?e.message:String(e);throw this._actionError.set(t),e}finally{this._actionLoading.set(!1)}}async updateClass(s,e){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateClass(s,e);return this._classes.update(a=>a.map(r=>r.id===s?t:r)),t}catch(t){let a=t instanceof Error?t.message:String(t);throw this._actionError.set(a),t}finally{this._actionLoading.set(!1)}}async toggleSeasonActive(s){let e=this._seasons().find(t=>t.id===s);e&&await this.updateSeason(s,{isActive:!e.isActive})}async toggleClassActive(s){let e=this._classes().find(t=>t.id===s);e&&await this.updateClass(s,{isActive:!e.isActive})}getSeason(s){return this._seasons().find(e=>e.id===s)}getClass(s){return this._classes().find(e=>e.id===s)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{f as a};
