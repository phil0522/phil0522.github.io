import{M as g,N as _,R as l,V as f,Y as v,Z as m,_ as y}from"./chunk-7EWFL5MX.js";import{I as u,N as d,da as n}from"./chunk-DU5POHF6.js";var h=15,b=class c{datastore=d(f);rpc=d(v);configService=d(m);seasonService=d(y);subscription=null;orderSubscription=null;_orders=n([]);_loading=n(!1);_error=n(null);_activeFilter=n("all");_cursor=n(null);_hasMore=n(!1);_loadingMore=n(!1);_actionLoading=n(!1);_actionError=n(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();filteredOrders=this._orders.asReadonly();setFilter(s){this._activeFilter.set(s),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(s){this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let r=s??this.getActiveSeasonId();if(!r){this._orders.set([]);return}let e=await this.queryOrders(r,h);this._orders.set(e.orders),this._cursor.set(e.lastDoc),this._hasMore.set(e.hasMore)}catch(r){let e=r instanceof Error?r.message:String(r);throw this._error.set(e),r}finally{this._loading.set(!1)}}async loadMore(s){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let r=s??this.getActiveSeasonId();if(!r)return;let e=this._cursor(),t=await this.queryOrders(r,h,e);this._orders.update(i=>[...i,...t.orders]),this._cursor.set(t.lastDoc),this._hasMore.set(t.hasMore)}catch(r){let e=r instanceof Error?r.message:String(r);throw this._error.set(e),r}finally{this._loadingMore.set(!1)}}}queryOrders(s,r,e){let t=this._activeFilter();switch(t){case"overdue":return this.datastore.listOverdueOrdersPaginated(s,this._cachedServerTime(),r,e);case"locked":case"submitted":case"paid":return this.datastore.listOrdersByStatusPaginated(s,t,r,e);case"all":return this.datastore.listOrdersPaginated(s,r,e)}}getActiveSeasonId(){return this.seasonService.selectedSeason()?.id??null}async loadAllOrders(s,r){this._loading.set(!0),this._error.set(null);try{let e=this.getActiveSeasonId();if(!e){this._orders.set([]);return}let t=await this.datastore.listSeasonOrders(e);s&&(t=t.filter(i=>l(i)===s)),t.sort((i,a)=>new Date(a.createdAt).getTime()-new Date(i.createdAt).getTime()),r&&r>0&&(t=t.slice(0,r)),this._orders.set(t)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let s=this.getActiveSeasonId();if(!s){this._orders.set([]);return}let r=this.configService.currentTime(),e=await this.datastore.listOverdueOrders(s,r);this._orders.set(e),this._activeFilter.set("overdue")}catch(s){let r=s instanceof Error?s.message:String(s);throw this._error.set(r),s}finally{this._loading.set(!1)}}async recordPayment(s,r,e,t="zelle",i,a=!1){this._actionLoading.set(!0),this._actionError.set(null);try{let o=this.getActiveSeasonId();if(!o)throw new Error("No season selected");await this.rpc.recordPayment({year:2026,seasonId:o,userAuthId:s,amount:r,reference:e,method:t,notes:i,isDepositConfirmation:a}),await this.loadAllOrders()}catch(o){let p=o instanceof Error?o.message:String(o);throw this._actionError.set(p),o}finally{this._actionLoading.set(!1)}}async cancelOrder(s,r,e){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(s,r,e),await this.loadAllOrders()}catch(t){let i=t instanceof Error?t.message:String(t);throw this._actionError.set(i),t}finally{this._actionLoading.set(!1)}}isOverdue(s){return g(s,this._cachedServerTime())}getRemainingLockTime(s){return _(s,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this.unsubscribe(),this.unsubscribeOrder(),this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}subscribeToOrders(s){this.unsubscribe();let r=s??this.getActiveSeasonId();if(!r){this._orders.set([]);return}this._loading.set(!0),this._error.set(null),this.subscription=this.datastore.subscribeToSeasonOrders(r,h).subscribe({next:e=>{let t=this.filterOrders(e);this._orders.set(t),this._loading.set(!1)},error:e=>{let t=e instanceof Error?e.message:String(e);this._error.set(t),this._loading.set(!1)}})}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}subscribeToOrder(s,r,e){this.unsubscribeOrder();let t=this.getActiveSeasonId();return t?(this.orderSubscription=this.datastore.subscribeToOrder(t,s).subscribe({next:r,error:e}),()=>this.unsubscribeOrder()):(e(new Error("No season selected")),()=>{})}unsubscribeOrder(){this.orderSubscription&&(this.orderSubscription.unsubscribe(),this.orderSubscription=null)}filterOrders(s){let r=this._activeFilter(),e=this._cachedServerTime();switch(r){case"overdue":return s.filter(t=>l(t)!=="submitted"||!t.lockExpiresAt?!1:new Date(t.lockExpiresAt)<new Date(e));case"locked":case"submitted":case"paid":return s.filter(t=>l(t)===r);case"all":default:return s}}async getOrder(s,r=!1){if(!r){let e=this._orders().find(t=>t.userAuthId===s);if(e)return e}this._loading.set(!0),this._error.set(null);try{let e=this.getActiveSeasonId();if(!e)throw new Error("No season selected");let t=await this.datastore.getUserSeasonOrder(e,s);if(!t)throw new Error(`Order not found for user: ${s}`);if(r){let i=this._orders(),a=i.findIndex(o=>o.userAuthId===s);if(a>=0){let o=[...i];o[a]=t,this._orders.set(o)}}return t}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||c)};static \u0275prov=u({token:c,factory:c.\u0275fac,providedIn:"root"})};export{b as a};
