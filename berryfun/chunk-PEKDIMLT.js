import{Oa as g,U as u,Y as d,Z as c,ea as h}from"./chunk-UBU22GLA.js";import{M as n,R as o,Tb as l,ha as s}from"./chunk-UKFGIOHC.js";var y=class a{functions=o(g);firestore=c(u());_users=s([]);_rebuiltAt=s(null);_rebuiltBy=s(null);_userCount=s(0);_loading=s(!1);_rebuilding=s(!1);_error=s(null);_isLoaded=s(!1);users=this._users.asReadonly();rebuiltAt=this._rebuiltAt.asReadonly();rebuiltBy=this._rebuiltBy.asReadonly();userCount=this._userCount.asReadonly();loading=this._loading.asReadonly();rebuilding=this._rebuilding.asReadonly();error=this._error.asReadonly();isLoaded=this._isLoaded.asReadonly();rebuiltAtFormatted=l(()=>{let e=this._rebuiltAt();return e?new Date(e).toLocaleString():null});async loadCache(){if(!this._isLoaded()){this._loading.set(!0),this._error.set(null);try{let e=d(this.firestore,"admin","userCache"),r=await h(e);if(r.exists()){let t=r.data();this._users.set(t.users),this._rebuiltAt.set(t.rebuiltAt),this._rebuiltBy.set(t.rebuiltBy),this._userCount.set(t.userCount)}else this._users.set([]),this._rebuiltAt.set(null),this._rebuiltBy.set(null),this._userCount.set(0);this._isLoaded.set(!0)}catch(e){console.error("Failed to load user cache:",e),this._error.set("Failed to load user cache"),this._users.set([])}finally{this._loading.set(!1)}}}async reloadCache(){this._isLoaded.set(!1),await this.loadCache()}searchUsers(e){let r=this._users();if(!e||e.trim().length===0)return r;let t=e.toLowerCase().trim();return r.filter(i=>!!(i.email.toLowerCase().includes(t)||i.displayName.toLowerCase().includes(t)||i.parentName.toLowerCase().includes(t)||i.studentNames.some(b=>b.toLowerCase().includes(t))||i.wechat?.toLowerCase().includes(t)))}getUserByAuthId(e){return this._users().find(r=>r.authId===e)}async rebuildCache(){this._rebuilding.set(!0),this._error.set(null);try{await this.functions.callApi("rebuildAdminUserCache",{}),await this.reloadCache()}catch(e){console.error("Failed to rebuild user cache:",e),this._error.set("Failed to rebuild user cache")}finally{this._rebuilding.set(!1)}}clearCache(){this._users.set([]),this._rebuiltAt.set(null),this._rebuiltBy.set(null),this._userCount.set(0),this._isLoaded.set(!1),this._error.set(null)}static \u0275fac=function(r){return new(r||a)};static \u0275prov=n({token:a,factory:a.\u0275fac,providedIn:"root"})};export{y as a};
