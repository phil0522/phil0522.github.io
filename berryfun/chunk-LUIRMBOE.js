import{a as $}from"./chunk-FWPBDQV6.js";import{b as C,c as w,d as U,e as L,f as Y,g as B}from"./chunk-WG3KNEG3.js";import{j as k,k as P,l as p,m as j,n as W,o as A,p as T,q,r as F,z}from"./chunk-6E4VX3TQ.js";import{U as I}from"./chunk-NA25QKA5.js";import{$ as c,F as M,G as N,I as D,L as f,Q as u,Qb as i,U as R,Z as y,a as g,b,f as h,ga as l,ha as _,i as O,ia as S,m as x}from"./chunk-C26OXKSD.js";function X(n){switch(n){case"submitted":return"Pending Payment";case"paid":return"Paid";case"cancelled":return"Cancelled";case"change_requested":return"Change Requested";case"refunded":return"Refunded";case"partial":return"Partially Paid";case"empty":return"Empty";default:return n}}function Z(n){switch(n){case"submitted":return"Pending";case"paid":return"Paid";case"cancelled":return"Cancelled";case"refunded":return"Refunded";default:return n}}function ee(n){return`$${(n/100).toFixed(2)}`}function te(n){return new Date(n).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0})}function re(n,e){let t=new Date(n),r=new Date(e),s=t.toLocaleDateString("en-US",{month:"short",day:"numeric"}),o=r.toLocaleDateString("en-US",{month:"short",day:"numeric"});return`${s} - ${o}`}var G=23;function H(n,e,t=G){if(n.isPromoted)return{isEligible:!0,hoursUntilEligible:null,reason:"promoted"};let r=new Date(n.joinedAt),o=(new Date(e).getTime()-r.getTime())/(1e3*60*60);return o>=t?{isEligible:!0,hoursUntilEligible:null,reason:"mature"}:{isEligible:!1,hoursUntilEligible:Math.ceil(t-o),reason:"not_mature"}}function E(n){n||(n=u(c));let e=new h(t=>{if(n.destroyed){t.next();return}return n.onDestroy(t.next.bind(t))});return t=>t.pipe(N(e))}function J(n,e){let t=e?.injector??u(y),r=new O(1),s=_(()=>{let o;try{o=n()}catch(a){S(()=>r.error(a));return}S(()=>r.next(o))},{injector:t,manualCleanup:!0});return t.get(c).onDestroy(()=>{s.destroy(),r.complete()}),r.asObservable()}function be(n,e){let r=!e?.manualCleanup?e?.injector?.get(c)??u(c):null,s=K(e?.equal),o;e?.requireSync?o=l({kind:0},{equal:s}):o=l({kind:1,value:e?.initialValue},{equal:s});let a,m=n.subscribe({next:d=>o.set({kind:1,value:d}),error:d=>{o.set({kind:2,error:d}),a?.()},complete:()=>{a?.()}});if(e?.requireSync&&o().kind===0)throw new D(601,!1);return a=r?.onDestroy(m.unsubscribe.bind(m)),i(()=>{let d=o();switch(d.kind){case 1:return d.value;case 2:throw d.error;case 0:throw new D(601,!1)}},{equal:e?.equal})}function K(n=Object.is){return(e,t)=>e.kind===1&&t.kind===1&&n(e.value,t.value)}var v=class n{db=new L(w(I()));firestore=w(I());async getUserSeasonOrder(e,t){let r=`years/${e}/orders`,s=await this.db.getDocument(r,t);return s?p.parse(s):null}subscribeToOrder(e,t){return new h(r=>{let s=C(this.firestore,`years/${e}/orders`,t),o=U(s,a=>{if(!a.exists()){r.next(null);return}try{let m=b(g({},a.data()),{id:a.id}),d=p.parse(m);r.next(d)}catch(m){r.error(m)}},a=>{r.error(a)});return()=>o()})}async listSeasonOrders(e,t){let r=`years/${e}/orders`;return(await this.db.getDocuments(r,[{field:"seasonId",op:"==",value:t}])).map(o=>p.parse(o))}async listYearOrders(e){let t=`years/${e}/orders`;return(await this.db.getDocuments(t)).map(s=>p.parse(s))}async listOrdersWithSubmittedItems(e){return(await this.listYearOrders(e)).filter(r=>r.items.some(s=>s.status==="submitted"))}async listOverdueOrders(e,t){let r=await this.listOrdersWithSubmittedItems(e),s=new Date(t);return r.filter(o=>o.lockExpiresAt?new Date(o.lockExpiresAt)<s:!1)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};var V=class n{datastore=u(v);rpc=u($);seasonDatastore=u(Y);seasonService=u(B);configService=u(z);destroyRef=u(c);injector=u(y);_order=l(null);_registration=l(null);_loading=l(!1);_error=l(null);_currentTime=i(()=>this.configService.currentTime());currentSeasonId=i(()=>this.seasonService.selectedSeason()?.id??null);orderSubscription=null;registrationSubscription=null;currentYear=null;currentUserAuthId=null;order=this._order.asReadonly();registration=this._registration.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();items=i(()=>this._order()?.items??[]);submittedItems=i(()=>{let e=this._order();return e?j(e):[]});paidItems=i(()=>{let e=this._order();return e?W(e):[]});cancelledItems=i(()=>this.items().filter(e=>e.status==="cancelled"));submittedCount=i(()=>this.submittedItems().length);paidCount=i(()=>this.paidItems().length);hasSubmittedItems=i(()=>this.submittedItems().length>0);hasPaidItems=i(()=>this.paidItems().length>0);waitlistEntries=i(()=>this._order()?.waitlist??[]);waitlistEntriesWithEligibility=i(()=>{let e=this.waitlistEntries(),t=this._registration(),r=this._currentTime();return e.map(s=>{let o=H(s,r),a=t?k(t,s.sessionId):0;return b(g({},s),{eligibility:o,isClaimable:o.isEligible&&a>0,claimableSpots:a})})});eligibleWaitlistEntries=i(()=>this.waitlistEntriesWithEligibility().filter(e=>e.eligibility.isEligible));claimableWaitlistEntries=i(()=>this.waitlistEntriesWithEligibility().filter(e=>e.isClaimable));waitlistCount=i(()=>this.waitlistEntries().length);claimableCount=i(()=>this.claimableWaitlistEntries().length);pricing=i(()=>this._order()?.pricing??null);totalDue=i(()=>{let e=this.pricing();return e?P(e):0});totalDiscountAmount=i(()=>{let e=this.pricing();return e?e.discounts.reduce((t,r)=>t+r.amount,0):0});totalPaid=i(()=>this._order()?.totalPaid??0);totalRefunded=i(()=>{let e=this._order();return e?(e.refunds??[]).reduce((t,r)=>t+r.amount,0):0});amountDue=i(()=>{let e=this._order();return e?q(e):0});payments=i(()=>this._order()?.payments??[]);isFullyPaid=i(()=>this.amountDue()<=0&&this.totalPaid()>0);lockExpiresAt=i(()=>this._order()?.lockExpiresAt??null);isOverdue=i(()=>{let e=this._order();return e?F(e,this._currentTime()):!1});hoursUntilLockExpires=i(()=>{let e=this.lockExpiresAt();if(!e)return null;let t=new Date(this._currentTime()),s=(new Date(e).getTime()-t.getTime())/(1e3*60*60);return s>0?Math.ceil(s):null});initialize(e,t){this.cleanup(),this.currentYear=e,this.currentUserAuthId=t,this._loading.set(!0),this._error.set(null),this.orderSubscription=this.datastore.subscribeToOrder(e,t).pipe(E(this.destroyRef)).subscribe({next:r=>{this._order.set(r),this._loading.set(!1)},error:r=>{this._error.set(r.message),this._loading.set(!1)}}),R(this.injector,()=>{this.registrationSubscription=J(this.seasonService.selectedSeason).pipe(E(this.destroyRef),M(r=>r?this.seasonDatastore.subscribeToRegistration(e,r.id):x(null))).subscribe({next:r=>{this._registration.set(r)},error:r=>{console.error("Failed to load registration:",r)}})})}cleanup(){this.orderSubscription?.unsubscribe(),this.orderSubscription=null,this.registrationSubscription?.unsubscribe(),this.registrationSubscription=null,this._order.set(null),this._registration.set(null),this.currentYear=null,this.currentUserAuthId=null}hasActiveEnrollment(e,t){let r=this._order();return r?A(r,e,t):!1}isOnWaitlist(e){let t=this._order();return t?T(t,e):!1}getWaitlistEntry(e){return this.waitlistEntries().find(t=>t.sessionId===e)??null}getEnrolledSessionIds(e){return this.items().filter(t=>t.studentId===e&&(t.status==="submitted"||t.status==="paid")).map(t=>t.sessionId)}getOrderItem(e,t){return this.items().find(r=>r.sessionId===e&&r.studentId===t)??null}async recordPayment(e,t,r,s){if(!this.currentYear||!this.currentUserAuthId)throw new Error("Order not initialized");let o={year:this.currentYear,userAuthId:this.currentUserAuthId,amount:e,reference:t,method:r,notes:s};await this.rpc.recordPayment(o)}async cancelItems(e,t){if(!this.currentYear)throw new Error("Order not initialized");let r={year:this.currentYear,items:e,reason:t};await this.rpc.cancelItems(r)}async joinWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.joinWaitlist({seasonId:t,sessionId:e})}async leaveWaitlist(e){let t=this.currentSeasonId();if(!t)throw new Error("No season selected");await this.rpc.leaveWaitlist({seasonId:t,sessionId:e})}clearError(){this._error.set(null)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};export{E as a,be as b,X as c,Z as d,ee as e,te as f,re as g,V as h};
