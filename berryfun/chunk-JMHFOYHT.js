import{l as R}from"./chunk-AAZ7ILIH.js";import{C as p,Ia as _,W as P,Y as H,t as E,v as w}from"./chunk-HB4R6T7X.js";import{a as M}from"./chunk-EPAU2WC6.js";import{T,p as S,q as u,y as D}from"./chunk-RLRP2YP4.js";import{K as f}from"./chunk-2NRCXSDQ.js";import{I as y,N as g,Rb as C,c as m,da as l}from"./chunk-WXZFQYIJ.js";var b=class c{db=new R(p(f()));async getSeason(s){let e=`years/${2026}/seasons`,t=await this.db.getDocument(e,s);return t?u(S.parse(t)):null}async listActiveSeasons(){let s=`years/${2026}/seasons`;return(await this.db.getDocuments(s,[{field:"isActive",op:"==",value:!0}])).map(t=>u(S.parse(t))).sort((t,r)=>t.startDate.localeCompare(r.startDate))}async listAllSeasons(){let s=`years/${2026}/seasons`;return(await this.db.getDocuments(s)).map(t=>u(S.parse(t))).sort((t,r)=>t.startDate.localeCompare(r.startDate))}async getRegistration(s){let e=`years/${2026}/registrations`,t=await this.db.getDocument(e,s);return t?D.parse(t):null}subscribeToRegistration(s){let e=p(f());return new m(t=>{let r=w(e,`years/${2026}/registrations`,s),a=_(r,n=>{if(!n.exists()){t.next(null);return}try{let o=n.data(),i=D.parse(o);t.next(i)}catch(o){console.error("Failed to parse registration:",o),t.error(o)}},n=>{console.error("Registration subscription error:",n),t.error(n)});return()=>a()})}subscribeToSeason(s){let e=p(f());return new m(t=>{let r=w(e,`years/${2026}/seasons`,s),a=_(r,n=>{if(!n.exists()){t.next(null);return}try{let o=n.data(),i=u(S.parse(o));t.next(i)}catch(o){console.error("Failed to parse season:",o),t.error(o)}},n=>{console.error("Season subscription error:",n),t.error(n)});return()=>a()})}subscribeToActiveSeasons(){let s=p(f());return new m(e=>{let t=E(s,`years/${2026}/seasons`),r=P(t,H("isActive","==",!0)),a=_(r,n=>{try{let o=[];n.docs.forEach(i=>{try{let h=u(S.parse(i.data()));o.push(h)}catch(h){console.error("Failed to parse season document:",h)}}),o.sort((i,h)=>i.startDate.localeCompare(h.startDate)),e.next(o)}catch(o){console.error("Failed to process seasons snapshot:",o),e.error(o)}},n=>{console.error("Active seasons subscription error:",n),e.error(n)});return()=>a()})}async getClass(s){let e=await this.listAllSeasons();for(let t of e){let r=t.sessions?.find(a=>a.id===s);if(r)return r}return null}async listClassesBySeason(s,e=!0){let t=await this.getSeason(s);if(!t||!t.sessions)return[];let r=t.sessions;return e&&(r=r.filter(a=>a.isActive)),r.sort((a,n)=>a.startDate.localeCompare(n.startDate))}async listClassesByYear(s=!0){let e=await this.listAllSeasons(),t=[];for(let r of e)if(r.sessions)for(let a of r.sessions)(!s||a.isActive)&&t.push(a);return t.sort((r,a)=>r.startDate.localeCompare(a.startDate))}static \u0275fac=function(e){return new(e||c)};static \u0275prov=y({token:c,factory:c.\u0275fac,providedIn:"root"})};var v=class c{functions=g(T);_loading=l(!1);_error=l(null);loading=this._loading.asReadonly();error=this._error.asReadonly();clearError(){this._error.set(null)}async wrapCall(s,e){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(s,e)}catch(t){let r=t instanceof Error?t.message:String(t);throw this._error.set(r),t}finally{this._loading.set(!1)}}async wrapApiCall(s,e){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(s,e)}catch(t){let r=t instanceof Error?t.message:String(t);throw this._error.set(r),t}finally{this._loading.set(!1)}}async listAllSeasons(s){return this.wrapCall("listAllSeasons",{year:s})}async listAllClasses(s){return this.wrapCall("listAllClasses",{year:s})}async createSeason(s){return this.wrapApiCall("createSeason",s)}async updateSeason(s,e){return this.wrapApiCall("updateSeason",{seasonId:s,updates:e})}async createClass(s){return this.wrapApiCall("createClass",s)}async updateClass(s,e){return this.wrapApiCall("updateClass",{sessionId:s,updates:e})}static \u0275fac=function(e){return new(e||c)};static \u0275prov=y({token:c,factory:c.\u0275fac,providedIn:"root"})};var A="berryfun_selected_season",L=class c{datastore=g(b);rpc=g(v);configService=g(M);seasonsSubscription=null;subscribedYear=null;_seasons=l([]);_classes=l([]);_selectedSeason=l(null);_selectedClass=l(null);_loading=l(!1);_error=l(null);_actionLoading=l(!1);_actionError=l(null);seasons=this._seasons.asReadonly();classes=this._classes.asReadonly();selectedSeason=this._selectedSeason.asReadonly();selectedClass=this._selectedClass.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();hasSeasons=C(()=>this._seasons().length>0);hasClasses=C(()=>this._classes().length>0);ngOnDestroy(){this.unsubscribeAll()}unsubscribeAll(){this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=null}async loadSeasons(){let s=2026;if(!(this.subscribedYear===s&&this.seasonsSubscription))return this._loading.set(!0),this._error.set(null),this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=s,new Promise((e,t)=>{let r=!0;this.seasonsSubscription=this.datastore.subscribeToActiveSeasons().subscribe({next:a=>{this._seasons.set(a),this._loading.set(!1),!this._selectedSeason()&&a.length>0&&this._selectedSeason.set(a[0]);let n=this._selectedSeason();if(n){let o=a.find(i=>i.id===n.id);o?(this._selectedSeason.set(o),this._classes.set(o.sessions?.filter(i=>i.isActive).sort((i,h)=>i.startDate.localeCompare(h.startDate))||[])):this._selectedSeason.set(a[0]||null)}r&&(r=!1,e())},error:a=>{let n=a instanceof Error?a.message:String(a);this._error.set(n),this._loading.set(!1),r&&(r=!1,t(a))}})})}async loadClassesBySeason(s){if(this.subscribedYear===2026&&this.seasonsSubscription){let e=this._seasons().find(t=>t.id===s);if(e){let t=e.sessions?.filter(r=>r.isActive).sort((r,a)=>r.startDate.localeCompare(a.startDate))||[];this._classes.set(t);return}}this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.listClassesBySeason(s);this._classes.set(e)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async loadClassesByYear(){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listClassesByYear();this._classes.set(s)}catch(s){let e=s instanceof Error?s.message:String(s);throw this._error.set(e),s}finally{this._loading.set(!1)}}async loadClass(s){this._loading.set(!0),this._error.set(null);try{let e=await this.datastore.getClass(s);if(e)this._selectedClass.set(e);else throw new Error(`Class not found: ${s}`)}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}selectSeason(s){this._selectedSeason.set(s),this.saveSelectedSeasonId(s?.id??null)}getLastSelectedSeasonId(){try{return localStorage.getItem(A)}catch{return null}}saveSelectedSeasonId(s){try{s?localStorage.setItem(A,s):localStorage.removeItem(A)}catch{}}selectClass(s){this._selectedClass.set(s)}async getClassById(s){let e=this._classes().find(t=>t.id===s);if(e)return e;try{return await this.datastore.getClass(s)}catch{return null}}calculatePrice(s,e){let r=this.configService.config().currentDate,a=s.basePrice;if(s.earlyBirdTiers&&s.earlyBirdTiers.length>0){let n=s.earlyBirdTiers.find(o=>r<=o.deadline);n&&(a=n.price)}return e.includeLunch&&(a+=s.lunchPrice),e.includeExtendedCare&&(a+=s.extendedCarePrice),a}formatPrice(s){return`$${(s/100).toFixed(2)}`}clearError(){this._error.set(null)}reset(){this.unsubscribeAll(),this._seasons.set([]),this._classes.set([]),this._selectedSeason.set(null),this._selectedClass.set(null),this._error.set(null)}async refreshCatalog(){this.subscribedYear=null,await this.loadSeasons()}async loadAllSeasons(){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listAllSeasons();this._seasons.set(s)}catch(s){let e=s instanceof Error?s.message:String(s);throw this._error.set(e),s}finally{this._loading.set(!1)}}async loadAllClasses(){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listClassesByYear(!1);this._classes.set(s)}catch(s){let e=s instanceof Error?s.message:String(s);throw this._error.set(e),s}finally{this._loading.set(!1)}}async createSeason(s){this._actionLoading.set(!0),this._actionError.set(null);try{let e=await this.rpc.createSeason(s),t=u(e);return this._seasons.update(r=>[...r,t]),t}catch(e){let t=e instanceof Error?e.message:String(e);throw this._actionError.set(t),e}finally{this._actionLoading.set(!1)}}async updateSeason(s,e){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateSeason(s,e),r=u(t);return this._seasons.update(a=>a.map(n=>n.id===s?r:n)),r}catch(t){let r=t instanceof Error?t.message:String(t);throw this._actionError.set(r),t}finally{this._actionLoading.set(!1)}}async createClass(s){this._actionLoading.set(!0),this._actionError.set(null);try{let e=await this.rpc.createClass(s);return this._classes.update(t=>[...t,e]),e}catch(e){let t=e instanceof Error?e.message:String(e);throw this._actionError.set(t),e}finally{this._actionLoading.set(!1)}}async updateClass(s,e){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateClass(s,e);return this._classes.update(r=>r.map(a=>a.id===s?t:a)),t}catch(t){let r=t instanceof Error?t.message:String(t);throw this._actionError.set(r),t}finally{this._actionLoading.set(!1)}}async toggleSeasonActive(s){let e=this._seasons().find(t=>t.id===s);e&&await this.updateSeason(s,{isActive:!e.isActive})}async toggleClassActive(s){let e=this._classes().find(t=>t.id===s);e&&await this.updateClass(s,{isActive:!e.isActive})}getSeason(s){return this._seasons().find(e=>e.id===s)}getClass(s){return this._classes().find(e=>e.id===s)}static \u0275fac=function(e){return new(e||c)};static \u0275prov=y({token:c,factory:c.\u0275fac,providedIn:"root"})};export{b as a,L as b};
