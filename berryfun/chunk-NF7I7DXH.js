import{g as E}from"./chunk-OD6KCV5K.js";import{a as b}from"./chunk-FYGYBRKK.js";import{b as _}from"./chunk-NR6WXTS5.js";import{a as I}from"./chunk-EUESG25O.js";import{b as D}from"./chunk-3NM435RE.js";import{Ba as y,Ka as S}from"./chunk-UIQMLXH2.js";import{M as m,R as p,Sb as a,a as g,b as h,ha as l,ia as v}from"./chunk-6GAPJCXB.js";function w(){return`cart-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function L(o,e){let t=new Date(o),s=new Date(e),r=t.toLocaleDateString("en-US",{month:"short",day:"numeric"}),n=s.toLocaleDateString("en-US",{month:"short",day:"numeric"});return`${r} - ${n}`}function k(o){if(!o||typeof o!="object")return!1;let e=o;if(e.details?.code==="CAPACITY_EXCEEDED")return!0;if(!(e.message??e.error?.message??"").toLowerCase().includes("full"))return!1;let s=(e.code??"").toLowerCase(),r=(e.status??e.error?.status??"").toLowerCase().replace(/_/g,"-");return s==="resource-exhausted"||s==="functions/resource-exhausted"||s==="failed-precondition"||r==="resource-exhausted"}function j(o){return!o||typeof o!="object"?[]:o.details?.failedItems??[]}function O(o){if(!o||typeof o!="object")return"";let e=o;return e.message??e.error?.message??""}var f=class o{functions=p(S);_seasonCoupons=l([]);_userCoupons=l([]);_selectedUserCouponIds=l([]);_loading=l(!1);_validating=l(!1);_error=l(null);seasonCoupons=this._seasonCoupons.asReadonly();userCoupons=this._userCoupons.asReadonly();selectedUserCouponIds=this._selectedUserCouponIds.asReadonly();loading=this._loading.asReadonly();validating=this._validating.asReadonly();error=this._error.asReadonly();couponsToApply=a(()=>[...this._seasonCoupons(),...this._userCoupons().filter(e=>this._selectedUserCouponIds().includes(e.id))]);totalCouponCredit=a(()=>this.couponsToApply().reduce((e,t)=>e+t.maxCreditCents,0));hasAvailableCoupons=a(()=>this._seasonCoupons().length>0||this._userCoupons().length>0);async loadCoupons(e){this._loading.set(!0),this._error.set(null);try{let t=await this.functions.callApi("getUserAvailableCoupons",{seasonId:e});this._seasonCoupons.set(t.seasonCoupons),this._userCoupons.set(t.userCoupons),this._selectedUserCouponIds.set(t.userCoupons.map(s=>s.id))}catch(t){console.error("Failed to load coupons:",t),this._error.set("Failed to load coupons"),this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([])}finally{this._loading.set(!1)}}toggleCoupon(e){let t=this._selectedUserCouponIds();t.includes(e)?this._selectedUserCouponIds.set(t.filter(s=>s!==e)):this._selectedUserCouponIds.set([...t,e])}isCouponSelected(e){return this._selectedUserCouponIds().includes(e)}clearCoupons(){this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([]),this._error.set(null)}getSelectedCouponIds(){return this._selectedUserCouponIds()}async validateAndAddCoupon(e){this._validating.set(!0);try{let s=(await this.functions.callApi("validateAndAddCoupon",{couponId:e})).coupon;return this._userCoupons().map(n=>n.id).includes(s.id)||(this._userCoupons.update(n=>[...n,s]),this._selectedUserCouponIds.update(n=>[...n,s.id])),{success:!0,coupon:s}}catch(t){return{success:!1,error:t.message||"Failed to validate coupon"}}finally{this._validating.set(!1)}}static \u0275fac=function(t){return new(t||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var N="berryfun_cart_",A="__berryfun_storage_test__",C=class o{getStorageKey(e,t){return`${N}${e}_${t}`}saveCart(e,t,s){try{let r={items:s,savedAt:Date.now()},n=this.getStorageKey(e,t);localStorage.setItem(n,JSON.stringify(r))}catch(r){console.warn("Failed to save cart to localStorage:",r)}}loadCart(e,t){try{let s=this.getStorageKey(e,t),r=localStorage.getItem(s);if(!r)return null;let n=JSON.parse(r);return this.isValidPersistedCartData(n)?n:(this.clearCart(e,t),null)}catch(s){console.warn("Failed to load cart from localStorage:",s);try{this.clearCart(e,t)}catch{}return null}}clearCart(e,t){try{let s=this.getStorageKey(e,t);localStorage.removeItem(s)}catch(s){console.warn("Failed to clear cart from localStorage:",s)}}isStorageAvailable(){try{return localStorage.setItem(A,"test"),localStorage.removeItem(A),!0}catch{return!1}}isValidPersistedCartData(e){if(typeof e!="object"||e===null)return!1;let t=e;return!(!Array.isArray(t.items)||typeof t.savedAt!="number")}static \u0275fac=function(t){return new(t||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var P=class o{orderRpc=p(_);orderService=p(E);seasonService=p(b);configService=p(I);couponService=p(f);persistenceService=p(C);userService=p(D);_items=l([]);_pricing=l(null);_pricingLoading=l(!1);_pricingError=l(null);_submitting=l(!1);_submitError=l(null);currentSeason=a(()=>this.seasonService.selectedSeason());currentUserId=a(()=>this.userService.currentUser()?.uid??null);previousUserId=null;previousSeasonId=null;constructor(){v(()=>{let e=this.currentUserId(),t=this.currentSeason()?.id??null;if(!e||!t){this.previousUserId=e,this.previousSeasonId=t;return}let s=this.previousUserId!==e,r=this.previousSeasonId!==t;(s||r)&&this.loadCartFromStorage(e,t),this.previousUserId=e,this.previousSeasonId=t})}items=this._items.asReadonly();pricing=this._pricing.asReadonly();pricingLoading=this._pricingLoading.asReadonly();pricingError=this._pricingError.asReadonly();submitting=this._submitting.asReadonly();submitError=this._submitError.asReadonly();loading=this.orderRpc.loading;seasonCoupons=this.couponService.seasonCoupons;userCoupons=this.couponService.userCoupons;selectedCouponIds=this.couponService.selectedUserCouponIds;couponsLoading=this.couponService.loading;couponsValidating=this.couponService.validating;couponsError=this.couponService.error;hasAvailableCoupons=this.couponService.hasAvailableCoupons;couponsToApply=this.couponService.couponsToApply;totalCouponCredit=this.couponService.totalCouponCredit;_couponValidationError=l(null);_couponValidationSuccess=l(null);couponValidationError=this._couponValidationError.asReadonly();couponValidationSuccess=this._couponValidationSuccess.asReadonly();_referralEmailsRaw=l("");referralEmailsRaw=this._referralEmailsRaw.asReadonly();referralEmailList=a(()=>{let e=this._referralEmailsRaw();return e.trim()?[...new Set(e.split(/[\n,]/).map(t=>t.trim().toLowerCase()).filter(Boolean))]:[]});referralEmailCount=a(()=>this.referralEmailList().length);itemCount=a(()=>this._items().length);hasItems=a(()=>this._items().length>0);isEmpty=a(()=>this._items().length===0);uniqueClassCount=a(()=>new Set(this._items().map(t=>t.class.id)).size);uniqueStudentCount=a(()=>new Set(this._items().flatMap(t=>t.students.map(s=>s.id))).size);totalEnrollmentCount=a(()=>this._items().reduce((e,t)=>e+t.students.length,0));itemsMissingStudents=a(()=>this._items().filter(e=>e.students.length===0));itemsMissingStudentsCount=a(()=>this.itemsMissingStudents().length);allStudentsAssigned=a(()=>this._items().every(e=>e.students.length>0));isReadyToSubmit=a(()=>this.hasItems()&&this.allStudentsAssigned()&&!this._submitting());subtotal=a(()=>this._pricing()?.subtotal??0);discounts=a(()=>this._pricing()?.discounts??[]);totalDiscountAmount=a(()=>this.discounts().reduce((e,t)=>e+t.amount,0));total=a(()=>{let e=this._pricing();if(!e)return 0;let t=e.discounts.reduce((s,r)=>s+r.amount,0);return Math.max(0,e.subtotal+t)});addToCart(e,t=[],s={lunch:!0,extendedCare:!1},r=!1){let n=this.currentSeason()?.id??"";if(e.seasonId!==n)throw new Error("Cannot add classes from different seasons. Please complete or clear your current cart first.");if(this.isClassInCart(e.id))throw new Error("This class is already in your cart");for(let u of t)this.validateStudentNotEnrolled(e.id,u.id);let d=g({id:w(),class:e,students:t,options:s},r&&{isWaitlistClaim:!0});return this._items.update(u=>[...u,d]),this.persistCart(),t.length>0&&this.refreshPricing(),d.id}removeFromCart(e){this._items.update(t=>t.filter(s=>s.id!==e)),this.persistCart(),this._items().length>0?this.refreshPricing():this._pricing.set(null)}toggleStudent(e,t){let s=this._items().find(n=>n.id===e);if(!s)return;let r=s.students.some(n=>n.id===t.id);if(!r&&(this.validateStudentNotEnrolled(s.class.id,t.id),this.isStudentInCartForClass(s.class.id,t.id)))throw new Error("This student is already in the cart for this class");this._items.update(n=>n.map(d=>{if(d.id!==e)return d;let u=r?d.students.filter(i=>i.id!==t.id):[...d.students,t];return h(g({},d),{students:u})})),this.persistCart(),this.refreshPricing()}updateItemOptions(e,t){this._items.update(s=>s.map(r=>r.id===e?h(g({},r),{options:g(g({},r.options),t)}):r)),this.persistCart(),this.refreshPricing()}clearCart(){this._items.set([]),this._pricing.set(null),this._pricingError.set(null),this._submitError.set(null),this._referralEmailsRaw.set(""),this.couponService.clearCoupons(),this.persistCart()}async loadCoupons(){let e=this.currentSeason()?.id;e&&await this.couponService.loadCoupons(e)}toggleCoupon(e){this.couponService.toggleCoupon(e)}isCouponSelected(e){return this.couponService.isCouponSelected(e)}async validateAndAddCoupon(e){this._couponValidationError.set(null),this._couponValidationSuccess.set(null);let t=await this.couponService.validateAndAddCoupon(e);t.success&&t.coupon?(this._couponValidationSuccess.set(`Coupon "${t.coupon.name}" added!`),setTimeout(()=>this._couponValidationSuccess.set(null),3e3),this.refreshPricing()):(this._couponValidationError.set(t.error||"Failed to add coupon"),setTimeout(()=>this._couponValidationError.set(null),5e3))}setReferralEmails(e){this._referralEmailsRaw.set(e),this.refreshPricing()}isClassInCart(e){return this._items().some(t=>t.class.id===e)}isStudentInCartForClass(e,t){return this._items().some(s=>s.class.id===e&&s.students.some(r=>r.id===t))}isStudentSelected(e,t){return this._items().find(r=>r.id===e)?.students.some(r=>r.id===t)??!1}getCartItem(e){return this._items().find(t=>t.id===e)??null}getCartItemForClass(e){return this._items().find(t=>t.class.id===e)??null}refreshPricing(){let e=this._items();if(e.length===0){this._pricing.set(null);return}if(!this.allStudentsAssigned()){this._pricing.set(null);return}let t=this.currentSeason();if(!t){this._pricingError.set("Season not set");return}this._pricingError.set(null);try{let s=new Map;for(let i of e)s.has(i.class.id)||s.set(i.class.id,{id:i.class.id,basePrice:i.class.basePrice,lunchPrice:i.class.lunchPrice,extendedCarePrice:i.class.extendedCarePrice,earlyBirdTiers:i.class.earlyBirdTiers??[]});let r=e.flatMap(i=>i.students.map(c=>({sessionId:i.class.id,studentId:c.id,options:i.options}))),n=new Set;for(let i of e)for(let c of i.students)c.lastCampYear&&n.add(c.id);let d=this.userService.students()[0]?.id,u=y.calculateCartPricing({items:r,sessionLookup:s,currentDate:this.configService.currentDate(),discountConfig:h(g({siblingDiscountPerWeek:t.siblingDiscountPerWeek??0,multiSessionDiscountTiers:t.multiSessionDiscounts??[],returningStudentIds:n},d!==void 0&&{firstStudentId:d}),{referralEmailCount:this.referralEmailCount()})});this._pricing.set(u)}catch(s){let r=s instanceof Error?s.message:String(s);this._pricingError.set(r)}}async submit(){let e=this._items();if(e.length===0)throw new Error("Cart is empty");if(!this.allStudentsAssigned())throw new Error("Please select a student for all classes");let t=this.currentSeason()?.id;if(!t)throw new Error("Season not set");this._submitting.set(!0),this._submitError.set(null);try{let s=e.flatMap(u=>u.students.map(i=>({sessionId:u.class.id,studentId:i.id,options:u.options}))),r=this.couponService.getSelectedCouponIds(),n=this.referralEmailList().join(","),d=await this.orderRpc.submitItems({seasonId:t,items:s,selectedCouponIds:r,referralEmails:n});return this.clearPersistedCart(),this.clearCart(),d}catch(s){let r=s instanceof Error?s.message:String(s);throw this._submitError.set(r),s}finally{this._submitting.set(!1)}}clearPricingError(){this._pricingError.set(null)}clearSubmitError(){this._submitError.set(null)}clearAllErrors(){this._pricingError.set(null),this._submitError.set(null)}validateStudentNotEnrolled(e,t){if(this.orderService.hasActiveEnrollment(e,t))throw new Error("This student is already enrolled in this class")}loadCartFromStorage(e,t){let s=this.persistenceService.loadCart(e,t);if(s&&s.items.length>0){let r=this.validateCartItems(s.items);this._items.set(r);let n=s.items.reduce((i,c)=>i+(c.students?.length??0),0),d=r.reduce((i,c)=>i+c.students.length,0);(r.length!==s.items.length||d!==n)&&this.persistCart(),r.some(i=>i.students.length>0)&&this.refreshPricing()}else this._items.set([]),this._pricing.set(null)}validateCartItems(e){let t=this.currentSeason(),s=new Set(t?.sessions?.map(n=>n.id)??[]),r=s.size>0;return e.filter(n=>!(!n||!n.class||!n.class.id||r&&!s.has(n.class.id))).map(n=>{let d=n.students.filter(u=>!this.orderService.hasActiveEnrollment(n.class.id,u.id));return h(g({},n),{students:d})}).filter(n=>{let d=e.find(c=>c.id===n.id);return d&&d.students.length>0&&n.students.length===0?(console.info(`[CartStore] Removing cart item for class "${n.class.name}" - all students already enrolled`),!1):!0})}persistCart(){let e=this.currentUserId(),t=this.currentSeason()?.id;!e||!t||this.persistenceService.saveCart(e,t,this._items())}clearPersistedCart(){let e=this.currentUserId(),t=this.currentSeason()?.id;!e||!t||this.persistenceService.clearCart(e,t)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{L as a,k as b,j as c,O as d,P as e};
