import{a as O}from"./chunk-AL5BDSXP.js";import{a as y,b as p}from"./chunk-QZAU5TJD.js";import{a as S}from"./chunk-7IUDPLYJ.js";import{Ca as v,Da as f,Ea as m,Ha as l}from"./chunk-7QJVSJKI.js";import{M as _,R as c,Sb as d,ha as a}from"./chunk-6GAPJCXB.js";var h=15,M=class u{datastore=c(y);rpc=c(p);configService=c(S);seasonService=c(O);_orders=a([]);_loading=a(!1);_error=a(null);_activeFilter=a("all");_cursor=a(null);_hasMore=a(!1);_loadingMore=a(!1);_actionLoading=a(!1);_actionError=a(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();orderCount=d(()=>this._orders().length);pendingCount=d(()=>this._orders().filter(e=>l(e)==="submitted").length);overdueCount=d(()=>this._orders().filter(e=>this.isOverdue(e)).length);changeRequestCount=d(()=>this._orders().filter(e=>e.changeRequests&&e.changeRequests.some(t=>t.status==="pending")).length);paidCount=d(()=>this._orders().filter(e=>l(e)==="paid").length);cancelledCount=d(()=>this._orders().filter(e=>{let t=l(e);return t==="cancelled"||t==="refunded"}).length);filteredOrders=d(()=>{let e=this._orders();switch(this._activeFilter()){case"pending":return e.filter(r=>l(r)==="submitted");case"overdue":return e.filter(r=>this.isOverdue(r));case"change_requested":return e.filter(r=>r.changeRequests&&r.changeRequests.some(s=>s.status==="pending"));case"paid":return e.filter(r=>l(r)==="paid");case"cancelled":return e.filter(r=>{let s=l(r);return s==="cancelled"||s==="refunded"});default:return e}});setFilter(e){this._activeFilter.set(e),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(e){this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let t=this.configService.currentActiveYear(),r=e??this.getActiveSeasonId();if(!r){this._orders.set([]);return}let s=this._activeFilter(),i=this.filterToOrderStatus(s),o=i?await this.datastore.listOrdersByStatusPaginated(t,r,i,h):await this.datastore.listOrdersPaginated(t,r,h);this._orders.set(o.orders),this._cursor.set(o.lastDoc),this._hasMore.set(o.hasMore)}catch(t){let r=t instanceof Error?t.message:String(t);throw this._error.set(r),t}finally{this._loading.set(!1)}}async loadMore(e){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let t=this.configService.currentActiveYear(),r=e??this.getActiveSeasonId();if(!r)return;let s=this._activeFilter(),i=this.filterToOrderStatus(s),o=this._cursor(),n=i?await this.datastore.listOrdersByStatusPaginated(t,r,i,h,o):await this.datastore.listOrdersPaginated(t,r,h,o);this._orders.update(g=>[...g,...n.orders]),this._cursor.set(n.lastDoc),this._hasMore.set(n.hasMore)}catch(t){let r=t instanceof Error?t.message:String(t);throw this._error.set(r),t}finally{this._loadingMore.set(!1)}}}filterToOrderStatus(e){switch(e){case"pending":return"submitted";case"paid":return"paid";case"cancelled":return"cancelled";default:return null}}getActiveSeasonId(){return this.seasonService.selectedSeason()?.id??null}async loadAllOrders(e,t){this._loading.set(!0),this._error.set(null);try{let r=this.configService.currentActiveYear(),s=await this.datastore.listYearOrders(r);e&&(s=s.filter(i=>l(i)===e)),s.sort((i,o)=>new Date(o.createdAt).getTime()-new Date(i.createdAt).getTime()),t&&t>0&&(s=s.slice(0,t)),this._orders.set(s)}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let e=this.configService.currentActiveYear(),t=this.configService.currentTime(),r=await this.datastore.listOverdueOrders(e,t);this._orders.set(r),this._activeFilter.set("overdue")}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async loadChangeRequests(){this._loading.set(!0),this._error.set(null);try{let e=this.configService.currentActiveYear(),t=await this.datastore.listOrdersWithChangeRequests(e);this._orders.set(t),this._activeFilter.set("change_requested")}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async recordPayment(e,t,r,s,i="zelle",o){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.recordPayment({year:e,userAuthId:t,amount:r,reference:s,method:i,notes:o}),await this.loadAllOrders()}catch(n){let g=n instanceof Error?n.message:String(n);throw this._actionError.set(g),n}finally{this._actionLoading.set(!1)}}async cancelOrder(e,t,r){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(e,t,r),await this.loadAllOrders()}catch(s){let i=s instanceof Error?s.message:String(s);throw this._actionError.set(i),s}finally{this._actionLoading.set(!1)}}isOverdue(e){return v(e,this._cachedServerTime())}isLockExpiringSoon(e){return f(e,this._cachedServerTime(),12)}getRemainingLockTime(e){return m(e,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}async getOrder(e){let t=this._orders().find(r=>r.userAuthId===e);if(t)return t;this._loading.set(!0),this._error.set(null);try{let r=this.configService.currentActiveYear(),s=await this.datastore.getUserSeasonOrder(r,e);if(!s)throw new Error(`Order not found for user: ${e}`);return s}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}static \u0275fac=function(t){return new(t||u)};static \u0275prov=_({token:u,factory:u.\u0275fac,providedIn:"root"})};export{M as a};
