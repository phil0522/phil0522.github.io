import{Y as h}from"./chunk-NA25QKA5.js";import{L as c,Q as u,Qb as o,a as i,b as l,ga as a}from"./chunk-C26OXKSD.js";var g=class d{functions=u(h);_loading=a(!1);_error=a(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async createUser(t){return this.wrapCall("createUserAccount",t)}async updateUser(t){return this.wrapCall("updateUserProfile",t)}async createStudent(t){return this.wrapCall("createStudent",t)}async updateStudent(t){return this.wrapCall("updateStudent",t)}async deleteStudent(t){return this.wrapCall("deleteStudent",{studentId:t})}async getUserProfile(t){return this.wrapCall("getUserProfile",{uid:t})}clearError(){this._error.set(null)}async wrapCall(t,e){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(t,e)}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}static \u0275fac=function(e){return new(e||d)};static \u0275prov=c({token:d,factory:d.\u0275fac,providedIn:"root"})};var f=class d{rpc=u(g);functionsClient=u(h);_currentUser=a(null);_loading=a(!1);_error=a(null);_isAdmin=a(!1);_users=a([]);_selectedUser=a(null);_searchQuery=a("");_actionLoading=a(!1);_actionError=a(null);currentUser=this._currentUser.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();users=this._users.asReadonly();selectedUser=this._selectedUser.asReadonly();searchQuery=this._searchQuery.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();isAuthenticated=o(()=>this._currentUser()!==null);userCount=o(()=>this._users().length);hasUsers=o(()=>this._users().length>0);students=o(()=>this._currentUser()?.students??[]);studentCount=o(()=>this.students().length);hasStudents=o(()=>this.students().length>0);isProfileComplete=o(()=>{let t=this._currentUser();if(!t)return!1;let e=t.contactInfo;if(!e)return!1;let r=!!e.phone,s=!!e.address?.street&&!!e.address?.city&&!!e.address?.state&&!!e.address?.zipCode,n=!!e.emergencyContact?.name&&!!e.emergencyContact?.phone&&!!e.emergencyContact?.relationship;return r&&s&&n});isAdmin=this._isAdmin.asReadonly();async createUser(t){this._loading.set(!0),this._error.set(null);try{return await this.rpc.createUser(t)}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async updateProfile(t){this._loading.set(!0),this._error.set(null);try{let e=await this.rpc.updateUser({updates:t});this._currentUser.set(e)}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}setCurrentUser(t){this._currentUser.set(t),t===null?this._isAdmin.set(!1):this._isAdmin.set(t.isAdmin===!0)}clearUser(){this._currentUser.set(null),this._isAdmin.set(!1)}clearError(){this._error.set(null)}getStudentById(t){return this.students().find(e=>e.id===t)}getEligibleStudents(t){let e=new Date(t,0,1);return this.students().filter(r=>{let s=new Date(r.dob),n=e.getFullYear()-s.getFullYear(),y=new Date(e.getFullYear(),s.getMonth(),s.getDate())>e?n-1:n;return y>=5&&y<=12})}async createStudent(t){let e=this._currentUser();if(!e)throw new Error("No current user");this._loading.set(!0),this._error.set(null);try{let r=await this.rpc.createStudent(i({parentAuthId:e.uid},t));return this._currentUser.update(s=>s&&l(i({},s),{students:[...s.students??[],r]})),r}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}async updateStudent(t,e){this._loading.set(!0),this._error.set(null);try{let r=await this.rpc.updateStudent(i({studentId:t},e));this._currentUser.update(s=>s&&l(i({},s),{students:s.students?.map(n=>n.id===t?r:n)}))}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}async deleteStudent(t){this._loading.set(!0),this._error.set(null);try{await this.rpc.deleteStudent(t),this._currentUser.update(e=>e&&l(i({},e),{students:e.students?.filter(r=>r.id!==t)}))}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async loadAllUsers(t){this._loading.set(!0),this._error.set(null);try{let e=await this.functionsClient.call("listAllUsers",{limit:t});this._users.set(e.users)}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async searchUsers(t){this._loading.set(!0),this._error.set(null),this._searchQuery.set(t);try{let e=await this.functionsClient.call("searchUsers",{query:t});this._users.set(e.users)}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async getUserDetails(t){this._loading.set(!0),this._error.set(null);try{let e=await this.functionsClient.call("getAdminUserDetails",{uid:t});return this._selectedUser.set(e),e}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async updateUserProfile(t,e){this._actionLoading.set(!0),this._actionError.set(null);try{await this.functionsClient.call("updateUserProfile",{authId:t,updates:e}),this._users.update(s=>s.map(n=>n.uid===t?l(i({},n),{displayName:e.displayName??n.displayName,contactInfo:e.contactInfo??n.contactInfo}):n));let r=this._selectedUser();r&&r.uid===t&&this._selectedUser.set(l(i({},r),{displayName:e.displayName??r.displayName,contactInfo:e.contactInfo??r.contactInfo}))}catch(r){let s=r instanceof Error?r.message:String(r);throw this._actionError.set(s),r}finally{this._actionLoading.set(!1)}}setSearchQuery(t){this._searchQuery.set(t)}clearSelectedUser(){this._selectedUser.set(null)}static \u0275fac=function(e){return new(e||d)};static \u0275prov=c({token:d,factory:d.\u0275fac,providedIn:"root"})};export{g as a,f as b};
