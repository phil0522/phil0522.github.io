import{h as S}from"./chunk-LUIRMBOE.js";import{a as f}from"./chunk-FWPBDQV6.js";import{g as b}from"./chunk-WG3KNEG3.js";import{t as p,z as y}from"./chunk-6E4VX3TQ.js";import{L as m,Q as c,Qb as o,a as l,b as g,ga as u,ha as h}from"./chunk-C26OXKSD.js";function _(){return`cart-${Date.now()}-${Math.random().toString(36).substring(2,9)}`}function I(i){let t=i<0,s=`$${(Math.abs(i)/100).toFixed(2)}`;return t?`-${s}`:s}function E(i,t){let e=new Date(i),s=new Date(t),r=e.toLocaleDateString("en-US",{month:"short",day:"numeric"}),a=s.toLocaleDateString("en-US",{month:"short",day:"numeric"});return`${r} - ${a}`}function D(i){if(!i||typeof i!="object")return!1;let t=i;if(t.details?.code==="CAPACITY_EXCEEDED")return!0;if(!(t.message??t.error?.message??"").toLowerCase().includes("full"))return!1;let s=(t.code??"").toLowerCase(),r=(t.status??t.error?.status??"").toLowerCase().replace(/_/g,"-");return s==="resource-exhausted"||s==="functions/resource-exhausted"||s==="failed-precondition"||r==="resource-exhausted"}function M(i){return!i||typeof i!="object"?[]:i.details?.failedItems??[]}function w(i){if(!i||typeof i!="object")return"";let t=i;return t.message??t.error?.message??""}function P(i){return{returning_family:"\u{1F3E0}",sibling:"\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F466}",multi_session:"\u{1F4C5}",coupon:"\u{1F39F}\uFE0F",manual:"\u270F\uFE0F",early_bird:"\u{1F426}"}[i]??"\u{1F4B0}"}var v=class i{orderRpc=c(f);orderService=c(S);seasonService=c(b);configService=c(y);_items=u([]);_pricing=u(null);_pricingLoading=u(!1);_pricingError=u(null);_submitting=u(!1);_submitError=u(null);currentSeason=o(()=>this.seasonService.selectedSeason());previousSeasonId=null;constructor(){h(()=>{let t=this.currentSeason()?.id??null;this.previousSeasonId!==null&&t!==this.previousSeasonId&&this.clearCart(),this.previousSeasonId=t})}items=this._items.asReadonly();pricing=this._pricing.asReadonly();pricingLoading=this._pricingLoading.asReadonly();pricingError=this._pricingError.asReadonly();submitting=this._submitting.asReadonly();submitError=this._submitError.asReadonly();loading=this.orderRpc.loading;itemCount=o(()=>this._items().length);hasItems=o(()=>this._items().length>0);isEmpty=o(()=>this._items().length===0);uniqueClassCount=o(()=>new Set(this._items().map(e=>e.class.id)).size);uniqueStudentCount=o(()=>new Set(this._items().flatMap(e=>e.students.map(s=>s.id))).size);totalEnrollmentCount=o(()=>this._items().reduce((t,e)=>t+e.students.length,0));itemsMissingStudents=o(()=>this._items().filter(t=>t.students.length===0));itemsMissingStudentsCount=o(()=>this.itemsMissingStudents().length);allStudentsAssigned=o(()=>this._items().every(t=>t.students.length>0));isReadyToSubmit=o(()=>this.hasItems()&&this.allStudentsAssigned()&&!this._submitting());subtotal=o(()=>this._pricing()?.subtotal??0);discounts=o(()=>this._pricing()?.discounts??[]);totalDiscountAmount=o(()=>this.discounts().reduce((t,e)=>t+e.amount,0));total=o(()=>{let t=this._pricing();if(!t)return 0;let e=t.discounts.reduce((s,r)=>s+r.amount,0);return Math.max(0,t.subtotal+e)});addToCart(t,e=[],s={lunch:!0,extendedCare:!1},r=!1){let a=this.currentSeason()?.id??"";if(t.seasonId!==a)throw new Error("Cannot add classes from different seasons. Please complete or clear your current cart first.");if(this.isClassInCart(t.id))throw new Error("This class is already in your cart");for(let d of e)this.validateStudentNotEnrolled(t.id,d.id);let n=l({id:_(),class:t,students:e,options:s},r&&{isWaitlistClaim:!0});return this._items.update(d=>[...d,n]),e.length>0&&this.refreshPricing(),n.id}removeFromCart(t){this._items.update(e=>e.filter(s=>s.id!==t)),this._items().length>0?this.refreshPricing():this._pricing.set(null)}toggleStudent(t,e){let s=this._items().find(a=>a.id===t);if(!s)return;let r=s.students.some(a=>a.id===e.id);if(!r&&(this.validateStudentNotEnrolled(s.class.id,e.id),this.isStudentInCartForClass(s.class.id,e.id)))throw new Error("This student is already in the cart for this class");this._items.update(a=>a.map(n=>{if(n.id!==t)return n;let d=r?n.students.filter(C=>C.id!==e.id):[...n.students,e];return g(l({},n),{students:d})})),this.refreshPricing()}updateItemOptions(t,e){this._items.update(s=>s.map(r=>r.id===t?g(l({},r),{options:l(l({},r.options),e)}):r)),this.refreshPricing()}clearCart(){this._items.set([]),this._pricing.set(null),this._pricingError.set(null),this._submitError.set(null)}isClassInCart(t){return this._items().some(e=>e.class.id===t)}isStudentInCartForClass(t,e){return this._items().some(s=>s.class.id===t&&s.students.some(r=>r.id===e))}isStudentSelected(t,e){return this._items().find(r=>r.id===t)?.students.some(r=>r.id===e)??!1}getCartItem(t){return this._items().find(e=>e.id===t)??null}getCartItemForClass(t){return this._items().find(e=>e.class.id===t)??null}refreshPricing(){let t=this._items();if(t.length===0){this._pricing.set(null);return}if(!this.allStudentsAssigned()){this._pricing.set(null);return}let e=this.currentSeason();if(!e){this._pricingError.set("Season not set");return}this._pricingError.set(null);try{let s=new Map;for(let n of t)s.has(n.class.id)||s.set(n.class.id,{id:n.class.id,basePrice:n.class.basePrice,lunchPrice:n.class.lunchPrice,extendedCarePrice:n.class.extendedCarePrice,earlyBirdTiers:n.class.earlyBirdTiers??[]});let r=t.flatMap(n=>n.students.map(d=>({sessionId:n.class.id,studentId:d.id,options:n.options}))),a=p.calculateCartPricing({items:r,sessionLookup:s,currentDate:this.configService.currentDate(),discountConfig:{siblingDiscountPerWeek:e.siblingDiscountPerWeek??0,multiSessionDiscountTiers:e.multiSessionDiscounts??[]}});this._pricing.set(a)}catch(s){let r=s instanceof Error?s.message:String(s);this._pricingError.set(r)}}async submit(){let t=this._items();if(t.length===0)throw new Error("Cart is empty");if(!this.allStudentsAssigned())throw new Error("Please select a student for all classes");let e=this.currentSeason()?.id;if(!e)throw new Error("Season not set");this._submitting.set(!0),this._submitError.set(null);try{let s=t.flatMap(a=>a.students.map(n=>({sessionId:a.class.id,studentId:n.id,options:a.options}))),r=await this.orderRpc.submitItems({seasonId:e,items:s});return this.clearCart(),r}catch(s){let r=s instanceof Error?s.message:String(s);throw this._submitError.set(r),s}finally{this._submitting.set(!1)}}clearPricingError(){this._pricingError.set(null)}clearSubmitError(){this._submitError.set(null)}clearAllErrors(){this._pricingError.set(null),this._submitError.set(null)}validateStudentNotEnrolled(t,e){if(this.orderService.hasActiveEnrollment(t,e))throw new Error("This student is already enrolled in this class")}static \u0275fac=function(e){return new(e||i)};static \u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})};export{I as a,E as b,D as c,M as d,w as e,P as f,v as g};
