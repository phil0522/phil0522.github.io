import{a as g}from"./chunk-VYJPQB7B.js";import{a as S}from"./chunk-2RRSDDC6.js";import{Da as y,da as h}from"./chunk-Z3TSPNBE.js";import{M as d,R as l,Rb as u,ha as i}from"./chunk-EVJ2WVWM.js";var c=class o{functions=l(y);_loading=i(!1);_error=i(null);loading=this._loading.asReadonly();error=this._error.asReadonly();clearError(){this._error.set(null)}async wrapCall(e,s){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,s)}catch(t){let a=t instanceof Error?t.message:String(t);throw this._error.set(a),t}finally{this._loading.set(!1)}}async wrapApiCall(e,s){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,s)}catch(t){let a=t instanceof Error?t.message:String(t);throw this._error.set(a),t}finally{this._loading.set(!1)}}async listAllSeasons(e){return this.wrapCall("listAllSeasons",{year:e})}async listAllClasses(e){return this.wrapCall("listAllClasses",{year:e})}async createSeason(e){return this.wrapApiCall("createSeason",e)}async updateSeason(e,s){return this.wrapApiCall("updateSeason",{seasonId:e,updates:s})}async createClass(e){return this.wrapApiCall("createClass",e)}async updateClass(e,s){return this.wrapApiCall("updateClass",{sessionId:e,updates:s})}static \u0275fac=function(s){return new(s||o)};static \u0275prov=d({token:o,factory:o.\u0275fac,providedIn:"root"})};var _=class o{datastore=l(g);rpc=l(c);configService=l(S);seasonsSubscription=null;subscribedYear=null;get currentYear(){return this.configService.currentActiveYear()}_seasons=i([]);_classes=i([]);_selectedSeason=i(null);_selectedClass=i(null);_loading=i(!1);_error=i(null);_actionLoading=i(!1);_actionError=i(null);seasons=this._seasons.asReadonly();classes=this._classes.asReadonly();selectedSeason=this._selectedSeason.asReadonly();selectedClass=this._selectedClass.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();hasSeasons=u(()=>this._seasons().length>0);hasClasses=u(()=>this._classes().length>0);ngOnDestroy(){this.unsubscribeAll()}unsubscribeAll(){this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=null}async loadSeasons(e){this.subscribedYear===e&&this.seasonsSubscription||(this._loading.set(!0),this._error.set(null),this.seasonsSubscription&&(this.seasonsSubscription.unsubscribe(),this.seasonsSubscription=null),this.subscribedYear=e,this.seasonsSubscription=this.datastore.subscribeToActiveSeasons(e).subscribe({next:s=>{this._seasons.set(s),this._loading.set(!1),!this._selectedSeason()&&s.length>0&&this._selectedSeason.set(s[0]);let t=this._selectedSeason();if(t){let a=s.find(r=>r.id===t.id);a?(this._selectedSeason.set(a),this._classes.set(a.sessions?.filter(r=>r.isActive).sort((r,n)=>r.startDate.localeCompare(n.startDate))||[])):this._selectedSeason.set(s[0]||null)}},error:s=>{let t=s instanceof Error?s.message:String(s);this._error.set(t),this._loading.set(!1)}}))}async loadClassesBySeason(e,s){if(this.subscribedYear===s&&this.seasonsSubscription){let t=this._seasons().find(a=>a.id===e);if(t){let a=t.sessions?.filter(r=>r.isActive).sort((r,n)=>r.startDate.localeCompare(n.startDate))||[];this._classes.set(a);return}}this._loading.set(!0),this._error.set(null);try{let t=await this.datastore.listClassesBySeason(s,e);this._classes.set(t)}catch(t){let a=t instanceof Error?t.message:String(t);throw this._error.set(a),t}finally{this._loading.set(!1)}}async loadClassesByYear(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listClassesByYear(e);this._classes.set(s)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async loadClass(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.getClass(this.currentYear,e);if(s)this._selectedClass.set(s);else throw new Error(`Class not found: ${e}`)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}selectSeason(e){this._selectedSeason.set(e)}selectClass(e){this._selectedClass.set(e)}async getClassById(e){let s=this._classes().find(t=>t.id===e);if(s)return s;try{return await this.datastore.getClass(this.currentYear,e)}catch{return null}}calculatePrice(e,s){let a=this.configService.config().currentDate,r=e.basePrice;if(e.earlyBirdTiers&&e.earlyBirdTiers.length>0){let n=e.earlyBirdTiers.find(f=>a<=f.deadline);n&&(r=n.price)}return s.includeLunch&&(r+=e.lunchPrice),s.includeExtendedCare&&(r+=e.extendedCarePrice),r}formatPrice(e){return`$${(e/100).toFixed(2)}`}clearError(){this._error.set(null)}reset(){this.unsubscribeAll(),this._seasons.set([]),this._classes.set([]),this._selectedSeason.set(null),this._selectedClass.set(null),this._error.set(null)}async refreshCatalog(){let e=this.subscribedYear||this.currentYear;this.subscribedYear=null,await this.loadSeasons(e)}async loadAllSeasons(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listAllSeasons(e);this._seasons.set(s)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async loadAllClasses(e){this._loading.set(!0),this._error.set(null);try{let s=await this.datastore.listClassesByYear(e,!1);this._classes.set(s)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async createSeason(e){this._actionLoading.set(!0),this._actionError.set(null);try{let s=await this.rpc.createSeason(e),t=h(s);return this._seasons.update(a=>[...a,t]),t}catch(s){let t=s instanceof Error?s.message:String(s);throw this._actionError.set(t),s}finally{this._actionLoading.set(!1)}}async updateSeason(e,s){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateSeason(e,s),a=h(t);return this._seasons.update(r=>r.map(n=>n.id===e?a:n)),a}catch(t){let a=t instanceof Error?t.message:String(t);throw this._actionError.set(a),t}finally{this._actionLoading.set(!1)}}async createClass(e){this._actionLoading.set(!0),this._actionError.set(null);try{let s=await this.rpc.createClass(e);return this._classes.update(t=>[...t,s]),s}catch(s){let t=s instanceof Error?s.message:String(s);throw this._actionError.set(t),s}finally{this._actionLoading.set(!1)}}async updateClass(e,s){this._actionLoading.set(!0),this._actionError.set(null);try{let t=await this.rpc.updateClass(e,s);return this._classes.update(a=>a.map(r=>r.id===e?t:r)),t}catch(t){let a=t instanceof Error?t.message:String(t);throw this._actionError.set(a),t}finally{this._actionLoading.set(!1)}}async toggleSeasonActive(e){let s=this._seasons().find(t=>t.id===e);s&&await this.updateSeason(e,{isActive:!s.isActive})}async toggleClassActive(e){let s=this._classes().find(t=>t.id===e);s&&await this.updateClass(e,{isActive:!s.isActive})}getSeason(e){return this._seasons().find(s=>s.id===e)}getClass(e){return this._classes().find(s=>s.id===e)}static \u0275fac=function(s){return new(s||o)};static \u0275prov=d({token:o,factory:o.\u0275fac,providedIn:"root"})};export{_ as a};
