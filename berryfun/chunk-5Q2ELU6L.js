import{a as f}from"./chunk-6THQUTU6.js";import{a as v,b as m}from"./chunk-35QEJLB4.js";import{a as y}from"./chunk-TZNWTF3S.js";import{Ga as u,Ha as _,Ka as l}from"./chunk-UBU22GLA.js";import{M as g,R as d,Tb as a,ha as i}from"./chunk-UKFGIOHC.js";var p=15,M=class h{datastore=d(v);rpc=d(m);configService=d(y);seasonService=d(f);_orders=i([]);_loading=i(!1);_error=i(null);_activeFilter=i("all");_cursor=i(null);_hasMore=i(!1);_loadingMore=i(!1);_actionLoading=i(!1);_actionError=i(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();orderCount=a(()=>this._orders().length);lockedCount=a(()=>this._orders().filter(e=>l(e)==="locked").length);submittedCount=a(()=>this._orders().filter(e=>l(e)==="submitted").length);overdueCount=a(()=>this._orders().filter(e=>this.isOverdue(e)).length);changeRequestCount=a(()=>this._orders().filter(e=>e.changeRequests&&e.changeRequests.some(r=>r.status==="pending")).length);paidCount=a(()=>this._orders().filter(e=>l(e)==="paid").length);filteredOrders=this._orders.asReadonly();setFilter(e){this._activeFilter.set(e),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(e){this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let r=this.configService.currentActiveYear(),t=e??this.getActiveSeasonId();if(!t){this._orders.set([]);return}let s=await this.queryOrders(r,t,p);this._orders.set(s.orders),this._cursor.set(s.lastDoc),this._hasMore.set(s.hasMore)}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loading.set(!1)}}async loadMore(e){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let r=this.configService.currentActiveYear(),t=e??this.getActiveSeasonId();if(!t)return;let s=this._cursor(),o=await this.queryOrders(r,t,p,s);this._orders.update(n=>[...n,...o.orders]),this._cursor.set(o.lastDoc),this._hasMore.set(o.hasMore)}catch(r){let t=r instanceof Error?r.message:String(r);throw this._error.set(t),r}finally{this._loadingMore.set(!1)}}}queryOrders(e,r,t,s){let o=this._activeFilter();switch(o){case"overdue":return this.datastore.listOverdueOrdersPaginated(e,r,this._cachedServerTime(),t,s);case"locked":case"submitted":case"paid":return this.datastore.listOrdersByStatusPaginated(e,r,o,t,s);case"all":return this.datastore.listOrdersPaginated(e,r,t,s)}}getActiveSeasonId(){return this.seasonService.selectedSeason()?.id??null}async loadAllOrders(e,r){this._loading.set(!0),this._error.set(null);try{let t=this.configService.currentActiveYear(),s=await this.datastore.listYearOrders(t);e&&(s=s.filter(o=>l(o)===e)),s.sort((o,n)=>new Date(n.createdAt).getTime()-new Date(o.createdAt).getTime()),r&&r>0&&(s=s.slice(0,r)),this._orders.set(s)}catch(t){let s=t instanceof Error?t.message:String(t);throw this._error.set(s),t}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let e=this.configService.currentActiveYear(),r=this.configService.currentTime(),t=await this.datastore.listOverdueOrders(e,r);this._orders.set(t),this._activeFilter.set("overdue")}catch(e){let r=e instanceof Error?e.message:String(e);throw this._error.set(r),e}finally{this._loading.set(!1)}}async recordPayment(e,r,t,s,o="zelle",n){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.recordPayment({year:e,userAuthId:r,amount:t,reference:s,method:o,notes:n}),await this.loadAllOrders()}catch(c){let O=c instanceof Error?c.message:String(c);throw this._actionError.set(O),c}finally{this._actionLoading.set(!1)}}async cancelOrder(e,r,t){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(e,r,t),await this.loadAllOrders()}catch(s){let o=s instanceof Error?s.message:String(s);throw this._actionError.set(o),s}finally{this._actionLoading.set(!1)}}isOverdue(e){return u(e,this._cachedServerTime())}getRemainingLockTime(e){return _(e,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}async getOrder(e){let r=this._orders().find(t=>t.userAuthId===e);if(r)return r;this._loading.set(!0),this._error.set(null);try{let t=this.configService.currentActiveYear(),s=await this.datastore.getUserSeasonOrder(t,e);if(!s)throw new Error(`Order not found for user: ${e}`);return s}catch(t){let s=t instanceof Error?t.message:String(t);throw this._error.set(s),t}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||h)};static \u0275prov=g({token:h,factory:h.\u0275fac,providedIn:"root"})};export{M as a};
