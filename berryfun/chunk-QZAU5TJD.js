import{a as D}from"./chunk-JGIIYOFF.js";import{$ as h,Ia as W,Ja as E,La as T,S as C,V as O,W as I,X as A,Z as c,_ as d,aa as y,ba as w,da as q,ea as v,ta as u}from"./chunk-7QJVSJKI.js";import{M as R,R as p,a as U,b,g as P,ha as f}from"./chunk-6GAPJCXB.js";var k=30,_=class m{db=new W(A(C()));firestore=A(C());seasonDatastore=p(D);userDatastore=p(E);async getUserSeasonOrder(e,t){let s=`years/${e}/orders`,r=await this.db.getDocument(s,t);return r?u.parse(r):null}subscribeToOrder(e,t){return new P(s=>{let r=I(this.firestore,`years/${e}/orders`,t),a=v(r,o=>{if(!o.exists()){s.next(null);return}try{let l=b(U({},o.data()),{id:o.id}),n=u.parse(l);s.next(n)}catch(l){s.error(l)}},o=>{s.error(o)});return()=>a()})}async listSeasonOrders(e,t){let s=`years/${e}/orders`;return(await this.db.getDocuments(s,[{field:"seasonId",op:"==",value:t}])).map(a=>u.parse(a))}async listYearOrders(e){let t=`years/${e}/orders`;return(await this.db.getDocuments(t)).map(r=>u.parse(r))}async listOrdersWithSubmittedItems(e){return(await this.listYearOrders(e)).filter(s=>s.items.some(r=>r.status==="submitted"))}async listOverdueOrders(e,t){let s=await this.listOrdersWithSubmittedItems(e),r=new Date(t);return s.filter(a=>a.lockExpiresAt?new Date(a.lockExpiresAt)<r:!1)}async listOrdersWithChangeRequests(e){return(await this.listYearOrders(e)).filter(s=>s.changeRequests&&s.changeRequests.some(r=>r.status==="pending"))}async listAllWaitlistEntries(e){let t=await this.listYearOrders(e),s=await this.seasonDatastore.listAllSeasons(e),r=new Map;for(let n of s)for(let i of n.sessions??[])r.set(i.id,i.name);let a=await this.userDatastore.listAllUsers(),o=new Map;for(let n of a)o.set(n.uid,n.displayName);let l=[];for(let n of t)if(!(!n.waitlist||n.waitlist.length===0))for(let i of n.waitlist)l.push({userId:n.userAuthId,userName:o.get(n.userAuthId)??"Unknown User",sessionId:i.sessionId,className:r.get(i.sessionId)??"Unknown Class",joinedAt:i.joinedAt??"",isPromoted:i.isPromoted,promotedAt:i.promotedAt,notes:i.notes});return l.sort((n,i)=>n.joinedAt.localeCompare(i.joinedAt)),l}async listWaitlistByClass(e,t){return(await this.listAllWaitlistEntries(e)).filter(r=>r.sessionId===t)}async listOrdersPaginated(e,t,s,r){let a=O(this.firestore,`years/${e}/orders`),o=r?c(a,d("seasonId","==",t),h("updatedAt","desc"),w(r),y(s)):c(a,d("seasonId","==",t),h("updatedAt","desc"),y(s)),l=await q(o),n=l.docs.map(S=>u.parse(S.data())),i=l.size>=s,g=i?l.docs[l.docs.length-1]:null;return{orders:n,lastDoc:g,hasMore:i}}async listOrdersByStatusPaginated(e,t,s,r,a){let o=O(this.firestore,`years/${e}/orders`),l=a?c(o,d("seasonId","==",t),d("orderStatus","==",s),h("updatedAt","desc"),w(a),y(r)):c(o,d("seasonId","==",t),d("orderStatus","==",s),h("updatedAt","desc"),y(r)),n=await q(l),i=n.docs.map(M=>u.parse(M.data())),g=n.size>=r,S=g?n.docs[n.docs.length-1]:null;return{orders:i,lastDoc:S,hasMore:g}}async listOrdersByUserIds(e,t){if(t.length===0)return[];let s=O(this.firestore,`years/${e}/orders`),r=[];for(let a=0;a<t.length;a+=k){let o=t.slice(a,a+k),l=c(s,d("userAuthId","in",o)),n=await q(l);for(let i of n.docs)r.push(u.parse(i.data()))}return r}async listOrdersBySessionId(e,t,s){return(await this.listSeasonOrders(e,t)).filter(a=>a.items.some(o=>o.sessionId===s))}static \u0275fac=function(t){return new(t||m)};static \u0275prov=R({token:m,factory:m.\u0275fac,providedIn:"root"})};var j=class m{functions=p(T);_loading=f(!1);_error=f(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async submitItems(e){return this.wrapApiCall("submitOrderItems",e)}async recordPayment(e){return this.wrapApiCall("recordOrderPayment",e)}async cancelItems(e){return this.wrapCall("cancelOrderItems",e)}async joinWaitlist(e){return this.wrapApiCall("joinWaitlist",e)}async leaveWaitlist(e){return this.wrapApiCall("leaveWaitlist",e)}async promoteWaitlistEntry(e){return this.wrapApiCall("promoteWaitlistEntry",e)}async removeSubmittedItems(e){return this.wrapApiCall("removeSubmittedItems",e)}async applySubmittedChanges(e){return this.wrapApiCall("applySubmittedChanges",e)}async requestOrderChange(e){return this.wrapApiCall("requestChange",e)}async updateChangeRequest(e){return this.wrapApiCall("updateChangeRequest",e)}async approveChangeRequest(e){return this.wrapApiCall("approveChange",e)}async denyChangeRequest(e){return this.wrapApiCall("denyChange",e)}async listAllOrders(e,t){return this.wrapCall("listAllOrders",{status:e,limit:t})}async listOverdueOrders(){return this.wrapCall("listOverdueOrders",void 0)}async listChangeRequests(){return this.wrapCall("listChangeRequests",void 0)}async adminCancelOrder(e,t,s){await this.wrapApiCall("cancelOrder",{userAuthId:e,itemsToCancel:t,reason:s})}async getOrder(e){return this.wrapCall("getOrder",{userAuthId:e})}async listAllWaitlistEntries(){return this.wrapCall("listAllWaitlistEntries",{})}async listWaitlistByClass(e){return this.wrapCall("listWaitlistByClass",{sessionId:e})}clearError(){this._error.set(null)}async wrapCall(e,t){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,t)}catch(s){let r=s instanceof Error?s.message:String(s);throw this._error.set(r),s}finally{this._loading.set(!1)}}async wrapApiCall(e,t){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,t)}catch(s){let r=s instanceof Error?s.message:String(s);throw this._error.set(r),s}finally{this._loading.set(!1)}}static \u0275fac=function(t){return new(t||m)};static \u0275prov=R({token:m,factory:m.\u0275fac,providedIn:"root"})};export{_ as a,j as b};
