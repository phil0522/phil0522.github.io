import{a as f,b as _}from"./chunk-NR6WXTS5.js";import{a as y}from"./chunk-EUESG25O.js";import{Ca as u,Da as m,Ea as v,Ga as n}from"./chunk-UIQMLXH2.js";import{M as h,R as l,Sb as i,ha as a}from"./chunk-6GAPJCXB.js";var p=class c{datastore=l(f);rpc=l(_);configService=l(y);_orders=a([]);_loading=a(!1);_error=a(null);_activeFilter=a("all");_actionLoading=a(!1);_actionError=a(null);_cachedServerTime=this.configService.currentTime;orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();orderCount=i(()=>this._orders().length);pendingCount=i(()=>this._orders().filter(e=>n(e)==="submitted").length);overdueCount=i(()=>this._orders().filter(e=>this.isOverdue(e)).length);changeRequestCount=i(()=>this._orders().filter(e=>e.changeRequests&&e.changeRequests.some(t=>t.status==="pending")).length);paidCount=i(()=>this._orders().filter(e=>n(e)==="paid").length);cancelledCount=i(()=>this._orders().filter(e=>{let t=n(e);return t==="cancelled"||t==="refunded"}).length);filteredOrders=i(()=>{let e=this._orders();switch(this._activeFilter()){case"pending":return e.filter(r=>n(r)==="submitted");case"overdue":return e.filter(r=>this.isOverdue(r));case"change_requested":return e.filter(r=>r.changeRequests&&r.changeRequests.some(s=>s.status==="pending"));case"paid":return e.filter(r=>n(r)==="paid");case"cancelled":return e.filter(r=>{let s=n(r);return s==="cancelled"||s==="refunded"});default:return e}});setFilter(e){this._activeFilter.set(e)}async loadAllOrders(e,t){this._loading.set(!0),this._error.set(null);try{let r=this.configService.currentActiveYear(),s=await this.datastore.listYearOrders(r);e&&(s=s.filter(o=>n(o)===e)),s.sort((o,g)=>new Date(g.createdAt).getTime()-new Date(o.createdAt).getTime()),t&&t>0&&(s=s.slice(0,t)),this._orders.set(s)}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}async loadOverdueOrders(){this._loading.set(!0),this._error.set(null);try{let e=this.configService.currentActiveYear(),t=this.configService.currentTime(),r=await this.datastore.listOverdueOrders(e,t);this._orders.set(r),this._activeFilter.set("overdue")}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async loadChangeRequests(){this._loading.set(!0),this._error.set(null);try{let e=this.configService.currentActiveYear(),t=await this.datastore.listOrdersWithChangeRequests(e);this._orders.set(t),this._activeFilter.set("change_requested")}catch(e){let t=e instanceof Error?e.message:String(e);throw this._error.set(t),e}finally{this._loading.set(!1)}}async recordPayment(e,t,r,s,o="zelle",g){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.recordPayment({year:e,userAuthId:t,amount:r,reference:s,method:o,notes:g}),await this.loadAllOrders()}catch(d){let O=d instanceof Error?d.message:String(d);throw this._actionError.set(O),d}finally{this._actionLoading.set(!1)}}async cancelOrder(e,t,r){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(e,t,r),await this.loadAllOrders()}catch(s){let o=s instanceof Error?s.message:String(s);throw this._actionError.set(o),s}finally{this._actionLoading.set(!1)}}isOverdue(e){return u(e,this._cachedServerTime())}isLockExpiringSoon(e){return m(e,this._cachedServerTime(),12)}getRemainingLockTime(e){return v(e,this._cachedServerTime())}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all")}async getOrder(e){let t=this._orders().find(r=>r.userAuthId===e);if(t)return t;this._loading.set(!0),this._error.set(null);try{let r=this.configService.currentActiveYear(),s=await this.datastore.getUserSeasonOrder(r,e);if(!s)throw new Error(`Order not found for user: ${e}`);return s}catch(r){let s=r instanceof Error?r.message:String(r);throw this._error.set(s),r}finally{this._loading.set(!1)}}static \u0275fac=function(t){return new(t||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{p as a};
