import{a as D}from"./chunk-YUXLOB7R.js";import{$ as u,Na as E,Oa as k,Qa as T,U as w,X as O,Y as I,Z as U,aa as c,ba as h,ca as g,da as f,fa as S,ha as W,va as m}from"./chunk-B4PSB7QN.js";import{M as q,R,a as b,b as v,g as P,ha as C}from"./chunk-VKJSCVXY.js";var j=30,$=class p{db=new E(U(w()));firestore=U(w());seasonDatastore=R(D);userDatastore=R(k);async getUserSeasonOrder(e,r,s){let t=`years/${e}/seasons/${r}/orders`,n=await this.db.getDocument(t,s);return n?m.parse(n):null}subscribeToOrder(e,r,s){return new P(t=>{let n=I(this.firestore,`years/${e}/seasons/${r}/orders`,s),i=W(n,l=>{if(!l.exists()){t.next(null);return}try{let o=v(b({},l.data()),{id:l.id}),a=m.parse(o);t.next(a)}catch(o){t.error(o)}},l=>{t.error(l)});return()=>i()})}async listSeasonOrders(e,r){let s=`years/${e}/seasons/${r}/orders`;return(await this.db.getDocuments(s)).map(n=>m.parse(n))}async listOrdersWithSubmittedItems(e,r){return(await this.listSeasonOrders(e,r)).filter(t=>t.items.some(n=>n.status==="submitted"))}async listOverdueOrders(e,r,s){let t=await this.listOrdersWithSubmittedItems(e,r),n=new Date(s);return t.filter(i=>i.lockExpiresAt?new Date(i.lockExpiresAt)<n:!1)}async listOrdersWithChangeRequests(e,r){return(await this.listSeasonOrders(e,r)).filter(t=>t.changeRequests&&t.changeRequests.some(n=>n.status==="pending"))}async listAllWaitlistEntries(e,r){let s=await this.listSeasonOrders(e,r),t=await this.seasonDatastore.listAllSeasons(e),n=new Map;for(let a of t)for(let d of a.sessions??[])n.set(d.id,d.name);let i=await this.userDatastore.listAllUsers(),l=new Map;for(let a of i)l.set(a.uid,a.displayName);let o=[];for(let a of s)if(!(!a.waitlist||a.waitlist.length===0))for(let d of a.waitlist)o.push({userId:a.userAuthId,userName:l.get(a.userAuthId)??"Unknown User",sessionId:d.sessionId,className:n.get(d.sessionId)??"Unknown Class",joinedAt:d.joinedAt??""});return o.sort((a,d)=>a.joinedAt.localeCompare(d.joinedAt)),o}async listWaitlistByClass(e,r,s){return(await this.listAllWaitlistEntries(e,r)).filter(n=>n.sessionId===s)}async listOrdersPaginated(e,r,s,t){let n=O(this.firestore,`years/${e}/seasons/${r}/orders`),i=t?u(n,h("updatedAt","desc"),f(t),g(s)):u(n,h("updatedAt","desc"),g(s)),l=await S(i),o=l.docs.map(y=>m.parse(y.data())),a=l.size>=s,d=a?l.docs[l.docs.length-1]:null;return{orders:o,lastDoc:d,hasMore:a}}async listOverdueOrdersPaginated(e,r,s,t,n){let i=O(this.firestore,`years/${e}/seasons/${r}/orders`),l=n?u(i,c("orderStatus","==","submitted"),c("lockExpiresAt","<",s),h("lockExpiresAt","desc"),f(n),g(t)):u(i,c("orderStatus","==","submitted"),c("lockExpiresAt","<",s),h("lockExpiresAt","desc"),g(t)),o=await S(l),a=o.docs.map(A=>m.parse(A.data())),d=o.size>=t,y=d?o.docs[o.docs.length-1]:null;return{orders:a,lastDoc:y,hasMore:d}}async listOrdersByStatusPaginated(e,r,s,t,n){let i=O(this.firestore,`years/${e}/seasons/${r}/orders`),l=n?u(i,c("orderStatus","==",s),h("updatedAt","desc"),f(n),g(t)):u(i,c("orderStatus","==",s),h("updatedAt","desc"),g(t)),o=await S(l),a=o.docs.map(A=>m.parse(A.data())),d=o.size>=t,y=d?o.docs[o.docs.length-1]:null;return{orders:a,lastDoc:y,hasMore:d}}async listOrdersByUserIds(e,r,s){if(s.length===0)return[];let t=O(this.firestore,`years/${e}/seasons/${r}/orders`),n=[];for(let i=0;i<s.length;i+=j){let l=s.slice(i,i+j),o=u(t,c("userAuthId","in",l)),a=await S(o);for(let d of a.docs)n.push(m.parse(d.data()))}return n}async listOrdersBySessionId(e,r,s){return(await this.listSeasonOrders(e,r)).filter(n=>n.items.some(i=>i.sessionId===s))}static \u0275fac=function(r){return new(r||p)};static \u0275prov=q({token:p,factory:p.\u0275fac,providedIn:"root"})};var x=class p{functions=R(T);_loading=C(!1);_error=C(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async lockSessions(e){return this.wrapApiCall("lockSessions",e)}async recordPayment(e){return this.wrapApiCall("recordOrderPayment",e)}async placeOrder(e){return this.wrapApiCall("placeOrder",e)}async cancelItems(e){return this.wrapApiCall("cancelOrderItems",e)}async joinWaitlist(e){return this.wrapApiCall("joinWaitlist",e)}async leaveWaitlist(e){return this.wrapApiCall("leaveWaitlist",e)}async removeWaitlistEntry(e){return this.wrapApiCall("removeWaitlistEntry",e)}async removeSubmittedItems(e){return this.wrapApiCall("removeSubmittedItems",e)}async applySubmittedChanges(e){return this.wrapApiCall("applySubmittedChanges",e)}async requestOrderChange(e){return this.wrapApiCall("requestChange",e)}async updateChangeRequest(e){return this.wrapApiCall("updateChangeRequest",e)}async approveChangeRequest(e){return this.wrapApiCall("approveChange",e)}async denyChangeRequest(e){return this.wrapApiCall("denyChange",e)}async addAdjustment(e){return this.wrapApiCall("addAdjustment",e)}async listAllOrders(e,r){return this.wrapCall("listAllOrders",{status:e,limit:r})}async listOverdueOrders(){return this.wrapCall("listOverdueOrders",void 0)}async listChangeRequests(){return this.wrapCall("listChangeRequests",void 0)}async adminCancelOrder(e,r,s){await this.wrapApiCall("cancelOrder",{userAuthId:e,itemsToCancel:r,reason:s})}async getOrder(e){return this.wrapCall("getOrder",{userAuthId:e})}async listAllWaitlistEntries(){return this.wrapCall("listAllWaitlistEntries",{})}async listWaitlistByClass(e){return this.wrapCall("listWaitlistByClass",{sessionId:e})}clearError(){this._error.set(null)}async wrapCall(e,r){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,r)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async wrapApiCall(e,r){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,r)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||p)};static \u0275prov=q({token:p,factory:p.\u0275fac,providedIn:"root"})};export{$ as a,x as b};
