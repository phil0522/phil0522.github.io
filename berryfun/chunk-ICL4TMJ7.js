import{a as _e,b as fe}from"./chunk-WF6RUSMF.js";import{a as ye}from"./chunk-QMA264EO.js";import{$ as pe,Y as ce,_ as me,aa as ue,ba as ge,d as q,j as oe,k as ie,r as ae,s as se,t as de,u as le}from"./chunk-F6WTWIJG.js";import{F as re}from"./chunk-UYHN5VVP.js";import{$a as Q,Ab as D,Bb as ne,Ea as a,I as ee,N as k,Pa as U,Pb as v,S as g,Sb as T,T as y,U as F,V as j,Za as _,_ as W,_a as f,bb as Z,cb as K,da as C,db as R,eb as s,fb as d,gb as B,hb as m,ib as c,jb as V,kb as E,lb as Y,mb as I,nb as M,ob as p,vb as te,wb as J,yb as r,zb as w}from"./chunk-DU5POHF6.js";import"./chunk-Q7L6LLAK.js";var Oe=5*1024*1024,Ee=["image/jpeg","image/png"],H=class o{storage=le(re());uploadProgress=C(0);uploading=C(!1);currentUploadTask=null;validateFile(t){return t.size>Oe?{type:"file_too_large",message:`File size (${(t.size/(1024*1024)).toFixed(1)} MB) exceeds the 5 MB limit.`}:Ee.includes(t.type)?null:{type:"invalid_type",message:"Only JPEG and PNG images are accepted."}}async uploadScreenshot(t,e){let n=this.validateFile(t);if(n)throw new Error(n.message);let i=t.type==="image/png"?"png":"jpg",l=`SS-${Date.now()}`,h=`orders/${e}/${l}.${i}`,x=de(this.storage,h);this.uploading.set(!0),this.uploadProgress.set(0);try{let O=ae(x,t,{contentType:t.type});this.currentUploadTask=O,await new Promise((z,N)=>{O.on("state_changed",S=>{let L=Math.round(S.bytesTransferred/S.totalBytes*100);this.uploadProgress.set(L)},S=>N(S),()=>z())});let P=await se(x);return{storagePath:h,downloadUrl:P}}finally{this.uploading.set(!1),this.currentUploadTask=null}}cancelUpload(){this.currentUploadTask&&(this.currentUploadTask.cancel(),this.currentUploadTask=null,this.uploading.set(!1),this.uploadProgress.set(0))}static \u0275fac=function(e){return new(e||o)};static \u0275prov=ee({token:o,factory:o.\u0275fac,providedIn:"root"})};function Ie(o,t){o&1&&r(0," Full Zelle Payment ")}function Me(o,t){o&1&&r(0," Cash + Deposit ")}function ke(o,t){if(o&1){let e=E();m(0,"div",10)(1,"div",21)(2,"div",22),r(3,"\u{1F4E7}"),c(),m(4,"div",23)(5,"strong"),r(6,"Zelle to:"),c(),m(7,"span",24),r(8,"cambrianexplorer@gmail.com"),c()()(),m(9,"div",21)(10,"div",22),r(11,"\u{1F4DD}"),c(),m(12,"div",23),r(13," Include your child's full name in the memo "),c()(),m(14,"div",25)(15,"p",26),r(16,"Scan to pay:"),c(),m(17,"img",27),M("click",function(){g(e);let i=p();return y(i.showQrOverlay.set(!0))}),c()()()}}function we(o,t){if(o&1){let e=E();m(0,"div",10)(1,"div",28)(2,"div",22),r(3,"\u{1F4B5}"),c(),m(4,"div",23)(5,"strong"),r(6,"Step 1:"),c(),r(7," Send $50 registration fee per class via Zelle to secure your spot "),c()(),m(8,"div",21)(9,"div",22),r(10,"\u{1F4E7}"),c(),m(11,"div",23)(12,"strong"),r(13,"Zelle to:"),c(),m(14,"span",24),r(15,"cambrianexplorer@gmail.com"),c()()(),m(16,"div",21)(17,"div",22),r(18,"\u{1F4AC}"),c(),m(19,"div",23)(20,"strong"),r(21,"Step 2:"),c(),r(22," Contact us via WeChat to arrange cash payment for the remaining balance "),c()(),m(23,"div",29)(24,"div",30)(25,"p",26),r(26,"Zelle:"),c(),m(27,"img",27),M("click",function(){g(e);let i=p();return y(i.showQrOverlay.set(!0))}),c()(),m(28,"div",30)(29,"p",26),r(30,"WeChat:"),c(),m(31,"img",31),M("click",function(){g(e);let i=p();return y(i.showWechatOverlay.set(!0))}),c()()()()}}function De(o,t){o&1&&(m(0,"span",15)(1,"span",32),r(2,"\u{1F4CE}"),c(),r(3," Choose JPEG or PNG image (max 5 MB) "),c())}function Te(o,t){if(o&1&&(m(0,"span",16)(1,"span",32),r(2,"\u2705"),c(),r(3),c()),o&2){let e=p();a(3),ne(" ",e.selectedFile().name," (",e.formatFileSize(e.selectedFile().size),") ")}}function Ne(o,t){if(o&1&&(m(0,"div",17),r(1),c()),o&2){let e=p();a(),D(" ",e.validationError()," ")}}function Le(o,t){if(o&1&&(m(0,"div",18)(1,"div",33),V(2,"div",34),c(),m(3,"span",35),r(4),c()()),o&2){let e=p();a(2),te("width",e.uploadProgress(),"%"),a(2),D("",e.uploadProgress(),"%")}}function ze(o,t){o&1&&r(0," Uploading... ")}function Ve(o,t){o&1&&r(0," Upload & Submit ")}function Ae(o,t){if(o&1){let e=E();m(0,"div",36),M("click",function(){g(e);let i=p();return y(i.showQrOverlay.set(!1))}),V(1,"img",37),c()}}function Fe(o,t){if(o&1){let e=E();m(0,"div",36),M("click",function(){g(e);let i=p();return y(i.showWechatOverlay.set(!1))}),V(1,"img",38),c()}}var $=class o{paymentOption=T.required();totalAmount=T.required();depositAmount=T.required();immediatelyDue=T.required();uploading=T(!1);uploadProgress=T(0);close=new W;uploadFile=new W;selectedFile=C(null);validationError=C(null);showQrOverlay=C(!1);showWechatOverlay=C(!1);amountDue=v(()=>this.paymentOption()==="zelle"?this.immediatelyDue():this.depositAmount());canSubmit=v(()=>this.selectedFile()!==null&&!this.uploading()&&!this.validationError());formatPrice(t){return(t/100).toLocaleString("en-US",{minimumFractionDigits:0})}formatFileSize(t){return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`}onBackdropClick(t){t.target.classList.contains("overlay-backdrop")&&this.close.emit()}onFileSelected(t){let n=t.target.files?.[0]??null;if(this.validationError.set(null),!n){this.selectedFile.set(null);return}let i=5*1024*1024;if(n.size>i){this.validationError.set(`File size (${(n.size/(1024*1024)).toFixed(1)} MB) exceeds the 5 MB limit.`),this.selectedFile.set(null);return}if(!["image/jpeg","image/png"].includes(n.type)){this.validationError.set("Only JPEG and PNG images are accepted."),this.selectedFile.set(null);return}this.selectedFile.set(n)}onSubmit(){let t=this.selectedFile();t&&!this.uploading()&&this.uploadFile.emit(t)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=U({type:o,selectors:[["app-payment-instruction-overlay"]],inputs:{paymentOption:[1,"paymentOption"],totalAmount:[1,"totalAmount"],depositAmount:[1,"depositAmount"],immediatelyDue:[1,"immediatelyDue"],uploading:[1,"uploading"],uploadProgress:[1,"uploadProgress"]},outputs:{close:"close",uploadFile:"uploadFile"},decls:33,vars:17,consts:[[1,"overlay-backdrop",3,"click"],[1,"overlay-content"],[1,"overlay-header"],["aria-label","Close",1,"btn-close",3,"click"],["width","24","height","24","viewBox","0 0 24 24","fill","currentColor"],["d","M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"],[1,"payment-option-badge"],[1,"amount-due"],[1,"amount-label"],[1,"amount-value"],[1,"instructions-section"],[1,"upload-section"],[1,"file-input-area"],[1,"file-label"],["type","file","accept","image/jpeg,image/png",1,"file-input",3,"change","disabled"],[1,"file-placeholder"],[1,"file-selected"],[1,"validation-error"],[1,"progress-container"],[1,"btn-upload",3,"click","disabled"],[1,"qr-fullscreen-overlay"],[1,"instruction-card"],[1,"instruction-icon"],[1,"instruction-content"],[1,"zelle-email"],[1,"qr-section"],[1,"qr-label"],["src","bf-zelle.jpg","alt","Zelle QR Code",1,"qr-code",3,"click"],[1,"instruction-card","highlight"],[1,"qr-section","dual"],[1,"qr-item"],["src","wechat_blueberry.png","alt","WeChat QR Code",1,"qr-code",3,"click"],[1,"file-icon"],[1,"progress-bar"],[1,"progress-fill"],[1,"progress-text"],[1,"qr-fullscreen-overlay",3,"click"],["src","bf-zelle.jpg","alt","Zelle QR Code",1,"qr-fullscreen-img"],["src","wechat_blueberry.png","alt","WeChat QR Code",1,"qr-fullscreen-img"]],template:function(e,n){e&1&&(m(0,"div",0),M("click",function(l){return n.onBackdropClick(l)}),m(1,"div",1)(2,"div",2)(3,"h2"),r(4,"Payment Instructions"),c(),m(5,"button",3),M("click",function(){return n.close.emit()}),F(),m(6,"svg",4),V(7,"path",5),c()()(),j(),m(8,"div",6),_(9,Ie,1,0)(10,Me,1,0),c(),m(11,"div",7)(12,"span",8),r(13,"Amount Due via Zelle:"),c(),m(14,"span",9),r(15),c()(),_(16,ke,18,0,"div",10)(17,we,32,0,"div",10),m(18,"div",11)(19,"h3"),r(20,"Upload Payment Screenshot"),c(),m(21,"div",12)(22,"label",13)(23,"input",14),M("change",function(l){return n.onFileSelected(l)}),c(),_(24,De,4,0,"span",15)(25,Te,4,2,"span",16),c()(),_(26,Ne,2,1,"div",17),_(27,Le,5,3,"div",18),m(28,"button",19),M("click",function(){return n.onSubmit()}),_(29,ze,1,0)(30,Ve,1,0),c()()()(),_(31,Ae,2,0,"div",20),_(32,Fe,2,0,"div",20)),e&2&&(a(8),J("zelle",n.paymentOption()==="zelle")("cash",n.paymentOption()==="cash_deposit"),a(),f(n.paymentOption()==="zelle"?9:10),a(6),D("$",n.formatPrice(n.amountDue())),a(),f(n.paymentOption()==="zelle"?16:17),a(6),J("disabled",n.uploading()),a(),Y("disabled",n.uploading()),a(),f(n.selectedFile()?25:24),a(2),f(n.validationError()?26:-1),a(),f(n.uploading()?27:-1),a(),Y("disabled",!n.canSubmit()),a(),f(n.uploading()?29:30),a(2),f(n.showQrOverlay()?31:-1),a(),f(n.showWechatOverlay()?32:-1))},dependencies:[q],styles:[".overlay-backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:#0009;display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}.overlay-content[_ngcontent-%COMP%]{background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px #0003}.overlay-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:1.25rem 1.5rem;border-bottom:1px solid var(--sys-outline-variant, #e0e0e0);position:sticky;top:0;background:#fff;z-index:1}.overlay-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.25rem;font-weight:600;color:var(--sys-on-surface, #212121)}.btn-close[_ngcontent-%COMP%]{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:50%;cursor:pointer;color:var(--sys-on-surface-variant, #666);transition:background .2s}.btn-close[_ngcontent-%COMP%]:hover{background:var(--sys-surface-variant, #f0f0f0)}.payment-option-badge[_ngcontent-%COMP%]{margin:1rem 1.5rem 0;padding:.5rem 1rem;border-radius:20px;font-weight:600;font-size:.875rem;display:inline-block}.payment-option-badge.zelle[_ngcontent-%COMP%]{background:var(--sys-primary-container, #ffebee);color:var(--sys-primary, #c62828)}.payment-option-badge.cash[_ngcontent-%COMP%]{background:var(--sys-tertiary-container, #e8f5e9);color:var(--sys-tertiary, #2e7d32)}.amount-due[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin:1rem 1.5rem;padding:1rem;background:var(--sys-surface-container, #fafafa);border-radius:10px;border:1px solid var(--sys-outline-variant, #e0e0e0)}.amount-label[_ngcontent-%COMP%]{font-size:.9rem;color:var(--sys-on-surface-variant, #666)}.amount-value[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;color:var(--sys-primary, #c62828)}.instructions-section[_ngcontent-%COMP%]{padding:0 1.5rem}.instruction-card[_ngcontent-%COMP%]{display:flex;gap:.75rem;padding:.875rem;background:var(--sys-surface-container, #fafafa);border-radius:10px;margin-bottom:.75rem}.instruction-card.highlight[_ngcontent-%COMP%]{background:var(--sys-tertiary-container, #e8f5e9);border:1px solid var(--sys-tertiary, #2e7d32)}.instruction-icon[_ngcontent-%COMP%]{font-size:1.25rem}.instruction-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem;font-size:.9rem;color:var(--sys-on-surface, #333)}.zelle-email[_ngcontent-%COMP%]{font-family:monospace;font-size:.95rem;color:var(--sys-primary, #c62828);font-weight:600;word-break:break-all}.qr-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:1rem;background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:10px;margin-bottom:.75rem}.qr-section.dual[_ngcontent-%COMP%]{flex-direction:row;justify-content:center;gap:2rem}.qr-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.qr-label[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:.8rem;color:var(--sys-on-surface-variant, #666);text-transform:uppercase;letter-spacing:.05em}.qr-code[_ngcontent-%COMP%]{width:120px;height:auto;border-radius:8px;cursor:pointer;transition:transform .2s}.qr-code[_ngcontent-%COMP%]:hover{transform:scale(1.05)}.cash-balance-note[_ngcontent-%COMP%]{text-align:center;padding:.75rem;background:var(--sys-surface-variant, #f5f5f5);border-radius:8px;font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.upload-section[_ngcontent-%COMP%]{padding:1.25rem 1.5rem;border-top:1px solid var(--sys-outline-variant, #e0e0e0);margin-top:.75rem}.upload-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1rem;font-weight:600;color:var(--sys-on-surface, #212121)}.file-input-area[_ngcontent-%COMP%]{margin-bottom:.75rem}.file-label[_ngcontent-%COMP%]{display:block;padding:1rem;background:var(--sys-surface-container, #fafafa);border:2px dashed var(--sys-outline-variant, #ccc);border-radius:10px;cursor:pointer;text-align:center;transition:border-color .2s,background .2s}.file-label[_ngcontent-%COMP%]:hover:not(.disabled){border-color:var(--sys-primary, #c62828);background:var(--sys-primary-container, #ffebee)}.file-label.disabled[_ngcontent-%COMP%]{opacity:.6;cursor:not-allowed}.file-input[_ngcontent-%COMP%]{display:none}.file-placeholder[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.file-selected[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;color:var(--sys-tertiary, #2e7d32);font-size:.875rem}.file-icon[_ngcontent-%COMP%]{font-size:1.25rem}.validation-error[_ngcontent-%COMP%]{padding:.5rem .75rem;background:var(--sys-error-container, #ffebee);border-radius:6px;color:var(--sys-error, #c62828);font-size:.875rem;margin-bottom:.75rem}.progress-container[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem}.progress-bar[_ngcontent-%COMP%]{flex:1;height:8px;background:var(--sys-surface-variant, #e0e0e0);border-radius:4px;overflow:hidden}.progress-fill[_ngcontent-%COMP%]{height:100%;background:var(--sys-primary, #c62828);border-radius:4px;transition:width .3s ease}.progress-text[_ngcontent-%COMP%]{font-size:.875rem;font-weight:600;color:var(--sys-primary, #c62828);min-width:40px;text-align:right}.btn-upload[_ngcontent-%COMP%]{width:100%;padding:1rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:background .2s}.btn-upload[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-upload[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.qr-fullscreen-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#000000d9;display:flex;align-items:center;justify-content:center;z-index:1100;cursor:pointer}.qr-fullscreen-img[_ngcontent-%COMP%]{max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 4px 24px #0000004d}"]})};function je(o,t){if(o&1&&(s(0,"div",9)(1,"div",16),r(2,"\u26A0\uFE0F"),d(),s(3,"div",17)(4,"strong"),r(5,"Payment Screenshot Rejected"),d(),s(6,"p"),r(7),d()()()),o&2){let e=p();a(7),w(e.rejectionNote())}}function Ue(o,t){o&1&&(s(0,"div",10),B(1,"div",18),s(2,"span"),r(3,"Loading..."),d()())}function Re(o,t){if(o&1){let e=E();s(0,"div",11)(1,"p"),r(2,"No reservations found."),d(),s(3,"button",19),I("click",function(){g(e);let i=p();return y(i.goToCatalog())}),r(4,"Browse Sessions"),d()()}}function Be(o,t){if(o&1&&(s(0,"tr")(1,"td"),r(2),d(),s(3,"td",25),r(4),d(),s(5,"td")(6,"span",26),r(7),d()(),s(8,"td"),r(9),d()()),o&2){let e=t.$implicit,n=p(4);a(2),w(n.formatDateTime(e.recordedAt)),a(2),w(n.formatCurrency(e.amount)),a(3),w(e.method),a(2),w(e.reference||"-")}}function qe(o,t){if(o&1&&(s(0,"table",24)(1,"thead")(2,"tr")(3,"th"),r(4,"Date"),d(),s(5,"th"),r(6,"Amount"),d(),s(7,"th"),r(8,"Method"),d(),s(9,"th"),r(10,"Reference"),d()()(),s(11,"tbody"),Z(12,Be,10,4,"tr",null,Q),d()()),o&2){let e=p(3);a(12),K(e.orderService.payments())}}function He(o,t){if(o&1){let e=E();s(0,"div",21)(1,"div",22),I("click",function(){g(e);let i=p(2);return y(i.paymentHistoryExpanded.set(!i.paymentHistoryExpanded()))}),s(2,"h2"),r(3),d(),s(4,"button",23),r(5),d()(),_(6,qe,14,0,"table",24),d()}if(o&2){let e=p(2);a(3),D("Payment History (",e.orderService.payments().length,")"),a(2),D(" ",e.paymentHistoryExpanded()?"\u25BC":"\u25B6"," "),a(),f(e.paymentHistoryExpanded()?6:-1)}}function $e(o,t){if(o&1&&(s(0,"div",32),r(1),d()),o&2){let e=p().$implicit;a(),w(e.details)}}function Ge(o,t){if(o&1&&(s(0,"div",28)(1,"div",29),r(2),d(),s(3,"div",30)(4,"div",31),r(5),d(),_(6,$e,2,1,"div",32),d()()),o&2){let e=t.$implicit,n=p(4);a(2),w(n.formatDateTime(e.timestamp)),a(3),w(n.getActionLabel(e.action)),a(),f(e.details?6:-1)}}function We(o,t){if(o&1&&(s(0,"div",27),Z(1,Ge,7,3,"div",28,Q),d()),o&2){let e=p(3);a(),K(e.userVisibleHistory())}}function Qe(o,t){if(o&1){let e=E();s(0,"div",21)(1,"div",22),I("click",function(){g(e);let i=p(2);return y(i.orderHistoryExpanded.set(!i.orderHistoryExpanded()))}),s(2,"h2"),r(3),d(),s(4,"button",23),r(5),d()(),_(6,We,3,0,"div",27),d()}if(o&2){let e=p(2);a(3),D("Order Activity (",e.userVisibleHistory().length,")"),a(2),D(" ",e.orderHistoryExpanded()?"\u25BC":"\u25B6"," "),a(),f(e.orderHistoryExpanded()?6:-1)}}function Ze(o,t){if(o&1){let e=E();s(0,"app-ledger-order-items",20),I("deleteItem",function(i){g(e);let l=p();return y(l.onDeleteItem(i))})("addonToggle",function(i){g(e);let l=p();return y(l.onAddonToggle(i))})("deleteScreenshot",function(i){g(e);let l=p();return y(l.onDeleteScreenshot(i))})("showCashInstructions",function(){g(e);let i=p();return y(i.showCashInstructionOverlay.set(!0))}),d(),_(1,He,7,3,"div",21),_(2,Qe,7,3,"div",21)}if(o&2){let e=p();R("lockedItems",e.lockedItems())("submittedItems",e.submittedItems())("securedItems",e.securedItems())("paidItems",e.paidItems())("editable",!0)("isAdmin",!1)("screenshotGroups",e.screenshotGroups()),a(),f(e.orderService.payments().length>0?1:-1),a(),f(e.userVisibleHistory().length>0?2:-1)}}function Ke(o,t){if(o&1){let e=E();s(0,"app-payment-instruction-overlay",33),I("close",function(){g(e);let i=p();return y(i.showPaymentOverlay.set(!1))})("uploadFile",function(i){g(e);let l=p();return y(l.onOverlayUpload(i))}),d()}if(o&2){let e=p();R("paymentOption",e.selectedPaymentOption())("totalAmount",e.lockedItemsTotal())("depositAmount",e.lockedDepositAmount())("immediatelyDue",e.lockedItemsDueNow())("uploading",e.uploadService.uploading())("uploadProgress",e.uploadService.uploadProgress())}}function Ye(o,t){if(o&1){let e=E();s(0,"div",34),I("click",function(){g(e);let i=p();return y(i.showCashInstructionOverlay.set(!1))}),s(1,"div",35),I("click",function(i){return g(e),y(i.stopPropagation())}),s(2,"button",36),I("click",function(){g(e);let i=p();return y(i.showCashInstructionOverlay.set(!1))}),r(3,"\xD7"),d(),s(4,"h2"),r(5,"\u{1F4B5} Cash Payment Instructions"),d(),s(6,"div",37)(7,"p"),r(8,"Please pay the remaining cash balance using one of the following methods:"),d(),s(9,"div",38)(10,"h3"),r(11,"WeChat Pay"),d(),s(12,"p"),r(13,"Scan the QR code below to pay via WeChat:"),d(),B(14,"img",39),d(),s(15,"div",38)(16,"h3"),r(17,"Cash In Person"),d(),s(18,"p"),r(19,"You may also pay cash in person. Please contact us to arrange a time."),d()()()()()}}var he=class o{orderService=k(pe);uploadService=k(H);seasonService=k(me);userService=k(ue);authService=k(ge);confirmDialog=k(ye);orderRpc=k(ce);router=k(oe);selectedPaymentOption=C("zelle");showPaymentOverlay=C(!1);showCashInstructionOverlay=C(!1);paymentHistoryExpanded=C(!1);orderHistoryExpanded=C(!1);pendingAddonUpdates=C(new Map);ngOnInit(){this.seasonService.selectedSeason()||this.seasonService.loadSeasons()}transformItem(t){let e=this.userService.getStudentById(t.studentId),n=`${t.sessionId}:${t.studentId}`,l=this.pendingAddonUpdates().get(n)??t.options,{basePrice:h,lunchPrice:x,extendedCarePrice:O}=t.snapshot.priceSnapshot,P=h+(l.lunch?x:0)+(l.extendedCare?O:0);return{sessionId:t.sessionId,studentId:t.studentId,studentName:e?`${e.firstName} ${e.lastName}`.trim():"Unknown",className:t.snapshot.className,startDate:t.snapshot.startDate,endDate:t.snapshot.endDate,status:t.status,options:l,pricing:{basePrice:h,lunchPrice:x,extendedCarePrice:O,itemTotal:P}}}lockedItems=v(()=>this.orderService.items().filter(t=>t.status==="locked").map(t=>this.transformItem(t)).sort((t,e)=>t.className.localeCompare(e.className)));submittedItems=v(()=>this.orderService.items().filter(t=>t.status==="submitted").map(t=>this.transformItem(t)).sort((t,e)=>t.className.localeCompare(e.className)));screenshotGroups=v(()=>{let t=this.orderService.paymentScreenshots(),e=this.submittedItems();return t.map(n=>{let i=new Set(n.lockedItemKeys),l=e.filter(h=>{let x=`${h.sessionId}:${h.studentId}`;return i.has(x)});return{screenshot:n,items:l}}).filter(n=>n.items.length>0)});securedItems=v(()=>this.orderService.items().filter(t=>t.status==="secured").map(t=>this.transformItem(t)).sort((t,e)=>t.className.localeCompare(e.className)));securedItemsTotal=v(()=>this.securedItems().reduce((t,e)=>t+e.pricing.itemTotal,0));securedDepositPaid=v(()=>this.securedItems().length*5e3);paidItems=v(()=>this.orderService.items().filter(t=>t.status==="paid").map(t=>this.transformItem(t)).sort((t,e)=>t.className.localeCompare(e.className)));paidItemsTotal=v(()=>this.paidItems().reduce((t,e)=>t+e.pricing.itemTotal,0));rejectionNote=v(()=>this.orderService.order()?.rejectionNote??null);userVisibleHistory=v(()=>{let t=["payment_recorded","refund_processed","items_submitted","change_approved","change_denied","waitlist_promoted","items_cancelled"];return[...this.orderService.order()?.history??[]].filter(n=>t.includes(n.action)).reverse()});hasNoItems(){return this.lockedItems().length===0&&this.submittedItems().length===0&&this.securedItems().length===0&&this.paidItems().length===0}lockedItemsTotal=v(()=>this.lockedItems().reduce((t,e)=>t+e.pricing.itemTotal,0));lockedDepositAmount=v(()=>{let n=this.lockedItems().length*5e3,i=this.lockedItemsTotal();return Math.min(n,i)});lockedItemsDiscount=v(()=>{let t=this.orderService.order()?.pricing;if(!t)return 0;let e=t.discounts.reduce((i,l)=>i+l.amount,0),n=(this.orderService.order()?.processingFees??[]).reduce((i,l)=>i+l.amount,0);return e+n});lockedItemsDueNow=v(()=>{let t=this.orderSummaryData();if(!t)return 0;let n=this.orderService.paymentScreenshots().reduce((i,l)=>i+(l.claimedAmountCents??0),0);return Math.max(0,t.amountDue-n)});orderSummaryData=v(()=>{let t=this.orderService.order(),e=t?.pricing;if(!e)return null;let i=[...this.lockedItems(),...this.submittedItems(),...this.securedItems(),...this.paidItems()].reduce((u,b)=>u+b.pricing.itemTotal,0),l=new Map;for(let u of e.discounts){let b=l.get(u.type)??0;l.set(u.type,b+u.amount)}for(let u of t.processingFees??[]){let b=l.get(u.type)??0;l.set(u.type,b+u.amount)}let h=[],x={returning_family:"\u{1F468}\u200D\u{1F469}\u200D\u{1F467} Returning Family",returning_student:"\u{1F393} Returning Student",sibling:"\u{1F46B} Sibling Discount",multi_session:"\u{1F4C5} Multi-Session",coupon:"\u{1F39F}\uFE0F Coupon Credit",manual:"\u270F\uFE0F Manual Adjustment",referral:"\u{1F91D} Referral Bonus",cash_discount:"\u{1F4B5} Cash Discount (3%)",adjustment:"\u270F\uFE0F Adjustment",forfeited_deposit:"\u26A0\uFE0F Forfeited Deposit"};for(let[u,b]of l)b!==0&&h.push({type:u,label:x[u]??u,amount:b});let P=this.orderService.paymentScreenshots().reduce((u,b)=>u+(b.claimedAmountCents??0),0),N=this.orderService.payments().reduce((u,b)=>u+b.amount,0),S=this.securedItems().length,L=this.paidItems().length,Ce=5e3,A=0,G=0;S>0&&L===0?A=N:S===0&&L>0?G=N:S>0&&L>0&&(A=Math.min(S*Ce,N),G=N-A);let be=[{status:"locked",label:"Awaiting Payment",count:this.lockedItems().length,total:this.lockedItemsTotal()},{status:"submitted",label:"Pending Verification",count:this.submittedItems().length,total:P},{status:"secured",label:"Deposit Confirmed",count:S,total:A},{status:"paid",label:"Payment Confirmed",count:L,total:G}],xe=h.reduce((u,b)=>u+b.amount,0),X=this.orderService.totalPaid(),Pe=Math.max(0,i+xe-X);return{subtotal:i,totalPaid:X,discounts:h,amountDue:Pe,statusCounts:be}});goToCatalog(){this.router.navigate(["/"])}formatPrice(t){return(t/100).toLocaleString("en-US",{minimumFractionDigits:0})}formatDateTime(t){return t?new Date(t).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}):"-"}formatCurrency(t){return"$"+(t/100).toFixed(2)}getActionLabel(t){return{payment_recorded:"Payment Confirmed",refund_processed:"Refund Issued",items_submitted:"Order Submitted",items_cancelled:"Items Cancelled",change_approved:"Change Request Approved",change_denied:"Change Request Denied",waitlist_promoted:"Promoted from Waitlist"}[t]??t.replace(/_/g," ")}onPaymentOptionChange(t){this.selectedPaymentOption.set(t)}async onDeleteItem(t){if(t.status!=="locked"||!await this.confirmDialog.confirm({title:"Release Reservation?",message:`This will release ${t.studentName} from "${t.className}". The spot will become available to others.`,confirmText:"Release",cancelText:"Keep",confirmButtonClass:"danger"}))return;let n=this.seasonService.selectedSeason();if(n)try{await this.orderRpc.releaseLockedItems({year:n.year,seasonId:n.id,items:[{sessionId:t.sessionId,studentId:t.studentId}]})}catch(i){console.error("Failed to release reservation:",i)}}async onAddonToggle(t){let{item:e,addon:n,value:i}=t;if(e.status!=="locked")return;let l=this.seasonService.selectedSeason();if(!l)return;let h={lunch:n==="lunch"?i:e.options.lunch,extendedCare:n==="extendedCare"?i:e.options.extendedCare},x=`${e.sessionId}:${e.studentId}`;this.pendingAddonUpdates.update(O=>{let P=new Map(O);return P.set(x,h),P});try{await this.orderRpc.updateLockedItemOptions({year:l.year,seasonId:l.id,sessionId:e.sessionId,studentId:e.studentId,options:h}),this.pendingAddonUpdates.update(O=>{let P=new Map(O);return P.delete(x),P})}catch(O){console.error("Failed to update addon:",O),this.pendingAddonUpdates.update(P=>{let z=new Map(P);return z.delete(x),z})}}onSubmitPayment(){this.showPaymentOverlay.set(!0)}async onOverlayUpload(t){try{let e=this.authService.firebaseUser()?.uid;if(!e)throw new Error("Not authenticated");let n=await this.uploadService.uploadScreenshot(t,e),i=this.selectedPaymentOption(),l=i==="cash_deposit"?this.lockedDepositAmount():this.lockedItemsDueNow();await this.orderService.placeOrder(n.storagePath,i,l),this.showPaymentOverlay.set(!1)}catch(e){console.error("Upload failed:",e)}}async onDeleteScreenshot(t){try{let e=this.seasonService.selectedSeason()?.id;if(!e)throw new Error("No season selected");await this.orderRpc.deleteScreenshot({seasonId:e,screenshotId:t})}catch(e){console.error("Delete screenshot failed:",e)}}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=U({type:o,selectors:[["app-ledger"]],decls:21,vars:13,consts:[[1,"ledger-page"],[1,"page-header"],[1,"subtitle"],[1,"ledger-layout"],[1,"main-column"],[1,"agreement-links"],["routerLink","/acknowledgement",1,"agreement-link"],["width","16","height","16","viewBox","0 0 24 24","fill","currentColor"],["d","M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"],[1,"rejection-notice"],[1,"loading-state"],[1,"empty-state"],[1,"sidebar-column"],[3,"optionChange","submitClick","lockedItemsTotal","lockedSessionCount","lockedDepositAmount","lockedItemsDueNow","lockedItemsDiscount","hasLockedItems","hasSecuredItems","selectedOption","orderSummary"],[3,"paymentOption","totalAmount","depositAmount","immediatelyDue","uploading","uploadProgress"],[1,"overlay-backdrop"],[1,"rejection-icon"],[1,"rejection-content"],[1,"spinner"],[1,"btn-browse",3,"click"],[3,"deleteItem","addonToggle","deleteScreenshot","showCashInstructions","lockedItems","submittedItems","securedItems","paidItems","editable","isAdmin","screenshotGroups"],[1,"info-card"],[1,"section-header",3,"click"],["type","button",1,"toggle-btn"],[1,"payments-table"],[1,"amount"],[1,"method-badge"],[1,"history-timeline"],[1,"history-event"],[1,"event-time"],[1,"event-details"],[1,"event-action"],[1,"event-metadata"],[3,"close","uploadFile","paymentOption","totalAmount","depositAmount","immediatelyDue","uploading","uploadProgress"],[1,"overlay-backdrop",3,"click"],[1,"cash-instruction-modal",3,"click"],[1,"modal-close",3,"click"],[1,"instruction-content"],[1,"payment-method"],["src","/wechat_blueberry.png","alt","WeChat QR Code",1,"qr-code"]],template:function(e,n){e&1&&(s(0,"div",0)(1,"header",1)(2,"h1"),r(3,"My Ledger"),d(),s(4,"p",2),r(5,"Spot holds remain active during payment audit"),d()(),s(6,"div",3)(7,"div",4)(8,"div",5)(9,"a",6),F(),s(10,"svg",7),B(11,"path",8),d(),r(12," View Liability Release & Financial Terms "),d()(),_(13,je,8,1,"div",9),_(14,Ue,4,0,"div",10)(15,Re,5,0,"div",11)(16,Ze,3,9),d(),j(),s(17,"div",12)(18,"app-ledger-settlement-sidebar",13),I("optionChange",function(l){return n.onPaymentOptionChange(l)})("submitClick",function(){return n.onSubmitPayment()}),d()()()(),_(19,Ke,1,6,"app-payment-instruction-overlay",14),_(20,Ye,20,0,"div",15)),e&2&&(a(13),f(n.rejectionNote()?13:-1),a(),f(n.orderService.loading()?14:n.hasNoItems()?15:16),a(4),R("lockedItemsTotal",n.lockedItemsTotal())("lockedSessionCount",n.lockedItems().length)("lockedDepositAmount",n.lockedDepositAmount())("lockedItemsDueNow",n.lockedItemsDueNow())("lockedItemsDiscount",n.lockedItemsDiscount())("hasLockedItems",n.lockedItems().length>0)("hasSecuredItems",n.securedItems().length>0)("selectedOption",n.selectedPaymentOption())("orderSummary",n.orderSummaryData()),a(),f(n.showPaymentOverlay()?19:-1),a(),f(n.showCashInstructionOverlay()?20:-1))},dependencies:[q,ie,_e,$,fe],styles:[".ledger-page[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto;padding:1.5rem}.page-header[_ngcontent-%COMP%]{margin-bottom:1.5rem}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1.75rem;color:var(--sys-on-surface, #212121)}.page-header[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{margin:0;color:var(--sys-on-surface-variant, #666);font-size:.95rem}.ledger-layout[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 350px;gap:1.5rem;align-items:start}.main-column[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem}.agreement-links[_ngcontent-%COMP%]{display:flex;gap:1rem}.agreement-link[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.75rem 1rem;background:var(--sys-surface-container, #f5f5f5);border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;color:var(--sys-primary, #c62828);text-decoration:none;font-size:.875rem;font-weight:500;transition:all .2s}.agreement-link[_ngcontent-%COMP%]:hover{background:var(--sys-primary-container, #ffebee);border-color:var(--sys-primary, #c62828)}.agreement-link[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{opacity:.8}.rejection-notice[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:.75rem;padding:1rem;background:#fff3cd;border:1px solid #ffc107;border-left:4px solid #ff9800;border-radius:8px;margin-bottom:.5rem}.rejection-icon[_ngcontent-%COMP%]{font-size:1.25rem;line-height:1}.rejection-content[_ngcontent-%COMP%]{flex:1}.rejection-content[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{display:block;color:#856404;margin-bottom:.25rem}.rejection-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:#664d03;font-size:.9rem}.loading-state[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:2rem;color:var(--sys-on-surface-variant, #666)}.spinner[_ngcontent-%COMP%]{width:24px;height:24px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:3rem;background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;color:var(--sys-on-surface-variant, #666)}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 1rem}.btn-browse[_ngcontent-%COMP%]{padding:.75rem 1.5rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:background .2s}.btn-browse[_ngcontent-%COMP%]:hover{background:var(--sys-primary-dark, #a51c1c)}.sidebar-column[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;position:sticky;top:1rem}.overlay-backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:#0009;display:flex;align-items:center;justify-content:center;z-index:1000}.cash-instruction-modal[_ngcontent-%COMP%]{background:#fff;border-radius:16px;padding:2rem;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;position:relative}.modal-close[_ngcontent-%COMP%]{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--sys-on-surface-variant, #666);line-height:1;padding:.25rem}.modal-close[_ngcontent-%COMP%]:hover{color:var(--sys-on-surface, #212121)}.cash-instruction-modal[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0 0 1.5rem;font-size:1.25rem;color:var(--sys-on-surface, #212121)}.instruction-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-on-surface-variant, #666);line-height:1.5}.payment-method[_ngcontent-%COMP%]{background:var(--sys-surface-container, #f5f5f5);border-radius:12px;padding:1.25rem;margin-bottom:1rem}.payment-method[_ngcontent-%COMP%]:last-child{margin-bottom:0}.payment-method[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1rem;color:var(--sys-on-surface, #212121)}.payment-method[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:.9rem}.payment-method[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]:last-child{margin-bottom:0}.qr-code[_ngcontent-%COMP%]{display:block;max-width:200px;margin:0 auto;border-radius:8px}.info-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.25rem}.section-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;cursor:pointer}.section-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600}.toggle-btn[_ngcontent-%COMP%]{background:none;border:none;font-size:.875rem;cursor:pointer;color:var(--sys-on-surface-variant, #666)}.payments-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;margin-top:1rem}.payments-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;padding:.75rem;background:#f8f9fa;border-bottom:2px solid #dee2e6;font-weight:600;font-size:.875rem}.payments-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem;border-bottom:1px solid #dee2e6;font-size:.875rem}.payments-table[_ngcontent-%COMP%]   .amount[_ngcontent-%COMP%]{font-weight:600}.method-badge[_ngcontent-%COMP%]{background:#6c757d;color:#fff;padding:.25rem .5rem;border-radius:4px;font-size:.75rem;text-transform:capitalize}.history-timeline[_ngcontent-%COMP%]{margin-top:1rem}.history-event[_ngcontent-%COMP%]{padding:.75rem 0;border-bottom:1px solid #eee}.history-event[_ngcontent-%COMP%]:last-child{border-bottom:none}.event-time[_ngcontent-%COMP%]{font-size:.75rem;color:#666;margin-bottom:.25rem}.event-action[_ngcontent-%COMP%]{font-weight:500}.event-metadata[_ngcontent-%COMP%]{font-size:.875rem;color:#666;margin-top:.25rem}@media(max-width:900px){.ledger-layout[_ngcontent-%COMP%]{grid-template-columns:1fr}.sidebar-column[_ngcontent-%COMP%]{position:static;order:-1}}"]})};export{he as LedgerComponent};
