import{a as D}from"./chunk-BV4MKCLK.js";import{$ as c,La as E,Ma as k,Oa as T,U as w,X as O,Y as I,Z as U,aa as d,ba as h,ca as y,da as f,fa as q,ha as W,va as u}from"./chunk-UBU22GLA.js";import{M as S,R,a as b,b as v,g as P,ha as A}from"./chunk-UKFGIOHC.js";var x=30,_=class m{db=new E(U(w()));firestore=U(w());seasonDatastore=R(D);userDatastore=R(k);async getUserSeasonOrder(e,r){let s=`years/${e}/orders`,t=await this.db.getDocument(s,r);return t?u.parse(t):null}subscribeToOrder(e,r){return new P(s=>{let t=I(this.firestore,`years/${e}/orders`,r),a=W(t,i=>{if(!i.exists()){s.next(null);return}try{let o=v(b({},i.data()),{id:i.id}),n=u.parse(o);s.next(n)}catch(o){s.error(o)}},i=>{s.error(i)});return()=>a()})}async listSeasonOrders(e,r){let s=`years/${e}/orders`;return(await this.db.getDocuments(s,[{field:"seasonId",op:"==",value:r}])).map(a=>u.parse(a))}async listYearOrders(e){let r=`years/${e}/orders`;return(await this.db.getDocuments(r)).map(t=>u.parse(t))}async listOrdersWithSubmittedItems(e){return(await this.listYearOrders(e)).filter(s=>s.items.some(t=>t.status==="submitted"))}async listOverdueOrders(e,r){let s=await this.listOrdersWithSubmittedItems(e),t=new Date(r);return s.filter(a=>a.lockExpiresAt?new Date(a.lockExpiresAt)<t:!1)}async listOrdersWithChangeRequests(e){return(await this.listYearOrders(e)).filter(s=>s.changeRequests&&s.changeRequests.some(t=>t.status==="pending"))}async listAllWaitlistEntries(e){let r=await this.listYearOrders(e),s=await this.seasonDatastore.listAllSeasons(e),t=new Map;for(let n of s)for(let l of n.sessions??[])t.set(l.id,l.name);let a=await this.userDatastore.listAllUsers(),i=new Map;for(let n of a)i.set(n.uid,n.displayName);let o=[];for(let n of r)if(!(!n.waitlist||n.waitlist.length===0))for(let l of n.waitlist)o.push({userId:n.userAuthId,userName:i.get(n.userAuthId)??"Unknown User",sessionId:l.sessionId,className:t.get(l.sessionId)??"Unknown Class",joinedAt:l.joinedAt??""});return o.sort((n,l)=>n.joinedAt.localeCompare(l.joinedAt)),o}async listWaitlistByClass(e,r){return(await this.listAllWaitlistEntries(e)).filter(t=>t.sessionId===r)}async listOrdersPaginated(e,r,s,t){let a=O(this.firestore,`years/${e}/orders`),i=t?c(a,d("seasonId","==",r),h("updatedAt","desc"),f(t),y(s)):c(a,d("seasonId","==",r),h("updatedAt","desc"),y(s)),o=await q(i),n=o.docs.map(g=>u.parse(g.data())),l=o.size>=s,p=l?o.docs[o.docs.length-1]:null;return{orders:n,lastDoc:p,hasMore:l}}async listOverdueOrdersPaginated(e,r,s,t,a){let i=O(this.firestore,`years/${e}/orders`),o=a?c(i,d("seasonId","==",r),d("orderStatus","==","submitted"),d("lockExpiresAt","<",s),h("lockExpiresAt","desc"),f(a),y(t)):c(i,d("seasonId","==",r),d("orderStatus","==","submitted"),d("lockExpiresAt","<",s),h("lockExpiresAt","desc"),y(t)),n=await q(o),l=n.docs.map(C=>u.parse(C.data())),p=n.size>=t,g=p?n.docs[n.docs.length-1]:null;return{orders:l,lastDoc:g,hasMore:p}}async listOrdersByStatusPaginated(e,r,s,t,a){let i=O(this.firestore,`years/${e}/orders`),o=a?c(i,d("seasonId","==",r),d("orderStatus","==",s),h("updatedAt","desc"),f(a),y(t)):c(i,d("seasonId","==",r),d("orderStatus","==",s),h("updatedAt","desc"),y(t)),n=await q(o),l=n.docs.map(C=>u.parse(C.data())),p=n.size>=t,g=p?n.docs[n.docs.length-1]:null;return{orders:l,lastDoc:g,hasMore:p}}async listOrdersByUserIds(e,r){if(r.length===0)return[];let s=O(this.firestore,`years/${e}/orders`),t=[];for(let a=0;a<r.length;a+=x){let i=r.slice(a,a+x),o=c(s,d("userAuthId","in",i)),n=await q(o);for(let l of n.docs)t.push(u.parse(l.data()))}return t}async listOrdersBySessionId(e,r,s){return(await this.listSeasonOrders(e,r)).filter(a=>a.items.some(i=>i.sessionId===s))}static \u0275fac=function(r){return new(r||m)};static \u0275prov=S({token:m,factory:m.\u0275fac,providedIn:"root"})};var j=class m{functions=R(T);_loading=A(!1);_error=A(null);loading=this._loading.asReadonly();error=this._error.asReadonly();async lockSessions(e){return this.wrapApiCall("lockSessions",e)}async recordPayment(e){return this.wrapApiCall("recordOrderPayment",e)}async placeOrder(e){return this.wrapApiCall("placeOrder",e)}async cancelItems(e){return this.wrapCall("cancelOrderItems",e)}async joinWaitlist(e){return this.wrapApiCall("joinWaitlist",e)}async leaveWaitlist(e){return this.wrapApiCall("leaveWaitlist",e)}async removeWaitlistEntry(e){return this.wrapApiCall("removeWaitlistEntry",e)}async removeSubmittedItems(e){return this.wrapApiCall("removeSubmittedItems",e)}async applySubmittedChanges(e){return this.wrapApiCall("applySubmittedChanges",e)}async requestOrderChange(e){return this.wrapApiCall("requestChange",e)}async updateChangeRequest(e){return this.wrapApiCall("updateChangeRequest",e)}async approveChangeRequest(e){return this.wrapApiCall("approveChange",e)}async denyChangeRequest(e){return this.wrapApiCall("denyChange",e)}async listAllOrders(e,r){return this.wrapCall("listAllOrders",{status:e,limit:r})}async listOverdueOrders(){return this.wrapCall("listOverdueOrders",void 0)}async listChangeRequests(){return this.wrapCall("listChangeRequests",void 0)}async adminCancelOrder(e,r,s){await this.wrapApiCall("cancelOrder",{userAuthId:e,itemsToCancel:r,reason:s})}async getOrder(e){return this.wrapCall("getOrder",{userAuthId:e})}async listAllWaitlistEntries(){return this.wrapCall("listAllWaitlistEntries",{})}async listWaitlistByClass(e){return this.wrapCall("listWaitlistByClass",{sessionId:e})}clearError(){this._error.set(null)}async wrapCall(e,r){this._loading.set(!0),this._error.set(null);try{return await this.functions.call(e,r)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async wrapApiCall(e,r){this._loading.set(!0),this._error.set(null);try{return await this.functions.callApi(e,r)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}static \u0275fac=function(r){return new(r||m)};static \u0275prov=S({token:m,factory:m.\u0275fac,providedIn:"root"})};export{_ as a,j as b};
