import{a as J,d as ue,g as Ee}from"./chunk-4EDQJUXU.js";import"./chunk-BENLYYZ6.js";import{c as Ce,f as ye,i as ve,j as be,k as we,r as Me}from"./chunk-5M3WJSTJ.js";import"./chunk-GZ2C2WLL.js";import{a as Se}from"./chunk-6THQUTU6.js";import"./chunk-35QEJLB4.js";import"./chunk-BV4MKCLK.js";import{a as _e}from"./chunk-TZNWTF3S.js";import{b as xe}from"./chunk-VVYVTIM6.js";import{$ as N,U as pe,X as Y,Y as k,Z as me,_ as ge,aa as $,ba as Z,ca as K,d as de,da as fe,ea as F,fa as Q,j as ce,k as le,ma as he}from"./chunk-UBU22GLA.js";import{Ab as ie,Cb as m,Db as R,Eb as ae,Fa as ne,Ia as h,R as D,Ta as oe,W as L,X as W,a as ee,b as te,bb as M,cb as E,fb as z,gb as q,ha as P,hb as U,ib as g,jb as u,kb as se,ob as re,qb as V,sb as O}from"./chunk-UKFGIOHC.js";var ke=50,Ne=30,B=class{constructor(t){this.firestore=t}async loadSeason(t,e){let n=k(this.firestore,`years/${t}/seasons`,e),o=await F(n);if(!o.exists())throw new Error(`Season ${e} not found`);let i=o.data();return he(i)}async loadOrders(t,e,n,o=ke){let i=[],a=Y(this.firestore,`years/${t}/orders`),r=null,d=0;for(;;){d++,n({step:"Loading orders...",detail:`batch ${d}`});let l=r?N(a,$("seasonId","==",e),Z("userAuthId"),K(o),fe(r)):N(a,$("seasonId","==",e),Z("userAuthId"),K(o)),c=await Q(l);for(let p of c.docs)i.push(p.data());if(c.size<o)break;r=c.docs[c.docs.length-1]}return i}async loadUsers(t,e,n=Ne){let o=new Map,i=[...new Set(t)];if(i.length===0)return o;let a=Y(this.firestore,"users"),r=Math.ceil(i.length/n);for(let d=0;d<i.length;d+=n){let l=Math.floor(d/n)+1;e({step:"Loading user data...",detail:`batch ${l} of ${r}`});let c=i.slice(d,d+n),p=N(a,$(ge(),"in",c)),_=await Q(p);for(let y of _.docs){let w=y.data();o.set(w.uid,w)}}return o}async loadRegistration(t,e){let n=k(this.firestore,`years/${t}/registrations`,e),o=await F(n);return o.exists()?o.data():null}async loadCoupons(t,e){let n=[...t.coupons??[]],o=new Set(n.map(a=>a.id)),i=new Set;for(let a of e)for(let r of a.appliedCouponIds??[])o.has(r)||i.add(r);for(let a of i){let r=k(this.firestore,"coupons",a),d=await F(r);d.exists()&&n.push(d.data())}return n}async loadAllData(t,e,n){n({step:"Loading season data..."});let o=await this.loadSeason(t,e),i=await this.loadOrders(t,e,n),a=i.map(c=>c.userAuthId),r=await this.loadUsers(a,n);n({step:"Loading registration data..."});let d=await this.loadRegistration(t,e);n({step:"Loading coupon data..."});let l=await this.loadCoupons(o,i);return{season:o,orders:i,users:r,registration:d,coupons:l}}};var Oe="https://sheets.googleapis.com/v4/spreadsheets",G=class{async acquireAccessToken(){let t=new J;t.addScope("https://www.googleapis.com/auth/spreadsheets");let e=await ue(Ee,t),n=J.credentialFromResult(e);if(!n)throw new Error("Failed to obtain Google credentials");let o=n.accessToken;if(!o)throw new Error("Failed to obtain access token");return o}async createSpreadsheet(t,e,n){let o=await fetch(Oe,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:t},sheets:e.map(a=>({properties:{title:a}}))})});if(!o.ok){let a=await o.text();throw new Error(`Google Sheets API error (${o.status}): ${a}`)}let i=await o.json();return{spreadsheetId:i.spreadsheetId,spreadsheetUrl:i.spreadsheetUrl}}async writeSheetData(t,e,n,o){let i=encodeURIComponent(e),a=`${Oe}/${t}/values/${i}?valueInputOption=RAW`,r=await fetch(a,{method:"PUT",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({range:e,majorDimension:"ROWS",values:n})});if(!r.ok){let d=await r.text();throw new Error(`Google Sheets API error (${r.status}): ${d}`)}}};function C(s){return`$${(s/100).toFixed(2)}`}function X(s,t,e){let n=s.get(t);return n?(n.students??[]).find(o=>o.id===e)??null:null}function $e(s,t){return s.sessions.find(e=>e.id===t)?.name??t}function Pe(s,t,e){let o=["Order User Display ID","Parent Name","Parent Email","Parent Phone","Student Name","Student DOB","Student Gender","Student School","Student Allergies",...e.sessions.map(r=>r.name),"Student Subtotal","Order Discount","Order Total"],i=[];for(let r of s){let d=t.get(r.userAuthId),l=d?.displayName??"",c=r.items,p=new Map;for(let x of c){let b=p.get(x.studentId)??[];b.push(x),p.set(x.studentId,b)}if(p.size===0)continue;let _=(r.pricing?.discounts??[]).reduce((x,b)=>x+b.amount,0),y=r.pricing?.subtotal??0,w=Math.max(0,y+_),f=[...p.keys()].sort((x,b)=>{let S=X(t,r.userAuthId,x),j=S?`${S.firstName} ${S.lastName}`.trim():"",I=X(t,r.userAuthId,b),A=I?`${I.firstName} ${I.lastName}`.trim():"";return j.localeCompare(A)}),v=[],H=!0;for(let x of f){let b=p.get(x),S=X(t,r.userAuthId,x),j=e.sessions.map(A=>{let T=b.find(Re=>Re.sessionId===A.id);return T?C(T.snapshot.priceSnapshot.itemTotal):""}),I=b.reduce((A,T)=>A+T.snapshot.priceSnapshot.itemTotal,0);v.push([r.userDisplayId,l,d?.email??"",d?.primaryGuardian?.phone??"",S?`${S.firstName} ${S.lastName}`.trim():"",S?.dob??"",S?.gender??"",S?.school??"",S?.allergies??"",...j,C(I),H?C(Math.abs(_)):"",H?C(w):""]),H=!1}i.push({parentName:l,rows:v})}i.sort((r,d)=>r.parentName.localeCompare(d.parentName));let a=i.flatMap(r=>r.rows);return[o,...a]}function Ie(s,t){let e=["User Display ID","Parent Name","Parent Email","Order Total","Coupon Discount","Total Paid","Balance Due","Payment Count","Payment Details","Refund Total"],n=[];for(let o of s){if(!o.items.some(f=>f.status==="submitted"||f.status==="paid"))continue;let a=t.get(o.userAuthId),r=o.pricing?.subtotal??0,d=(o.pricing?.discounts??[]).reduce((f,v)=>f+v.amount,0),l=Math.max(0,r+d),c=o.couponDiscount??0,p=o.totalPaid??0,_=(o.refunds??[]).reduce((f,v)=>f+v.amount,0),y=Math.max(0,l-p-_),w=(o.payments??[]).map(f=>`${f.method} ${C(f.amount)} ${f.recordedAt}${f.reference?` ref:${f.reference}`:""}`).join("; ");n.push([o.userDisplayId,a?.displayName??"",a?.email??"",C(l),C(c),C(p),C(y),String((o.payments??[]).length),w,C(_)])}return[e,...n]}function Ae(s,t){let e=["Coupon ID","Name","Description","Type","Max Credit (cents)","Eligible Emails","Used By (Order Count)"],n=new Map;for(let i of t)for(let a of i.appliedCouponIds??[])n.set(a,(n.get(a)??0)+1);let o=s.map(i=>[i.id,i.name,i.description,i.coupon_type,String(i.maxCreditCents),(i.eligible_emails??[]).join(", "),String(n.get(i.id)??0)]);return[e,...o]}function De(s,t,e){let n=["User Display ID","Parent Name","Parent Email","Session ID","Session Name","Joined At"],o=[];for(let i of s){let a=t.get(i.userAuthId);for(let r of i.waitlist??[])o.push([i.userDisplayId,a?.displayName??"",a?.email??"",r.sessionId,$e(e,r.sessionId),r.joinedAt])}return[n,...o]}function Ue(s,t,e,n){let o=["Session ID","Session Name","Start Date","End Date","Capacity","Enrolled Count","Waitlisted Count","Available Spots","Enrolled Students"],i=new Map,a=new Map;for(let l of t){for(let c of l.items){let p=i.get(c.sessionId)??[];p.push(c.studentId),i.set(c.sessionId,p)}for(let c of l.waitlist??[])a.set(c.sessionId,(a.get(c.sessionId)??0)+1)}let r=new Map;if(n)for(let l of n.values())for(let c of l.students??[])r.set(c.id,`${c.firstName} ${c.lastName}`.trim());let d=s.sessions.map(l=>{let c=i.get(l.id)??[],p=c.length,_=a.get(l.id)??0,y=Math.max(0,l.capacity-p),w=c.map(f=>{let v=r.get(f);return v?`${v} (${f})`:f}).join(", ");return[l.id,l.name,l.startDate,l.endDate,String(l.capacity),String(p),String(_),String(y),w]});return[o,...d]}var Fe=(s,t)=>t.id,Be=(s,t)=>t.label;function Ge(s,t){s&1&&(g(0,"div",4),se(1,"div",5),g(2,"p"),m(3,"Loading seasons..."),u()())}function He(s,t){if(s&1&&(g(0,"option",11),m(1),u()),s&2){let e=t.$implicit;U("value",e.id),h(),R(e.name)}}function je(s,t){s&1&&m(0," Exporting... ")}function Le(s,t){s&1&&m(0," Export to Google Sheets ")}function We(s,t){s&1&&m(0," \u25CB ")}function ze(s,t){s&1&&m(0," \u25CC ")}function qe(s,t){s&1&&m(0," \u2713 ")}function Ve(s,t){s&1&&m(0," \u2717 ")}function Je(s,t){if(s&1&&(g(0,"span",21),m(1),u()),s&2){let e=O().$implicit;h(),ae("(",e.detail,")")}}function Ye(s,t){if(s&1&&(g(0,"div",18)(1,"span",19),M(2,We,1,0)(3,ze,1,0)(4,qe,1,0)(5,Ve,1,0),u(),g(6,"span",20),m(7),u(),M(8,Je,2,1,"span",21),u()),s&2){let e,n=t.$implicit;ie("step-pending",n.status==="pending")("step-in-progress",n.status==="in-progress")("step-completed",n.status==="completed")("step-error",n.status==="error"),h(2),E((e=n.status)==="pending"?2:e==="in-progress"?3:e==="completed"?4:e==="error"?5:-1),h(5),R(n.label),h(),E(n.detail?8:-1)}}function Ze(s,t){if(s&1&&(g(0,"div",13)(1,"h3"),m(2,"Export Progress"),u(),g(3,"div",16),z(4,Ye,9,11,"div",17,Be),u()()),s&2){let e=O(2);h(4),q(e.steps())}}function Ke(s,t){if(s&1&&(g(0,"div",14)(1,"div",22),m(2,"\u2713"),u(),g(3,"h3"),m(4,"Export Complete"),u(),g(5,"a",23),m(6," Open Spreadsheet \u2192 "),u()()),s&2){let e=O(2);h(5),U("href",e.spreadsheetUrl(),ne)}}function Qe(s,t){if(s&1&&(g(0,"div",15)(1,"p",24),m(2),u()()),s&2){let e=O(2);h(2),R(e.error())}}function Xe(s,t){if(s&1){let e=re();g(0,"div",6)(1,"div",7)(2,"label",8),m(3,"Select Season"),u(),g(4,"select",9),V("ngModelChange",function(o){L(e);let i=O();return W(i.onSeasonChange(o))}),g(5,"option",10),m(6,"-- Select a season --"),u(),z(7,He,2,2,"option",11,Fe),u()(),g(9,"button",12),V("click",function(){L(e);let o=O();return W(o.startExport())}),M(10,je,1,0)(11,Le,1,0),u()(),M(12,Ze,6,0,"div",13),M(13,Ke,7,1,"div",14),M(14,Qe,3,1,"div",15)}if(s&2){let e=O();h(4),U("ngModel",e.selectedSeasonId()),h(3),q(e.seasons()),h(2),U("disabled",!e.selectedSeasonId()||e.exporting()),h(),E(e.exporting()?10:11),h(2),E(e.steps().length>0?12:-1),h(),E(e.spreadsheetUrl()?13:-1),h(),E(e.error()?14:-1)}}var Te=class s{router=D(ce);userService=D(xe);configService=D(_e);seasonService=D(Se);_steps=P([]);_selectedSeasonId=P(null);_exporting=P(!1);_spreadsheetUrl=P(null);_error=P(null);_loadingSeasons=P(!1);steps=this._steps.asReadonly();selectedSeasonId=this._selectedSeasonId.asReadonly();exporting=this._exporting.asReadonly();spreadsheetUrl=this._spreadsheetUrl.asReadonly();error=this._error.asReadonly();loadingSeasons=this._loadingSeasons.asReadonly();seasons=this.seasonService.seasons;async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}this._loadingSeasons.set(!0);try{let t=this.configService.currentActiveYear();await this.seasonService.loadAllSeasons(t)}catch(t){this._error.set(t instanceof Error?t.message:"Failed to load seasons")}finally{this._loadingSeasons.set(!1)}}onSeasonChange(t){this._selectedSeasonId.set(t||null),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([])}async startExport(){let t=this._selectedSeasonId();if(t){this._exporting.set(!0),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([{label:"Authenticating with Google",status:"pending"},{label:"Loading data from Firestore",status:"pending"},{label:"Building spreadsheet data",status:"pending"},{label:"Creating Google Spreadsheet",status:"pending"},{label:"Writing sheet data",status:"pending"}]);try{this.updateStep(0,"in-progress");let e=new G,n=await e.acquireAccessToken();this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let o=this.configService.currentActiveYear(),i=me(pe()),r=await new B(i).loadAllData(o,t,_=>{this.updateStep(1,"in-progress",_.detail)});this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let d={Orders:Pe(r.orders,r.users,r.season),Payments:Ie(r.orders,r.users),Coupons:Ae(r.coupons,r.orders),Waitlist:De(r.orders,r.users,r.season),Sessions:Ue(r.season,r.orders,r.registration,r.users)};this.updateStep(2,"completed"),this.updateStep(3,"in-progress");let l=`${r.season.name} \u2014 Export ${new Date().toLocaleDateString()}`,c=Object.keys(d),p=await e.createSpreadsheet(l,c,n);this.updateStep(3,"completed"),this.updateStep(4,"in-progress");for(let[_,y]of Object.entries(d))this.updateStep(4,"in-progress",`Writing ${_}...`),await e.writeSheetData(p.spreadsheetId,_,y,n);this.updateStep(4,"completed"),this._spreadsheetUrl.set(p.spreadsheetUrl)}catch(e){let n=this._steps().findIndex(o=>o.status==="in-progress");n>=0&&this.updateStep(n,"error"),this._error.set(e instanceof Error?e.message:"Export failed")}finally{this._exporting.set(!1)}}}updateStep(t,e,n){this._steps.update(o=>o.map((i,a)=>a===t?te(ee({},i),{status:e,detail:n}):i))}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=oe({type:s,selectors:[["app-admin-export"]],decls:10,vars:1,consts:[[1,"admin-export"],[1,"page-header"],["routerLink","/admin",1,"back-link"],[1,"subtitle"],[1,"loading-container"],[1,"spinner"],[1,"export-card"],[1,"form-group"],["for","season-select"],["id","season-select",1,"season-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"btn-export",3,"click","disabled"],[1,"steps-card"],[1,"success-card"],[1,"error-card"],[1,"steps-list"],[1,"step",3,"step-pending","step-in-progress","step-completed","step-error"],[1,"step"],[1,"step-icon"],[1,"step-label"],[1,"step-detail"],[1,"success-icon"],["target","_blank","rel","noopener",1,"spreadsheet-link",3,"href"],[1,"error-message"]],template:function(e,n){e&1&&(g(0,"div",0)(1,"header",1)(2,"a",2),m(3,"\u2190 Back to Console"),u(),g(4,"h1"),m(5,"Data Export"),u(),g(6,"p",3),m(7,"Export season data to Google Sheets"),u()(),M(8,Ge,4,0,"div",4)(9,Xe,15,6),u()),e&2&&(h(8),E(n.loadingSeasons()?8:9))},dependencies:[de,Me,be,we,ve,Ce,ye,le],styles:[".admin-export[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:1.5rem}.page-header[_ngcontent-%COMP%]{margin-bottom:2rem}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1.75rem;color:var(--sys-on-surface, #212121)}.page-header[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{margin:0;color:var(--sys-on-surface-variant, #666)}.back-link[_ngcontent-%COMP%]{display:inline-block;margin-bottom:1rem;color:var(--sys-primary, #c62828);text-decoration:none;font-size:.875rem}.back-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem 2rem}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.export-card[_ngcontent-%COMP%], .steps-card[_ngcontent-%COMP%], .success-card[_ngcontent-%COMP%], .error-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.season-select[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;font-size:1rem;background:#fff}.btn-export[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-export[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-export[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.steps-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.steps-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.step[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.5rem 0}.step-icon[_ngcontent-%COMP%]{font-size:1rem;width:1.25rem;text-align:center}.step-pending[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #999)}.step-in-progress[_ngcontent-%COMP%]{color:var(--sys-tertiary, #1976d2);font-weight:500}.step-completed[_ngcontent-%COMP%]{color:var(--sys-secondary, #2e7d32)}.step-error[_ngcontent-%COMP%]{color:var(--sys-error, #c62828)}.step-detail[_ngcontent-%COMP%]{font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.success-card[_ngcontent-%COMP%]{text-align:center;border-color:var(--sys-secondary, #2e7d32)}.success-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--sys-secondary, #2e7d32);margin-bottom:.5rem}.success-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-secondary, #2e7d32)}.spreadsheet-link[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1.5rem;background:var(--sys-secondary, #2e7d32);color:#fff;border-radius:8px;text-decoration:none;font-weight:500}.spreadsheet-link[_ngcontent-%COMP%]:hover{opacity:.9}.error-card[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}.error-message[_ngcontent-%COMP%]{margin:0;color:var(--sys-error, #c62828);font-weight:500}"]})};export{Te as AdminExportComponent};
