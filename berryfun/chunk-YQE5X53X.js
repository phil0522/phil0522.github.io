import{W as m}from"./chunk-6R3HGSVM.js";import{F as u,aa as c,db as g,ha as h}from"./chunk-UYHN5VVP.js";import{I as o,N as l,Pb as d,da as s}from"./chunk-DU5POHF6.js";var b=class n{functions=l(m);firestore=h(u());_users=s([]);_rebuiltAt=s(null);_rebuiltBy=s(null);_userCount=s(0);_loading=s(!1);_rebuilding=s(!1);_error=s(null);_isLoaded=s(!1);users=this._users.asReadonly();rebuiltAt=this._rebuiltAt.asReadonly();rebuiltBy=this._rebuiltBy.asReadonly();userCount=this._userCount.asReadonly();loading=this._loading.asReadonly();rebuilding=this._rebuilding.asReadonly();error=this._error.asReadonly();isLoaded=this._isLoaded.asReadonly();rebuiltAtFormatted=d(()=>{let e=this._rebuiltAt();return e?new Date(e).toLocaleString():null});async loadCache(){if(!this._isLoaded()){this._loading.set(!0),this._error.set(null);try{let e=c(this.firestore,"admin","userCache"),t=await g(e);if(t.exists()){let r=t.data();this._users.set(r.users),this._rebuiltAt.set(r.rebuiltAt),this._rebuiltBy.set(r.rebuiltBy),this._userCount.set(r.userCount),this._isLoaded.set(!0)}else{this._isLoaded.set(!0),this._loading.set(!1),this._rebuilding()?console.log("Admin user cache miss - rebuild already in progress, skipping"):(console.log("Admin user cache miss - triggering automatic rebuild"),await this.rebuildCache());return}}catch(e){console.error("Failed to load user cache:",e),this._error.set("Failed to load user cache"),this._users.set([])}finally{this._loading.set(!1)}}}async reloadCache(){this._isLoaded.set(!1),await this.loadCache()}searchUsers(e){let t=this._users();if(!e||e.trim().length===0)return t;let r=e.toLowerCase().trim();return t.filter(i=>!!(i.email.toLowerCase().includes(r)||i.displayName.toLowerCase().includes(r)||i.parentName.toLowerCase().includes(r)||i.studentNames.some(a=>a.toLowerCase().includes(r))||i.wechat?.toLowerCase().includes(r)))}getUserByAuthId(e){return this._users().find(t=>t.authId===e)}async ensureUsersInCache(e){if(!this._isLoaded()||this._rebuilding())return!1;let t=this._users(),r=new Set(t.map(a=>a.authId)),i=e.filter(a=>!r.has(a));return i.length>0?(console.log(`Admin user cache miss for ${i.length} user(s) - triggering rebuild`),await this.rebuildCache(),!0):!1}async rebuildCache(){this._rebuilding.set(!0),this._error.set(null);try{await this.functions.callApi("rebuildAdminUserCache",{}),await this.reloadCache()}catch(e){console.error("Failed to rebuild user cache:",e),this._error.set("Failed to rebuild user cache")}finally{this._rebuilding.set(!1)}}clearCache(){this._users.set([]),this._rebuiltAt.set(null),this._rebuiltBy.set(null),this._userCount.set(0),this._isLoaded.set(!1),this._error.set(null)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=o({token:n,factory:n.\u0275fac,providedIn:"root"})};export{b as a};
