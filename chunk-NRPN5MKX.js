import{a as se}from"./chunk-GALFOU5G.js";import{a as L}from"./chunk-OHPF5INC.js";import{b as ae}from"./chunk-RWCIAQKD.js";import{b as ne,c as re,f as ie,q as oe}from"./chunk-LW7CKVVA.js";import{c as K}from"./chunk-RYIKU5Y3.js";import{$ as G,Z,ba as J,h as A,ja as X,l as Y,n as H,oa as ee,ra as te}from"./chunk-TKIXSRNU.js";import"./chunk-ZEYGPIIR.js";import"./chunk-KBXPF7D4.js";import"./chunk-2PX3OE6K.js";import{$a as h,Bb as O,Cb as W,Db as a,Ea as o,Eb as p,Fb as w,Jb as z,Kb as U,Lb as q,N as S,Qa as P,S as _,T as v,Tb as x,Vb as T,Wb as B,ab as f,da as g,db as E,eb as I,fb as k,gb as s,hb as d,ib as j,jb as l,kb as m,ob as b,pb as Q,qb as y,rb as C,sb as u}from"./chunk-CNMR2ZL6.js";import"./chunk-Q7L6LLAK.js";function ge(i,t){return this.getRowKey(t)}function he(i,t){if(i&1){let e=b();l(0,"tr",7),C("click",function(){let r=_(e).$implicit,c=u();return v(c.rowClick.emit({userAuthId:r.userAuthId,seasonId:r.seasonId}))}),l(1,"td",8),a(2),m(),l(3,"td",9),a(4),m(),l(5,"td",10),a(6),m(),l(7,"td")(8,"span",11),a(9),m()(),l(10,"td",4),a(11),m(),l(12,"td",4),a(13),m(),l(14,"td",12),a(15),m(),l(16,"td",13),a(17),m()()}if(i&2){let e=t.$implicit,n=u();o(2),p(n.getParentName(e)),o(2),p(n.getStudentNames(e)),o(2),p(n.getSessionNames(e)),o(2),W("status-"+n.getStatusClass(e)),o(),w(" ",n.getStatusLabel(e)," "),o(2),w("$",n.formatCents(n.getTotal(e))),o(2),w("$",n.formatCents(n.getPaid(e))),o(2),p(n.formatDeadline(e)),o(2),p(n.formatDate(e.createdAt))}}var N=class i{orders=B.required();userCache=B(new Map);rowClick=T();sortKey=g("created");sortDirection=g("desc");sortedOrders=x(()=>this.sortOrders(this.orders(),this.sortKey(),this.sortDirection()));getRowKey(t){return`${t.seasonId}:${t.userAuthId}`}getParentName(t){return this.userCache().get(t.userAuthId)?.parentName??t.userDisplayId}getStudentNames(t){let e=this.userCache().get(t.userAuthId);return e?.studentNames?.length?e.studentNames.join(", "):[...new Set(t.items.map(r=>r.studentId))].join(", ")}getSessionNames(t){let e=t.items.map(r=>r.snapshot.className);return[...new Set(e)].join(", ")}getStatusClass(t){return t.orderStatus??"submitted"}getStatusLabel(t){return{locked:"Locked",submitted:"Submitted",secured:"Registration Fee Received",paid:"Paid",empty:"Empty"}[t.orderStatus??""]??"Empty"}getTotal(t){return J(t)}getPaid(t){return G(t)}formatCents(t){return(t/100).toFixed(2)}formatDeadline(t){return t.lockExpiresAt?new Date(t.lockExpiresAt)<new Date?"Overdue":K(t.lockExpiresAt,{month:"short",day:"numeric"}):"-"}formatDate(t){return K(t,{month:"short",day:"numeric"})}toggleSort(t){if(this.sortKey()===t){this.sortDirection.set(this.sortDirection()==="asc"?"desc":"asc");return}this.sortKey.set(t),this.sortDirection.set(t==="created"?"desc":"asc")}getSortIndicator(t){return this.sortKey()!==t?"\u2195":this.sortDirection()==="asc"?"\u25B2":"\u25BC"}sortOrders(t,e,n){let r=n==="asc"?1:-1;return[...t].sort((c,R)=>this.compareOrder(c,R,e)*r)}compareOrder(t,e,n){switch(n){case"parentName":return this.compareText(this.getParentName(t),this.getParentName(e));case"students":return this.compareText(this.getStudentNames(t),this.getStudentNames(e));case"sessions":return this.compareText(this.getSessionNames(t),this.getSessionNames(e));case"status":return this.compareText(this.getStatusLabel(t),this.getStatusLabel(e));case"total":return this.getTotal(t)-this.getTotal(e);case"paid":return this.getPaid(t)-this.getPaid(e);case"deadline":return this.compareNullableTime(t.lockExpiresAt,e.lockExpiresAt);case"created":return this.compareNullableTime(t.createdAt,e.createdAt);default:return 0}}compareText(t,e){return t.localeCompare(e,void 0,{sensitivity:"base",numeric:!0})}compareNullableTime(t,e){let n=t?new Date(t).getTime():Number.POSITIVE_INFINITY,r=e?new Date(e).getTime():Number.POSITIVE_INFINITY;return n-r}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=P({type:i,selectors:[["app-admin-order-table"]],inputs:{orders:[1,"orders"],userCache:[1,"userCache"]},outputs:{rowClick:"rowClick"},decls:47,vars:8,consts:[[1,"table-container"],[1,"order-table"],["type","button",1,"sort-btn",3,"click"],[1,"sort-indicator"],[1,"col-amount"],["type","button",1,"sort-btn","sort-btn-right",3,"click"],[1,"order-row"],[1,"order-row",3,"click"],[1,"col-name"],[1,"col-students"],[1,"col-sessions"],[1,"status-badge"],[1,"col-deadline"],[1,"col-date"]],template:function(e,n){e&1&&(l(0,"div",0)(1,"table",1)(2,"thead")(3,"tr")(4,"th")(5,"button",2),C("click",function(){return n.toggleSort("parentName")}),a(6," Parent Name "),l(7,"span",3),a(8),m()()(),l(9,"th")(10,"button",2),C("click",function(){return n.toggleSort("students")}),a(11," Students "),l(12,"span",3),a(13),m()()(),l(14,"th")(15,"button",2),C("click",function(){return n.toggleSort("sessions")}),a(16," Sessions "),l(17,"span",3),a(18),m()()(),l(19,"th")(20,"button",2),C("click",function(){return n.toggleSort("status")}),a(21," Status "),l(22,"span",3),a(23),m()()(),l(24,"th",4)(25,"button",5),C("click",function(){return n.toggleSort("total")}),a(26," Total "),l(27,"span",3),a(28),m()()(),l(29,"th",4)(30,"button",5),C("click",function(){return n.toggleSort("paid")}),a(31," Paid "),l(32,"span",3),a(33),m()()(),l(34,"th")(35,"button",2),C("click",function(){return n.toggleSort("deadline")}),a(36," Deadline "),l(37,"span",3),a(38),m()()(),l(39,"th")(40,"button",2),C("click",function(){return n.toggleSort("created")}),a(41," Created "),l(42,"span",3),a(43),m()()()()(),l(44,"tbody"),E(45,he,18,10,"tr",6,ge,!0),m()()()),e&2&&(o(8),p(n.getSortIndicator("parentName")),o(5),p(n.getSortIndicator("students")),o(5),p(n.getSortIndicator("sessions")),o(5),p(n.getSortIndicator("status")),o(5),p(n.getSortIndicator("total")),o(5),p(n.getSortIndicator("paid")),o(5),p(n.getSortIndicator("deadline")),o(5),p(n.getSortIndicator("created")),o(2),I(n.sortedOrders()))},dependencies:[A],styles:[".table-container[_ngcontent-%COMP%]{overflow-x:auto}.order-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.85rem}.order-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;padding:.5rem .75rem;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--sys-on-surface-variant, #666);border-bottom:2px solid var(--sys-outline-variant, #e0e0e0);white-space:nowrap}.order-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.625rem .75rem;border-bottom:1px solid var(--sys-outline-variant, #f0f0f0);color:var(--sys-on-surface, #212121);vertical-align:middle}.sort-btn[_ngcontent-%COMP%]{width:100%;display:inline-flex;align-items:center;gap:.35rem;border:none;background:transparent;padding:.125rem 0;font:inherit;color:inherit;text-transform:inherit;letter-spacing:inherit;cursor:pointer}.sort-btn[_ngcontent-%COMP%]:hover{color:var(--sys-primary, #c62828)}.sort-btn-right[_ngcontent-%COMP%]{justify-content:flex-end}.sort-indicator[_ngcontent-%COMP%]{font-size:.72rem;line-height:1;opacity:.7}.order-row[_ngcontent-%COMP%]{cursor:pointer;transition:background .15s ease}.order-row[_ngcontent-%COMP%]:hover{background:var(--sys-surface-variant, #f5f5f5)}.col-name[_ngcontent-%COMP%]{font-weight:500;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.col-students[_ngcontent-%COMP%], .col-sessions[_ngcontent-%COMP%]{max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.col-amount[_ngcontent-%COMP%]{text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap}.col-deadline[_ngcontent-%COMP%]{white-space:nowrap;font-size:.8rem}.col-date[_ngcontent-%COMP%]{white-space:nowrap;font-size:.8rem;color:var(--sys-on-surface-variant, #666)}.status-badge[_ngcontent-%COMP%]{display:inline-block;padding:.2rem .5rem;border-radius:10px;font-size:.75rem;font-weight:500;white-space:nowrap}.status-locked[_ngcontent-%COMP%]{background:#f3e5f5;color:#6a1b9a}.status-submitted[_ngcontent-%COMP%]{background:#fff3e0;color:#e65100}.status-paid[_ngcontent-%COMP%]{background:#e8f5e9;color:#2e7d32}.status-secured[_ngcontent-%COMP%]{background:#f3e5f5;color:#6a1b9a}.status-mixed[_ngcontent-%COMP%]{background:#e3f2fd;color:#1565c0}.status-cancelled[_ngcontent-%COMP%]{background:#fafafa;color:#757575}.status-empty[_ngcontent-%COMP%]{background:#eceff1;color:#607d8b}"]})};var fe=(i,t)=>t.id;function _e(i,t){if(i&1){let e=b();l(0,"button",6),C("click",function(){_(e);let r=u();return v(r.onClear())}),a(1,"x"),m()}}function ve(i,t){if(i&1){let e=b();l(0,"div",10),C("mousedown",function(){let r=_(e).$implicit,c=u(3);return v(c.selectSuggestion(r))})("mouseenter",function(){let r=_(e).$index,c=u(3);return v(c.highlightedIndex.set(r))}),l(1,"span",11),a(2),m(),l(3,"span",12),a(4),m()()}if(i&2){let e=t.$implicit,n=t.$index,r=u(3);O("highlighted",r.highlightedIndex()===n),o(2),p(e.label),o(2),p(e.sublabel)}}function Ce(i,t){if(i&1&&(l(0,"div",7)(1,"div",8),a(2,"Students / Parents"),m(),E(3,ve,5,4,"div",9,fe),m()),i&2){let e=u(2);o(3),I(e.userSuggestions())}}function be(i,t){if(i&1&&(l(0,"div",4),h(1,Ce,5,0,"div",7),m()),i&2){let e=u();o(),f(e.userSuggestions().length>0?1:-1)}}function ye(i,t){if(i&1&&(l(0,"div",5),a(1," Showing results for: "),l(2,"strong"),a(3),m(),a(4," (Parent/Student) "),m()),i&2){let e=u();o(3),p(e.activeSelection().label)}}var V=class i{userCacheService=S(L);_studentIdsByAuthId=g(new Map);set studentIdsByAuthId(t){this._studentIdsByAuthId.set(t??new Map)}searchSelect=T();searchClear=T();query=g("");showSuggestions=g(!1);highlightedIndex=g(-1);activeSelection=g(null);debounceTimer=null;debouncedQuery=g("");userSuggestions=x(()=>{let t=this.debouncedQuery().toLowerCase().trim();if(t.length<2)return[];let e=this.userCacheService.users(),n=this._studentIdsByAuthId(),r=[];for(let c of e){if(r.length>=8)break;let R=c.parentName.toLowerCase().includes(t),$=c.displayId.toLowerCase().includes(t),F=c.studentNames.find(M=>M.toLowerCase().includes(t)),D=(n.get(c.authId)??[]).find(M=>M.toLowerCase().includes(t)),me=t.includes("-k");if(R||$||F||D){let M=$&&!me,ue=M?c.displayId:D||(F??c.parentName),pe=M?`Parent ID \u2022 ${c.parentName}`:D?`Student ID \u2022 Parent: ${c.parentName}`:F?`Parent: ${c.parentName}`:"Parent";r.push({type:"user",id:c.authId,label:ue,sublabel:pe})}}return r});allSuggestions=x(()=>[...this.userSuggestions()]);onInput(t){this.query.set(t),this.highlightedIndex.set(-1),this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.debouncedQuery.set(t),t.trim().length>=2?this.showSuggestions.set(!0):this.showSuggestions.set(!1)},200)}onFocus(){this.debouncedQuery().trim().length>=2&&this.allSuggestions().length>0&&this.showSuggestions.set(!0)}closeSuggestions(){this.showSuggestions.set(!1)}selectSuggestion(t){let e={type:t.type,id:t.id,label:t.label};this.activeSelection.set(e),this.query.set(t.label),this.showSuggestions.set(!1),this.searchSelect.emit(e)}onClear(){this.query.set(""),this.debouncedQuery.set(""),this.activeSelection.set(null),this.showSuggestions.set(!1),this.highlightedIndex.set(-1),this.searchClear.emit()}onKeydown(t){let e=this.allSuggestions();if(!(!this.showSuggestions()||e.length===0))switch(t.key){case"ArrowDown":t.preventDefault(),this.highlightedIndex.update(r=>Math.min(r+1,e.length-1));break;case"ArrowUp":t.preventDefault(),this.highlightedIndex.update(r=>Math.max(r-1,0));break;case"Enter":t.preventDefault();let n=this.highlightedIndex();n>=0&&n<e.length&&this.selectSuggestion(e[n]);break;case"Escape":this.closeSuggestions();break}}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=P({type:i,selectors:[["app-admin-order-search"]],inputs:{studentIdsByAuthId:"studentIdsByAuthId"},outputs:{searchSelect:"searchSelect",searchClear:"searchClear"},decls:6,vars:4,consts:[[1,"search-container",3,"clickOutside"],[1,"search-input-wrapper"],["type","text","placeholder","Search by parent/student name or ID...",1,"search-input",3,"input","focus","keydown","value"],[1,"btn-clear"],[1,"suggestions-dropdown"],[1,"active-selection"],[1,"btn-clear",3,"click"],[1,"suggestion-section"],[1,"section-label"],[1,"suggestion-item",3,"highlighted"],[1,"suggestion-item",3,"mousedown","mouseenter"],[1,"suggestion-label"],[1,"suggestion-sublabel"]],template:function(e,n){e&1&&(l(0,"div",0),C("clickOutside",function(){return n.closeSuggestions()}),l(1,"div",1)(2,"input",2),C("input",function(c){return n.onInput(c.target.value)})("focus",function(){return n.onFocus()})("keydown",function(c){return n.onKeydown(c)}),m(),h(3,_e,2,0,"button",3),m(),h(4,be,2,1,"div",4),h(5,ye,5,1,"div",5),m()),e&2&&(o(2),Q("value",n.query()),o(),f(n.query()||n.activeSelection()?3:-1),o(),f(n.showSuggestions()&&n.allSuggestions().length>0?4:-1),o(),f(n.activeSelection()?5:-1))},dependencies:[A],styles:[".search-container[_ngcontent-%COMP%]{position:relative;margin-bottom:1rem}.search-input-wrapper[_ngcontent-%COMP%]{position:relative}.search-input[_ngcontent-%COMP%]{width:100%;padding:.75rem 2.5rem .75rem .875rem;border:1px solid var(--sys-outline, #e0e0e0);border-radius:8px;font-size:.875rem;background:#fff;box-sizing:border-box}.search-input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--sys-primary, #c62828)}.search-input[_ngcontent-%COMP%]::placeholder{color:var(--sys-on-surface-variant, #999)}.btn-clear[_ngcontent-%COMP%]{position:absolute;right:.5rem;top:50%;transform:translateY(-50%);background:transparent;border:none;font-size:1rem;color:var(--sys-on-surface-variant, #666);cursor:pointer;padding:.25rem .5rem;line-height:1}.btn-clear[_ngcontent-%COMP%]:hover{color:var(--sys-on-surface, #212121)}.suggestions-dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--sys-outline, #e0e0e0);border-radius:8px;box-shadow:0 4px 16px #0000001f;z-index:100;max-height:320px;overflow-y:auto;margin-top:4px}.suggestion-section[_ngcontent-%COMP%]{padding:.25rem 0}.suggestion-section[_ngcontent-%COMP%] + .suggestion-section[_ngcontent-%COMP%]{border-top:1px solid var(--sys-outline-variant, #f0f0f0)}.section-label[_ngcontent-%COMP%]{padding:.5rem .875rem .25rem;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--sys-on-surface-variant, #666)}.suggestion-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.5rem .875rem;cursor:pointer;transition:background .1s ease}.suggestion-item[_ngcontent-%COMP%]:hover, .suggestion-item.highlighted[_ngcontent-%COMP%]{background:var(--sys-surface-variant, #f5f5f5)}.suggestion-label[_ngcontent-%COMP%]{font-size:.85rem;color:var(--sys-on-surface, #212121)}.suggestion-sublabel[_ngcontent-%COMP%]{font-size:.75rem;color:var(--sys-on-surface-variant, #999);margin-left:.5rem;white-space:nowrap}.active-selection[_ngcontent-%COMP%]{margin-top:.5rem;font-size:.8rem;color:var(--sys-on-surface-variant, #666)}.active-selection[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--sys-on-surface, #212121)}"]})};var Se=(i,t)=>t.id;function xe(i,t){if(i&1){let e=b();s(0,"label",4)(1,"input",13),y("change",function(){let r=_(e).$implicit,c=u();return v(c.onSeasonToggle(r.id))}),d(),s(2,"span"),a(3),d()()}if(i&2){let e=t.$implicit,n=u();o(),k("checked",n.isSeasonSelected(e.id)),o(2),p(e.name)}}function Oe(i,t){i&1&&(s(0,"div",9),j(1,"div",14),s(2,"p"),a(3,"Loading orders..."),d()())}function we(i,t){if(i&1){let e=b();s(0,"div",10)(1,"div",15),a(2,"!"),d(),s(3,"p"),a(4),d(),s(5,"button",16),y("click",function(){_(e);let r=u();return v(r.loadOrders())}),a(6,"Retry"),d()()}if(i&2){let e=u();o(4),p(e.adminService.error())}}function Me(i,t){i&1&&(s(0,"h2"),a(1,"No orders match your search"),d(),s(2,"p"),a(3,"Try adjusting your search query"),d())}function Pe(i,t){i&1&&(s(0,"p"),a(1,"No orders in the system yet"),d())}function Ee(i,t){i&1&&(s(0,"p"),a(1,"Try another filter"),d())}function Ie(i,t){if(i&1&&(s(0,"h2"),a(1),d(),h(2,Pe,2,0,"p")(3,Ee,2,0,"p")),i&2){let e=u(2);o(),w("No ",e.getFilterName()," orders"),o(),f(e.adminService.activeFilter()==="all"?2:3)}}function ke(i,t){if(i&1&&(s(0,"div",11)(1,"div",17),a(2,"receipt_long"),d(),h(3,Me,4,0)(4,Ie,4,2),d()),i&2){let e=u();o(3),f(e.isSearchMode()?3:4)}}function Ae(i,t){if(i&1){let e=b();s(0,"div",19)(1,"button",20),y("click",function(){_(e);let r=u(2);return v(r.onLoadMore())}),a(2),d()()}if(i&2){let e=u(2);o(),k("disabled",e.adminService.loadingMore()),o(),w(" ",e.adminService.loadingMore()?"Loading...":"Load More"," ")}}function Te(i,t){if(i&1){let e=b();s(0,"app-admin-order-table",18),y("rowClick",function(r){_(e);let c=u();return v(c.onViewDetails(r))}),d(),h(1,Ae,3,2,"div",19)}if(i&2){let e=u();k("orders",e.displayedOrders())("userCache",e.userCacheMap()),o(),f(!e.isSearchMode()&&e.adminService.hasMore()?1:-1)}}function De(i,t){if(i&1){let e=b();s(0,"div",22)(1,"label",27),a(2,"Payment Reference"),d(),s(3,"input",28),q("ngModelChange",function(r){_(e);let c=u(2);return U(c.paymentReference,r)||(c.paymentReference=r),v(r)}),d()()}if(i&2){let e=u(2);o(3),z("ngModel",e.paymentReference)}}function Le(i,t){if(i&1){let e=b();s(0,"div",22)(1,"label",29),a(2,"Cancellation Reason"),d(),s(3,"textarea",30),q("ngModelChange",function(r){_(e);let c=u(2);return U(c.cancelReason,r)||(c.cancelReason=r),v(r)}),d()()}if(i&2){let e=u(2);o(3),z("ngModel",e.cancelReason)}}function Ne(i,t){if(i&1&&(s(0,"div",23),a(1),d()),i&2){let e=u(2);o(),p(e.adminService.actionError())}}function Ve(i,t){if(i&1){let e=b();s(0,"div",12)(1,"div",21)(2,"h3"),a(3),d(),s(4,"p"),a(5),d(),h(6,De,4,1,"div",22),h(7,Le,4,1,"div",22),h(8,Ne,2,1,"div",23),s(9,"div",24)(10,"button",25),y("click",function(){_(e);let r=u();return v(r.confirmAction())}),a(11),d(),s(12,"button",26),y("click",function(){_(e);let r=u();return v(r.closeDialog())}),a(13,"Cancel"),d()()()()}if(i&2){let e=u();o(3),p(e.dialogTitle()),o(2),p(e.dialogMessage()),o(),f(e.dialogType()==="confirm-payment"?6:-1),o(),f(e.dialogType()==="cancel"?7:-1),o(),f(e.adminService.actionError()?8:-1),o(2),k("disabled",e.adminService.actionLoading()),o(),w(" ",e.adminService.actionLoading()?"Processing...":"Confirm"," ")}}var le=class i{adminService=S(se);seasonService=S(ee);userService=S(te);userCacheService=S(L);orderDatastore=S(X);router=S(H);route=S(Y);userCacheMap=x(()=>{let t=this.userCacheService.users(),e=new Map;for(let n of t)e.set(n.authId,n);return e});studentIdsByAuthId=x(()=>{let t=new Map;for(let e of this.adminService.filteredOrders()){let n=t.get(e.userAuthId)??[],r=new Set(n);for(let c of e.items)r.add(c.studentId);t.set(e.userAuthId,[...r].sort())}return t});isSearchMode=g(!1);_searchResults=g([]);showDialog=g(!1);dialogType=g(null);dialogTitle=g("");dialogMessage=g("");selectedOrder=null;paymentReference="";cancelReason="";displayedOrders=x(()=>this.isSearchMode()?this._searchResults():this.adminService.filteredOrders());async ngOnInit(){if(console.log("[AdminOrderList] ngOnInit start"),!this.userService.isAuthenticated()){console.log("[AdminOrderList] not authenticated, redirecting"),this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){console.log("[AdminOrderList] not admin, redirecting"),this.router.navigate(["/"]);return}this.route.queryParams.subscribe(e=>{let n=e.filter;console.log("[AdminOrderList] query params filter:",n),n&&["all","locked","submitted","secured","paid"].includes(n)&&this.adminService.setFilter(n)}),console.log("[AdminOrderList] calling loadSeasons..."),await this.seasonService.loadSeasons(),console.log("[AdminOrderList] loadSeasons complete");let t=this.seasonService.seasons().map(e=>e.id);this.adminService.setSelectedSeasons(t),console.log("[AdminOrderList] initialized selectedSeasons:",t),await this.seasonService.loadClassesByYear(),this.userCacheService.isLoaded()||await this.userCacheService.loadCache(),console.log("[AdminOrderList] calling loadOrders..."),this.loadOrders()}async loadOrders(){console.log("[AdminOrderList] loadOrders: loading all orders"),await this.adminService.loadAllOrders()}ngOnDestroy(){this.adminService.unsubscribe()}async ensureCacheHasDisplayedUsers(){let t=this.adminService.filteredOrders();if(t.length===0)return;let e=t.map(n=>n.userAuthId);await this.userCacheService.ensureUsersInCache(e)}setFilter(t){this.adminService.setFilter(t),this.router.navigate([],{relativeTo:this.route,queryParams:{filter:t},queryParamsHandling:"merge"})}isSeasonSelected(t){return this.adminService.selectedSeasonIds().includes(t)}onSeasonToggle(t){this.adminService.toggleSeasonSelection(t),this.loadOrders()}async onLoadMore(){try{let t=this.adminService.selectedSeasonIds();if(t.length!==1)return;await this.adminService.loadMore(t[0]),await this.ensureCacheHasDisplayedUsers()}catch{}}async onSearchSelect(t){this.isSearchMode.set(!0),this._searchResults.set([]);try{let e=this.seasonService.selectedSeason();if(!e)return;let n=[];if(t.type==="user"&&(n=await this.orderDatastore.listOrdersByUserIds(e.id,[t.id])),this._searchResults.set(n),n.length>0){let r=n.map(c=>c.userAuthId);await this.userCacheService.ensureUsersInCache(r)}}catch{}}onSearchClear(){this.isSearchMode.set(!1),this._searchResults.set([])}getFilterName(){return{all:"",locked:"locked",submitted:"submitted",secured:"secured",paid:"paid"}[this.adminService.activeFilter()]}onConfirmPayment(t){let e=this.adminService.filteredOrders().find(n=>n.userAuthId===t);e&&(this.selectedOrder=e,this.paymentReference="",this.dialogType.set("confirm-payment"),this.dialogTitle.set("Confirm Payment"),this.dialogMessage.set("Enter payment reference to confirm receipt."),this.showDialog.set(!0))}onCancelOrder(t){let e=this.adminService.filteredOrders().find(n=>n.userAuthId===t);e&&(this.selectedOrder=e,this.cancelReason="",this.dialogType.set("cancel"),this.dialogTitle.set("Cancel Order"),this.dialogMessage.set("Are you sure you want to cancel this order? Inventory will be released."),this.showDialog.set(!0))}onViewDetails(t){this.router.navigate(["/admin/orders",t.userAuthId],{queryParams:{seasonId:t.seasonId}})}closeDialog(){this.showDialog.set(!1),this.dialogType.set(null),this.selectedOrder=null,this.adminService.clearError()}async confirmAction(){if(this.selectedOrder)try{switch(this.dialogType()){case"confirm-payment":if(!this.paymentReference.trim())return;let t=Z(this.selectedOrder);await this.adminService.recordPayment(this.selectedOrder.seasonId,this.selectedOrder.userAuthId,t,this.paymentReference.trim(),"zelle");break;case"cancel":let e=this.selectedOrder.items.filter(n=>n.status==="locked"||n.status==="submitted"||n.status==="secured"||n.status==="paid").map(n=>({sessionId:n.sessionId,studentId:n.studentId}));if(e.length===0)return;await this.adminService.cancelOrder(this.selectedOrder.seasonId,this.selectedOrder.userAuthId,e,this.cancelReason.trim()||"Cancelled by admin");break}this.closeDialog()}catch{}}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=P({type:i,selectors:[["app-admin-order-list"]],decls:39,vars:21,consts:[["pageTitle","Order Management","pageSubtitle","View and manage all orders"],[1,"admin-order-list"],[1,"season-filter"],[1,"filter-label"],[1,"season-checkbox"],[1,"filter-tabs"],[1,"tab",3,"click"],[1,"tab-count"],[3,"searchSelect","searchClear","studentIdsByAuthId"],[1,"loading-container"],[1,"error-container"],[1,"empty-container"],[1,"dialog-overlay"],["type","checkbox",3,"change","checked"],[1,"spinner"],[1,"error-icon"],[1,"btn-retry",3,"click"],["aria-hidden","true",1,"empty-icon","material-symbols-rounded"],[3,"rowClick","orders","userCache"],[1,"load-more-container"],[1,"btn-load-more",3,"click","disabled"],[1,"dialog"],[1,"form-group"],[1,"dialog-error"],[1,"dialog-actions"],[1,"btn","btn-primary",3,"click","disabled"],[1,"btn","btn-outline",3,"click"],["for","paymentRef"],["type","text","id","paymentRef","placeholder","Zelle confirmation / Bank transfer number",3,"ngModelChange","ngModel"],["for","cancelReason"],["id","cancelReason","rows","3","placeholder","Enter cancellation reason",3,"ngModelChange","ngModel"]],template:function(e,n){e&1&&(s(0,"app-admin-layout",0)(1,"div",1)(2,"div",2)(3,"span",3),a(4,"Seasons:"),d(),E(5,xe,4,2,"label",4,Se),d(),s(7,"div",5)(8,"button",6),y("click",function(){return n.setFilter("all")}),s(9,"span"),a(10,"All"),d(),s(11,"span",7),a(12),d()(),s(13,"button",6),y("click",function(){return n.setFilter("locked")}),s(14,"span"),a(15,"Locked"),d(),s(16,"span",7),a(17),d()(),s(18,"button",6),y("click",function(){return n.setFilter("submitted")}),s(19,"span"),a(20,"Submitted"),d(),s(21,"span",7),a(22),d()(),s(23,"button",6),y("click",function(){return n.setFilter("secured")}),s(24,"span"),a(25,"Secured"),d(),s(26,"span",7),a(27),d()(),s(28,"button",6),y("click",function(){return n.setFilter("paid")}),s(29,"span"),a(30,"Paid"),d(),s(31,"span",7),a(32),d()()(),s(33,"app-admin-order-search",8),y("searchSelect",function(c){return n.onSearchSelect(c)})("searchClear",function(){return n.onSearchClear()}),d(),h(34,Oe,4,0,"div",9),h(35,we,7,1,"div",10),h(36,ke,5,1,"div",11),h(37,Te,2,3),h(38,Ve,14,7,"div",12),d()()),e&2&&(o(5),I(n.seasonService.seasons()),o(3),O("active",n.adminService.activeFilter()==="all"),o(4),p(n.adminService.filterCounts().all),o(),O("active",n.adminService.activeFilter()==="locked"),o(4),p(n.adminService.filterCounts().locked),o(),O("active",n.adminService.activeFilter()==="submitted"),o(4),p(n.adminService.filterCounts().submitted),o(),O("active",n.adminService.activeFilter()==="secured"),o(4),p(n.adminService.filterCounts().secured),o(),O("active",n.adminService.activeFilter()==="paid"),o(4),p(n.adminService.filterCounts().paid),o(),k("studentIdsByAuthId",n.studentIdsByAuthId()),o(),f(n.adminService.loading()?34:-1),o(),f(n.adminService.error()?35:-1),o(),f(!n.adminService.loading()&&!n.adminService.error()&&n.displayedOrders().length===0?36:-1),o(),f(!n.adminService.loading()&&n.displayedOrders().length>0?37:-1),o(),f(n.showDialog()?38:-1))},dependencies:[A,oe,ne,re,ie,N,V,ae],styles:[".admin-order-list[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto;padding:1.5rem}.season-filter[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;margin-bottom:1rem;padding:.75rem 1rem;background:var(--sys-surface-container, #f5f5f5);border-radius:8px;flex-wrap:wrap}.filter-label[_ngcontent-%COMP%]{font-weight:500;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.season-checkbox[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.375rem;cursor:pointer;font-size:.875rem;color:var(--sys-on-surface, #333)}.season-checkbox[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{cursor:pointer}.filter-tabs[_ngcontent-%COMP%]{display:flex;gap:.5rem;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--sys-outline-variant, #f0f0f0);overflow-x:auto}.tab[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem 1rem;background:transparent;border:1px solid var(--sys-outline, #e0e0e0);border-radius:20px;font-size:.875rem;color:var(--sys-on-surface-variant, #666);cursor:pointer;white-space:nowrap;transition:all .2s ease}.tab[_ngcontent-%COMP%]:hover{border-color:var(--sys-primary, #c62828);color:var(--sys-primary, #c62828)}.tab.active[_ngcontent-%COMP%]{background:var(--sys-primary, #c62828);border-color:var(--sys-primary, #c62828);color:#fff}.tab-count[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;min-width:1.35rem;height:1.35rem;padding:0 .35rem;border-radius:999px;background:var(--sys-surface-variant, #f5f5f5);color:var(--sys-on-surface-variant, #666);font-size:.75rem;line-height:1;font-weight:500}.tab.active[_ngcontent-%COMP%]   .tab-count[_ngcontent-%COMP%]{background:#fff3;color:#fff}.loading-container[_ngcontent-%COMP%], .error-container[_ngcontent-%COMP%], .empty-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.error-container[_ngcontent-%COMP%]{background:var(--sys-error-container, #ffebee);border-radius:12px}.error-icon[_ngcontent-%COMP%]{width:48px;height:48px;background:var(--sys-error, #c62828);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;margin-bottom:1rem}.btn-retry[_ngcontent-%COMP%]{padding:.5rem 1.5rem;background:var(--sys-error, #c62828);color:#fff;border:none;border-radius:6px;cursor:pointer}.empty-icon[_ngcontent-%COMP%]{font-size:4rem;margin-bottom:1rem}.empty-container[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0 0 .5rem;color:var(--sys-on-surface, #212121)}.empty-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:var(--sys-on-surface-variant, #666)}.load-more-container[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:1.5rem 0}.btn-load-more[_ngcontent-%COMP%]{padding:.625rem 2rem;background:transparent;border:1px solid var(--sys-outline, #e0e0e0);border-radius:8px;font-size:.875rem;color:var(--sys-primary, #c62828);cursor:pointer;transition:all .2s ease}.btn-load-more[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-surface-variant, #f5f5f5);border-color:var(--sys-primary, #c62828)}.btn-load-more[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.dialog-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}.dialog[_ngcontent-%COMP%]{background:#fff;border-radius:12px;padding:1.5rem;max-width:400px;width:100%;box-shadow:0 8px 32px #0003}.dialog[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1.25rem;color:var(--sys-on-surface, #212121)}.dialog[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-size:.875rem;font-weight:500;color:var(--sys-on-surface, #212121)}.form-group[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .form-group[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline, #e0e0e0);border-radius:8px;font-size:.875rem;box-sizing:border-box}.form-group[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus, .form-group[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--sys-primary, #c62828)}.dialog-error[_ngcontent-%COMP%]{padding:.75rem;background:var(--sys-error-container, #ffebee);color:var(--sys-error, #d32f2f);border-radius:8px;font-size:.875rem;margin-bottom:1rem}.dialog-actions[_ngcontent-%COMP%]{display:flex;gap:.75rem;justify-content:flex-end}.btn[_ngcontent-%COMP%]{padding:.75rem 1.25rem;border-radius:8px;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease;border:none}.btn-primary[_ngcontent-%COMP%]{background:var(--sys-primary, #c62828);color:#fff}.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-primary[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.btn-outline[_ngcontent-%COMP%]{background:transparent;border:1px solid var(--sys-outline, #e0e0e0);color:var(--sys-on-surface-variant, #666)}.btn-outline[_ngcontent-%COMP%]:hover{background:var(--sys-surface-variant, #f5f5f5)}.search-filters[_ngcontent-%COMP%]{margin-bottom:1.5rem;padding:1rem;background:var(--sys-surface-variant, #f5f5f5);border-radius:12px}.filter-row[_ngcontent-%COMP%]{display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end}.filter-group[_ngcontent-%COMP%]{flex:1;min-width:200px}.filter-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.375rem;font-size:.8rem;font-weight:500;color:var(--sys-on-surface-variant, #666)}.filter-input[_ngcontent-%COMP%], .filter-select[_ngcontent-%COMP%]{width:100%;padding:.625rem .875rem;border:1px solid var(--sys-outline, #e0e0e0);border-radius:8px;font-size:.875rem;background:#fff;box-sizing:border-box}.filter-input[_ngcontent-%COMP%]:focus, .filter-select[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--sys-primary, #c62828)}.filter-input[_ngcontent-%COMP%]::placeholder{color:var(--sys-on-surface-variant, #999)}.btn-clear-filters[_ngcontent-%COMP%]{padding:.625rem 1rem;background:transparent;border:1px solid var(--sys-outline, #e0e0e0);border-radius:8px;font-size:.875rem;color:var(--sys-on-surface-variant, #666);cursor:pointer;white-space:nowrap}.btn-clear-filters[_ngcontent-%COMP%]:hover{background:#fff;border-color:var(--sys-primary, #c62828);color:var(--sys-primary, #c62828)}.filter-results-info[_ngcontent-%COMP%]{margin-top:.75rem;font-size:.8rem;color:var(--sys-on-surface-variant, #666)}@media(max-width:640px){.filter-group[_ngcontent-%COMP%]{min-width:100%}}"]})};export{le as AdminOrderListComponent};
