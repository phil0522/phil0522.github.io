import{T as h,Z as _,aa as f}from"./chunk-XJRQXI57.js";import{I as g,N as c,da as i}from"./chunk-5O64VQN5.js";var u=15,b=class l{datastore=c(_);rpc=c(f);subscription=null;orderSubscription=null;_orders=i([]);_loading=i(!1);_error=i(null);_activeFilter=i("all");_selectedSeasonIds=i([]);_cursor=i(null);_hasMore=i(!1);_loadingMore=i(!1);_actionLoading=i(!1);_actionError=i(null);orders=this._orders.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();activeFilter=this._activeFilter.asReadonly();hasMore=this._hasMore.asReadonly();loadingMore=this._loadingMore.asReadonly();actionLoading=this._actionLoading.asReadonly();actionError=this._actionError.asReadonly();selectedSeasonIds=this._selectedSeasonIds.asReadonly();filteredOrders=this._orders.asReadonly();setSelectedSeasons(r){console.log("[AdminOrdersStore] setSelectedSeasons:",r.length===0?"all":r),this._selectedSeasonIds.set(r)}toggleSeasonSelection(r){let e=this._selectedSeasonIds();e.includes(r)?this._selectedSeasonIds.set(e.filter(s=>s!==r)):this._selectedSeasonIds.set([...e,r]),console.log("[AdminOrdersStore] toggleSeasonSelection:",this._selectedSeasonIds())}setFilter(r){this._activeFilter.set(r),this._orders.set([]),this._cursor.set(null),this._hasMore.set(!1)}async loadPage(r){console.log("[AdminOrdersStore] loadPage called, seasonId param:",r),this._loading.set(!0),this._error.set(null),this._cursor.set(null);try{let e=await this.queryOrders(r,u);console.log("[AdminOrdersStore] loadPage: fetched",e.orders.length,"orders, hasMore:",e.hasMore),this._orders.set(e.orders),this._cursor.set(e.lastDoc),this._hasMore.set(e.hasMore)}catch(e){console.error("[AdminOrdersStore] loadPage error:",e);let s=e instanceof Error?e.message:String(e);throw this._error.set(s),e}finally{this._loading.set(!1)}}async loadMore(r){if(!(!this._hasMore()||this._loadingMore())){this._loadingMore.set(!0);try{let e=this._cursor(),s=await this.queryOrders(r,u,e);this._orders.update(t=>[...t,...s.orders]),this._cursor.set(s.lastDoc),this._hasMore.set(s.hasMore)}catch(e){let s=e instanceof Error?e.message:String(e);throw this._error.set(s),e}finally{this._loadingMore.set(!1)}}}queryOrders(r,e,s){let t=this._activeFilter();switch(t){case"locked":case"submitted":case"paid":return this.datastore.listOrdersByStatusPaginated(r,t,e,s);case"all":return this.datastore.listOrdersPaginated(r,e,s)}}async loadAllOrders(r,e){console.log("[AdminOrdersStore] loadAllOrders called, status:",r,"limit:",e),this._loading.set(!0),this._error.set(null);try{let s=this._selectedSeasonIds(),t=s.length>0?s:void 0;console.log("[AdminOrdersStore] loadAllOrders: seasonFilter =",t??"all seasons");let o=await this.datastore.listAllSeasonOrders(t);console.log("[AdminOrdersStore] loadAllOrders: fetched",o.length,"orders from datastore"),r&&(o=o.filter(n=>h(n)===r)),o.sort((n,a)=>new Date(a.createdAt).getTime()-new Date(n.createdAt).getTime()),e&&e>0&&(o=o.slice(0,e)),this._orders.set(o)}catch(s){let t=s instanceof Error?s.message:String(s);throw this._error.set(t),s}finally{this._loading.set(!1)}}async recordPayment(r,e,s,t,o="zelle",n,a=!1){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.recordPayment({year:2026,seasonId:r,userAuthId:e,amount:s,reference:t??null,method:o,notes:n??null,isDepositConfirmation:a,itemKeys:null}),await this.loadAllOrders()}catch(d){let m=d instanceof Error?d.message:String(d);throw this._actionError.set(m),d}finally{this._actionLoading.set(!1)}}async cancelOrder(r,e,s){this._actionLoading.set(!0),this._actionError.set(null);try{await this.rpc.adminCancelOrder(r,e,s),await this.loadAllOrders()}catch(t){let o=t instanceof Error?t.message:String(t);throw this._actionError.set(o),t}finally{this._actionLoading.set(!1)}}clearError(){this._error.set(null),this._actionError.set(null)}clearState(){this.unsubscribe(),this.unsubscribeOrder(),this._orders.set([]),this._error.set(null),this._actionError.set(null),this._activeFilter.set("all"),this._cursor.set(null),this._hasMore.set(!1)}subscribeToOrders(r){console.log("[AdminOrdersStore] subscribeToOrders called, seasonId param:",r),this.unsubscribe(),this._loading.set(!0),this._error.set(null),console.log("[AdminOrdersStore] subscribeToOrders: creating subscription for season",r),this.subscription=this.datastore.subscribeToSeasonOrders(r,u).subscribe({next:e=>{console.log("[AdminOrdersStore] subscribeToOrders: received",e.length,"orders");let s=this.filterOrders(e);console.log("[AdminOrdersStore] subscribeToOrders: after filter:",s.length,"orders (filter:",this._activeFilter(),")"),this._orders.set(s),this._loading.set(!1)},error:e=>{console.error("[AdminOrdersStore] subscribeToOrders error:",e);let s=e instanceof Error?e.message:String(e);this._error.set(s),this._loading.set(!1)}})}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}subscribeToOrder(r,e,s,t){return this.unsubscribeOrder(),this.orderSubscription=this.datastore.subscribeToOrder(t,r).subscribe({next:e,error:s}),()=>this.unsubscribeOrder()}unsubscribeOrder(){this.orderSubscription&&(this.orderSubscription.unsubscribe(),this.orderSubscription=null)}filterOrders(r){let e=this._activeFilter();switch(e){case"locked":case"submitted":case"paid":return r.filter(s=>h(s)===e);case"all":default:return r}}async getOrder(r,e,s=!1){if(!s){let t=this._orders().find(o=>o.userAuthId===e);if(t)return t}this._loading.set(!0),this._error.set(null);try{let t=await this.datastore.getUserSeasonOrder(r,e);if(!t)throw new Error(`Order not found for user: ${e}`);if(s){let o=this._orders(),n=o.findIndex(a=>a.userAuthId===e);if(n>=0){let a=[...o];a[n]=t,this._orders.set(a)}}return t}catch(t){let o=t instanceof Error?t.message:String(t);throw this._error.set(o),t}finally{this._loading.set(!1)}}static \u0275fac=function(e){return new(e||l)};static \u0275prov=g({token:l,factory:l.\u0275fac,providedIn:"root"})};export{b as a};
