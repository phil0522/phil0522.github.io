import{a as Pe}from"./chunk-FOFLONKS.js";import{a as Ae}from"./chunk-5SZ7XOBG.js";import{b as xe,c as Se,f as Ie,i as we,j as Me,k as Ee,q as Te}from"./chunk-Q7GIANAM.js";import{G as Q,P as B,Q as he,T as ye,V as Y,ba as Ce,ca as ve,fa as be,h as ce,ma as _e,o as de,q as K,qa as Oe,s as pe}from"./chunk-7OKX75GD.js";import{F as me,aa as ge,db as fe,ha as ue}from"./chunk-UYHN5VVP.js";import{$a as A,Bb as oe,Db as c,Ea as g,Eb as v,Fb as q,Gb as le,I as M,N as h,Qa as se,S as y,T as C,Tb as J,ab as P,da as f,db as H,eb as $,fb as S,gb as s,hb as o,ob as W,qb as x,sb as u}from"./chunk-5O64VQN5.js";import{a as V,b as ae}from"./chunk-Q7L6LLAK.js";var j=class a{firestore=ue(me());orderDatastore=h(be);seasonDatastore=h(ve);async getAdminUserCache(){let e=ge(this.firestore,"admin","userCache"),t=await fe(e);return t.exists()?Ce.parse(t.data()):null}async listAllSeasons(){return await this.seasonDatastore.listAllSeasons()}async listOrdersByUserIds(e,t){return t.length===0?[]:await this.orderDatastore.listOrdersByUserIds(e,t)}async listSeasonOrders(e){return await this.orderDatastore.listSeasonOrders(e)}static \u0275fac=function(t){return new(t||a)};static \u0275prov=M({token:a,factory:a.\u0275fac,providedIn:"root"})};function z(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function E(a){let e=Math.abs(a);return`${a<0?"-":""}$${(e/100).toFixed(2)}`}function X(a,e){return(a.pricing?.discounts??[]).filter(i=>i.type===e).reduce((i,n)=>i+n.amount,0)}function Be(a,e){let i=a.items.map(r=>r.snapshot.studentName?.trim()??"").filter(r=>r.length>0),n=[...new Set(i)];return n.length>0?n:e.studentNames.length>0?e.studentNames:[e.displayName]}function je(a){let e=a.items,t=new Map;for(let n of e){let r=n.snapshot.studentName?.trim()||n.studentId,d=t.get(r)??[],m=[];n.options.lunch&&m.push("Lunch"),n.options.extendedCare&&m.push("Extended Care"),m.length===0&&m.push("None"),d.push({sessionName:n.snapshot.className||n.sessionId,addOns:m}),t.set(r,d)}return t.size===0?"<p>No active registration items found.</p>":[...t.entries()].map(([n,r])=>{let d=r.map(p=>z(p.sessionName)).join(", "),l=[...new Set(r.flatMap(p=>p.addOns))].map(p=>z(p)).join(", ");return['<div style="margin-bottom:12px;">',`<div><strong>Student Name:</strong> ${z(n)}</div>`,`<div><strong>Registered Session(s):</strong> ${d}</div>`,`<div><strong>Add-On Services:</strong> ${l}</div>`,"</div>"].join("")}).join("")}function Fe(a){let e=a.items,t=e.reduce((w,O)=>w+O.snapshot.priceSnapshot.basePrice,0),i=e.reduce((w,O)=>w+O.snapshot.priceSnapshot.lunchPrice+O.snapshot.priceSnapshot.extendedCarePrice,0),n=X(a,B.RETURNING_STUDENT),r=X(a,B.SIBLING),d=X(a,B.REFERRAL),m=a.pricing?he(a.pricing):0,l=a.totalPaid??0,p=Y(a),b=[...new Set((a.payments??[]).map(w=>w.method))],I=b.length>0?b.join(", "):"N/A";return["<div>",`<div><strong>Base Tuition:</strong> ${E(t)}</div>`,`<div><strong>Add-On Services:</strong> ${E(i)}</div>`,'<div style="margin-top:8px;">',`<div><strong>Returning Student Discount:</strong> ${E(n)}</div>`,`<div><strong>Sibling Discount:</strong> ${E(r)}</div>`,`<div><strong>Referral Discount:</strong> ${E(d)}</div>`,"</div>",'<div style="margin-top:8px;">',`<div><strong>Total Tuition After Discounts:</strong> ${E(m)}</div>`,`<div><strong>Payment Received (${z(I)}):</strong> ${E(l)}</div>`,`<div><strong>Remaining Cash Balance:</strong> ${E(p)}</div>`,"</div>","</div>"].join("")}function ze(a){return!a.items.some(t=>t.status==="secured")||Y(a)<=0?"":['<div style="margin-top:16px;">',"<img",'  src="/wechat_blueberry.jpg"','  alt="WeChat QR Code"','  style="display:block;width:160px;max-width:100%;height:auto;border:0;"',"/>",'<p style="margin:10px 0 0;">Please add us on WeChat for the next payment steps.</p>',"</div>"].join("")}function ke(a){let e=Be(a.order,a.cacheEntry);return{PARENT_NAME:a.cacheEntry.parentName||a.cacheEntry.displayName,STUDENT_NAME:e.join(", "),REGISTRATION_DETAILS_HTML:je(a.order),TUITION_PAYMENT_SUMMARY_HTML:Fe(a.order),WECHAT_CONTACT_HTML_SECURED_ONLY:ze(a.order)}}function Ge(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Z(a,e){let t=a;for(let[i,n]of Object.entries(e)){let r=new RegExp(`{{\\s*${Ge(i)}\\s*}}`,"g");t=t.replace(r,n)}return t}var Le="https://www.googleapis.com/auth/drive.readonly",Ve="https://www.googleapis.com/auth/gmail.compose",N=[Le,Ve],We=3600*1e3,ee="berryfun.email.googleWorkspaceTokenCache.v1",qe=["access_token_scope_insufficient","insufficient authentication scopes","insufficient permission","insufficientpermissions"],D=class a{tokenCache=new Map;constructor(){this.hydrateFromSessionStorage()}async acquireAccessToken(e){let t=this.normalizeScopes([...N,...e]),i=t.join(" "),n=Date.now(),r=this.findReusableToken(t,n);if(r)return r.token;let d=new K;for(let p of t)d.addScope(p);let m=await pe(Oe,d),l=K.credentialFromResult(m);if(!l?.accessToken)throw new Error("Failed to obtain Google access token");return this.tokenCache.set(i,{token:l.accessToken,expiresAtMs:Date.now()+We}),this.persistToSessionStorage(),l.accessToken}clearCachedTokens(){this.tokenCache.clear(),typeof window<"u"&&window.sessionStorage.removeItem(ee)}isScopeInsufficientError(e){let t=e.toLowerCase();return qe.some(i=>t.includes(i))}normalizeScopes(e){return[...new Set(e)].sort()}hasAllScopes(e,t){let i=new Set(e.split(" ").filter(n=>n.length>0));return t.every(n=>i.has(n))}findReusableToken(e,t){for(let[i,n]of this.tokenCache.entries()){if(n.expiresAtMs<=t){this.tokenCache.delete(i);continue}if(this.hasAllScopes(i,e))return n}return this.persistToSessionStorage(),null}hydrateFromSessionStorage(){if(!(typeof window>"u"))try{let e=window.sessionStorage.getItem(ee);if(!e)return;let t=JSON.parse(e);if(!t||t.version!==1||typeof t.entries!="object")return;let i=Date.now();for(let[n,r]of Object.entries(t.entries))!r||typeof r.token!="string"||typeof r.expiresAtMs!="number"||r.expiresAtMs<=i||this.tokenCache.set(n,{token:r.token,expiresAtMs:r.expiresAtMs})}catch{}}persistToSessionStorage(){if(!(typeof window>"u"))try{let e={};for(let[i,n]of this.tokenCache.entries())e[i]=n;let t={version:1,entries:e};window.sessionStorage.setItem(ee,JSON.stringify(t))}catch{}}static \u0275fac=function(t){return new(t||a)};static \u0275prov=M({token:a,factory:a.\u0275fac,providedIn:"root"})};var G=class a{authHelper=h(D);inlineImageCache=new Map;async createDraft(e){let t=[...N],i=await this.authHelper.acquireAccessToken(t);try{return await this.createDraftWithToken(e,i)}catch(n){let r=n instanceof Error?n.message:String(n);if(!this.authHelper.isScopeInsufficientError(r))throw n;return this.authHelper.clearCachedTokens(),i=await this.authHelper.acquireAccessToken(t),await this.createDraftWithToken(e,i)}}async createDraftWithToken(e,t){let i=await this.buildRawMessage(e),n=await fetch("https://gmail.googleapis.com/gmail/v1/users/me/drafts",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({message:{raw:i}})});if(!n.ok){let l=await n.text();throw new Error(`Gmail draft creation failed (${n.status}): ${l}`)}let r=await n.json(),d=r.id,m=r.message?.id;if(!d||!m)throw new Error("Gmail draft creation returned an invalid response");return{draftId:d,messageId:m}}async buildRawMessage(e){let t=this.encodeSubjectHeader(e.subject),i=await this.prepareHtmlBodyWithInlineImages(e.htmlBody);if(i.inlineImages.length>0){let d=`berryfun-inline-${Date.now()}-${Math.random().toString(36).slice(2)}`,m=[`To: ${e.to}`,`Subject: ${t}`,"MIME-Version: 1.0",`Content-Type: multipart/related; boundary="${d}"`,"",`--${d}`,"Content-Type: text/html; charset=UTF-8","Content-Transfer-Encoding: base64","",this.base64EncodeUtf8(i.htmlBody)];for(let p of i.inlineImages)m.push(`--${d}`,`Content-Type: ${p.payload.contentType}; name="${p.payload.filename}"`,"Content-Transfer-Encoding: base64",`Content-ID: <${p.cid}>`,`Content-Disposition: inline; filename="${p.payload.filename}"`,"",p.payload.base64);m.push(`--${d}--`);let l=m.join(`\r
`);return this.base64UrlEncodeUtf8(l)}let r=[`To: ${e.to}`,`Subject: ${t}`,"MIME-Version: 1.0","Content-Type: text/html; charset=UTF-8","",e.htmlBody].join(`\r
`);return this.base64UrlEncodeUtf8(r)}async prepareHtmlBodyWithInlineImages(e){let t=/src=(["'])([^"']+)\1/gi,i=[...e.matchAll(t)];if(i.length===0)return{htmlBody:e,inlineImages:[]};let n=new Map;for(let l of i){let p=(l[2]??"").trim(),b=this.resolveInlineImagePath(p);b&&n.set(p,b)}if(n.size===0)return{htmlBody:e,inlineImages:[]};let r=new Map,d=1;for(let l of new Set(n.values())){let p=await this.loadInlineImage(l);p&&(r.set(l,{cid:`inline-image-${d}`,payload:p}),d+=1)}if(r.size===0)return{htmlBody:e,inlineImages:[]};let m=e;for(let[l,p]of n.entries()){let b=r.get(p);if(!b)continue;let I=new RegExp(`src=(["'])${this.escapeRegex(l)}\\1`,"g");m=m.replace(I,`src="cid:${b.cid}"`)}return{htmlBody:m,inlineImages:[...r.values()]}}resolveInlineImagePath(e){let t=e.trim();if(!t)return null;let i=t.toLowerCase();if(i.startsWith("cid:")||i.startsWith("data:")||i.startsWith("http://")||i.startsWith("https://")||i.startsWith("//"))return null;let n=t.split("#")[0]?.split("?")[0]?.trim()??"";return!n||n.includes("..")?null:n.startsWith("/")?n:n.startsWith("./")?`/${n.slice(2)}`:`/${n}`}async loadInlineImage(e){let t=this.inlineImageCache.get(e);if(t)return await t;let i=this.fetchInlineImage(e).catch(()=>null);this.inlineImageCache.set(e,i);let n=await i;return n||this.inlineImageCache.delete(e),n}async fetchInlineImage(e){let t=await fetch(e,{method:"GET"});if(!t.ok)return null;let i=await t.arrayBuffer(),n=new Uint8Array(i);return{contentType:this.resolveImageContentType(e,t.headers.get("Content-Type")),filename:this.extractFilename(e),base64:this.base64EncodeBytes(n)}}resolveImageContentType(e,t){let i=t?.split(";")[0]?.trim().toLowerCase()??"";if(i.startsWith("image/"))return i;let n=e.split(".").pop()?.toLowerCase()??"";return n==="png"?"image/png":n==="gif"?"image/gif":n==="webp"?"image/webp":n==="svg"?"image/svg+xml":"image/jpeg"}extractFilename(e){let i=(e.split("#")[0]?.split("?")[0]??e).split("/").filter(n=>n.length>0);return i[i.length-1]??"inline-image.jpg"}base64UrlEncodeUtf8(e){return this.base64EncodeUtf8(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}base64EncodeUtf8(e){let i=new TextEncoder().encode(e),n="";for(let r of i)n+=String.fromCharCode(r);return btoa(n)}base64EncodeBytes(e){let t="";for(let i of e)t+=String.fromCharCode(i);return btoa(t)}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}encodeSubjectHeader(e){let t=e.replace(/[\r\n]+/g," ").trim();return/^[\x20-\x7E]*$/.test(t)?t:`=?UTF-8?B?${this.base64EncodeUtf8(t)}?=`}static \u0275fac=function(t){return new(t||a)};static \u0275prov=M({token:a,factory:a.\u0275fac,providedIn:"root"})};var L=class a{authHelper=h(D);async resolveTemplateHtml(e){let t=this.resolveGoogleDocId(e.googleDocUrl);if(!t)throw new Error(`Template ${e.name} has invalid Google Doc URL`);let i=[...N],n=await this.authHelper.acquireAccessToken(i);try{return await this.fetchGoogleDocHtml(t,n)}catch(r){let d=r instanceof Error?r.message:String(r);if(!this.authHelper.isScopeInsufficientError(d))throw r;return this.authHelper.clearCachedTokens(),n=await this.authHelper.acquireAccessToken(i),await this.fetchGoogleDocHtml(t,n)}}resolveGoogleDocId(e){if(!e)return null;let t=e.match(/\/document\/d\/([a-zA-Z0-9_-]+)/);return!t||!t[1]?null:t[1]}async fetchGoogleDocHtml(e,t){let i=`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(e)}/export?mimeType=text/html`,n=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(!n.ok){let r=await n.text();throw new Error(this.buildReadableExportError(n.status,r,n.statusText))}return await n.text()}buildReadableExportError(e,t,i){let r=this.extractApiMessage(t)||i||"Unknown error",d=r.toLowerCase(),m=(t||"").toLowerCase();return e===403&&(d.includes("drive api has not been used")||d.includes("accessnotconfigured")||d.includes("service_disabled")||m.includes("drive api has not been used")||m.includes("accessnotconfigured")||m.includes("service_disabled"))?'Google Drive API is not enabled for this Firebase project. Enable "Google Drive API" in Google Cloud Console, wait a few minutes, then retry.':`Google Doc export failed (${e}): ${r}`}extractApiMessage(e){if(!e)return"";try{return JSON.parse(e).error?.message?.trim()??""}catch{return e.trim()}}static \u0275fac=function(t){return new(t||a)};static \u0275prov=M({token:a,factory:a.\u0275fac,providedIn:"root"})};var De=(a,e)=>e.id,Je=(a,e)=>e.authId;function Ke(a,e){a&1&&(s(0,"div",2)(1,"p"),c(2,"Loading email configuration..."),o()())}function Qe(a,e){if(a&1&&(s(0,"div",3),c(1),o()),a&2){let t=u(2);g(),v(t.message())}}function Ye(a,e){if(a&1&&(s(0,"div",4),c(1),o()),a&2){let t=u(2);g(),v(t.error())}}function Xe(a,e){if(a&1&&(s(0,"option",13),c(1),o()),a&2){let t=e.$implicit;S("value",t.id),g(),v(t.name)}}function Ze(a,e){if(a&1&&(s(0,"option",13),c(1),o()),a&2){let t=e.$implicit;S("value",t.id),g(),v(t.name)}}function et(a,e){a&1&&(s(0,"div",36),c(1," No recipients match current filters. Adjust your search keyword. "),o())}function tt(a,e){a&1&&(s(0,"span",53),c(1,"Drafted"),o())}function nt(a,e){a&1&&(s(0,"span",54),c(1,"Unsent"),o())}function it(a,e){if(a&1){let t=W();s(0,"div",47),x("click",function(){let n=y(t).$implicit,r=u(3);return C(r.toggleUserRow(n.authId))}),s(1,"div")(2,"input",48),x("click",function(n){return y(t),C(n.stopPropagation())})("change",function(n){let r=y(t).$implicit,d=u(3);return C(d.onRecipientToggle(r.authId,n))}),o()(),s(3,"div",49)(4,"span",50),c(5),o(),s(6,"span",51),c(7),o()(),s(8,"div",52),c(9),o(),s(10,"div"),c(11),o(),s(12,"div"),A(13,tt,2,0,"span",53)(14,nt,2,0,"span",54),o()()}if(a&2){let t=e.$implicit,i=u(3);oe("user-row-selected",i.isSelected(t.authId)),g(2),S("checked",i.isSelected(t.authId)),g(3),v(i.getInitials(t.parentName||t.displayName)),g(2),v(t.parentName||t.displayName),g(2),v(t.email),g(2),v(t.studentNames.join(", ")),g(2),P(i.hasDraftRecord(t.authId)?13:14)}}function rt(a,e){if(a&1&&H(0,it,15,8,"div",46,Je),a&2){let t=u(2);$(t.filteredUsers())}}function at(a,e){a&1&&c(0," Creating Drafts... ")}function st(a,e){if(a&1&&c(0),a&2){let t=u(2);le(" Generate ",t.selectedAuthIds().length," Draft",t.selectedAuthIds().length===1?"":"s"," ")}}function ot(a,e){if(a&1){let t=W();A(0,Qe,2,1,"div",3),A(1,Ye,2,1,"div",4),s(2,"div",2)(3,"div",5)(4,"div")(5,"h3"),c(6,"Draft Setup"),o(),s(7,"p",6),c(8,"Choose season, notification type, and template."),o()(),s(9,"a",7),c(10,"Manage Templates \u2192"),o()(),s(11,"div",8)(12,"div",9)(13,"label",10),c(14,"Season"),o(),s(15,"select",11),x("ngModelChange",function(n){y(t);let r=u();return C(r.onSeasonChange(n))}),s(16,"option",12),c(17,"-- Select season --"),o(),H(18,Xe,2,2,"option",13,De),o()(),s(20,"div",9)(21,"label",14),c(22,"Notification Type"),o(),s(23,"select",15),x("ngModelChange",function(n){y(t);let r=u();return C(r.onNotificationTypeChange(n))}),s(24,"option",16),c(25,"Registration Confirmation"),o()()(),s(26,"div",9)(27,"label",17),c(28,"Template"),o(),s(29,"select",18),x("ngModelChange",function(n){y(t);let r=u();return C(r.onTemplateChange(n))}),s(30,"option",12),c(31,"-- Select template --"),o(),H(32,Ze,2,2,"option",13,De),o()()(),s(34,"label",19)(35,"input",20),x("change",function(n){y(t);let r=u();return C(r.onDebugModeChange(n))}),o(),c(36," Debug mode (create at most 1 draft and do not update stats) "),o()(),s(37,"details",21)(38,"summary")(39,"span"),c(40,"Template Stats (Season + Template)"),o()(),s(41,"div",22)(42,"p",6),c(43,"Draft activity for the selected season and template."),o(),s(44,"div",23)(45,"div",24)(46,"div",25),c(47,"draft"),o(),s(48,"div")(49,"p",26),c(50,"Drafts created"),o(),s(51,"p",27),c(52),o()()(),s(53,"div",24)(54,"div",25),c(55,"group"),o(),s(56,"div")(57,"p",26),c(58,"Unique recipients"),o(),s(59,"p",27),c(60),o()()(),s(61,"div",24)(62,"div",25),c(63,"schedule"),o(),s(64,"div")(65,"p",26),c(66,"Last draft created"),o(),s(67,"p",27),c(68),o()()()()()(),s(69,"div",2)(70,"h3"),c(71,"Recipient Selection"),o(),s(72,"div",28)(73,"input",29),x("ngModelChange",function(n){y(t);let r=u();return C(r.searchQuery.set(n))}),o(),s(74,"button",30),x("click",function(){y(t);let n=u();return C(n.clearSelectedUsers())}),c(75,"Clear"),o()(),s(76,"div",31)(77,"div",32)(78,"div",33)(79,"div",34)(80,"input",35),x("change",function(n){y(t);let r=u();return C(r.onSelectAllFilteredChange(n))}),o()(),s(81,"div"),c(82,"Parent"),o(),s(83,"div"),c(84,"Email"),o(),s(85,"div"),c(86,"Students"),o(),s(87,"div"),c(88,"Status"),o()(),A(89,et,2,0,"div",36)(90,rt,2,0),o()(),s(91,"p",37),c(92),o()(),s(93,"div",38)(94,"div",39)(95,"div",40)(96,"div",41),c(97),o(),s(98,"div",42),c(99),o()(),s(100,"div",43)(101,"button",30),x("click",function(){y(t);let n=u();return C(n.clearSelectedUsers())}),c(102,"Clear Selection"),o(),s(103,"button",44),x("click",function(){y(t);let n=u();return C(n.createDraftBatch())}),s(104,"span",45),c(105,"auto_awesome"),o(),A(106,at,1,0)(107,st,1,2),o()()()()}if(a&2){let t,i,n,r=u();P(r.message()?0:-1),g(),P(r.error()?1:-1),g(14),S("ngModel",r.selectedSeasonId()),g(3),$(r.seasons()),g(5),S("ngModel",r.selectedNotificationType()),g(6),S("ngModel",r.selectedTemplateId()),g(3),$(r.filteredTemplates()),g(3),S("checked",r.debugMode()),g(17),v(((t=r.currentStats())==null?null:t.draftCreatedCount)??0),g(8),v(((i=r.currentStats())==null?null:i.uniqueRecipientCount)??0),g(8),v(r.formatStatsDate((n=r.currentStats())==null?null:n.lastDraftCreatedAt)),g(5),S("ngModel",r.searchQuery()),g(7),S("checked",r.areAllFilteredSelected())("indeterminate",r.isPartiallyFilteredSelected()),g(9),P(r.filteredUsers().length===0?89:90),g(3),q("Selected ",r.selectedAuthIds().length," recipient(s)."),g(5),q(" ",r.selectedAuthIds().length," recipient(s) selected "),g(2),v(r.actionHint()),g(4),S("disabled",r.runningBatch()||r.selectedAuthIds().length===0||!r.selectedTemplateId()),g(3),P(r.runningBatch()?106:107)}}var Ne=class a{readonlyHelper=h(j);storeHelper=h(Pe);userService=h(_e);docTemplateHelper=h(L);gmailDraftHelper=h(G);eligibleAuthIdsBySeason=new Map;loading=f(!1);runningBatch=f(!1);message=f(null);error=f(null);seasons=f([]);selectedSeasonId=f("");selectedNotificationType=f("registrationConfirmation");allTemplatesDoc=f(null);selectedTemplateId=f("");currentStats=f(null);allCacheUsers=f([]);users=f([]);searchQuery=f("");selectedAuthIds=f([]);debugMode=f(!1);filteredTemplates=J(()=>(this.allTemplatesDoc()?.templates??[]).filter(e=>e.notificationType===this.selectedNotificationType()&&e.isActive).sort((e,t)=>e.name.localeCompare(t.name)));filteredUsers=J(()=>{let e=this.searchQuery().trim().toLowerCase();return this.users().filter(i=>{let n=[i.displayName,i.parentName,i.email,i.displayId,...i.studentNames].join(" ").toLowerCase();return e.length===0||n.includes(e)}).sort((i,n)=>(i.parentName||i.displayName).localeCompare(n.parentName||n.displayName))});async ngOnInit(){await this.loadInitialData()}async onSeasonChange(e){this.selectedSeasonId.set(e),this.selectedAuthIds.set([]),await Promise.all([this.refreshEligibleUsersForSelectedSeason(),this.reloadCurrentStats()])}async onNotificationTypeChange(e){if(e!=="registrationConfirmation"){this.error.set(`Unsupported notificationType: ${e}`);return}this.selectedNotificationType.set(e);let t=this.filteredTemplates()[0];this.selectedTemplateId.set(t?.id??""),this.selectedAuthIds.set([]),await this.reloadCurrentStats()}async onTemplateChange(e){this.selectedTemplateId.set(e),this.selectedAuthIds.set([]),await this.reloadCurrentStats()}isSelected(e){return this.selectedAuthIds().includes(e)}hasDraftRecord(e){let t=this.currentStats()?.recipientStateByAuthId[e];return!!t&&t.draftCount>0}formatStatsDate(e){if(!e)return"Never";let t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleString()}getInitials(e){let t=e.trim();return t.length===0?"--":t.split(/\s+/).slice(0,2).map(n=>n.charAt(0).toUpperCase()).join("")}toggleUserRow(e){this.toggleSelectedUser(e,!this.isSelected(e))}actionHint(){return this.selectedTemplateId()?this.selectedAuthIds().length===0?"Select at least one recipient.":this.debugMode()?"Debug mode is ON: at most one draft will be created.":"Ready to create Gmail drafts.":"Select a template to enable draft generation."}toggleSelectedUser(e,t){let i=new Set(this.selectedAuthIds());t?i.add(e):i.delete(e),this.selectedAuthIds.set([...i])}onRecipientToggle(e,t){let i=t.target;i instanceof HTMLInputElement&&this.toggleSelectedUser(e,i.checked)}onDebugModeChange(e){let t=e.target;t instanceof HTMLInputElement&&this.debugMode.set(t.checked)}areAllFilteredSelected(){let e=this.filteredUsers();if(e.length===0)return!1;let t=new Set(this.selectedAuthIds());return e.every(i=>t.has(i.authId))}isPartiallyFilteredSelected(){let e=this.filteredUsers();if(e.length===0)return!1;let t=new Set(this.selectedAuthIds()),i=e.filter(n=>t.has(n.authId)).length;return i>0&&i<e.length}onSelectAllFilteredChange(e){let t=e.target;if(!(t instanceof HTMLInputElement))return;let i=this.filteredUsers().map(r=>r.authId),n=new Set(this.selectedAuthIds());if(t.checked)for(let r of i)n.add(r);else for(let r of i)n.delete(r);this.selectedAuthIds.set([...n])}clearSelectedUsers(){this.selectedAuthIds.set([])}async createDraftBatch(){this.message.set(null),this.error.set(null);let e=this.selectedSeasonId(),t=this.selectedTemplate(),i=this.selectedAuthIds(),r=this.userService.actualUser()?.uid??"admin";if(!e){this.error.set("Please select a season.");return}if(!t){this.error.set("Please select a template.");return}if(i.length===0){this.error.set("Please select at least one recipient.");return}let d=this.debugMode(),m=d?i.slice(0,1):i,l=new Date().toISOString(),p=this.buildJobId(),b={jobId:p,seasonId:e,notificationType:this.selectedNotificationType(),templateId:t.id,requestedBy:r,requestedAt:l,debugMode:d,targetAuthIds:m,successAuthIds:[],failed:[],createdDraftIds:[],status:"running",completedAt:null};this.runningBatch.set(!0);try{await this.storeHelper.createBatchJob(b);let I=await this.docTemplateHelper.resolveTemplateHtml(t),w=await this.readonlyHelper.listOrdersByUserIds(e,m),O=new Map(w.map(_=>[_.userAuthId,_])),Re=new Map(this.users().map(_=>[_.authId,_])),k=[],te=[],ne=new Map,R=[];for(let _ of m)try{let T=Re.get(_);if(!T)throw new Error(`Missing admin cache entry for authId ${_}`);let U=O.get(_);if(!U)throw new Error("No order found for selected season");let ie=ke({order:U,cacheEntry:T}),He=Z(t.subjectTemplate,ie),$e=Z(I,ie),re=await this.gmailDraftHelper.createDraft({to:T.email,subject:He,htmlBody:$e});k.push(_),te.push(re.draftId),ne.set(_,re.draftId)}catch(T){let U=T instanceof Error?T.message:String(T);R.push({authId:_,error:U})}let Ue=R.length>0&&k.length===0?"failed":"completed";await this.storeHelper.updateBatchJob(p,{successAuthIds:k,failed:R,createdDraftIds:te,status:Ue,completedAt:new Date().toISOString()}),!d&&k.length>0&&await this.updateSeasonTemplateStats({seasonId:e,template:t,requestedBy:r,successAuthIds:k,createdDraftIdByAuthId:ne,jobId:p}),await this.reloadCurrentStats(),this.message.set(`Draft creation finished. Success: ${k.length}, Failed: ${R.length}${d?" (debug mode)":""}.`)}catch(I){let w=I instanceof Error?I.message:String(I);this.error.set(w)}finally{this.runningBatch.set(!1)}}selectedTemplate(){let e=this.selectedTemplateId();return e?this.filteredTemplates().find(t=>t.id===e)??null:null}async loadInitialData(){this.loading.set(!0),this.error.set(null),this.message.set(null);try{let t=this.userService.actualUser()?.uid??"admin",[i,n,r]=await Promise.all([this.readonlyHelper.listAllSeasons(),this.readonlyHelper.getAdminUserCache(),this.storeHelper.getTemplatesDocOrCreate(t)]);this.seasons.set(i),i.length>0&&this.selectedSeasonId.set(i[0].id);let d=(n?.users??[]).map(l=>({authId:l.authId,email:l.email,displayName:l.displayName,displayId:l.displayId,parentName:l.parentName,studentNames:l.studentNames,wechat:l.wechat}));this.allCacheUsers.set(d),this.users.set(d),this.allTemplatesDoc.set(r);let m=r.templates.find(l=>l.notificationType===this.selectedNotificationType()&&l.isActive);this.selectedTemplateId.set(m?.id??""),await Promise.all([this.refreshEligibleUsersForSelectedSeason(),this.reloadCurrentStats()])}catch(e){let t=e instanceof Error?e.message:String(e);this.error.set(t)}finally{this.loading.set(!1)}}async reloadCurrentStats(){let e=this.selectedSeasonId(),t=this.selectedTemplate(),n=this.userService.actualUser()?.uid??"admin";if(!e||!t){this.currentStats.set(null);return}let r=await this.storeHelper.getSeasonTemplateStats(e,this.selectedNotificationType(),t.id);this.currentStats.set(r??Q({seasonId:e,notificationType:this.selectedNotificationType(),templateId:t.id,templateName:t.name,updatedBy:n}))}async refreshEligibleUsersForSelectedSeason(){let e=this.selectedSeasonId();if(!e){this.users.set([]);return}let t=this.eligibleAuthIdsBySeason.get(e);if(t){let l=this.allCacheUsers().filter(p=>t.has(p.authId));this.users.set(l);return}let i=this.seasons().find(l=>l.id===e),n=new Set((i?.sessions??[]).filter(l=>l.isActive).map(l=>l.id)),r=await this.readonlyHelper.listSeasonOrders(e),d=new Set;for(let l of r)ye(l).some(b=>n.size===0?!0:n.has(b.sessionId))&&d.add(l.userAuthId);this.eligibleAuthIdsBySeason.set(e,d);let m=this.allCacheUsers().filter(l=>d.has(l.authId));this.users.set(m)}async updateSeasonTemplateStats(e){let t=await this.storeHelper.getSeasonTemplateStats(e.seasonId,this.selectedNotificationType(),e.template.id)??Q({seasonId:e.seasonId,notificationType:this.selectedNotificationType(),templateId:e.template.id,templateName:e.template.name,updatedBy:e.requestedBy}),i=new Date().toISOString(),n=V({},t.recipientStateByAuthId);for(let m of e.successAuthIds){let l=n[m]??{draftCount:0,lastDraftCreatedAt:null,lastDraftId:null,lastBatchJobId:null};n[m]={draftCount:l.draftCount+1,lastDraftCreatedAt:i,lastDraftId:e.createdDraftIdByAuthId.get(m)??l.lastDraftId,lastBatchJobId:e.jobId}}let r=Object.values(n).filter(m=>m.draftCount>0).length,d=ae(V({},t),{templateName:e.template.name,draftCreatedCount:t.draftCreatedCount+e.successAuthIds.length,lastDraftCreatedAt:i,uniqueRecipientCount:r,recipientStateByAuthId:n,updatedAt:i,updatedBy:e.requestedBy});await this.storeHelper.saveSeasonTemplateStats(d)}buildJobId(){let e=Math.random().toString(36).slice(2,10);return`EML-${Date.now()}-${e}`}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=se({type:a,selectors:[["app-admin-email-center"]],decls:4,vars:1,consts:[["pageTitle","Email Draft Center","pageSubtitle","Create Gmail drafts for admin review"],[1,"email-center"],[1,"card"],[1,"card","success"],[1,"card","error"],[1,"card-head"],[1,"card-subtitle"],["routerLink","/admin/email/templates",1,"inline-link"],[1,"controls-grid"],[1,"field"],["for","season"],["id","season",3,"ngModelChange","ngModel"],["value",""],[3,"value"],["for","notificationType"],["id","notificationType",3,"ngModelChange","ngModel"],["value","registrationConfirmation"],["for","template"],["id","template",3,"ngModelChange","ngModel"],[1,"checkbox","checkbox-inline"],["type","checkbox",3,"change","checked"],[1,"card","card-collapsible"],[1,"collapsible-body"],[1,"stats-grid"],[1,"stat-card"],["aria-hidden","true",1,"stat-icon","material-symbols-rounded"],[1,"stat-label"],[1,"stat-value"],[1,"recipient-toolbar"],["type","text","placeholder","Search by parent/email/student name",3,"ngModelChange","ngModel"],["type","button",1,"btn","btn-outline",3,"click"],[1,"user-table-scroll"],[1,"user-table"],[1,"user-table-header"],[1,"select-header-cell"],["type","checkbox",3,"change","checked","indeterminate"],[1,"empty-table-state"],[1,"hint"],[1,"sticky-action-bar"],[1,"sticky-action-inner"],[1,"selection-block"],[1,"selection-info"],[1,"selection-hint"],[1,"sticky-actions"],["type","button",1,"btn","btn-primary","btn-generate",3,"click","disabled"],["aria-hidden","true",1,"material-symbols-rounded"],[1,"user-row",3,"user-row-selected"],[1,"user-row",3,"click"],["type","checkbox",3,"click","change","checked"],[1,"parent-cell"],[1,"avatar"],[1,"parent-name"],[1,"email-cell"],[1,"status-pill","status-drafted"],[1,"status-pill","status-unsent"]],template:function(t,i){t&1&&(s(0,"app-admin-layout",0)(1,"div",1),A(2,Ke,3,0,"div",2)(3,ot,108,18),o()()),t&2&&(g(2),P(i.loading()?2:3))},dependencies:[ce,Te,Me,Ee,xe,we,Se,Ie,de,Ae],styles:['.email-center[_ngcontent-%COMP%]{display:grid;gap:1rem;max-width:1400px;margin:0 auto;padding:1.5rem;padding-bottom:0}.card[_ngcontent-%COMP%]{background:var(--sys-surface, #fff);border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.25rem}.card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 .75rem;font-size:1.4rem;font-weight:600;color:var(--sys-on-surface, #212121)}.card-subtitle[_ngcontent-%COMP%]{margin:-.45rem 0 0;font-size:.86rem;color:var(--sys-on-surface-variant, #616161)}.card-head[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:.75rem}.card-head[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0}.inline-link[_ngcontent-%COMP%]{font-size:.95rem;font-weight:600;color:var(--sys-primary, #c62828);text-decoration:none;white-space:nowrap}.inline-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.controls-grid[_ngcontent-%COMP%]{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}.field[_ngcontent-%COMP%]{display:grid;gap:.5rem}.field[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-weight:500;font-size:.95rem;color:var(--sys-on-surface, #212121)}.checkbox-inline[_ngcontent-%COMP%]{margin-top:.85rem}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{border:1px solid var(--sys-outline-variant, #d1d5db);border-radius:8px;padding:.55rem .65rem;font-size:.95rem;width:100%;box-sizing:border-box;color:var(--sys-on-surface, #212121);background:var(--sys-surface, #fff)}input[_ngcontent-%COMP%]:focus, select[_ngcontent-%COMP%]:focus{outline:2px solid color-mix(in srgb,var(--sys-primary, #c62828) 30%,white);border-color:var(--sys-primary, #c62828)}.stats-grid[_ngcontent-%COMP%]{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}.stat-card[_ngcontent-%COMP%]{border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:10px;padding:.75rem;background:color-mix(in srgb,var(--sys-surface, #fff) 75%,#f7f7f7);display:flex;align-items:center;gap:.65rem}.stat-icon[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-size:1.1rem;background:color-mix(in srgb,var(--sys-primary, #c62828) 14%,white);color:var(--sys-primary, #c62828)}.stat-label[_ngcontent-%COMP%]{margin:0;font-size:.78rem;color:var(--sys-on-surface-variant, #616161);font-weight:500}.stat-value[_ngcontent-%COMP%]{margin:.08rem 0 0;font-size:1rem;font-weight:600;color:var(--sys-on-surface, #212121)}.card-collapsible[_ngcontent-%COMP%]{padding-top:.8rem}.card-collapsible[_ngcontent-%COMP%]   summary[_ngcontent-%COMP%]{list-style:none;cursor:pointer;display:flex;align-items:center;font-size:1.2rem;font-weight:600;color:var(--sys-on-surface, #212121);margin:0}.card-collapsible[_ngcontent-%COMP%]   summary[_ngcontent-%COMP%]::-webkit-details-marker{display:none}.card-collapsible[_ngcontent-%COMP%]   summary[_ngcontent-%COMP%]:after{content:"expand_more";font-family:Material Symbols Rounded;font-size:1.2rem;margin-left:.3rem;transition:transform .2s ease;color:var(--sys-on-surface-variant, #616161)}.card-collapsible[open][_ngcontent-%COMP%]   summary[_ngcontent-%COMP%]:after{transform:rotate(180deg)}.collapsible-body[_ngcontent-%COMP%]{margin-top:.75rem}.recipient-toolbar[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center;margin-bottom:.55rem}.checkbox[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.4rem;font-size:.9rem;color:var(--sys-on-surface, #212121)}.select-header-cell[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center}.user-table-scroll[_ngcontent-%COMP%]{max-height:52vh;overflow:auto;border-radius:8px;border:1px solid var(--sys-outline-variant, #e0e0e0)}.user-table[_ngcontent-%COMP%]{background:var(--sys-surface, #fff)}.user-table-header[_ngcontent-%COMP%], .user-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:80px 1fr 1fr 1fr 100px;gap:.5rem;padding:.55rem .65rem;align-items:center;font-size:.9rem}.user-table-header[_ngcontent-%COMP%]{background:var(--sys-surface-variant, #f5f5f5);font-weight:600;color:var(--sys-on-surface, #212121);position:sticky;top:0;z-index:2}.user-row[_ngcontent-%COMP%]:nth-child(2n){background:color-mix(in srgb,var(--sys-surface, #fff) 70%,#f5f5f5)}.user-row[_ngcontent-%COMP%]{color:var(--sys-on-surface, #212121);cursor:pointer;transition:background .15s ease}.empty-table-state[_ngcontent-%COMP%]{padding:1.1rem .9rem;font-size:.9rem;color:var(--sys-on-surface-variant, #616161);text-align:center;background:color-mix(in srgb,var(--sys-surface, #fff) 82%,#f3f3f3)}.user-row[_ngcontent-%COMP%]:hover{background:color-mix(in srgb,var(--sys-primary, #c62828) 6%,#ffffff)}.user-row-selected[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--sys-primary, #c62828) 11%,#ffffff);box-shadow:inset 3px 0 0 var(--sys-primary, #c62828)}.parent-cell[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;min-width:0}.avatar[_ngcontent-%COMP%]{width:24px;height:24px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-size:.67rem;font-weight:700;color:var(--sys-primary, #c62828);background:color-mix(in srgb,var(--sys-primary, #c62828) 10%,#ffffff);border:1px solid color-mix(in srgb,var(--sys-primary, #c62828) 28%,#ffffff);flex-shrink:0}.parent-name[_ngcontent-%COMP%]{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.email-cell[_ngcontent-%COMP%]{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.83rem;overflow-wrap:anywhere}.status-pill[_ngcontent-%COMP%]{display:inline-flex;align-items:center;border-radius:999px;padding:.2rem .55rem;font-size:.78rem;font-weight:600;line-height:1.3}.status-drafted[_ngcontent-%COMP%]{background:#e8f5e9;color:#2e7d32;border:1px solid #c8e6c9}.status-unsent[_ngcontent-%COMP%]{background:#f5f5f5;color:#424242;border:1px solid #e0e0e0}.btn[_ngcontent-%COMP%]{border:1px solid var(--sys-outline-variant, #d1d5db);background:var(--sys-surface, #fff);color:var(--sys-on-surface, #212121);border-radius:8px;padding:.5rem .8rem;cursor:pointer;text-decoration:none;transition:background .2s ease,border-color .2s ease}.btn[_ngcontent-%COMP%]:hover{background:var(--sys-surface-variant, #f5f5f5);border-color:var(--sys-outline, #bdbdbd)}.btn-primary[_ngcontent-%COMP%]{background:var(--sys-primary, #c62828);border-color:var(--sys-primary, #c62828);color:#fff}.btn-primary[_ngcontent-%COMP%]:hover{background:color-mix(in srgb,var(--sys-primary, #c62828) 88%,black);border-color:color-mix(in srgb,var(--sys-primary, #c62828) 88%,black)}.btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.btn-outline[_ngcontent-%COMP%]{background:var(--sys-surface, #fff)}.hint[_ngcontent-%COMP%]{margin-top:.6rem;color:var(--sys-on-surface-variant, #616161);font-size:.85rem}.sticky-action-bar[_ngcontent-%COMP%]{position:sticky;bottom:0;z-index:30;border-top:1px solid var(--sys-outline-variant, #e0e0e0);background:var(--sys-surface, #fff);box-shadow:0 -2px 8px #00000014;border-radius:12px 12px 0 0;background-clip:padding-box}.sticky-action-inner[_ngcontent-%COMP%]{padding:.75rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:.75rem}.selection-block[_ngcontent-%COMP%]{display:grid;gap:.15rem}.selection-info[_ngcontent-%COMP%]{color:var(--sys-on-surface, #212121);font-size:.95rem;font-weight:500}.selection-hint[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #616161);font-size:.82rem}.sticky-actions[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.7rem;flex-wrap:wrap}.btn-generate[_ngcontent-%COMP%]{min-height:54px;min-width:260px;padding:.9rem 1.45rem;font-size:1.08rem;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;box-shadow:0 4px 12px color-mix(in srgb,var(--sys-primary, #c62828) 28%,transparent);transition:transform .15s ease,box-shadow .2s ease,background .2s ease}.btn-generate[_ngcontent-%COMP%]   .material-symbols-rounded[_ngcontent-%COMP%]{font-size:1.1rem}.btn-generate[_ngcontent-%COMP%]:disabled{box-shadow:none}.btn-generate[_ngcontent-%COMP%]:not(:disabled):hover{transform:translateY(-1px);box-shadow:0 8px 18px color-mix(in srgb,var(--sys-primary, #c62828) 38%,transparent)}.success[_ngcontent-%COMP%]{border-color:var(--sys-tertiary, #2e7d32);color:#1b5e20;background:#f1f8e9}.error[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}@media(max-width:900px){.email-center[_ngcontent-%COMP%]{padding:1rem;padding-bottom:0}.card-head[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.recipient-toolbar[_ngcontent-%COMP%]{grid-template-columns:1fr}.user-table-scroll[_ngcontent-%COMP%]{max-height:56vh}.user-table-header[_ngcontent-%COMP%], .user-row[_ngcontent-%COMP%]{grid-template-columns:60px 1fr 1fr}.user-table-header[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(4), .user-table-header[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(5), .user-row[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(4), .user-row[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(5){display:none}.sticky-action-inner[_ngcontent-%COMP%]{padding:.75rem 1rem;flex-direction:column;align-items:stretch}.selection-info[_ngcontent-%COMP%], .selection-hint[_ngcontent-%COMP%]{text-align:center}.sticky-actions[_ngcontent-%COMP%]{justify-content:center}.btn-generate[_ngcontent-%COMP%]{width:100%;max-width:420px}}']})};export{Ne as AdminEmailCenterComponent};
