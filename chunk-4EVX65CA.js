import{b as y}from"./chunk-RYIKU5Y3.js";import{$ as b,Y as n}from"./chunk-4OLSY4ZS.js";import{F as c,aa as h,db as m,ha as g}from"./chunk-UYHN5VVP.js";import{I as l,N as d,Tb as u,da as i}from"./chunk-5O64VQN5.js";var f=class o{functions=d(b);firestore=g(c());_users=i([]);_rebuiltAt=i(null);_rebuiltBy=i(null);_userCount=i(0);_loading=i(!1);_rebuilding=i(!1);_error=i(null);_isLoaded=i(!1);users=this._users.asReadonly();rebuiltAt=this._rebuiltAt.asReadonly();rebuiltBy=this._rebuiltBy.asReadonly();userCount=this._userCount.asReadonly();loading=this._loading.asReadonly();rebuilding=this._rebuilding.asReadonly();error=this._error.asReadonly();isLoaded=this._isLoaded.asReadonly();rebuiltAtFormatted=u(()=>{let e=this._rebuiltAt();return e?y(e):null});async loadCache(){if(!this._isLoaded()){this._loading.set(!0),this._error.set(null);try{let e=h(this.firestore,"admin","userCache"),r=await m(e);if(r.exists()){let t=r.data();this._users.set(t.users),this._rebuiltAt.set(t.rebuiltAt),this._rebuiltBy.set(t.rebuiltBy),this._userCount.set(t.userCount),this._isLoaded.set(!0)}else{this._isLoaded.set(!0),this._loading.set(!1),this._rebuilding()?n("Admin user cache miss - rebuild already in progress, skipping"):(n("Admin user cache miss - triggering automatic rebuild"),await this.rebuildCache());return}}catch(e){console.error("Failed to load user cache:",e),this._error.set("Failed to load user cache"),this._users.set([])}finally{this._loading.set(!1)}}}async reloadCache(){this._isLoaded.set(!1),await this.loadCache()}searchUsers(e){let r=this._users();if(!e||e.trim().length===0)return r;let t=e.toLowerCase().trim();return r.filter(s=>!!(s.email.toLowerCase().includes(t)||s.displayName.toLowerCase().includes(t)||s.displayId.toLowerCase().includes(t)||s.parentName.toLowerCase().includes(t)||s.studentNames.some(a=>a.toLowerCase().includes(t))||s.wechat?.toLowerCase().includes(t)))}getUserByAuthId(e){return this._users().find(r=>r.authId===e)}async ensureUsersInCache(e){if(!this._isLoaded()||this._rebuilding())return!1;let r=this._users(),t=new Set(r.map(a=>a.authId)),s=e.filter(a=>!t.has(a));return s.length>0?(n(`Admin user cache miss for ${s.length} user(s) - triggering incremental update`),await this.rebuildCache(s),!0):!1}async rebuildCache(e){this._rebuilding.set(!0),this._error.set(null);try{let r=e&&e.length>0?{authIds:e}:{};await this.functions.callApi("rebuildAdminUserCache",r),await this.reloadCache()}catch(r){console.error("Failed to rebuild user cache:",r),this._error.set("Failed to rebuild user cache")}finally{this._rebuilding.set(!1)}}clearCache(){this._users.set([]),this._rebuiltAt.set(null),this._rebuiltBy.set(null),this._userCount.set(0),this._isLoaded.set(!1),this._error.set(null)}static \u0275fac=function(r){return new(r||o)};static \u0275prov=l({token:o,factory:o.\u0275fac,providedIn:"root"})};export{f as a};
