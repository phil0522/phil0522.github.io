import{d as W}from"./chunk-6CU2GE2E.js";import{a as V}from"./chunk-CHJDJQSS.js";import{a as Q}from"./chunk-45EKZZOI.js";import{a as K,d as J}from"./chunk-RYIKU5Y3.js";import{W as G,X as j,Z as q,ea as Y,h as F,l as $,n as z,o as H}from"./chunk-44VRRK2E.js";import"./chunk-UYHN5VVP.js";import{$a as C,Db as a,Ea as l,Eb as d,Fb as T,N as h,Ob as k,Pb as B,Qa as N,Tb as w,ab as b,da as x,db as A,eb as R,fb as M,gb as n,hb as i,ib as U,sb as S}from"./chunk-5O64VQN5.js";import"./chunk-Q7L6LLAK.js";var ee=()=>["/admin/users"],te=s=>({q:s}),ne=(s,t)=>t.studentId;function ie(s,t){s&1&&(n(0,"div",2),U(1,"div",4),n(2,"p"),a(3,"Loading roster..."),i()())}function ae(s,t){if(s&1&&(n(0,"div",3)(1,"div",5),a(2,"!"),i(),n(3,"p"),a(4),i()()),s&2){let e=S();l(4),d(e.error())}}function re(s,t){s&1&&(n(0,"div",10)(1,"h3"),a(2,"No registrations found"),i(),n(3,"p"),a(4,"This session has no enrolled students."),i()())}function se(s,t){if(s&1&&(n(0,"a",17),a(1),i()),s&2){let e=S().$implicit;M("routerLink",k(3,ee))("queryParams",B(4,te,e.parentDisplayId)),l(),T(" ",e.parentName," ")}}function oe(s,t){if(s&1&&(n(0,"span",18),a(1),i()),s&2){let e=S().$implicit;l(),d(e.parentName)}}function le(s,t){if(s&1&&(n(0,"tr")(1,"td",13)(2,"div",14),a(3),i(),n(4,"div",15),a(5),i()(),n(6,"td"),a(7),i(),n(8,"td"),a(9),i(),n(10,"td"),a(11),i(),n(12,"td"),a(13),i(),n(14,"td"),a(15),i(),n(16,"td"),a(17),i(),n(18,"td",16),C(19,se,2,6,"a",17)(20,oe,2,1,"span",18),n(21,"div",19)(22,"span",20),a(23),i(),n(24,"span"),a(25),i(),n(26,"span"),a(27),i()()(),n(28,"td")(29,"span",21),a(30),i()()()),s&2){let e=t.$implicit;l(3),d(e.studentName),l(2),d(e.studentId),l(2),d(e.ageLabel),l(2),d(e.genderLabel),l(2),d(e.dobLabel),l(2),d(e.gradeLabel),l(2),d(e.schoolLabel),l(2),d(e.allergiesLabel),l(2),b(e.parentDisplayId?19:20),l(4),d(e.parentDisplayId||"--"),l(2),d(e.parentEmail),l(2),d(e.parentPhone),l(3),d(e.orderStatusLabel)}}function de(s,t){if(s&1&&(n(0,"div",11)(1,"table",12)(2,"thead")(3,"tr")(4,"th"),a(5,"Student"),i(),n(6,"th"),a(7,"Age"),i(),n(8,"th"),a(9,"Gender"),i(),n(10,"th"),a(11,"DOB"),i(),n(12,"th"),a(13,"Grade"),i(),n(14,"th"),a(15,"School"),i(),n(16,"th"),a(17,"Allergies"),i(),n(18,"th"),a(19,"Parent"),i(),n(20,"th"),a(21,"Status"),i()()(),n(22,"tbody"),A(23,le,31,13,"tr",null,ne),i()()()),s&2){let e=S(2);l(23),R(e.rows())}}function me(s,t){if(s&1&&(n(0,"div",6)(1,"div",7)(2,"span",8),a(3,"Session"),i(),n(4,"span",9),a(5),i()(),n(6,"div",7)(7,"span",8),a(8,"Dates"),i(),n(9,"span",9),a(10),i()(),n(11,"div",7)(12,"span",8),a(13,"Enrolled"),i(),n(14,"span",9),a(15),i()()(),C(16,re,5,0,"div",10)(17,de,25,0,"div",11)),s&2){let e,o=S();l(5),d((e=o.session())==null?null:e.name),l(5),d(o.dateRange()),l(5),d(o.rows().length),l(),b(o.rows().length===0?16:17)}}var X=class s{route=h($);router=h(z);userService=h(Y);userCacheService=h(V);seasonDatastore=h(G);orderDatastore=h(q);userDatastore=h(j);loading=x(!0);error=x(null);season=x(null);session=x(null);rows=x([]);subtitle=w(()=>{let t=this.season()?.name??"Season",e=this.session()?.name??"Session";return`${t} - ${e}`});dateRange=w(()=>{let t=this.session();return!t?.startDate||!t?.endDate?"--":J(t.startDate,t.endDate)});async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}let t=this.route.snapshot.paramMap.get("sessionId");if(!t){this.error.set("Missing session ID."),this.loading.set(!1);return}try{let{season:e,session:o}=await this.loadSessionContext(t);this.season.set(e),this.session.set(o);let g=(await this.seasonDatastore.getRegistration(e.id))?.classes[t]?.enrolledStudents??[];await this.userCacheService.loadCache();let u=new Map(this.userCacheService.users().map(r=>[r.displayId,r.authId])),f=g.map(r=>this.getParentDisplayId(r)).filter(r=>!!r).filter(r=>!u.has(r));if(f.length>0){let r=await this.userDatastore.listUsersByDisplayIds(f);for(let p of r)u.set(p.displayId,p.uid)}let v=new Map,c=new Map;for(let r of g){let p=this.getParentDisplayId(r);if(!p)continue;c.set(r,p);let L=u.get(p);L&&v.set(r,L)}let y=Array.from(new Set(v.values()));y.length>0&&await this.userCacheService.ensureUsersInCache(y);let _=new Map(this.userCacheService.users().map(r=>[r.authId,r])),I=y.length>0?await this.userDatastore.listUsersByAuthIds(y):[],D=new Map(I.map(r=>[r.uid,r])),Z=y.length>0?await this.orderDatastore.listOrdersByUserIds(e.id,y):[],P=new Map;for(let r of Z)for(let p of r.items)p.sessionId===t&&P.set(p.studentId,p.status);let O=g.map(r=>this.buildRow(r,D,_,v.get(r)??null,c.get(r)??null,P.get(r)??null,o.startDate??null));O.sort((r,p)=>r.studentName.localeCompare(p.studentName)),this.rows.set(O)}catch(e){let o=e instanceof Error?e.message:"Failed to load session registrations.";this.error.set(o)}finally{this.loading.set(!1)}}async loadSessionContext(t){let e=await this.seasonDatastore.listAllSeasons();for(let o of e){let m=o.sessions?.find(g=>g.id===t);if(m)return{season:o,session:m}}throw new Error("Session not found.")}buildRow(t,e,o,m,g,u,E){let f=m?e.get(m)??null:null,v=m?o.get(m)??null:null,c=f?.students?.find(D=>D.id===t)??null,y=c?`${c.firstName} ${c.lastName}`:t,_=this.getAgeLabel(c,E),I=f?.displayId??v?.displayId??g??this.getParentDisplayId(t)??"";return{studentId:t,studentName:y,ageLabel:_,dobLabel:c?.dob?K(c.dob,{month:"short",day:"numeric",year:"numeric"}):"--",genderLabel:this.getGenderLabel(c),gradeLabel:c?.grade??"--",schoolLabel:c?.school??"--",allergiesLabel:c?.allergies??"--",parentName:f?.displayName??v?.parentName??"Unknown Parent",parentDisplayId:I,parentEmail:f?.email??v?.email??"--",parentPhone:f?.primaryGuardian?.phone??"--",orderStatusLabel:u?W(u):"Unknown"}}getParentDisplayId(t){let e=t.match(/^(U-\d{8})-K\d+$/);return e?e[1]:null}getGenderLabel(t){return t?.gender?t.gender==="M"?"Male":"Female":"--"}getAgeLabel(t,e){if(!t?.dob)return"--";let o=e??t.dob,m=this.calculateAge(t.dob,o);return Number.isNaN(m)?"--":String(m)}calculateAge(t,e){let o=this.parseDateOnly(t),m=this.parseDateOnly(e),g=m.getUTCFullYear()-o.getUTCFullYear(),u=m.getUTCMonth()-o.getUTCMonth();return(u<0||u===0&&m.getUTCDate()<o.getUTCDate())&&(g-=1),g}parseDateOnly(t){let[e,o,m]=t.split("T")[0].split("-").map(Number);return new Date(Date.UTC(e,o-1,m,12))}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=N({type:s,selectors:[["app-admin-session-registrations"]],decls:5,vars:2,consts:[["pageTitle","Session Registrations",3,"pageSubtitle"],[1,"session-registrations"],[1,"loading-container"],[1,"error-container"],[1,"spinner"],[1,"error-icon"],[1,"session-summary"],[1,"summary-item"],[1,"summary-label"],[1,"summary-value"],[1,"empty-state"],[1,"table-container"],[1,"roster-table"],[1,"col-student"],[1,"student-name"],[1,"student-id"],[1,"col-parent"],[1,"parent-link",3,"routerLink","queryParams"],[1,"parent-link","disabled"],[1,"parent-meta"],[1,"mono"],[1,"status-pill"]],template:function(e,o){e&1&&(n(0,"app-admin-layout",0)(1,"div",1),C(2,ie,4,0,"div",2)(3,ae,5,1,"div",3)(4,me,18,4),i()()),e&2&&(M("pageSubtitle",o.subtitle()),l(2),b(o.loading()?2:o.error()?3:4))},dependencies:[F,H,Q],styles:[".session-registrations[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto;padding:1.5rem}.loading-container[_ngcontent-%COMP%], .error-container[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center}.spinner[_ngcontent-%COMP%]{width:32px;height:32px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.error-container[_ngcontent-%COMP%]{background:var(--sys-error-container, #ffebee);border-radius:12px}.error-icon[_ngcontent-%COMP%]{width:48px;height:48px;background:var(--sys-error, #c62828);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;margin-bottom:1rem}.session-summary[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem;padding:1rem 1.25rem;background:var(--sys-surface-variant, #f5f5f5);border-radius:12px;margin-bottom:1.5rem}.summary-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.summary-label[_ngcontent-%COMP%]{font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;color:var(--sys-on-surface-variant, #666)}.summary-value[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:var(--sys-on-surface, #212121)}.table-container[_ngcontent-%COMP%]{overflow-x:auto}.roster-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.85rem}.roster-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;padding:.625rem .75rem;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--sys-on-surface-variant, #666);border-bottom:2px solid var(--sys-outline-variant, #e0e0e0);white-space:nowrap}.roster-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.625rem .75rem;border-bottom:1px solid var(--sys-outline-variant, #f0f0f0);color:var(--sys-on-surface, #212121);vertical-align:top}.col-student[_ngcontent-%COMP%]{min-width:180px}.student-name[_ngcontent-%COMP%]{font-weight:600}.student-id[_ngcontent-%COMP%]{font-size:.75rem;color:var(--sys-on-surface-variant, #666);margin-top:.2rem}.col-parent[_ngcontent-%COMP%]{min-width:220px}.parent-link[_ngcontent-%COMP%]{color:var(--sys-primary, #c62828);text-decoration:none;font-weight:600}.parent-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.parent-link.disabled[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #888);cursor:default}.parent-meta[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.2rem;font-size:.75rem;color:var(--sys-on-surface-variant, #666);margin-top:.25rem}.mono[_ngcontent-%COMP%]{font-family:monospace}.status-pill[_ngcontent-%COMP%]{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:var(--sys-surface-variant, #f5f5f5);font-size:.75rem;font-weight:600}@media(max-width:960px){.session-summary[_ngcontent-%COMP%]{grid-template-columns:1fr}}"]})};export{X as AdminSessionRegistrationsComponent};
