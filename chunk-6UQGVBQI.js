import{a as Ge}from"./chunk-RETJH3ZJ.js";import{c as Pe,f as De,i as Oe,j as Te,k as Me,q as Ue}from"./chunk-KPP33G2Z.js";import{c as Ne}from"./chunk-RYIKU5Y3.js";import{H as de,V as Ee,W as be,Y as Ae,Z as le,ea as C,h as Se,ja as Re,ka as Ie,ma as ve,n as Ce,q as se,qa as ke,s as _e}from"./chunk-FN3HE72D.js";import{Ba as j,Da as K,F as q,Ia as ae,Ka as ie,Oa as we,_ as F,aa as O,db as T,gb as L,ha as Z,wa as xe}from"./chunk-CIPCES67.js";import{$a as I,Ba as me,Bb as ye,Db as g,Ea as y,Eb as z,Fb as fe,N as W,Qa as pe,S as G,T as k,ab as v,da as A,db as re,eb as oe,fb as D,gb as p,hb as u,ib as ue,ob as ge,qb as $,sb as R,zb as he}from"./chunk-CNMR2ZL6.js";import{a as te,b as ne}from"./chunk-Q7L6LLAK.js";var it=50,dt=30,V=class{constructor(n){this.firestore=n}getErrorCode(n){if(typeof n!="object"||n===null)return null;let t=n.code;return typeof t=="string"?t:null}async loadSeasonRaw(n){let t=O(this.firestore,`years/${2026}/seasons`,n),r=await T(t);if(!r.exists())throw new Error(`Season ${n} not found`);return r.data()}async loadSeason(n){let t=await this.loadSeasonRaw(n);return de(t)}async loadOrders(n,t,r=it){let o=[],s=F(this.firestore,`years/${2026}/seasons/${n}/orders`),a=null,i=0;for(;;){i++,t({step:"Loading orders...",detail:`batch ${i}`});let d=a?j(s,ae("userAuthId"),ie(r),we(a)):j(s,ae("userAuthId"),ie(r)),l=await L(d);for(let c of l.docs)o.push(c.data());if(l.size<r)break;a=l.docs[l.docs.length-1]}return o}async loadUsers(n,t,r=dt){let o=new Map,s=[...new Set(n)];if(s.length===0)return o;let a=F(this.firestore,"users"),i=Math.ceil(s.length/r);for(let d=0;d<s.length;d+=r){let l=Math.floor(d/r)+1;t({step:"Loading user data...",detail:`batch ${l} of ${i}`});let c=s.slice(d,d+r),h=j(a,K(xe(),"in",c)),_=await L(h);for(let f of _.docs){let E=f.data();o.set(E.uid,E)}}return o}async loadRegistration(n){let t=O(this.firestore,`years/${2026}/registrations`,n),r=await T(t);return r.exists()?r.data():null}async loadSystemConfig(){let n=O(this.firestore,"system","config"),t=await T(n);return t.exists()?t.data():null}async loadAdminUserCache(){let n=O(this.firestore,"admin","userCache"),t=await T(n);return t.exists()?t.data():null}async loadAdminEmailTemplates(){let n=O(this.firestore,"admin","email","templates","all_templates"),t=await T(n);return t.exists()?t.data():null}async loadAdminEmailSeasonTemplateStats(n){let t=F(this.firestore,"admin","email","season_template_stats"),r=j(t,K("seasonId","==",n));return(await L(r)).docs.map(s=>s.data())}async loadAdminEmailBatchJobs(n){let t=F(this.firestore,"admin","email","batch_jobs"),r=j(t,K("seasonId","==",n));return(await L(r)).docs.map(s=>s.data())}async loadCounters(){let n=F(this.firestore,"system","counters","entities"),t=await L(n);if(t.size>0)return t.docs.map(s=>({id:s.id,data:s.data()}));let r=O(this.firestore,"system","counters"),o=await T(r);return o.exists()?[{id:o.id,data:o.data()}]:[]}async loadCoupons(n,t){let r=[],o=F(this.firestore,"coupons"),s=await L(o);for(let d of s.docs)r.push(d.data());let a=new Set(r.map(d=>d.id));for(let d of n.coupons??[])a.has(d.id)||(r.push(d),a.add(d.id));let i=new Set;for(let d of t)for(let l of d.appliedCouponIds??[])a.has(l)||i.add(l);for(let d of i){let l=O(this.firestore,"coupons",d),c=await T(l);if(c.exists()){let h=c.data();a.has(h.id)||(r.push(h),a.add(h.id))}}return r}async loadAllData(n,t){t({step:"Loading season data..."});let r=await this.loadSeasonRaw(n),o=de(r),s=await this.loadOrders(n,t),a=s.map(m=>m.userAuthId),i=await this.loadUsers(a,t);t({step:"Loading registration data..."});let d=await this.loadRegistration(n);t({step:"Loading coupon data..."});let l=await this.loadCoupons(o,s);t({step:"Loading system config..."});let c=null;try{c=await this.loadSystemConfig()}catch(m){if(this.getErrorCode(m)!=="permission-denied")throw m;t({step:"Skipping system config (permission denied)"})}t({step:"Loading admin cache..."});let h=null;try{h=await this.loadAdminUserCache()}catch(m){if(this.getErrorCode(m)!=="permission-denied")throw m;t({step:"Skipping admin cache (permission denied)"})}t({step:"Loading system counters..."});let _=[];try{_=await this.loadCounters()}catch(m){if(this.getErrorCode(m)!=="permission-denied")throw m;t({step:"Skipping system counters (permission denied)"})}t({step:"Loading admin email templates..."});let f=null;try{f=await this.loadAdminEmailTemplates()}catch(m){if(this.getErrorCode(m)!=="permission-denied")throw m;t({step:"Skipping admin email templates (permission denied)"})}t({step:"Loading admin email season stats..."});let E=[];try{E=await this.loadAdminEmailSeasonTemplateStats(n)}catch(m){if(this.getErrorCode(m)!=="permission-denied")throw m;t({step:"Skipping admin email season stats (permission denied)"})}t({step:"Loading admin email batch jobs..."});let S=[];try{S=await this.loadAdminEmailBatchJobs(n)}catch(m){if(this.getErrorCode(m)!=="permission-denied")throw m;t({step:"Skipping admin email batch jobs (permission denied)"})}return{seasonRaw:r,season:o,orders:s,users:i,registration:d,coupons:l,systemConfig:c,adminUserCache:h,counters:_,adminEmailTemplates:f,adminEmailSeasonTemplateStats:E,adminEmailBatchJobs:S}}};var $e="https://sheets.googleapis.com/v4/spreadsheets",Q=null,X=0,lt=3300*1e3;var ee=class{async acquireAccessToken(){if(Q&&Date.now()<X)return C("[GoogleSheets] Using cached access token (expires in",Math.round((X-Date.now())/1e3/60),"minutes)"),Q;C("[GoogleSheets] Acquiring new access token via OAuth popup...");let n=new se;n.addScope("https://www.googleapis.com/auth/spreadsheets"),C("[GoogleSheets] Opening sign-in popup...");let t=await _e(ke,n);C("[GoogleSheets] Sign-in popup completed, user:",t.user?.email);let r=se.credentialFromResult(t);if(C("[GoogleSheets] Credential extracted:",r?"success":"null"),!r)throw console.error("[GoogleSheets] Failed to obtain Google credentials from result:",t),new Error("Failed to obtain Google credentials");let o=r.accessToken;if(C("[GoogleSheets] Access token present:",!!o),!o)throw console.error("[GoogleSheets] Credential has no accessToken. Credential type:",r.providerId),new Error("Failed to obtain access token");return Q=o,X=Date.now()+lt,C("[GoogleSheets] Access token cached successfully"),o}clearCachedToken(){C("[GoogleSheets] Clearing cached access token"),Q=null,X=0}async createSpreadsheet(n,t,r){C("[GoogleSheets] Creating spreadsheet:",{title:n,sheetNames:t}),C("[GoogleSheets] Access token length:",r?.length||0);let o={properties:{title:n},sheets:t.map(i=>({properties:{title:i}}))};C("[GoogleSheets] Request body:",JSON.stringify(o));let s;try{s=await fetch($e,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(o)})}catch(i){throw console.error("[GoogleSheets] Network error during createSpreadsheet:",i),new Error(`Network error creating spreadsheet: ${i instanceof Error?i.message:String(i)}`)}if(C("[GoogleSheets] createSpreadsheet response status:",s.status,s.statusText),!s.ok){let i=await s.text();throw console.error("[GoogleSheets] createSpreadsheet API error:",{status:s.status,statusText:s.statusText,errorText:i,headers:Object.fromEntries(s.headers.entries())}),(s.status===401||s.status===403)&&(C("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${s.status}): ${i}`)}let a=await s.json();return C("[GoogleSheets] Spreadsheet created successfully:",{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}),{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}}async writeSheetData(n,t,r,o){C("[GoogleSheets] Writing sheet data:",{spreadsheetId:n,sheetName:t,rowCount:r.length,columnCount:r[0]?.length||0});let s=encodeURIComponent(t),a=`${$e}/${n}/values/${s}?valueInputOption=RAW`,i;try{i=await fetch(a,{method:"PUT",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({range:t,majorDimension:"ROWS",values:r})})}catch(d){throw console.error("[GoogleSheets] Network error during writeSheetData:",d),new Error(`Network error writing sheet data: ${d instanceof Error?d.message:String(d)}`)}if(C("[GoogleSheets] writeSheetData response status:",i.status,i.statusText),!i.ok){let d=await i.text();throw console.error("[GoogleSheets] writeSheetData API error:",{status:i.status,statusText:i.statusText,errorText:d,sheetName:t}),(i.status===401||i.status===403)&&(C("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${i.status}): ${d}`)}C("[GoogleSheets] Sheet data written successfully:",t)}};function P(e){return`$${(e/100).toFixed(2)}`}function ce(e,n,t){let r=e.get(n);return r?(r.students??[]).find(o=>o.id===t)??null:null}function ct(e,n){return e.sessions.find(t=>t.id===n)?.name??n}function N(e){return JSON.stringify(e??null)}function Fe(e,n,t){let o=["Order User Display ID","Parent Name","Parent Email","Parent Phone","Student Name","Student DOB","Student Gender","Student School","Student Allergies",...t.sessions.map(i=>i.name),"Student Subtotal","Order Discount","Order Total"],s=[];for(let i of e){let d=n.get(i.userAuthId),l=d?.displayName??"",c=i.items,h=new Map;for(let w of c){let b=h.get(w.studentId)??[];b.push(w),h.set(w.studentId,b)}if(h.size===0)continue;let _=be(i.pricing?.discounts??[]),f=le(i),E=[...h.keys()].sort((w,b)=>{let x=ce(n,i.userAuthId,w),J=x?`${x.firstName} ${x.lastName}`.trim():"",U=ce(n,i.userAuthId,b),B=U?`${U.firstName} ${U.lastName}`.trim():"";return J.localeCompare(B)}),S=[],m=!0;for(let w of E){let b=h.get(w),x=ce(n,i.userAuthId,w),J=t.sessions.map(B=>{let Y=b.find(at=>at.sessionId===B.id);return Y?P(Y.snapshot.priceSnapshot.itemTotal):""}),U=b.reduce((B,Y)=>B+Y.snapshot.priceSnapshot.itemTotal,0);S.push([i.userDisplayId,l,d?.email??"",d?.primaryGuardian?.phone??"",x?`${x.firstName} ${x.lastName}`.trim():"",x?.dob??"",x?.gender??"",x?.school??"",x?.allergies??"",...J,P(U),m?P(Math.abs(_)):"",m?P(f):""]),m=!1}s.push({parentName:l,rows:S})}s.sort((i,d)=>i.parentName.localeCompare(d.parentName));let a=s.flatMap(i=>i.rows);return[o,...a]}function Le(e,n){let t=["User Display ID","Parent Name","Parent Email","Order Total","Coupon Discount","Total Paid","Balance Due","Payment Count","Payment Details","Refund Total"],r=[];for(let o of e){if(!o.items.some(f=>f.status==="submitted"||f.status==="paid"))continue;let a=n.get(o.userAuthId),i=le(o),d=o.couponDiscount??0,l=o.totalPaid??0,c=Ae(o),h=Ee(o),_=(o.payments??[]).map(f=>`${f.method} ${P(f.amount)} ${f.recordedAt}${f.reference?` ref:${f.reference}`:""}`).join("; ");r.push([o.userDisplayId,a?.displayName??"",a?.email??"",P(i),P(d),P(l),P(h),String((o.payments??[]).length),_,P(c)])}return[t,...r]}function je(e,n){let t=["Coupon ID","Name","Description","Type","Max Credit (cents)","Eligible Emails","Used By (Order Count)"],r=new Map;for(let s of n)for(let a of s.appliedCouponIds??[])r.set(a,(r.get(a)??0)+1);let o=e.map(s=>[s.id,s.name,s.description,s.coupon_type,String(s.maxCreditCents),(s.eligible_emails??[]).join(", "),String(r.get(s.id)??0)]);return[t,...o]}function Je(e,n,t){let r=["User Display ID","Parent Name","Parent Email","Session ID","Session Name","Joined At"],o=[];for(let s of e){let a=n.get(s.userAuthId);for(let i of s.waitlist??[])o.push([s.userDisplayId,a?.displayName??"",a?.email??"",i.sessionId,ct(t,i.sessionId),i.joinedAt])}return[r,...o]}function Be(e,n,t,r){let o=["Session ID","Session Name","Start Date","End Date","Location","Active","Base Price (cents)","Lunch Price (cents)","Extended Care Price (cents)","Early Bird Tiers (JSON)","Capacity","Enrolled Count","Waitlisted Count","Available Spots","Enrolled Students"],s=new Map,a=new Map;for(let l of n){for(let c of l.items){let h=s.get(c.sessionId)??[];h.push(c.studentId),s.set(c.sessionId,h)}for(let c of l.waitlist??[])a.set(c.sessionId,(a.get(c.sessionId)??0)+1)}let i=new Map;if(r)for(let l of r.values())for(let c of l.students??[])i.set(c.id,`${c.firstName} ${c.lastName}`.trim());let d=e.sessions.map(l=>{let c=s.get(l.id)??[],h=c.length,_=a.get(l.id)??0,f=Math.max(0,l.capacity-h),E=c.map(S=>{let m=i.get(S);return m?`${m} (${S})`:S}).join(", ");return[l.id,l.name,l.startDate,l.endDate,l.location??"",l.isActive?"Yes":"No",String(l.basePrice),String(l.lunchPrice),String(l.extendedCarePrice),N(l.earlyBirdTiers??[]),String(l.capacity),String(h),String(_),String(f),E]});return[o,...d]}var mt={uid:"UID",displayId:"Display ID",email:"Email",displayName:"Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryEmail:"Primary Email",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",primaryEmployer:"Primary Employer",primaryStreet:"Primary Street",primaryCity:"Primary City",primaryState:"Primary State",primaryZipCode:"Primary Zip Code",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryEmail:"Secondary Email",secondaryPhone:"Secondary Phone",secondaryWechatId:"Secondary WeChat ID",secondaryWechatName:"Secondary WeChat Name",secondaryEmployer:"Secondary Employer",secondarySameAddress:"Secondary Same Address",secondaryStreet:"Secondary Street",secondaryCity:"Secondary City",secondaryState:"Secondary State",secondaryZipCode:"Secondary Zip Code",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship",couponIds:"Coupon IDs",referredStudentIds:"Referred Student IDs",createdAt:"Created At",updatedAt:"Updated At"};function pt(e){return{uid:e.uid,displayId:e.displayId,email:e.email,displayName:e.displayName,primaryFirstName:e.primaryGuardian?.firstName??"",primaryLastName:e.primaryGuardian?.lastName??"",primaryEmail:e.primaryGuardian?.email??"",primaryPhone:e.primaryGuardian?.phone??"",primaryWechatId:e.primaryGuardian?.wechatId??"",primaryWechatName:e.primaryGuardian?.wechatName??"",primaryEmployer:e.primaryGuardian?.employer??"",primaryStreet:e.primaryGuardian?.address?.street??"",primaryCity:e.primaryGuardian?.address?.city??"",primaryState:e.primaryGuardian?.address?.state??"",primaryZipCode:e.primaryGuardian?.address?.zipCode??"",secondaryFirstName:e.secondaryGuardian?.firstName??"",secondaryLastName:e.secondaryGuardian?.lastName??"",secondaryEmail:e.secondaryGuardian?.email??"",secondaryPhone:e.secondaryGuardian?.phone??"",secondaryWechatId:e.secondaryGuardian?.wechatId??"",secondaryWechatName:e.secondaryGuardian?.wechatName??"",secondaryEmployer:e.secondaryGuardian?.employer??"",secondarySameAddress:e.secondaryGuardian?.sameAddressAsPrimary?"Yes":"",secondaryStreet:e.secondaryGuardian?.address?.street??"",secondaryCity:e.secondaryGuardian?.address?.city??"",secondaryState:e.secondaryGuardian?.address?.state??"",secondaryZipCode:e.secondaryGuardian?.address?.zipCode??"",emergencyName:e.emergencyContact?.name??"",emergencyPhone:e.emergencyContact?.phone??"",emergencyRelationship:e.emergencyContact?.relationship??"",couponIds:(e.couponIds??[]).join(", "),referredStudentIds:(e.referredStudentIds??[]).join(", "),createdAt:e.timestamps.createdAt,updatedAt:e.timestamps.updatedAt}}function We(e){let n=[...e.values()].sort((o,s)=>o.displayId.localeCompare(s.displayId)),t=Object.values(mt),r=n.map(o=>Object.values(pt(o)));return[t,...r]}var ut={studentId:"Student ID",studentFirstName:"Student First Name",studentLastName:"Student Last Name",studentDob:"Student DOB",studentGender:"Student Gender",studentAllergies:"Student Allergies",studentDietaryNotes:"Student Dietary Notes",studentMedicalNotes:"Student Medical Notes",studentSchool:"Student School",studentLastCampYear:"Student Last Camp Year",studentGrade:"Student Grade",studentReferCode:"Student Refer Code",parentDisplayId:"Parent Display ID",parentEmail:"Parent Email",parentDisplayName:"Parent Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryPhone:"Secondary Phone",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship"};function gt(e,n){return{studentId:e.id,studentFirstName:e.firstName,studentLastName:e.lastName,studentDob:e.dob,studentGender:e.gender,studentAllergies:e.allergies,studentDietaryNotes:e.dietaryNotes??"",studentMedicalNotes:e.medicalNotes??"",studentSchool:e.school??"",studentLastCampYear:e.lastCampYear??"",studentGrade:e.grade??"",studentReferCode:e.referCode??"",parentDisplayId:n.displayId,parentEmail:n.email,parentDisplayName:n.displayName,primaryFirstName:n.primaryGuardian?.firstName??"",primaryLastName:n.primaryGuardian?.lastName??"",primaryPhone:n.primaryGuardian?.phone??"",primaryWechatId:n.primaryGuardian?.wechatId??"",primaryWechatName:n.primaryGuardian?.wechatName??"",secondaryFirstName:n.secondaryGuardian?.firstName??"",secondaryLastName:n.secondaryGuardian?.lastName??"",secondaryPhone:n.secondaryGuardian?.phone??"",emergencyName:n.emergencyContact?.name??"",emergencyPhone:n.emergencyContact?.phone??"",emergencyRelationship:n.emergencyContact?.relationship??""}}function ze(e){let n=[];for(let o of e.values())for(let s of o.students??[])n.push({student:s,user:o});n.sort((o,s)=>{let a=o.user.displayId.localeCompare(s.user.displayId);return a!==0?a:o.student.id.localeCompare(s.student.id)});let t=Object.values(ut),r=n.map(({student:o,user:s})=>Object.values(gt(o,s)));return[t,...r]}var ht={isSystemInitialized:"System Initialized",currentDate:"Current Date",currentTime:"Current Time",allowEnrollment:"Allow Enrollment",maintenanceMode:"Maintenance Mode",financials:"Financials (JSON)",paymentInstructions:"Payment Instructions",returnInstructions:"Return Instructions",releaseAgreementContent:"Release Agreement Content",mediaPolicyContent:"Media Policy Content",formsPageContent:"Forms Page Content",contactEmail:"Contact Email",contactPhone:"Contact Phone",contactAddress:"Contact Address",waitlistLastRecalculationAt:"Waitlist Last Recalculation",waitlistRaw:"Waitlist Config (JSON)"};function yt(e){return{isSystemInitialized:e.isSystemInitialized?"Yes":"No",currentDate:e.currentDate,currentTime:e.currentTime,allowEnrollment:e.systemSwitch.allowEnrollment?"Yes":"No",maintenanceMode:e.systemSwitch.maintenanceMode?"Yes":"No",financials:N(e.financials),paymentInstructions:e.paymentInstructions.content,returnInstructions:e.returnInstructions?.content??"",releaseAgreementContent:e.releaseAgreementContent?.content??"",mediaPolicyContent:e.mediaPolicyContent?.content??"",formsPageContent:e.formsPageContent?.content??"",contactEmail:e.contactInfo.email,contactPhone:e.contactInfo.phone,contactAddress:e.contactInfo.address??"",waitlistLastRecalculationAt:e.waitlist?.lastRecalculationAt??"",waitlistRaw:N(e.waitlist??null)}}function Ve(e){let n=Object.values(ht),t=Object.values(yt(e));return[n,t]}function He(e){let n=["Key","Value"],t=[["exportedAt",e.exportedAt],["year",String(e.year)],["seasonId",e.seasonId],["seasonName",e.seasonName],["counts",N(e.counts)]];return[n,...t]}function H(e,n,t){let r=["Collection Path","Document ID","Document Path","JSON"];return t?[[...r],[e,n,`${e}/${n}`,N(t)]]:[r]}function Ye(e){return H(`years/${e.year}/seasons`,e.id,e)}function qe(e,n,t){return H(`years/${e}/registrations`,n,t)}function Ze(e){return H("system","config",e)}function Ke(e){return H("admin","userCache",e)}function Qe(e){return H("admin/email/templates","all_templates",e)}function Xe(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=e.map(r=>{let o=`${r.seasonId}__${r.notificationType}__${r.templateId}`;return["admin/email/season_template_stats",o,`admin/email/season_template_stats/${o}`,N(r)]});return[n,...t]}function et(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=e.map(r=>["admin/email/batch_jobs",r.jobId,`admin/email/batch_jobs/${r.jobId}`,N(r)]);return[n,...t]}function tt(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=e.map(r=>["system/counters/entities",r.id,`system/counters/entities/${r.id}`,N(r.data)]);return[n,...t]}function nt(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=e.map(r=>["coupons",r.id,`coupons/${r.id}`,N(r)]);return[n,...t]}function rt(e){let n=["Collection Path","Document ID","Document Path","JSON"],t=[...e.values()].map(r=>["users",r.uid,`users/${r.uid}`,N(r)]);return[n,...t]}function ot(e,n,t){let r=["Collection Path","Document ID","Document Path","JSON"],o=t.map(s=>[`years/${e}/seasons/${n}/orders`,s.userAuthId,`years/${e}/seasons/${n}/orders/${s.userAuthId}`,N(s)]);return[r,...o]}var ft=(e,n)=>n.id,St=(e,n)=>n.label;function Ct(e,n){e&1&&(p(0,"div",3),ue(1,"div",4),p(2,"p"),g(3,"Loading seasons..."),u()())}function _t(e,n){if(e&1&&(p(0,"option",10),g(1),u()),e&2){let t=n.$implicit;D("value",t.id),y(),z(t.name)}}function xt(e,n){e&1&&g(0," Exporting... ")}function wt(e,n){e&1&&g(0," Download JSON File ")}function Et(e,n){e&1&&g(0," Export to Google Sheets ")}function bt(e,n){e&1&&g(0," \u25CB ")}function At(e,n){e&1&&g(0," \u25CC ")}function Rt(e,n){e&1&&g(0," \u2713 ")}function It(e,n){e&1&&g(0," \u2717 ")}function vt(e,n){if(e&1&&(p(0,"span",28),g(1),u()),e&2){let t=R().$implicit;y(),fe("(",t.detail,")")}}function Nt(e,n){if(e&1&&(p(0,"div",25)(1,"span",26),I(2,bt,1,0)(3,At,1,0)(4,Rt,1,0)(5,It,1,0),u(),p(6,"span",27),g(7),u(),I(8,vt,2,1,"span",28),u()),e&2){let t,r=n.$implicit;ye("step-pending",r.status==="pending")("step-in-progress",r.status==="in-progress")("step-completed",r.status==="completed")("step-error",r.status==="error"),y(2),v((t=r.status)==="pending"?2:t==="in-progress"?3:t==="completed"?4:t==="error"?5:-1),y(5),z(r.label),y(),v(r.detail?8:-1)}}function Pt(e,n){if(e&1&&(p(0,"div",17)(1,"h3"),g(2,"Export Progress"),u(),p(3,"div",23),re(4,Nt,9,11,"div",24,St),u()()),e&2){let t=R(2);y(4),oe(t.steps())}}function Dt(e,n){e&1&&g(0," Importing... ")}function Ot(e,n){e&1&&g(0," Select JSON File to Import ")}function Tt(e,n){if(e&1&&(p(0,"div",21)(1,"div",29),g(2,"\u2713"),u(),p(3,"h3"),g(4,"Export Complete"),u(),p(5,"a",30),g(6," Open Spreadsheet \u2192 "),u()()),e&2){let t=R(2);y(5),D("href",t.spreadsheetUrl(),me)}}function Mt(e,n){e&1&&(p(0,"div",21)(1,"div",29),g(2,"\u2713"),u(),p(3,"h3"),g(4,"JSON Export Complete"),u(),p(5,"p"),g(6,"The file has been downloaded to your device."),u()())}function Ut(e,n){if(e&1&&(p(0,"div",21)(1,"div",29),g(2,"\u2713"),u(),p(3,"h3"),g(4,"Import Complete"),u(),p(5,"p"),g(6),u()()),e&2){let t=R(2);y(6),z(t.importSummary())}}function Gt(e,n){if(e&1&&(p(0,"div",22)(1,"p",31),g(2),u()()),e&2){let t=R(2);y(2),z(t.error())}}function kt(e,n){if(e&1){let t=ge();p(0,"div",5)(1,"h3"),g(2,"Export Season Data"),u(),p(3,"div",6)(4,"label",7),g(5,"Select Season"),u(),p(6,"select",8),$("ngModelChange",function(o){G(t);let s=R();return k(s.onSeasonChange(o))}),p(7,"option",9),g(8,"-- Select a season --"),u(),re(9,_t,2,2,"option",10,ft),u()(),p(11,"div",11)(12,"label"),g(13,"Export Format"),u(),p(14,"div",12)(15,"label",13)(16,"input",14),$("change",function(){G(t);let o=R();return k(o.onFormatChange("google-sheets"))}),u(),p(17,"span"),g(18,"Google Sheets"),u()(),p(19,"label",13)(20,"input",15),$("change",function(){G(t);let o=R();return k(o.onFormatChange("json"))}),u(),p(21,"span"),g(22,"JSON File"),u()()()(),p(23,"button",16),$("click",function(){G(t);let o=R();return k(o.startExport())}),I(24,xt,1,0)(25,wt,1,0)(26,Et,1,0),u()(),I(27,Pt,6,0,"div",17),p(28,"div",5)(29,"h3"),g(30,"Import from JSON"),u(),p(31,"p",18),g(32," Import season data from a previously exported JSON file. "),u(),p(33,"input",19,0),$("change",function(o){G(t);let s=R();return k(s.onFileSelected(o))}),u(),p(35,"button",20),$("click",function(){G(t);let o=he(34);return k(o.click())}),I(36,Dt,1,0)(37,Ot,1,0),u()(),I(38,Tt,7,1,"div",21),I(39,Mt,7,0,"div",21),I(40,Ut,7,1,"div",21),I(41,Gt,3,1,"div",22)}if(e&2){let t=R();y(6),D("ngModel",t.selectedSeasonId()),y(3),oe(t.seasons()),y(7),D("checked",t.exportFormat()==="google-sheets"),y(4),D("checked",t.exportFormat()==="json"),y(3),D("disabled",!t.selectedSeasonId()||t.exporting()),y(),v(t.exporting()?24:t.exportFormat()==="json"?25:26),y(3),v(t.steps().length>0?27:-1),y(8),D("disabled",t.importing()),y(),v(t.importing()?36:37),y(2),v(t.spreadsheetUrl()?38:-1),y(),v(t.jsonExportComplete()?39:-1),y(),v(t.importComplete()?40:-1),y(),v(t.error()?41:-1)}}var st=class e{router=W(Ce);userService=W(ve);configService=W(Re);seasonService=W(Ie);_steps=A([]);_selectedSeasonId=A(null);_exporting=A(!1);_spreadsheetUrl=A(null);_error=A(null);_loadingSeasons=A(!1);_exportFormat=A("google-sheets");_jsonExportComplete=A(!1);_importing=A(!1);_importComplete=A(!1);_importSummary=A("");steps=this._steps.asReadonly();selectedSeasonId=this._selectedSeasonId.asReadonly();exporting=this._exporting.asReadonly();spreadsheetUrl=this._spreadsheetUrl.asReadonly();error=this._error.asReadonly();loadingSeasons=this._loadingSeasons.asReadonly();exportFormat=this._exportFormat.asReadonly();jsonExportComplete=this._jsonExportComplete.asReadonly();importing=this._importing.asReadonly();importComplete=this._importComplete.asReadonly();importSummary=this._importSummary.asReadonly();seasons=this.seasonService.seasons;async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}this._loadingSeasons.set(!0);try{await this.seasonService.loadAllSeasons()}catch(n){this._error.set(n instanceof Error?n.message:"Failed to load seasons")}finally{this._loadingSeasons.set(!1)}}onSeasonChange(n){this._selectedSeasonId.set(n||null),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([]),this._jsonExportComplete.set(!1)}onFormatChange(n){this._exportFormat.set(n),this._spreadsheetUrl.set(null),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([])}async startExport(){return this._exportFormat()==="json"?this.startJsonExport():this.startGoogleSheetsExport()}async startJsonExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([{label:"Loading data from Firestore",status:"pending"},{label:"Generating JSON file",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=Z(q()),o=await new V(t).loadAllData(n,c=>{this.updateStep(0,"in-progress",c.detail??c.step)});this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let s={exportedAt:new Date().toISOString(),year:2026,seasonId:n,season:o.season,orders:o.orders,users:Object.fromEntries(o.users),registration:o.registration,coupons:o.coupons,systemConfig:o.systemConfig,adminUserCache:o.adminUserCache,counters:o.counters,adminEmailTemplates:o.adminEmailTemplates,adminEmailSeasonTemplateStats:o.adminEmailSeasonTemplateStats,adminEmailBatchJobs:o.adminEmailBatchJobs},a=JSON.stringify(s,null,2),i=new Blob([a],{type:"application/json"}),d=URL.createObjectURL(i),l=document.createElement("a");l.href=d,l.download=`${o.season.name.replace(/[^a-zA-Z0-9]/g,"-")}-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(d),this.updateStep(1,"completed"),this._jsonExportComplete.set(!0)}catch(t){let r=this.formatExportError(t),o=this._steps().findIndex(s=>s.status==="in-progress");o>=0&&this.updateStep(o,"error",r),this._error.set(r),console.error("[AdminExport] JSON export failed",t)}finally{this._exporting.set(!1)}}}async startGoogleSheetsExport(){let n=this._selectedSeasonId();if(n){this._exporting.set(!0),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([{label:"Authenticating with Google",status:"pending"},{label:"Loading data from Firestore",status:"pending"},{label:"Building spreadsheet data",status:"pending"},{label:"Creating Google Spreadsheet",status:"pending"},{label:"Writing sheet data",status:"pending"}]);try{this.updateStep(0,"in-progress");let t=new ee,r=await t.acquireAccessToken();this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let o=Z(q()),a=await new V(o).loadAllData(n,h=>{this.updateStep(1,"in-progress",h.detail??h.step)});this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let i=ne(te({Meta:He({exportedAt:new Date().toISOString(),year:2026,seasonId:a.season.id,seasonName:a.season.name,counts:{orders:a.orders.length,users:a.users.size,coupons:a.coupons.length,counters:a.counters.length,hasRegistration:a.registration?1:0,hasSystemConfig:a.systemConfig?1:0,hasAdminUserCache:a.adminUserCache?1:0,hasAdminEmailTemplates:a.adminEmailTemplates?1:0,adminEmailSeasonTemplateStats:a.adminEmailSeasonTemplateStats.length,adminEmailBatchJobs:a.adminEmailBatchJobs.length}}),Orders:Fe(a.orders,a.users,a.season),Payments:Le(a.orders,a.users),Coupons:je(a.coupons,a.orders),Waitlist:Je(a.orders,a.users,a.season),Sessions:Be(a.season,a.orders,a.registration,a.users),Users:We(a.users),Students:ze(a.users)},a.systemConfig?{SystemConfig:Ve(a.systemConfig)}:{}),{SeasonRaw:Ye(a.seasonRaw),RegistrationRaw:qe(2026,n,a.registration),SystemConfigRaw:Ze(a.systemConfig),AdminUserCacheRaw:Ke(a.adminUserCache),AdminEmailTemplatesRaw:Qe(a.adminEmailTemplates),AdminEmailSeasonTemplateStatsRaw:Xe(a.adminEmailSeasonTemplateStats),AdminEmailBatchJobsRaw:et(a.adminEmailBatchJobs),CountersRaw:tt(a.counters),CouponsRaw:nt(a.coupons),UsersRaw:rt(a.users),OrdersRaw:ot(2026,n,a.orders)});this.updateStep(2,"completed"),this.updateStep(3,"in-progress");let d=`${a.season.name} \u2014 Export ${Ne(new Date().toISOString())}`,l=Object.keys(i),c=await t.createSpreadsheet(d,l,r);this.updateStep(3,"completed"),this.updateStep(4,"in-progress");for(let[h,_]of Object.entries(i))this.updateStep(4,"in-progress",`Writing ${h}...`),await t.writeSheetData(c.spreadsheetId,h,_,r);this.updateStep(4,"completed"),this._spreadsheetUrl.set(c.spreadsheetUrl)}catch(t){let r=this.formatExportError(t),o=this._steps().findIndex(s=>s.status==="in-progress");o>=0&&this.updateStep(o,"error",r),this._error.set(r),console.error("[AdminExport] Google Sheets export failed",t)}finally{this._exporting.set(!1)}}}updateStep(n,t,r){this._steps.update(o=>o.map((s,a)=>a===n?ne(te({},s),{status:t,detail:r}):s))}formatExportError(n){if(n instanceof Error){let t=n.code;return typeof t=="string"&&t.length>0?`${t}: ${n.message}`:n.message}return"Export failed"}async onFileSelected(n){let t=n.target,r=t.files?.[0];if(r){this._importing.set(!0),this._importComplete.set(!1),this._error.set(null),this._steps.set([{label:"Reading JSON file",status:"pending"},{label:"Validating data structure",status:"pending"},{label:"Importing to Firestore",status:"pending"}]);try{this.updateStep(0,"in-progress");let o=await r.text(),s=JSON.parse(o);if(this.updateStep(0,"completed"),this.updateStep(1,"in-progress"),!s.season||!s.orders)throw new Error("Invalid export file: missing season or orders data");this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let a=Z(q()),i=s.year??this.configService.activeYear(),{doc:d,setDoc:l,writeBatch:c}=await import("./chunk-GSMCNYGL.js"),h=d(a,`years/${i}/seasons`,s.season.id);await l(h,s.season),this.updateStep(2,"in-progress","Season imported");let _=s.orders,f=500,E=0;for(let S=0;S<_.length;S+=f){let m=c(a),w=_.slice(S,S+f);for(let b of w){let x=d(a,`years/${i}/seasons/${s.season.id}/orders`,b.userAuthId);m.set(x,b)}await m.commit(),E+=w.length,this.updateStep(2,"in-progress",`Imported ${E}/${_.length} orders`)}if(s.users&&typeof s.users=="object"){let S=Object.entries(s.users);for(let m=0;m<S.length;m+=f){let w=c(a),b=S.slice(m,m+f);for(let[x,J]of b){let U=d(a,"users",x);w.set(U,J,{merge:!0})}await w.commit()}this.updateStep(2,"in-progress",`Imported ${S.length} users`)}if(s.registration){let S=d(a,`years/${i}/registrations`,s.season.id);await l(S,s.registration)}this.updateStep(2,"completed"),this._importComplete.set(!0),this._importSummary.set(`Imported season "${s.season.name}" with ${_.length} orders.`)}catch(o){let s=this._steps().findIndex(a=>a.status==="in-progress");s>=0&&this.updateStep(s,"error"),this._error.set(o instanceof Error?o.message:"Import failed")}finally{this._importing.set(!1),t.value=""}}}static \u0275fac=function(t){return new(t||e)};static \u0275cmp=pe({type:e,selectors:[["app-admin-export"]],decls:4,vars:1,consts:[["fileInput",""],["pageTitle","Data Export","pageSubtitle","Export season data to spreadsheets"],[1,"admin-export"],[1,"loading-container"],[1,"spinner"],[1,"export-card"],[1,"form-group"],["for","season-select"],["id","season-select",1,"season-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"format-group"],[1,"format-options"],[1,"format-option"],["type","radio","name","format","value","google-sheets",3,"change","checked"],["type","radio","name","format","value","json",3,"change","checked"],[1,"btn-export",3,"click","disabled"],[1,"steps-card"],[1,"import-description"],["type","file","accept",".json",2,"display","none",3,"change"],[1,"btn-import",3,"click","disabled"],[1,"success-card"],[1,"error-card"],[1,"steps-list"],[1,"step",3,"step-pending","step-in-progress","step-completed","step-error"],[1,"step"],[1,"step-icon"],[1,"step-label"],[1,"step-detail"],[1,"success-icon"],["target","_blank","rel","noopener",1,"spreadsheet-link",3,"href"],[1,"error-message"]],template:function(t,r){t&1&&(p(0,"app-admin-layout",1)(1,"div",2),I(2,Ct,4,0,"div",3)(3,kt,42,12),u()()),t&2&&(y(2),v(r.loadingSeasons()?2:3))},dependencies:[Se,Ue,Te,Me,Oe,Pe,De,Ge],styles:[".admin-export[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:1.5rem}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem 2rem}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.export-card[_ngcontent-%COMP%], .steps-card[_ngcontent-%COMP%], .success-card[_ngcontent-%COMP%], .error-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.export-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.season-select[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;font-size:1rem;background:#fff}.format-group[_ngcontent-%COMP%]{margin-bottom:1rem}.format-group[_ngcontent-%COMP%] > label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.format-options[_ngcontent-%COMP%]{display:flex;gap:1.5rem}.format-option[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;font-weight:400}.format-option[_ngcontent-%COMP%]   input[type=radio][_ngcontent-%COMP%]{cursor:pointer}.import-description[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.btn-import[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-tertiary, #1976d2);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-import[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-tertiary-dark, #1565c0)}.btn-import[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.btn-export[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-export[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-export[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.steps-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.steps-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.step[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.5rem 0}.step-icon[_ngcontent-%COMP%]{font-size:1rem;width:1.25rem;text-align:center}.step-pending[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #999)}.step-in-progress[_ngcontent-%COMP%]{color:var(--sys-tertiary, #1976d2);font-weight:500}.step-completed[_ngcontent-%COMP%]{color:var(--sys-secondary, #2e7d32)}.step-error[_ngcontent-%COMP%]{color:var(--sys-error, #c62828)}.step-detail[_ngcontent-%COMP%]{font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.success-card[_ngcontent-%COMP%]{text-align:center;border-color:var(--sys-secondary, #2e7d32)}.success-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--sys-secondary, #2e7d32);margin-bottom:.5rem}.success-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-secondary, #2e7d32)}.spreadsheet-link[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1.5rem;background:var(--sys-secondary, #2e7d32);color:#fff;border-radius:8px;text-decoration:none;font-weight:500}.spreadsheet-link[_ngcontent-%COMP%]:hover{opacity:.9}.error-card[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}.error-message[_ngcontent-%COMP%]{margin:0;color:var(--sys-error, #c62828);font-weight:500}"]})};export{st as AdminExportComponent};
