import{a as q}from"./chunk-DQHXMC6B.js";import{da as U,fa as L,h as z,ka as $,ma as j,n as F}from"./chunk-Z6M3NQZL.js";import"./chunk-UYHN5VVP.js";import{$a as _,Ab as S,Bb as k,Db as r,Ea as o,Eb as v,Fb as A,Gb as N,N as y,Qa as E,Tb as I,ab as x,da as h,db as P,eb as w,fb as T,gb as i,hb as a,ib as M,sb as b}from"./chunk-5O64VQN5.js";import"./chunk-Q7L6LLAK.js";var H=(n,t)=>t.key,Q=(n,t)=>t.sessionId,G=(n,t)=>t.label;function Z(n,t){n&1&&(i(0,"div",1),r(1,"Loading analysis data..."),a())}function Y(n,t){if(n&1&&(i(0,"div",2),r(1),a()),n&2){let e=b();o(),v(e.error())}}function J(n,t){n&1&&(i(0,"div",5),r(1,"No registration items found."),a())}function K(n,t){if(n&1&&(i(0,"div",7)(1,"div",12),r(2),a(),i(3,"div",13)(4,"div",14),M(5,"div",15),a(),i(6,"div",16),r(7),a()()()),n&2){let e=t.$implicit;o(),T("title",e.className),o(),v(e.className),o(3),S("width",e.barPercent,"%"),o(2),N("",e.enrolledCount," (",e.percentage.toFixed(1),"%)")}}function V(n,t){if(n&1&&(i(0,"div",6),P(1,K,8,6,"div",7,Q),a()),n&2){let e=b(2);o(),w(e.rows())}}function W(n,t){if(n&1&&(i(0,"div",7)(1,"div",17),r(2),a(),i(3,"div",13)(4,"div",14),M(5,"div",18),a(),i(6,"div",16),r(7),a()()()),n&2){let e=t.$implicit;o(2),v(e.label),o(3),S("width",e.barPercent,"%"),k("zelle",e.key==="zelle")("cash",e.key==="cash_deposit"),o(2),v(e.count)}}function X(n,t){n&1&&(i(0,"div",5),r(1,"No age data."),a())}function ee(n,t){if(n&1&&(i(0,"div",7)(1,"div",17),r(2),a(),i(3,"div",13)(4,"div",14),M(5,"div",19),a(),i(6,"div",16),r(7),a()()()),n&2){let e=t.$implicit;o(2),v(e.label),o(3),S("width",e.barPercent,"%"),o(2),v(e.count)}}function te(n,t){if(n&1&&P(0,ee,8,4,"div",7,G),n&2){let e=b(2);w(e.ageRows())}}function ne(n,t){n&1&&(i(0,"div",5),r(1,"No gender data."),a())}function ae(n,t){if(n&1&&(i(0,"div",7)(1,"div",17),r(2),a(),i(3,"div",13)(4,"div",14),M(5,"div",19),a(),i(6,"div",16),r(7),a()()()),n&2){let e=t.$implicit;o(2),v(e.label),o(3),S("width",e.barPercent,"%"),o(2),v(e.count)}}function ie(n,t){if(n&1&&P(0,ae,8,4,"div",7,G),n&2){let e=b(2);w(e.genderRows())}}function oe(n,t){if(n&1&&(i(0,"section",3)(1,"div",4)(2,"h2"),r(3,"Enrollment Count by Class"),a(),i(4,"p"),r(5),a()(),_(6,J,2,0,"div",5)(7,V,3,0,"div",6),a(),i(8,"section",3)(9,"div",4)(10,"h2"),r(11,"Payment Type Summary"),a(),i(12,"p"),r(13),a(),i(14,"p"),r(15),a()(),i(16,"div",6),P(17,W,8,8,"div",7,H),a()(),i(19,"section",3)(20,"div",4)(21,"h2"),r(22,"Registered Children Demographics"),a(),i(23,"p"),r(24),a()(),i(25,"div",8)(26,"div",9)(27,"div",10)(28,"h3"),r(29,"By Age"),a(),i(30,"span",11),r(31,"Quantity"),a()(),i(32,"div",6),_(33,X,2,0,"div",5)(34,te,2,0),a()(),i(35,"div",9)(36,"div",10)(37,"h3"),r(38,"By Gender"),a(),i(39,"span",11),r(40,"Quantity"),a()(),i(41,"div",6),_(42,ne,2,0,"div",5)(43,ie,2,0),a()()()()),n&2){let e=b();o(5),A("Total enrolled students: ",e.totalLocked()),o(),x(e.rows().length===0?6:7),o(7),A("Zelle full payment total amount: ",e.formatCurrency(e.zelleFullPaymentTotalCents())),o(2),A("Cash payment total amount: ",e.formatCurrency(e.cashPaymentTotalCents())),o(2),w(e.paymentRows()),o(7),A("Total registered children: ",e.registeredChildrenCount()),o(9),x(e.ageRows().length===0?33:34),o(9),x(e.genderRows().length===0?42:43)}}var B=class n{userService=y(j);router=y(F);seasonService=y($);orderDatastore=y(L);userDatastore=y(U);loading=h(!0);error=h(null);rows=h([]);paymentRows=h([]);zelleFullPaymentTotalCents=h(0);cashPaymentTotalCents=h(0);ageRows=h([]);genderRows=h([]);registeredChildrenCount=h(0);totalLocked=I(()=>this.rows().reduce((t,e)=>t+e.enrolledCount,0));async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}try{await this.loadReport()}catch(t){let e=t instanceof Error?t.message:String(t);this.error.set(`Failed to load report: ${e}`)}finally{this.loading.set(!1)}}async loadReport(){await this.seasonService.loadAllSeasons();let t=this.seasonService.seasons(),[e,l]=await Promise.all([this.orderDatastore.listAllSeasonOrders(),this.userDatastore.listAllUsers()]),c=this.buildClassNameMap(t),s=this.computeLockedCounts(e),g=Math.max(0,...s.values()),u=Array.from(s.values()).reduce((d,m)=>d+m,0),C=Array.from(s.entries()).filter(([,d])=>d>0).sort((d,m)=>m[1]-d[1]).map(([d,m])=>({sessionId:d,className:c.get(d)??d,enrolledCount:m,percentage:u>0?m/u*100:0,barPercent:g>0?m/g*100:0}));this.rows.set(C),this.computePaymentStats(e),this.computeDemographics(e,l)}buildClassNameMap(t){let e=new Map;for(let l of t)for(let c of l.sessions??[])e.set(c.id,c.name);return e}computeLockedCounts(t){let e=new Set(["locked","submitted","secured","paid"]),l=new Map;for(let c of t)for(let s of c.items)s.cancelledAt||e.has(s.status)&&l.set(s.sessionId,(l.get(s.sessionId)??0)+1);return l}computePaymentStats(t){let e=new Set,l=new Set,c=0,s=0;for(let d of t)for(let m of d.payments??[]){if(m.method==="zelle"){e.add(d.userAuthId),c+=m.amount;continue}m.method==="cash"&&(l.add(d.userAuthId),s+=m.amount)}let g=e.size,u=l.size,C=Math.max(g,u,1);this.paymentRows.set([{key:"zelle",label:"Zelle Full Payment",count:g,barPercent:g/C*100},{key:"cash_deposit",label:"Cash",count:u,barPercent:u/C*100}]),this.zelleFullPaymentTotalCents.set(c),this.cashPaymentTotalCents.set(s)}formatCurrency(t){return(t/100).toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2})}computeDemographics(t,e){let l=new Set;for(let f of t)for(let p of f.items)p.cancelledAt||l.add(p.studentId);let c=new Map,s=new Map,g=new Date;for(let f of e)for(let p of f.students){if(!l.has(p.id))continue;let O=this.computeAge(p.dob,g);O!==null&&c.set(O,(c.get(O)??0)+1);let R=p.gender==="M"?"Male":"Female";s.set(R,(s.get(R)??0)+1)}let u=Array.from(l).length;this.registeredChildrenCount.set(u);let C=Math.max(1,...c.values()),d=Array.from(c.entries()).sort((f,p)=>f[0]-p[0]).map(([f,p])=>({label:`${f} yrs`,count:p,barPercent:p/C*100})),m=Math.max(1,...s.values()),D=Array.from(s.entries()).sort((f,p)=>p[1]-f[1]).map(([f,p])=>({label:f,count:p,barPercent:p/m*100}));this.ageRows.set(d),this.genderRows.set(D)}computeAge(t,e){let[l,c,s]=t.split("-");if(!l||!c||!s)return null;let g=Number(l),u=Number(c),C=Number(s);if(!Number.isFinite(g)||!Number.isFinite(u)||!Number.isFinite(C))return null;let d=e.getFullYear()-g,m=e.getMonth()+1-u,D=e.getDate()-C;return(m<0||m===0&&D<0)&&(d-=1),d>=0?d:null}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-admin-data-analysis-report"]],decls:4,vars:1,consts:[["pageTitle","Data Analysis Report","pageSubtitle","Enrollment headcount by class"],[1,"state-card"],[1,"state-card","error"],[1,"report-card"],[1,"chart-head"],[1,"empty-note"],[1,"chart-grid"],[1,"chart-row"],[1,"demographic-grid"],[1,"demographic-panel"],[1,"demographic-head"],[1,"quantity-head"],[1,"label",3,"title"],[1,"bar-area"],[1,"bar-track"],[1,"bar-fill"],[1,"bar-value"],[1,"label"],[1,"bar-fill","payment"],[1,"bar-fill","demographic"]],template:function(e,l){e&1&&(i(0,"app-admin-layout",0),_(1,Z,2,0,"div",1)(2,Y,2,1,"div",2)(3,oe,44,7),a()),e&2&&(o(),x(l.loading()?1:l.error()?2:3))},dependencies:[z,q],styles:['.state-card[_ngcontent-%COMP%]{background:#fff;border:1px solid #e8e8e8;border-radius:12px;padding:1rem 1.25rem;color:#444}.state-card.error[_ngcontent-%COMP%]{color:#b42318;border-color:#f3b3ad;background:#fff5f4}.report-card[_ngcontent-%COMP%]{background:#fff;border:1px solid #ececec;border-radius:16px;padding:1.25rem;margin-bottom:1rem}.chart-head[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.125rem;font-weight:700;color:#212121}.chart-head[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:.4rem 0 1rem;color:#666;font-size:.9rem}.chart-grid[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.85rem}.empty-note[_ngcontent-%COMP%]{font-size:.92rem;color:#666}.chart-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:minmax(170px,280px) 1fr;gap:.85rem;align-items:center}.label[_ngcontent-%COMP%]{font-size:.92rem;color:#2c2c2c;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.bar-area[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.6rem}.bar-track[_ngcontent-%COMP%]{flex:1;height:28px;border-radius:6px;background:repeating-linear-gradient(to right,#f4f4f4 0 9.5%,#ececec 9.5% 10%);border:1px solid #ebebeb;overflow:hidden}.bar-fill[_ngcontent-%COMP%]{height:100%;background:#36c}.bar-fill.payment.zelle[_ngcontent-%COMP%]{background:#82e0aa}.bar-fill.payment.cash[_ngcontent-%COMP%]{background:#fac5d2}.bar-fill.demographic[_ngcontent-%COMP%]{background:#7da6f7}.bar-value[_ngcontent-%COMP%]{min-width:96px;font-size:.95rem;color:#2b2b2b;text-align:left}@media(max-width:900px){.chart-row[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:.45rem}.bar-value[_ngcontent-%COMP%]{min-width:0}}.demographic-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.demographic-panel[_ngcontent-%COMP%]{border:1px solid #ececec;border-radius:12px;padding:.9rem}.demographic-panel[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1rem;color:#2a2a2a}.demographic-head[_ngcontent-%COMP%]{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:.75rem}.quantity-head[_ngcontent-%COMP%]{width:140px;font-size:.84rem;font-weight:600;color:#666;text-align:left}.demographic-panel[_ngcontent-%COMP%]   .chart-row[_ngcontent-%COMP%]{grid-template-columns:1fr 140px}.demographic-panel[_ngcontent-%COMP%]   .bar-area[_ngcontent-%COMP%]{display:grid;grid-template-columns:14px 1fr;gap:.5rem;align-items:center}.demographic-panel[_ngcontent-%COMP%]   .bar-track[_ngcontent-%COMP%]{width:14px;height:36px;border:none;border-radius:0;background:transparent;position:relative}.demographic-panel[_ngcontent-%COMP%]   .bar-track[_ngcontent-%COMP%]:after{content:"";position:absolute;right:0;top:2px;bottom:2px;width:4px;border-radius:999px;background:#e2e2e2}.demographic-panel[_ngcontent-%COMP%]   .bar-fill.demographic[_ngcontent-%COMP%]{display:none}.demographic-panel[_ngcontent-%COMP%]   .bar-value[_ngcontent-%COMP%]{min-width:0}@media(max-width:900px){.demographic-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}']})};export{B as AdminDataAnalysisReportComponent};
