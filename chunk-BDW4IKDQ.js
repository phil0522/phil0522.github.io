import{ha as l}from"./chunk-PB7AT65J.js";import{I as d,N as u,Tb as a,da as n}from"./chunk-5O64VQN5.js";var p=class i{functions=u(l);_seasonCoupons=n([]);_userCoupons=n([]);_selectedUserCouponIds=n([]);_loading=n(!1);_validating=n(!1);_error=n(null);seasonCoupons=this._seasonCoupons.asReadonly();userCoupons=this._userCoupons.asReadonly();selectedUserCouponIds=this._selectedUserCouponIds.asReadonly();loading=this._loading.asReadonly();validating=this._validating.asReadonly();error=this._error.asReadonly();couponsToApply=a(()=>[...this._seasonCoupons(),...this._userCoupons().filter(o=>this._selectedUserCouponIds().includes(o.id))]);totalCouponCredit=a(()=>this.couponsToApply().reduce((o,e)=>o+e.maxCreditCents,0));hasAvailableCoupons=a(()=>this._seasonCoupons().length>0||this._userCoupons().length>0);async loadCoupons(o){this._loading.set(!0),this._error.set(null);try{let e=await this.functions.callApi("getUserAvailableCoupons",{seasonId:o});this._seasonCoupons.set(e.seasonCoupons),this._userCoupons.set(e.userCoupons),this._selectedUserCouponIds.set(e.userCoupons.map(t=>t.id))}catch(e){console.error("Failed to load coupons:",e),this._error.set("Failed to load coupons"),this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([])}finally{this._loading.set(!1)}}toggleCoupon(o){let e=this._selectedUserCouponIds();e.includes(o)?this._selectedUserCouponIds.set(e.filter(t=>t!==o)):this._selectedUserCouponIds.set([...e,o])}isCouponSelected(o){return this._selectedUserCouponIds().includes(o)}clearCoupons(){this._seasonCoupons.set([]),this._userCoupons.set([]),this._selectedUserCouponIds.set([]),this._error.set(null)}getSelectedCouponIds(){return this._selectedUserCouponIds()}async validateAndAddCoupon(o){this._validating.set(!0);try{let e=o.trim().toUpperCase();if(!/^[A-Z0-9]+$/.test(e))return{success:!1,error:"Coupon code must contain only letters and numbers."};let s=(await this.functions.callApi("validateAndAddCoupon",{couponId:e})).coupon;return this._userCoupons().map(r=>r.id).includes(s.id)||(this._userCoupons.update(r=>[...r,s]),this._selectedUserCouponIds.update(r=>[...r,s.id])),{success:!0,coupon:s}}catch(e){let s=e.message||"Failed to validate coupon";return{success:!1,error:s.includes("Invalid data for action 'validateAndAddCoupon'")?"Coupon code must contain only letters and numbers.":s}}finally{this._validating.set(!1)}}static \u0275fac=function(e){return new(e||i)};static \u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"})};export{p as a};
