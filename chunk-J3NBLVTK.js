import{a as Oe,b as Me}from"./chunk-2DRPB4NJ.js";import{a as Pe}from"./chunk-KZ27A6Z5.js";import{a as Se}from"./chunk-BDW4IKDQ.js";import"./chunk-PX3IE7QR.js";import{b as Ee}from"./chunk-RYIKU5Y3.js";import{h as A,ia as _e,ja as ve,ka as he,la as ye,ma as Ce,n as le,na as be,o as ce,oa as xe,u as pe,v as ue,w as ge,x as fe}from"./chunk-PB7AT65J.js";import{F as me}from"./chunk-UYHN5VVP.js";import{$a as u,Ab as ae,Bb as w,Cb as se,Db as i,Ea as a,Eb as E,Fb as z,Gb as de,I as re,N as I,Qa as V,S as h,T as y,Tb as _,U as N,V as B,Wb as x,_ as ee,ab as g,bb as H,da as C,db as G,ea as te,eb as Q,fb as F,gb as m,hb as l,ib as j,jb as d,kb as s,lb as M,ob as k,pb as ne,qb as D,rb as L,sb as p}from"./chunk-5O64VQN5.js";import"./chunk-Q7L6LLAK.js";var Le=5*1024*1024,Ne=["image/jpeg","image/png"],W=class o{storage=fe(me());uploadProgress=C(0);uploading=C(!1);currentUploadTask=null;validateFile(e){return e.size>Le?{type:"file_too_large",message:`File size (${(e.size/(1024*1024)).toFixed(1)} MB) exceeds the 5 MB limit.`}:Ne.includes(e.type)?null:{type:"invalid_type",message:"Only JPEG and PNG images are accepted."}}async uploadScreenshot(e,t){let n=this.validateFile(e);if(n)throw new Error(n.message);let r=e.type==="image/png"?"png":"jpg",c=`SS-${Date.now()}`,b=`orders/${t}/${c}.${r}`,v=ge(this.storage,b);this.uploading.set(!0),this.uploadProgress.set(0);try{let S=pe(v,e,{contentType:e.type});this.currentUploadTask=S,await new Promise(($,U)=>{S.on("state_changed",T=>{let R=Math.round(T.bytesTransferred/T.totalBytes*100);this.uploadProgress.set(R)},T=>U(T),()=>$())});let O=await ue(v);return{storagePath:b,downloadUrl:O}}finally{this.uploading.set(!1),this.currentUploadTask=null}}cancelUpload(){this.currentUploadTask&&(this.currentUploadTask.cancel(),this.currentUploadTask=null,this.uploading.set(!1),this.uploadProgress.set(0))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=re({token:o,factory:o.\u0275fac,providedIn:"root"})};function ze(o,e){o&1&&i(0," Cash Payment Instruction ")}function Ve(o,e){o&1&&i(0," Full Zelle Payment Instructions ")}function Ae(o,e){o&1&&i(0," Registration Fee Due Now via Zelle: ")}function Fe(o,e){o&1&&i(0," Amount Due via Zelle: ")}function Ue(o,e){if(o&1){let t=k();d(0,"div",9)(1,"div",20)(2,"div",21),i(3,"1"),s(),d(4,"div",22)(5,"div",23),i(6,"Send payment via Zelle"),s(),d(7,"p",24),i(8,"Zelle Account: "),d(9,"span",25),i(10,"cambrianexplorer@gmail.com"),s()(),d(11,"p"),i(12,"OR scan the QR code below."),s()()(),d(13,"div",20)(14,"div",21),i(15,"2"),s(),d(16,"div",22)(17,"div",23),i(18,"Add payment note"),s(),d(19,"p"),i(20,"Kindly include your child\u2019s full name in the payment note for efficient processing."),s()()(),d(21,"div",20)(22,"div",21),i(23,"3"),s(),d(24,"div",22)(25,"div",23),i(26,"Upload payment screenshot"),s()()(),d(27,"div",26)(28,"strong"),i(29,"Important:"),s(),i(30," Please complete the payment and upload the payment screenshot within 2 hours to secure your reserved spot. Otherwise, the reservation will be released. "),s(),d(31,"div",27)(32,"p",28),i(33,"ZELLE QR CODE"),s(),d(34,"img",29),L("click",function(){h(t);let r=p();return y(r.showQrOverlay.set(!0))}),s()()()}}function Re(o,e){if(o&1){let t=k();d(0,"div",9)(1,"div",20)(2,"div",21),i(3,"1"),s(),d(4,"div",22)(5,"div",23),i(6,"Send payment via Zelle"),s(),d(7,"p"),i(8,"Please send the registration fee amount shown above to secure your reserved spot."),s(),d(9,"p",24),i(10,"Zelle Account: "),d(11,"span",25),i(12,"cambrianexplorer@gmail.com"),s()(),d(13,"p"),i(14,"Or scan the QR code below."),s()()(),d(15,"div",20)(16,"div",21),i(17,"2"),s(),d(18,"div",22)(19,"div",23),i(20,"Add payment note"),s(),d(21,"p"),i(22,"Kindly include your child\u2019s full name in the payment note for efficient processing."),s()()(),d(23,"div",20)(24,"div",21),i(25,"3"),s(),d(26,"div",22)(27,"div",23),i(28,"Arrange remaining balance"),s(),d(29,"p"),i(30,"Cash payments must be made in person. Checks are not accepted. Please scan the QR code to contact \u84DD\u8393\u8001\u5E08 to arrange any remaining balance."),s()()(),d(31,"div",26)(32,"strong"),i(33,"Important:"),s(),i(34," Please complete the payment and upload the payment screenshot within 2 hours to secure your reserved spot. Otherwise, the reservation will be released. "),s(),d(35,"div",30)(36,"div",31)(37,"p",28),i(38,"ZELLE QR CODE"),s(),d(39,"img",29),L("click",function(){h(t);let r=p();return y(r.showQrOverlay.set(!0))}),s()(),d(40,"div",31)(41,"p",28),i(42,"WECHAT QR CODE"),s(),d(43,"img",32),L("click",function(){h(t);let r=p();return y(r.showWechatOverlay.set(!0))}),s()()()()}}function je(o,e){o&1&&(d(0,"span",14)(1,"span",33),i(2,"attach_file"),s(),i(3," Choose JPEG or PNG image (max 5 MB) "),s())}function $e(o,e){if(o&1&&(d(0,"span",15)(1,"span",33),i(2,"check_circle"),s(),i(3),s()),o&2){let t=p();a(3),de(" ",t.selectedFile().name," (",t.formatFileSize(t.selectedFile().size),") ")}}function qe(o,e){if(o&1&&(d(0,"div",16),i(1),s()),o&2){let t=p();a(),z(" ",t.validationError()," ")}}function Be(o,e){if(o&1&&(d(0,"div",17)(1,"div",34),M(2,"div",35),s(),d(3,"span",36),i(4),s()()),o&2){let t=p();a(2),ae("width",t.uploadProgress(),"%"),a(2),z("",t.uploadProgress(),"%")}}function He(o,e){o&1&&i(0," Uploading... ")}function Ge(o,e){o&1&&i(0," Upload & Submit ")}function Qe(o,e){if(o&1){let t=k();d(0,"div",37),L("click",function(){h(t);let r=p();return y(r.showQrOverlay.set(!1))}),M(1,"img",38),s()}}function We(o,e){if(o&1){let t=k();d(0,"div",37),L("click",function(){h(t);let r=p();return y(r.showWechatOverlay.set(!1))}),M(1,"img",39),s()}}var Y=class o{paymentOption=x.required();totalAmount=x.required();depositAmount=x.required();immediatelyDue=x.required();uploading=x(!1);uploadProgress=x(0);close=new ee;uploadFile=new ee;selectedFile=C(null);validationError=C(null);showQrOverlay=C(!1);showWechatOverlay=C(!1);amountDue=_(()=>this.paymentOption()==="zelle"?this.immediatelyDue():this.depositAmount());canSubmit=_(()=>this.selectedFile()!==null&&!this.uploading()&&!this.validationError());formatPrice(e){return(e/100).toLocaleString("en-US",{minimumFractionDigits:0})}formatFileSize(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}onBackdropClick(e){e.target.classList.contains("overlay-backdrop")&&this.close.emit()}onFileSelected(e){let n=e.target.files?.[0]??null;if(this.validationError.set(null),!n){this.selectedFile.set(null);return}let r=5*1024*1024;if(n.size>r){this.validationError.set(`File size (${(n.size/(1024*1024)).toFixed(1)} MB) exceeds the 5 MB limit.`),this.selectedFile.set(null);return}if(!["image/jpeg","image/png"].includes(n.type)){this.validationError.set("Only JPEG and PNG images are accepted."),this.selectedFile.set(null);return}this.selectedFile.set(n)}onSubmit(){let e=this.selectedFile();e&&!this.uploading()&&this.uploadFile.emit(e)}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=V({type:o,selectors:[["app-payment-instruction-overlay"]],inputs:{paymentOption:[1,"paymentOption"],totalAmount:[1,"totalAmount"],depositAmount:[1,"depositAmount"],immediatelyDue:[1,"immediatelyDue"],uploading:[1,"uploading"],uploadProgress:[1,"uploadProgress"]},outputs:{close:"close",uploadFile:"uploadFile"},decls:32,vars:16,consts:[[1,"overlay-backdrop",3,"click"],[1,"overlay-content"],[1,"overlay-header"],["aria-label","Close",1,"btn-close",3,"click"],["width","24","height","24","viewBox","0 0 24 24","fill","currentColor"],["d","M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"],[1,"amount-due"],[1,"amount-label"],[1,"amount-value"],[1,"instructions-section","cash"],[1,"upload-section"],[1,"file-input-area"],[1,"file-label"],["type","file","accept","image/jpeg,image/png",1,"file-input",3,"change","disabled"],[1,"file-placeholder"],[1,"file-selected"],[1,"validation-error"],[1,"progress-container"],[1,"btn-upload",3,"click","disabled"],[1,"qr-fullscreen-overlay"],[1,"cash-step-card"],[1,"cash-step-number"],[1,"cash-step-content"],[1,"cash-step-title"],[1,"cash-zelle-line"],[1,"zelle-email"],[1,"cash-important"],[1,"qr-section"],[1,"qr-label"],["src","bf-zelle.jpg","alt","Zelle QR Code",1,"qr-code",3,"click"],[1,"qr-section","dual"],[1,"qr-item"],["src","wechat_blueberry.jpg","alt","WeChat QR Code",1,"qr-code",3,"click"],["aria-hidden","true",1,"file-icon","material-symbols-rounded"],[1,"progress-bar"],[1,"progress-fill"],[1,"progress-text"],[1,"qr-fullscreen-overlay",3,"click"],["src","bf-zelle.jpg","alt","Zelle QR Code",1,"qr-fullscreen-img"],["src","wechat_blueberry.jpg","alt","WeChat QR Code",1,"qr-fullscreen-img"]],template:function(t,n){t&1&&(d(0,"div",0),L("click",function(c){return n.onBackdropClick(c)}),d(1,"div",1)(2,"div",2)(3,"h2"),u(4,ze,1,0)(5,Ve,1,0),s(),d(6,"button",3),L("click",function(){return n.close.emit()}),N(),d(7,"svg",4),M(8,"path",5),s()()(),B(),d(9,"div",6)(10,"span",7),u(11,Ae,1,0)(12,Fe,1,0),s(),d(13,"span",8),i(14),s()(),u(15,Ue,35,0,"div",9)(16,Re,44,0,"div",9),d(17,"div",10)(18,"h3"),i(19,"Upload Payment Screenshot"),s(),d(20,"div",11)(21,"label",12)(22,"input",13),L("change",function(c){return n.onFileSelected(c)}),s(),u(23,je,4,0,"span",14)(24,$e,4,2,"span",15),s()(),u(25,qe,2,1,"div",16),u(26,Be,5,3,"div",17),d(27,"button",18),L("click",function(){return n.onSubmit()}),u(28,He,1,0)(29,Ge,1,0),s()()()(),u(30,Qe,2,0,"div",19),u(31,We,2,0,"div",19)),t&2&&(a(4),g(n.paymentOption()==="cash_deposit"?4:5),a(5),w("cash",n.paymentOption()==="cash_deposit"||n.paymentOption()==="zelle"),a(2),g(n.paymentOption()==="cash_deposit"?11:12),a(3),z("$",n.formatPrice(n.amountDue())),a(),g(n.paymentOption()==="zelle"?15:16),a(6),w("disabled",n.uploading()),a(),ne("disabled",n.uploading()),a(),g(n.selectedFile()?24:23),a(2),g(n.validationError()?25:-1),a(),g(n.uploading()?26:-1),a(),ne("disabled",!n.canSubmit()),a(),g(n.uploading()?28:29),a(2),g(n.showQrOverlay()?30:-1),a(),g(n.showWechatOverlay()?31:-1))},dependencies:[A],styles:[".overlay-backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:#0009;display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}.overlay-content[_ngcontent-%COMP%]{background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:88vh;overflow-y:auto;box-shadow:0 8px 32px #0003}.overlay-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid var(--sys-outline-variant, #e0e0e0);position:sticky;top:0;background:#fff;z-index:1}.overlay-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.25rem;font-weight:600;color:var(--sys-on-surface, #212121)}.btn-close[_ngcontent-%COMP%]{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:50%;cursor:pointer;color:var(--sys-on-surface-variant, #666);transition:background .2s}.btn-close[_ngcontent-%COMP%]:hover{background:var(--sys-surface-variant, #f0f0f0)}.payment-option-badge[_ngcontent-%COMP%]{margin:1rem 1.5rem 0;padding:.5rem 1rem;border-radius:20px;font-weight:600;font-size:.875rem;display:inline-block}.payment-option-badge.zelle[_ngcontent-%COMP%]{background:var(--sys-primary-container, #ffebee);color:var(--sys-primary, #c62828)}.payment-option-badge.cash[_ngcontent-%COMP%]{background:var(--sys-tertiary-container, #e8f5e9);color:var(--sys-tertiary, #2e7d32)}.amount-due[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin:.8rem 1.25rem;padding:.85rem .9rem;background:var(--sys-surface-container, #fafafa);border-radius:10px;border:1px solid var(--sys-outline-variant, #e0e0e0)}.amount-due.cash[_ngcontent-%COMP%]{background:linear-gradient(135deg,#ff3d71,#ff2f62);border:1px solid #ff5a86;color:#fff;box-shadow:0 4px 12px #ff3d714d}.zelle-payment-note[_ngcontent-%COMP%]{margin:.75rem 1.5rem 0;padding:.75rem 1rem;border-radius:12px;background:var(--sys-primary-container, #ffebee);color:var(--sys-on-primary-container, #5f1414);border:1px solid var(--sys-outline-variant, #e0e0e0);font-size:.875rem;line-height:1.35}.zelle-payment-note[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0}.amount-label[_ngcontent-%COMP%]{font-size:.9rem;color:var(--sys-on-surface-variant, #666)}.amount-value[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;color:var(--sys-primary, #c62828)}.amount-due.cash[_ngcontent-%COMP%]   .amount-label[_ngcontent-%COMP%], .amount-due.cash[_ngcontent-%COMP%]   .amount-value[_ngcontent-%COMP%]{color:#fff}.instructions-section[_ngcontent-%COMP%]{padding:0 1.25rem}.instructions-section.cash[_ngcontent-%COMP%]{padding-bottom:.25rem}.cash-section-title[_ngcontent-%COMP%]{margin:0 0 .75rem;font-size:1.75rem;font-weight:700;color:#3b2f2f;font-family:Georgia,Times New Roman,serif}.cash-step-card[_ngcontent-%COMP%]{display:flex;gap:.75rem;padding:.75rem .8rem;background:#fff;border:1px solid #f0dada;border-radius:12px;margin-bottom:.5rem}.cash-step-number[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:50%;background:#ff5a6e;color:#fff;font-weight:700;font-size:.9rem;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:.1rem}.cash-step-content[_ngcontent-%COMP%]{flex:1;min-width:0}.cash-step-title[_ngcontent-%COMP%]{font-size:1.05rem;font-weight:700;color:#3b2f2f;margin-bottom:.25rem}.cash-step-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:#7a6f6f;font-size:.92rem;line-height:1.35}.cash-zelle-line[_ngcontent-%COMP%]{margin-top:.25rem!important;color:#5c4c4c!important;font-weight:600}.cash-important[_ngcontent-%COMP%]{padding:.75rem .9rem;border:1px solid #ef9aa8;border-radius:12px;background:#ffe8eb;color:#af4a58;font-size:.95rem;margin-bottom:.6rem;line-height:1.35}.instruction-card[_ngcontent-%COMP%]{display:flex;gap:.75rem;padding:.875rem;background:var(--sys-surface-container, #fafafa);border-radius:10px;margin-bottom:.75rem}.instruction-card.highlight[_ngcontent-%COMP%]{background:var(--sys-tertiary-container, #e8f5e9);border:1px solid var(--sys-tertiary, #2e7d32)}.instruction-icon[_ngcontent-%COMP%]{font-size:1.25rem}.instruction-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem;font-size:.9rem;color:var(--sys-on-surface, #333)}.zelle-email[_ngcontent-%COMP%]{font-family:Helvetica,Arial,sans-serif;font-size:.95rem;color:navy;font-weight:600;word-break:break-all}.qr-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:.8rem;background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:10px;margin-bottom:.6rem}.qr-section.dual[_ngcontent-%COMP%]{flex-direction:row;justify-content:center;gap:1.25rem}.qr-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.qr-label[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:.8rem;color:#9c8f8f;text-transform:uppercase;letter-spacing:.05em;font-weight:700}.qr-code[_ngcontent-%COMP%]{width:120px;height:auto;border-radius:8px;cursor:pointer;transition:transform .2s}.qr-code[_ngcontent-%COMP%]:hover{transform:scale(1.05)}.cash-balance-note[_ngcontent-%COMP%]{text-align:center;padding:.75rem;background:var(--sys-surface-variant, #f5f5f5);border-radius:8px;font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.upload-section[_ngcontent-%COMP%]{padding:1rem 1.25rem;border-top:1px solid var(--sys-outline-variant, #e0e0e0);margin-top:.6rem}.upload-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1rem;font-weight:600;color:var(--sys-on-surface, #212121)}.file-input-area[_ngcontent-%COMP%]{margin-bottom:.75rem}.file-label[_ngcontent-%COMP%]{display:block;padding:1rem;background:var(--sys-surface-container, #fafafa);border:2px dashed var(--sys-outline-variant, #ccc);border-radius:10px;cursor:pointer;text-align:center;transition:border-color .2s,background .2s}.file-label[_ngcontent-%COMP%]:hover:not(.disabled){border-color:var(--sys-primary, #c62828);background:var(--sys-primary-container, #ffebee)}.file-label.disabled[_ngcontent-%COMP%]{opacity:.6;cursor:not-allowed}.file-input[_ngcontent-%COMP%]{display:none}.file-placeholder[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.file-selected[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;color:var(--sys-tertiary, #2e7d32);font-size:.875rem}.file-icon[_ngcontent-%COMP%]{font-size:1.25rem}.validation-error[_ngcontent-%COMP%]{padding:.5rem .75rem;background:var(--sys-error-container, #ffebee);border-radius:6px;color:var(--sys-error, #c62828);font-size:.875rem;margin-bottom:.75rem}.progress-container[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem}.progress-bar[_ngcontent-%COMP%]{flex:1;height:8px;background:var(--sys-surface-variant, #e0e0e0);border-radius:4px;overflow:hidden}.progress-fill[_ngcontent-%COMP%]{height:100%;background:var(--sys-primary, #c62828);border-radius:4px;transition:width .3s ease}.progress-text[_ngcontent-%COMP%]{font-size:.875rem;font-weight:600;color:var(--sys-primary, #c62828);min-width:40px;text-align:right}.btn-upload[_ngcontent-%COMP%]{width:100%;padding:1rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:background .2s}.btn-upload[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-upload[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.qr-fullscreen-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#000000d9;display:flex;align-items:center;justify-content:center;z-index:1100;cursor:pointer}.qr-fullscreen-img[_ngcontent-%COMP%]{max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 4px 24px #0000004d}@media(max-width:640px){.overlay-content[_ngcontent-%COMP%]{max-width:100%}.qr-section.dual[_ngcontent-%COMP%]{flex-direction:column;gap:.75rem}}"]})};function Ze(o,e){o&1&&(N(),d(0,"svg",3),M(1,"path",7),s())}function Ye(o,e){o&1&&(d(0,"span",4),i(1,"1"),s())}function Ke(o,e){o&1&&(N(),d(0,"svg",3),M(1,"path",7),s())}function Je(o,e){o&1&&(d(0,"span",4),i(1,"2"),s())}function Xe(o,e){o&1&&(N(),d(0,"svg",3),M(1,"path",7),s())}function et(o,e){o&1&&(d(0,"span",4),i(1,"3"),s())}function tt(o,e){o&1&&(N(),d(0,"svg",3),M(1,"path",7),s())}function nt(o,e){o&1&&(d(0,"span",4),i(1,"4"),s())}var K=class o{currentStage=x.required();completedStages=x.required();static \u0275fac=function(t){return new(t||o)};static \u0275cmp=V({type:o,selectors:[["app-ledger-progress-stepper"]],inputs:{currentStage:[1,"currentStage"],completedStages:[1,"completedStages"]},decls:28,vars:26,consts:[[1,"progress-stepper"],[1,"step"],[1,"step-circle"],["viewBox","0 0 24 24","fill","currentColor",1,"check-icon"],[1,"step-number"],[1,"step-label"],[1,"step-connector"],["d","M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"]],template:function(t,n){t&1&&(d(0,"div",0)(1,"div",1)(2,"div",2),u(3,Ze,2,0,":svg:svg",3)(4,Ye,2,0,"span",4),s(),d(5,"span",5),i(6,"Spots Locked"),s()(),M(7,"div",6),d(8,"div",1)(9,"div",2),u(10,Ke,2,0,":svg:svg",3)(11,Je,2,0,"span",4),s(),d(12,"span",5),i(13,"Payment Sent"),s()(),M(14,"div",6),d(15,"div",1)(16,"div",2),u(17,Xe,2,0,":svg:svg",3)(18,et,2,0,"span",4),s(),d(19,"span",5),i(20,"Verification"),s()(),M(21,"div",6),d(22,"div",1)(23,"div",2),u(24,tt,2,0,":svg:svg",3)(25,nt,2,0,"span",4),s(),d(26,"span",5),i(27,"Complete"),s()()()),t&2&&(a(),w("active",n.currentStage()===1)("completed",n.completedStages().includes(1)),a(2),g(n.completedStages().includes(1)?3:4),a(4),w("completed",n.completedStages().includes(1)),a(),w("active",n.currentStage()===2)("completed",n.completedStages().includes(2)),a(2),g(n.completedStages().includes(2)?10:11),a(4),w("completed",n.completedStages().includes(2)),a(),w("active",n.currentStage()===3)("completed",n.completedStages().includes(3)),a(2),g(n.completedStages().includes(3)?17:18),a(4),w("completed",n.completedStages().includes(3)),a(),w("active",n.currentStage()===4)("completed",n.completedStages().includes(4)),a(2),g(n.completedStages().includes(4)||n.currentStage()===4?24:25))},dependencies:[A],styles:[".progress-stepper[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:center;gap:0}.step[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem;min-width:80px}.step-circle[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:50%;background:var(--sys-surface-variant, #e8e8e8);color:var(--sys-on-surface-variant, #666);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.875rem;transition:all .3s ease;border:2px solid transparent}.step.active[_ngcontent-%COMP%]   .step-circle[_ngcontent-%COMP%]{background:var(--sys-primary, #c62828);color:#fff;border-color:var(--sys-primary, #c62828);box-shadow:0 2px 8px #c628284d}.step.completed[_ngcontent-%COMP%]   .step-circle[_ngcontent-%COMP%]{background:var(--sys-tertiary, #2e7d32);color:#fff;border-color:var(--sys-tertiary, #2e7d32)}.check-icon[_ngcontent-%COMP%]{width:18px;height:18px}.step-number[_ngcontent-%COMP%]{font-size:.875rem}.step-label[_ngcontent-%COMP%]{font-size:.75rem;color:var(--sys-on-surface-variant, #666);text-align:center;white-space:nowrap}.step.active[_ngcontent-%COMP%]   .step-label[_ngcontent-%COMP%]{color:var(--sys-primary, #c62828);font-weight:600}.step.completed[_ngcontent-%COMP%]   .step-label[_ngcontent-%COMP%]{color:var(--sys-tertiary, #2e7d32)}.step-connector[_ngcontent-%COMP%]{flex:1;max-width:60px;min-width:30px;height:3px;background:var(--sys-outline-variant, #e0e0e0);margin-top:16px;transition:background .3s ease}.step-connector.completed[_ngcontent-%COMP%]{background:var(--sys-tertiary, #2e7d32)}@media(max-width:480px){.step[_ngcontent-%COMP%]{min-width:60px}.step-circle[_ngcontent-%COMP%]{width:32px;height:32px}.check-icon[_ngcontent-%COMP%]{width:16px;height:16px}.step-label[_ngcontent-%COMP%]{font-size:.625rem}.step-connector[_ngcontent-%COMP%]{max-width:40px;min-width:20px;margin-top:14px}}"]})};var J=class o{currentStage=x.required();lockedCount=x(0);submittedCount=x(0);securedCount=x(0);paidCount=x(0);minutesUntilExpires=x(null);formatMinutes(e){if(e<=0)return"expired";if(e<60)return`${e} min`;let t=Math.floor(e/60),n=e%60;return n>0?`${t}h ${n}min`:`${t}h`}statusInfo=_(()=>{let e=this.lockedCount(),t=this.submittedCount(),n=this.securedCount(),r=this.paidCount(),c=this.currentStage();if(e>0&&(t>0||n>0)){let v=[];return e>0&&v.push(`${e} new reservation${e!==1?"s":""} awaiting payment`),t>0&&v.push(`${t} item${t!==1?"s":""} pending verification`),n>0&&v.push(`${n} item${n!==1?"s":""} awaiting cash balance`),{icon:"\u2139\uFE0F",title:"Action Required",description:`You have ${v.join(" and ")}.`,variant:"action"}}if(c===4&&r>0&&e===0&&t===0&&n===0)return{icon:"\u2705",title:"Registration Complete",description:"All your classes are confirmed! You're all set for the upcoming session.",variant:"success"};if(n>0&&t===0&&e===0)return{icon:"\u{1F6E1}\uFE0F",title:"Registration Fee Received",description:`Your registration fee has been received for ${n} class${n!==1?"es":""}. Please pay the remaining balance to complete registration.`,variant:"secured"};if((c===2||c===3)&&t>0)return{icon:"\u23F1\uFE0F",title:"Verification in Progress",description:"We have received your payment receipt and are matching it to your order. This usually takes 24-48 hours. Spot holds remain active during this audit.",variant:"info"};if(e>0){let v=this.minutesUntilExpires(),S="";return v!==null&&v>0?S=` Reservation expires in ${this.formatMinutes(v)}.`:v!==null&&v<=0&&(S=" Reservation has expired."),{icon:"\u23F3",title:"Payment Required",description:`You have ${e} class${e!==1?"es":""} reserved. Submit your payment receipt to secure your spots.${S}`,variant:"warning"}}return{icon:"\u2139\uFE0F",title:"Welcome",description:"Review your registration status below.",variant:"info"}});static \u0275fac=function(t){return new(t||o)};static \u0275cmp=V({type:o,selectors:[["app-ledger-status-banner"]],inputs:{currentStage:[1,"currentStage"],lockedCount:[1,"lockedCount"],submittedCount:[1,"submittedCount"],securedCount:[1,"securedCount"],paidCount:[1,"paidCount"],minutesUntilExpires:[1,"minutesUntilExpires"]},decls:8,vars:5,consts:[[1,"status-banner"],[1,"status-icon"],[1,"status-content"],[1,"status-title"],[1,"status-description"]],template:function(t,n){t&1&&(d(0,"div",0)(1,"span",1),i(2),s(),d(3,"div",2)(4,"h3",3),i(5),s(),d(6,"p",4),i(7),s()()()),t&2&&(se(n.statusInfo().variant),a(2),E(n.statusInfo().icon),a(3),E(n.statusInfo().title),a(2),E(n.statusInfo().description))},dependencies:[A],styles:[".status-banner[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:1rem;padding:1rem 1.25rem;border-radius:12px;margin-bottom:1rem}.status-banner.warning[_ngcontent-%COMP%]{background:linear-gradient(135deg,#fff8e1,#ffecb3);border:1px solid #ffc107}.status-banner.info[_ngcontent-%COMP%]{background:linear-gradient(135deg,#e3f2fd,#bbdefb);border:1px solid #2196f3}.status-banner.secured[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f3e5f5,#e1bee7);border:1px solid #9c27b0}.status-banner.success[_ngcontent-%COMP%]{background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border:1px solid #4caf50}.status-banner.action[_ngcontent-%COMP%]{background:linear-gradient(135deg,#fff3e0,#ffe0b2);border:1px solid #ff9800}.status-icon[_ngcontent-%COMP%]{font-size:1.5rem;line-height:1;flex-shrink:0}.status-content[_ngcontent-%COMP%]{flex:1;min-width:0}.status-title[_ngcontent-%COMP%]{margin:0 0 .25rem;font-size:1rem;font-weight:600;color:var(--sys-on-surface, #212121)}.status-description[_ngcontent-%COMP%]{margin:0;font-size:.875rem;color:var(--sys-on-surface-variant, #555);line-height:1.5}@media(max-width:480px){.status-banner[_ngcontent-%COMP%]{padding:.875rem 1rem}.status-icon[_ngcontent-%COMP%]{font-size:1.25rem}.status-title[_ngcontent-%COMP%]{font-size:.9375rem}.status-description[_ngcontent-%COMP%]{font-size:.8125rem}}"]})};function ot(o,e){o&1&&(m(0,"span",22),i(1,"alarm"),l(),m(2,"span",23),i(3,"Your reservation has expired"),l())}function it(o,e){if(o&1&&(m(0,"span",22),i(1,"timer"),l(),m(2,"span",23),i(3," Time remaining: "),m(4,"strong"),i(5),l()()),o&2){let t=p(2);a(5),E(t.formatMinutes(t.minutesUntilLockExpires()))}}function rt(o,e){o&1&&i(0," Extending... ")}function at(o,e){o&1&&i(0," Extend 120 min ")}function st(o,e){if(o&1){let t=k();m(0,"button",24),D("click",function(){h(t);let r=p(2);return y(r.onExtendLock())}),u(1,rt,1,0)(2,at,1,0),l()}if(o&2){let t=p(2);F("disabled",t.extendingLock()),a(),g(t.extendingLock()?1:2)}}function dt(o,e){if(o&1&&(m(0,"div",19)(1,"div",20),u(2,ot,4,0)(3,it,6,1),l(),u(4,st,3,2,"button",21),l()),o&2){let t=p();w("expired",t.minutesUntilLockExpires()<=0)("warning",t.minutesUntilLockExpires()>0&&t.minutesUntilLockExpires()<=5),a(2),g(t.minutesUntilLockExpires()<=0?2:3),a(2),g(t.orderService.showExtendLockButton()?4:-1)}}function lt(o,e){if(o&1&&(m(0,"div",4)(1,"div",25),i(2,"CURRENT STATUS"),l(),j(3,"app-ledger-progress-stepper",26),l()),o&2){let t=p();a(3),F("currentStage",t.currentPrimaryStage())("completedStages",t.completedStages())}}function ct(o,e){if(o&1&&j(0,"app-ledger-status-banner",5),o&2){let t=p();F("currentStage",t.currentPrimaryStage())("lockedCount",t.lockedItems().length)("submittedCount",t.submittedItems().length)("securedCount",t.securedItems().length)("paidCount",t.paidItems().length)("minutesUntilExpires",t.minutesUntilLockExpires())}}function mt(o,e){if(o&1&&(m(0,"div",12)(1,"div",27),i(2,"warning"),l(),m(3,"div",28)(4,"strong"),i(5,"Payment Screenshot Rejected"),l(),m(6,"p"),i(7),l()()()),o&2){let t=p();a(7),E(t.rejectionNote())}}function pt(o,e){o&1&&(m(0,"div",13),j(1,"div",29),m(2,"span"),i(3,"Loading..."),l()())}function ut(o,e){if(o&1){let t=k();m(0,"div",14)(1,"p"),i(2,"No reservations found."),l(),m(3,"button",30),D("click",function(){h(t);let r=p();return y(r.goToCatalog())}),i(4,"Browse Sessions"),l()()}}function gt(o,e){if(o&1&&(m(0,"tr")(1,"td"),i(2),l(),m(3,"td",36),i(4),l(),m(5,"td")(6,"span",37),i(7),l()(),m(8,"td"),i(9),l()()),o&2){let t=e.$implicit,n=p(4);a(2),E(n.formatDateTime(t.recordedAt)),a(2),E(n.formatCurrency(t.amount)),a(3),E(t.method),a(2),E(t.reference||"-")}}function ft(o,e){if(o&1&&(m(0,"table",35)(1,"thead")(2,"tr")(3,"th"),i(4,"Date"),l(),m(5,"th"),i(6,"Amount"),l(),m(7,"th"),i(8,"Method"),l(),m(9,"th"),i(10,"Reference"),l()()(),m(11,"tbody"),G(12,gt,10,4,"tr",null,H),l()()),o&2){let t=p(3);a(12),Q(t.orderService.payments())}}function _t(o,e){if(o&1){let t=k();m(0,"div",32)(1,"div",33),D("click",function(){h(t);let r=p(2);return y(r.paymentHistoryExpanded.set(!r.paymentHistoryExpanded()))}),m(2,"h2"),i(3),l(),m(4,"button",34),i(5),l()(),u(6,ft,14,0,"table",35),l()}if(o&2){let t=p(2);a(3),z("Payment History (",t.orderService.payments().length,")"),a(2),z(" ",t.paymentHistoryExpanded()?"\u25BC":"\u25B6"," "),a(),g(t.paymentHistoryExpanded()?6:-1)}}function vt(o,e){if(o&1&&(m(0,"span",47),i(1),l()),o&2){let t=p().$implicit;a(),E(t.studentName)}}function ht(o,e){if(o&1&&(m(0,"li",45)(1,"span",46),i(2),l(),u(3,vt,2,1,"span",47),l()),o&2){let t=e.$implicit;a(2),E(t.className),a(),g(t.studentName?3:-1)}}function yt(o,e){if(o&1&&(m(0,"ul",43),G(1,ht,4,2,"li",45,H),l()),o&2){let t=p().$implicit;a(),Q(t.affectedItems)}}function Ct(o,e){if(o&1&&(m(0,"div",44),i(1),l()),o&2){let t=p().$implicit;a(),E(t.details)}}function bt(o,e){if(o&1&&(m(0,"div",39)(1,"div",40),i(2),l(),m(3,"div",41)(4,"div",42),i(5),l(),u(6,yt,3,0,"ul",43)(7,Ct,2,1,"div",44),l()()),o&2){let t=e.$implicit,n=p(4);a(2),E(n.formatDateTime(t.timestamp)),a(3),E(n.getActionLabel(t.action)),a(),g(t.affectedItems&&t.affectedItems.length>0?6:t.details?7:-1)}}function xt(o,e){if(o&1&&(m(0,"div",38),G(1,bt,8,3,"div",39,H),l()),o&2){let t=p(3);a(),Q(t.userVisibleHistory())}}function St(o,e){if(o&1){let t=k();m(0,"div",32)(1,"div",33),D("click",function(){h(t);let r=p(2);return y(r.orderHistoryExpanded.set(!r.orderHistoryExpanded()))}),m(2,"h2"),i(3),l(),m(4,"button",34),i(5),l()(),u(6,xt,3,0,"div",38),l()}if(o&2){let t=p(2);a(3),z("Order Activity (",t.userVisibleHistory().length,")"),a(2),z(" ",t.orderHistoryExpanded()?"\u25BC":"\u25B6"," "),a(),g(t.orderHistoryExpanded()?6:-1)}}function Et(o,e){if(o&1){let t=k();m(0,"app-ledger-order-items",31),D("deleteItem",function(r){h(t);let c=p();return y(c.onDeleteItem(r))})("addonToggle",function(r){h(t);let c=p();return y(c.onAddonToggle(r))})("deleteScreenshot",function(r){h(t);let c=p();return y(c.onDeleteScreenshot(r))})("showCashInstructions",function(){h(t);let r=p();return y(r.showCashInstructionOverlay.set(!0))}),l(),u(1,_t,7,3,"div",32),u(2,St,7,3,"div",32)}if(o&2){let t=p();F("lockedItems",t.lockedItems())("submittedItems",t.submittedItems())("securedItems",t.securedItems())("paidItems",t.paidItems())("editable",!0)("isAdmin",!1)("screenshotGroups",t.screenshotGroups()),a(),g(t.orderService.payments().length>0?1:-1),a(),g(t.userVisibleHistory().length>0?2:-1)}}function Pt(o,e){if(o&1){let t=k();m(0,"app-payment-instruction-overlay",48),D("close",function(){h(t);let r=p();return y(r.showPaymentOverlay.set(!1))})("uploadFile",function(r){h(t);let c=p();return y(c.onOverlayUpload(r))}),l()}if(o&2){let t=p();F("paymentOption",t.selectedPaymentOption())("totalAmount",t.lockedItemsTotal())("depositAmount",t.lockedDepositAmount())("immediatelyDue",t.lockedItemsDueNow())("uploading",t.uploadService.uploading())("uploadProgress",t.uploadService.uploadProgress())}}function Ot(o,e){if(o&1){let t=k();m(0,"div",49),D("click",function(){h(t);let r=p();return y(r.showCashInstructionOverlay.set(!1))}),m(1,"div",50),D("click",function(r){return h(t),y(r.stopPropagation())}),m(2,"button",51),D("click",function(){h(t);let r=p();return y(r.showCashInstructionOverlay.set(!1))}),i(3,"\xD7"),l(),m(4,"h2")(5,"span",52),i(6,"payments"),l(),i(7," Cash Payment Instructions "),l(),m(8,"div",53)(9,"p"),i(10," For families choosing to pay in cash, we kindly ask that all cash payments be made "),m(11,"strong",54),i(12,"in person"),l(),i(13," by handing the cash directly to a BerryFun Teacher. To avoid any confusion, please note that checks are not accepted for cash payments. Kindly scan the QR code to contact \u84DD\u8393\u8001\u5E08 to arrange a suitable payment time. "),l(),m(14,"div",55),j(15,"img",56),l()()()()}}var ke=class o{orderService=I(ye);uploadService=I(W);seasonService=I(he);userService=I(Ce);acknowledgementService=I(xe);authService=I(be);confirmDialog=I(Pe);orderRpc=I(_e);router=I(le);couponService=I(Se);configService=I(ve);selectedPaymentOption=C("zelle");showPaymentOverlay=C(!1);showCashInstructionOverlay=C(!1);paymentHistoryExpanded=C(!1);orderHistoryExpanded=C(!1);extendingLock=C(!1);couponValidationError=C(null);couponValidationSuccess=C(null);couponLoadSeasonId=C(null);suppressOverlayOpenUntil=C(0);pendingAddonUpdates=C(new Map);seasonCoupons=this.couponService.seasonCoupons;userCoupons=this.couponService.userCoupons;selectedCouponIds=this.couponService.selectedUserCouponIds;couponsLoading=this.couponService.loading;couponsValidating=this.couponService.validating;constructor(){te(()=>{let e=this.seasonService.selectedSeason();e&&this.orderService.hasLockedItems()&&(this.acknowledgementService.hasAcknowledged(e.id)||this.router.navigate(["/acknowledgement"],{queryParams:{redirect:"/ledger"}}))}),te(()=>{let e=this.seasonService.selectedSeason()?.id??null;!e||!this.showCouponSection()||this.couponLoadSeasonId()!==e&&(this.couponLoadSeasonId.set(e),this.loadCouponsForSeason(e))})}async ngOnInit(){await this.seasonService.loadSeasons(),this.restoreSelectedSeasonFromStorage()}restoreSelectedSeasonFromStorage(){let e=this.seasonService.getLastSelectedSeasonId();if(!e)return;let n=this.seasonService.seasons().find(c=>c.id===e);if(!n)return;let r=this.seasonService.selectedSeason();(!r||r.id!==n.id)&&this.seasonService.selectSeason(n)}async loadCouponsForSeason(e){try{await this.couponService.loadCoupons(e)}catch(t){console.error("Failed to load coupons for ledger:",t)}}async applySelectedCoupons(){if(!this.showCouponSection())return;let e=this.seasonService.selectedSeason()?.id;if(e)try{await this.orderRpc.lockSessions({seasonId:e,items:[],selectedCouponIds:this.couponService.getSelectedCouponIds()}),this.couponValidationError.set(null),this.couponValidationSuccess.set("Coupons applied to current reservation.")}catch(t){console.error("Failed to apply coupons:",t),this.couponValidationSuccess.set(null),this.couponValidationError.set(t instanceof Error?t.message:"Failed to apply coupons")}}transformItem(e){let t=this.userService.getStudentById(e.studentId),n=`${e.sessionId}:${e.studentId}`,c=this.pendingAddonUpdates().get(n)??e.options,{basePrice:b,lunchPrice:v,extendedCarePrice:S}=e.snapshot.priceSnapshot,O=b+(c.lunch?v:0)+(c.extendedCare?S:0);return{sessionId:e.sessionId,studentId:e.studentId,studentName:t?`${t.firstName} ${t.lastName}`.trim():"Unknown",className:e.snapshot.className,startDate:e.snapshot.startDate,endDate:e.snapshot.endDate,status:e.status,options:c,pricing:{basePrice:b,lunchPrice:v,extendedCarePrice:S,itemTotal:O}}}lockedItems=_(()=>this.orderService.items().filter(e=>e.status==="locked").map(e=>this.transformItem(e)).sort((e,t)=>e.className.localeCompare(t.className)));submittedItems=_(()=>this.orderService.items().filter(e=>e.status==="submitted").map(e=>this.transformItem(e)).sort((e,t)=>e.className.localeCompare(t.className)));screenshotGroups=_(()=>{let e=this.orderService.paymentScreenshots(),t=this.submittedItems();return e.map(n=>{let r=new Set(n.lockedItemKeys),c=t.filter(b=>{let v=`${b.sessionId}:${b.studentId}`;return r.has(v)});return{screenshot:n,items:c}}).filter(n=>n.items.length>0)});securedItems=_(()=>this.orderService.items().filter(e=>e.status==="secured").map(e=>this.transformItem(e)).sort((e,t)=>e.className.localeCompare(t.className)));securedItemsTotal=_(()=>this.securedItems().reduce((e,t)=>e+t.pricing.itemTotal,0));securedDepositPaid=_(()=>this.securedItems().length*5e3);paidItems=_(()=>this.orderService.items().filter(e=>e.status==="paid").map(e=>this.transformItem(e)).sort((e,t)=>e.className.localeCompare(t.className)));paidItemsTotal=_(()=>this.paidItems().reduce((e,t)=>e+t.pricing.itemTotal,0));rejectionNote=_(()=>this.orderService.order()?.rejectionNote??null);minutesUntilLockExpires=_(()=>this.orderService.minutesUntilLockExpires());userVisibleHistory=_(()=>{let e=["payment_recorded","refund_processed","session_reserved","items_submitted","change_approved","change_denied","waitlist_promoted","items_cancelled"];return[...this.orderService.order()?.history??[]].filter(n=>e.includes(n.action)).reverse()});currentPrimaryStage=_(()=>{let e=this.lockedItems().length,t=this.submittedItems().length,n=this.securedItems().length,r=this.paidItems().length;return e>0?1:t>0||n>0?3:r>0?4:1});completedStages=_(()=>{let e=[],t=this.lockedItems().length,n=this.submittedItems().length,r=this.securedItems().length,c=this.paidItems().length;return t>0||n>0||r>0||c>0?(t===0&&(n>0||r>0||c>0)&&e.push(1),t===0&&(n>0||r>0||c>0)&&e.push(2),t===0&&n===0&&r===0&&c>0&&e.push(3),e):[]});hasNoItems(){return this.lockedItems().length===0&&this.submittedItems().length===0&&this.securedItems().length===0&&this.paidItems().length===0}canEditCoupons=_(()=>this.lockedItems().length>0||this.submittedItems().length>0);showCouponSection=_(()=>this.configService.systemSwitch().showLedgerCoupons&&this.canEditCoupons());lockedItemsTotal=_(()=>this.lockedItems().reduce((e,t)=>e+t.pricing.itemTotal,0));lockedDepositAmount=_(()=>{let n=this.lockedItems().length*5e3,r=this.lockedItemsTotal();return Math.min(n,r)});lockedItemsDiscount=_(()=>{let e=this.orderService.order()?.pricing;if(!e)return 0;let t=e.discounts.reduce((r,c)=>r+c.amount,0),n=(this.orderService.order()?.processingFees??[]).reduce((r,c)=>r+c.amount,0);return t+n});lockedItemsDueNow=_(()=>{let e=this.orderSummaryData();if(!e)return 0;let n=this.orderService.paymentScreenshots().reduce((r,c)=>r+(c.claimedAmountCents??0),0);return Math.max(0,e.amountDue-n)});orderSummaryData=_(()=>{let e=this.orderService.order(),t=e?.pricing;if(!t)return null;let r=[...this.lockedItems(),...this.submittedItems(),...this.securedItems(),...this.paidItems()].reduce((f,P)=>f+P.pricing.itemTotal,0),c=new Map;for(let f of t.discounts){let P=c.get(f.type)??0;c.set(f.type,P+f.amount)}for(let f of e.processingFees??[]){if(f.type==="adjustment")continue;let P=c.get(f.type)??0;c.set(f.type,P+f.amount)}let b=[],v={returning_family:"Returning Family",returning_student:"Returning Student",sibling:"Sibling Discount",multi_session:"Multi-Session",coupon:"Coupon Credit",manual:"Manual Adjustment",referral:"Referral Bonus",cash_discount:"Cash Discount (3%)",adjustment:"Adjustment",forfeited_deposit:"Forfeited Deposit"};for(let[f,P]of c)P!==0&&b.push({key:`type:${f}`,type:f,label:v[f]??f,amount:P});for(let f of e.processingFees??[])f.type!=="adjustment"||f.amount===0||b.push({key:`adjustment:${f.id}`,type:"adjustment",label:f.description?.trim()?`Adjustment: ${f.description.trim()}`:"Adjustment",amount:f.amount});let O=this.orderService.paymentScreenshots().reduce((f,P)=>f+(P.claimedAmountCents??0),0),U=this.orderService.payments().reduce((f,P)=>f+P.amount,0),T=this.securedItems().length,R=this.paidItems().length,we=5e3,q=0,X=0;T>0&&R===0?q=U:T===0&&R>0?X=U:T>0&&R>0&&(q=Math.min(T*we,U),X=U-q);let Ie=[{status:"locked",label:"Awaiting Payment",count:this.lockedItems().length,total:this.lockedItemsTotal()},{status:"submitted",label:"Pending Verification",count:this.submittedItems().length,total:O},{status:"secured",label:"Registration Fee Received",count:T,total:q},{status:"paid",label:"Payment Confirmed",count:R,total:X}],De=b.reduce((f,P)=>f+P.amount,0),ie=this.orderService.totalPaid(),Te=Math.max(0,r+De-ie);return{subtotal:r,totalPaid:ie,discounts:b,amountDue:Te,statusCounts:Ie}});goToCatalog(){this.router.navigate(["/"])}formatPrice(e){return(e/100).toLocaleString("en-US",{minimumFractionDigits:0})}formatDateTime(e){return e?Ee(e):"-"}formatCurrency(e){return"$"+(e/100).toFixed(2)}formatMinutes(e){if(e<=0)return"Expired";if(e<60)return`${e} min`;let t=Math.floor(e/60),n=e%60;return n>0?`${t}h ${n}min`:`${t}h`}async onExtendLock(){this.extendingLock.set(!0);try{await this.orderService.extendLock()}catch(e){console.error("Failed to extend lock:",e)}finally{this.extendingLock.set(!1)}}getActionLabel(e){return{payment_recorded:"Payment Confirmed",refund_processed:"Refund Issued",session_reserved:"Session Reserved",items_submitted:"Order Submitted",items_cancelled:"Items Cancelled",change_approved:"Change Request Approved",change_denied:"Change Request Denied",waitlist_promoted:"Promoted from Waitlist"}[e]??e.replace(/_/g," ")}onPaymentOptionChange(e){this.selectedPaymentOption.set(e),e==="cash_deposit"&&this.showPaymentOverlay.set(!0)}async onToggleCoupon(e){this.showCouponSection()&&(this.couponValidationError.set(null),this.couponValidationSuccess.set(null),this.couponService.toggleCoupon(e),await this.applySelectedCoupons())}async onAddCoupon(e){if(!this.showCouponSection())return;this.couponValidationError.set(null),this.couponValidationSuccess.set(null);let t=await this.couponService.validateAndAddCoupon(e);if(!t.success){this.couponValidationError.set(t.error??"Failed to add coupon");return}this.couponValidationSuccess.set(`Coupon "${t.coupon?.id??e}" added.`),await this.applySelectedCoupons()}async onDeleteItem(e){if(e.status!=="locked"||!await this.confirmDialog.confirm({title:"Release Reservation?",message:`This will release ${e.studentName} from "${e.className}". The spot will become available to others.`,confirmText:"Release",cancelText:"Keep",confirmButtonClass:"danger"}))return;let n=this.seasonService.selectedSeason();if(n)try{await this.orderRpc.releaseLockedItems({year:n.year,seasonId:n.id,items:[{sessionId:e.sessionId,studentId:e.studentId}]})}catch(r){console.error("Failed to release reservation:",r)}}async onAddonToggle(e){let{item:t,addon:n,value:r}=e;if(t.status!=="locked")return;let c=this.seasonService.selectedSeason();if(!c)return;let b={lunch:n==="lunch"?r:t.options.lunch,extendedCare:n==="extendedCare"?r:t.options.extendedCare},v=`${t.sessionId}:${t.studentId}`;this.pendingAddonUpdates.update(S=>{let O=new Map(S);return O.set(v,b),O});try{await this.orderRpc.updateLockedItemOptions({year:c.year,seasonId:c.id,sessionId:t.sessionId,studentId:t.studentId,options:b}),this.pendingAddonUpdates.update(S=>{let O=new Map(S);return O.delete(v),O})}catch(S){console.error("Failed to update addon:",S),this.pendingAddonUpdates.update(O=>{let $=new Map(O);return $.delete(v),$})}}onSubmitPayment(){Date.now()<this.suppressOverlayOpenUntil()||this.showPaymentOverlay.set(!0)}async onOverlayUpload(e){try{let t=this.authService.firebaseUser()?.uid;if(!t)throw new Error("Not authenticated");let n=await this.uploadService.uploadScreenshot(e,t),r=this.selectedPaymentOption(),c=r==="cash_deposit"?this.lockedDepositAmount():this.lockedItemsDueNow();await this.orderService.placeOrder(n.storagePath,r,c),this.suppressOverlayOpenUntil.set(Date.now()+1e3),this.showPaymentOverlay.set(!1),r==="cash_deposit"&&this.showCashInstructionOverlay.set(!0)}catch(t){console.error("Upload failed:",t)}}async onDeleteScreenshot(e){try{let t=this.seasonService.selectedSeason()?.id;if(!t)throw new Error("No season selected");await this.orderRpc.deleteScreenshot({seasonId:t,screenshotId:e,userAuthId:null,rejectionReason:null})}catch(t){console.error("Delete screenshot failed:",t)}}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=V({type:o,selectors:[["app-ledger"]],decls:24,vars:24,consts:[[1,"ledger-page"],[1,"page-header"],[1,"subtitle"],[1,"lock-timer-bar",3,"expired","warning"],[1,"status-card"],[3,"currentStage","lockedCount","submittedCount","securedCount","paidCount","minutesUntilExpires"],[1,"ledger-layout"],[1,"main-column"],[1,"agreement-links"],["routerLink","/acknowledgement",1,"agreement-link"],["width","16","height","16","viewBox","0 0 24 24","fill","currentColor"],["d","M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"],[1,"rejection-notice"],[1,"loading-state"],[1,"empty-state"],[1,"sidebar-column"],[3,"optionChange","toggleCouponClick","addCouponClick","submitClick","lockedItemsTotal","lockedSessionCount","lockedDepositAmount","lockedItemsDueNow","lockedItemsDiscount","hasLockedItems","hasSecuredItems","showCouponSection","selectedOption","seasonCoupons","userCoupons","selectedCouponIds","couponsLoading","couponsValidating","couponError","couponSuccess","orderSummary"],[3,"paymentOption","totalAmount","depositAmount","immediatelyDue","uploading","uploadProgress"],[1,"overlay-backdrop"],[1,"lock-timer-bar"],[1,"timer-content"],[1,"extend-btn",3,"disabled"],["aria-hidden","true",1,"timer-icon","material-symbols-rounded"],[1,"timer-text"],[1,"extend-btn",3,"click","disabled"],[1,"status-card-label"],[3,"currentStage","completedStages"],["aria-hidden","true",1,"rejection-icon","material-symbols-rounded"],[1,"rejection-content"],[1,"spinner"],[1,"btn-browse",3,"click"],[3,"deleteItem","addonToggle","deleteScreenshot","showCashInstructions","lockedItems","submittedItems","securedItems","paidItems","editable","isAdmin","screenshotGroups"],[1,"info-card"],[1,"section-header",3,"click"],["type","button",1,"toggle-btn"],[1,"payments-table"],[1,"amount"],[1,"method-badge"],[1,"history-timeline"],[1,"history-event"],[1,"event-time"],[1,"event-details"],[1,"event-action"],[1,"affected-items-list"],[1,"event-metadata"],[1,"affected-item"],[1,"item-class"],[1,"item-student"],[3,"close","uploadFile","paymentOption","totalAmount","depositAmount","immediatelyDue","uploading","uploadProgress"],[1,"overlay-backdrop",3,"click"],[1,"cash-instruction-modal",3,"click"],[1,"modal-close",3,"click"],["aria-hidden","true",1,"material-symbols-rounded","icon-inline"],[1,"instruction-content"],[1,"in-person-emphasis"],[1,"payment-method"],["src","/wechat_blueberry.jpg","alt","WeChat QR Code",1,"qr-code"]],template:function(t,n){t&1&&(m(0,"div",0)(1,"header",1)(2,"h1"),i(3,"My Ledger"),l(),m(4,"p",2),i(5,"Spot holds remain active during payment audit"),l(),u(6,dt,5,6,"div",3),l(),u(7,lt,4,2,"div",4),u(8,ct,1,6,"app-ledger-status-banner",5),m(9,"div",6)(10,"div",7)(11,"div",8)(12,"a",9),N(),m(13,"svg",10),j(14,"path",11),l(),i(15," View Camp Terms & Policies "),l()(),u(16,mt,8,1,"div",12),u(17,pt,4,0,"div",13)(18,ut,5,0,"div",14)(19,Et,3,9),l(),B(),m(20,"div",15)(21,"app-ledger-settlement-sidebar",16),D("optionChange",function(c){return n.onPaymentOptionChange(c)})("toggleCouponClick",function(c){return n.onToggleCoupon(c)})("addCouponClick",function(c){return n.onAddCoupon(c)})("submitClick",function(){return n.onSubmitPayment()}),l()()()(),u(22,Pt,1,6,"app-payment-instruction-overlay",17),u(23,Ot,16,0,"div",18)),t&2&&(a(6),g(n.orderService.hasLockedItems()&&n.minutesUntilLockExpires()!==null?6:-1),a(),g(n.hasNoItems()?-1:7),a(),g(n.hasNoItems()?-1:8),a(8),g(n.rejectionNote()?16:-1),a(),g(n.orderService.loading()?17:n.hasNoItems()?18:19),a(4),F("lockedItemsTotal",n.lockedItemsTotal())("lockedSessionCount",n.lockedItems().length)("lockedDepositAmount",n.lockedDepositAmount())("lockedItemsDueNow",n.lockedItemsDueNow())("lockedItemsDiscount",n.lockedItemsDiscount())("hasLockedItems",n.lockedItems().length>0)("hasSecuredItems",n.securedItems().length>0)("showCouponSection",n.showCouponSection())("selectedOption",n.selectedPaymentOption())("seasonCoupons",n.seasonCoupons())("userCoupons",n.userCoupons())("selectedCouponIds",n.selectedCouponIds())("couponsLoading",n.couponsLoading())("couponsValidating",n.couponsValidating())("couponError",n.couponValidationError())("couponSuccess",n.couponValidationSuccess())("orderSummary",n.orderSummaryData()),a(),g(n.showPaymentOverlay()?22:-1),a(),g(n.showCashInstructionOverlay()?23:-1))},dependencies:[A,ce,Oe,Y,Me,K,J],styles:[".ledger-page[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto;padding:1.5rem}.page-header[_ngcontent-%COMP%]{margin-bottom:1.5rem}.page-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1.75rem;color:var(--sys-on-surface, #212121)}.page-header[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{margin:0;color:var(--sys-on-surface-variant, #666);font-size:.95rem}.status-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.status-card-label[_ngcontent-%COMP%]{font-size:.75rem;font-weight:600;color:var(--sys-on-surface-variant, #666);letter-spacing:.05em;margin-bottom:1rem}.lock-timer-bar[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-top:1rem;padding:.75rem 1rem;background:var(--sys-surface-container, #f5f5f5);border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px}.lock-timer-bar.warning[_ngcontent-%COMP%]{background:#fff3cd;border-color:#ffc107}.lock-timer-bar.expired[_ngcontent-%COMP%]{background:#f8d7da;border-color:#dc3545}.timer-content[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.timer-icon[_ngcontent-%COMP%]{font-size:1.25rem}.timer-text[_ngcontent-%COMP%]{font-size:.9rem;color:var(--sys-on-surface, #212121)}.lock-timer-bar.warning[_ngcontent-%COMP%]   .timer-text[_ngcontent-%COMP%]{color:#664d03}.lock-timer-bar.expired[_ngcontent-%COMP%]   .timer-text[_ngcontent-%COMP%]{color:#721c24}.extend-btn[_ngcontent-%COMP%]{padding:.5rem 1rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:6px;font-weight:500;font-size:.875rem;cursor:pointer;transition:background .2s;white-space:nowrap}.extend-btn[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.extend-btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.ledger-layout[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 350px;gap:1.5rem;align-items:start}.main-column[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem}.agreement-links[_ngcontent-%COMP%]{display:flex;gap:1rem}.agreement-link[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.75rem 1rem;background:var(--sys-surface-container, #f5f5f5);border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;color:var(--sys-primary, #c62828);text-decoration:none;font-size:.875rem;font-weight:500;transition:all .2s}.agreement-link[_ngcontent-%COMP%]:hover{background:var(--sys-primary-container, #ffebee);border-color:var(--sys-primary, #c62828)}.agreement-link[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{opacity:.8}.rejection-notice[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:.75rem;padding:1rem;background:#fff3cd;border:1px solid #ffc107;border-left:4px solid #ff9800;border-radius:8px;margin-bottom:.5rem}.rejection-icon[_ngcontent-%COMP%]{font-size:1.25rem;line-height:1}.rejection-content[_ngcontent-%COMP%]{flex:1}.rejection-content[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{display:block;color:#856404;margin-bottom:.25rem}.rejection-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:#664d03;font-size:.9rem}.loading-state[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:2rem;color:var(--sys-on-surface-variant, #666)}.spinner[_ngcontent-%COMP%]{width:24px;height:24px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:3rem;background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;color:var(--sys-on-surface-variant, #666)}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 1rem}.btn-browse[_ngcontent-%COMP%]{padding:.75rem 1.5rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:background .2s}.btn-browse[_ngcontent-%COMP%]:hover{background:var(--sys-primary-dark, #a51c1c)}.sidebar-column[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;position:sticky;top:1rem}.overlay-backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:#0009;display:flex;align-items:center;justify-content:center;z-index:1000}.cash-instruction-modal[_ngcontent-%COMP%]{background:#fff;border-radius:16px;padding:1.5rem;max-width:680px;width:90%;max-height:90vh;overflow-y:auto;position:relative}.modal-close[_ngcontent-%COMP%]{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--sys-on-surface-variant, #666);line-height:1;padding:.25rem}.modal-close[_ngcontent-%COMP%]:hover{color:var(--sys-on-surface, #212121)}.cash-instruction-modal[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.25rem;color:var(--sys-on-surface, #212121)}.instruction-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 .75rem;color:var(--sys-on-surface-variant, #666);line-height:1.4}.in-person-emphasis[_ngcontent-%COMP%]{color:var(--sys-on-surface, #212121);font-weight:700}.payment-method[_ngcontent-%COMP%]{background:var(--sys-surface-container, #f5f5f5);border-radius:12px;padding:.875rem;margin-bottom:.75rem}.payment-method[_ngcontent-%COMP%]:last-child{margin-bottom:0}.payment-method[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1rem;color:var(--sys-on-surface, #212121)}.payment-method[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:.9rem}.payment-method[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]:last-child{margin-bottom:0}.qr-code[_ngcontent-%COMP%]{display:block;width:420px;height:478px;max-width:100%;object-fit:contain;margin:0 auto;border-radius:8px}.info-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.25rem}.section-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;cursor:pointer}.section-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600}.toggle-btn[_ngcontent-%COMP%]{background:none;border:none;font-size:.875rem;cursor:pointer;color:var(--sys-on-surface-variant, #666)}.payments-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;margin-top:1rem}.payments-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;padding:.75rem;background:#f8f9fa;border-bottom:2px solid #dee2e6;font-weight:600;font-size:.875rem}.payments-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem;border-bottom:1px solid #dee2e6;font-size:.875rem}.payments-table[_ngcontent-%COMP%]   .amount[_ngcontent-%COMP%]{font-weight:600}.method-badge[_ngcontent-%COMP%]{background:#6c757d;color:#fff;padding:.25rem .5rem;border-radius:4px;font-size:.75rem;text-transform:capitalize}.history-timeline[_ngcontent-%COMP%]{margin-top:1rem}.history-event[_ngcontent-%COMP%]{padding:.75rem 0;border-bottom:1px solid #eee}.history-event[_ngcontent-%COMP%]:last-child{border-bottom:none}.event-time[_ngcontent-%COMP%]{font-size:.75rem;color:#666;margin-bottom:.25rem}.event-action[_ngcontent-%COMP%]{font-weight:500}.event-metadata[_ngcontent-%COMP%]{font-size:.875rem;color:#666;margin-top:.25rem}.affected-items-list[_ngcontent-%COMP%]{margin:.5rem 0 0;padding:0;list-style:none}.affected-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.125rem;padding:.375rem 0;border-bottom:1px dashed #eee}.affected-item[_ngcontent-%COMP%]:last-child{border-bottom:none;padding-bottom:0}.item-class[_ngcontent-%COMP%]{font-size:.875rem;color:#333}.item-student[_ngcontent-%COMP%]{font-size:.75rem;color:#666}@media(max-width:900px){.ledger-layout[_ngcontent-%COMP%]{grid-template-columns:1fr}.sidebar-column[_ngcontent-%COMP%]{position:static;order:1}.cash-instruction-modal[_ngcontent-%COMP%]{padding:1rem;max-height:94vh}.qr-code[_ngcontent-%COMP%]{width:300px;height:341px}}"]})};export{ke as LedgerComponent};
