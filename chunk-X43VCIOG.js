import{a as Je}from"./chunk-67R2YGLJ.js";import{c as Ue,f as ke,i as Fe,j as We,k as Le,q as je}from"./chunk-QKJF4FOC.js";import{c as Ge}from"./chunk-RYIKU5Y3.js";import{H as ge,V as Re,W as De,Y as Te,Z as he,ea as x,h as Ne,ja as Oe,ka as Me,n as Ie,na as $e,q as me,ra as Be,s as Ae}from"./chunk-T5UFPD4P.js";import{Ba as j,Da as K,F as q,Ia as pe,Ka as ue,Oa as Pe,_ as F,aa as M,db as $,gb as W,ha as Z,wa as ve}from"./chunk-CIPCES67.js";import{$a as v,Ba as Se,Bb as Ee,Db as h,Ea as f,Eb as z,Fb as be,N as B,Qa as Ce,S as G,T as U,ab as P,da as N,db as le,eb as ce,fb as O,gb as p,hb as u,ib as _e,ob as xe,qb as k,sb as I,zb as we}from"./chunk-CNMR2ZL6.js";import{a as de,b as fe}from"./chunk-Q7L6LLAK.js";var ot=50,at=30,H=class{constructor(t){this.firestore=t}getErrorCode(t){if(typeof t!="object"||t===null)return null;let e=t.code;return typeof e=="string"?e:null}async loadSeasonRaw(t){let e=M(this.firestore,`years/${2026}/seasons`,t),o=await $(e);if(!o.exists())throw new Error(`Season ${t} not found`);return o.data()}async loadSeason(t){let e=await this.loadSeasonRaw(t);return ge(e)}async loadOrders(t,e,o=ot){let s=[],r=F(this.firestore,`years/${2026}/seasons/${t}/orders`),a=null,d=0;for(;;){d++,e({step:"Loading orders...",detail:`batch ${d}`});let i=a?j(r,pe("userAuthId"),ue(o),Pe(a)):j(r,pe("userAuthId"),ue(o)),l=await W(i);for(let m of l.docs)s.push(m.data());if(l.size<o)break;a=l.docs[l.docs.length-1]}return s}async loadUsers(t,e,o=at){let s=new Map,r=[...new Set(t)];if(r.length===0)return s;let a=F(this.firestore,"users"),d=Math.ceil(r.length/o);for(let i=0;i<r.length;i+=o){let l=Math.floor(i/o)+1;e({step:"Loading user data...",detail:`batch ${l} of ${d}`});let m=r.slice(i,i+o),_=j(a,K(ve(),"in",m)),g=await W(_);for(let y of g.docs){let S=y.data();s.set(S.uid,S)}}return s}async loadRegistration(t){let e=M(this.firestore,`years/${2026}/registrations`,t),o=await $(e);return o.exists()?o.data():null}async loadSystemConfig(){let t=M(this.firestore,"system","config"),e=await $(t);return e.exists()?e.data():null}async loadAdminUserCache(){let t=M(this.firestore,"admin","userCache"),e=await $(t);return e.exists()?e.data():null}async loadAdminEmailTemplates(){let t=M(this.firestore,"admin","email","templates","all_templates"),e=await $(t);return e.exists()?e.data():null}async loadAdminEmailSeasonTemplateStats(t){let e=F(this.firestore,"admin","email","season_template_stats"),o=j(e,K("seasonId","==",t));return(await W(o)).docs.map(r=>r.data())}async loadAdminEmailBatchJobs(t){let e=F(this.firestore,"admin","email","batch_jobs"),o=j(e,K("seasonId","==",t));return(await W(o)).docs.map(r=>r.data())}async loadCounters(){let t=F(this.firestore,"system","counters","entities"),e=await W(t);if(e.size>0)return e.docs.map(r=>({id:r.id,data:r.data()}));let o=M(this.firestore,"system","counters"),s=await $(o);return s.exists()?[{id:s.id,data:s.data()}]:[]}async loadCoupons(t,e){let o=[],s=F(this.firestore,"coupons"),r=await W(s);for(let i of r.docs)o.push(i.data());let a=new Set(o.map(i=>i.id));for(let i of t.coupons??[])a.has(i.id)||(o.push(i),a.add(i.id));let d=new Set;for(let i of e)for(let l of i.appliedCouponIds??[])a.has(l)||d.add(l);for(let i of d){let l=M(this.firestore,"coupons",i),m=await $(l);if(m.exists()){let _=m.data();a.has(_.id)||(o.push(_),a.add(_.id))}}return o}async loadAllData(t,e){e({step:"Loading season data..."});let o=await this.loadSeasonRaw(t),s=ge(o),r=await this.loadOrders(t,e),a=r.map(c=>c.userAuthId),d=await this.loadUsers(a,e);e({step:"Loading registration data..."});let i=await this.loadRegistration(t);e({step:"Loading coupon data..."});let l=await this.loadCoupons(s,r);e({step:"Loading system config..."});let m=null;try{m=await this.loadSystemConfig()}catch(c){if(this.getErrorCode(c)!=="permission-denied")throw c;e({step:"Skipping system config (permission denied)"})}e({step:"Loading admin cache..."});let _=null;try{_=await this.loadAdminUserCache()}catch(c){if(this.getErrorCode(c)!=="permission-denied")throw c;e({step:"Skipping admin cache (permission denied)"})}e({step:"Loading system counters..."});let g=[];try{g=await this.loadCounters()}catch(c){if(this.getErrorCode(c)!=="permission-denied")throw c;e({step:"Skipping system counters (permission denied)"})}e({step:"Loading admin email templates..."});let y=null;try{y=await this.loadAdminEmailTemplates()}catch(c){if(this.getErrorCode(c)!=="permission-denied")throw c;e({step:"Skipping admin email templates (permission denied)"})}e({step:"Loading admin email season stats..."});let S=[];try{S=await this.loadAdminEmailSeasonTemplateStats(t)}catch(c){if(this.getErrorCode(c)!=="permission-denied")throw c;e({step:"Skipping admin email season stats (permission denied)"})}e({step:"Loading admin email batch jobs..."});let C=[];try{C=await this.loadAdminEmailBatchJobs(t)}catch(c){if(this.getErrorCode(c)!=="permission-denied")throw c;e({step:"Skipping admin email batch jobs (permission denied)"})}return{seasonRaw:o,season:s,orders:r,users:d,registration:i,coupons:l,systemConfig:m,adminUserCache:_,counters:g,adminEmailTemplates:y,adminEmailSeasonTemplateStats:S,adminEmailBatchJobs:C}}};var X="https://sheets.googleapis.com/v4/spreadsheets",Q=null,ee=0,it=3300*1e3;var te=class{sheetIdCache=new Map;async acquireAccessToken(){if(Q&&Date.now()<ee)return x("[GoogleSheets] Using cached access token (expires in",Math.round((ee-Date.now())/1e3/60),"minutes)"),Q;x("[GoogleSheets] Acquiring new access token via OAuth popup...");let t=new me;t.addScope("https://www.googleapis.com/auth/spreadsheets"),x("[GoogleSheets] Opening sign-in popup...");let e=await Ae(Be,t);x("[GoogleSheets] Sign-in popup completed, user:",e.user?.email);let o=me.credentialFromResult(e);if(x("[GoogleSheets] Credential extracted:",o?"success":"null"),!o)throw console.error("[GoogleSheets] Failed to obtain Google credentials from result:",e),new Error("Failed to obtain Google credentials");let s=o.accessToken;if(x("[GoogleSheets] Access token present:",!!s),!s)throw console.error("[GoogleSheets] Credential has no accessToken. Credential type:",o.providerId),new Error("Failed to obtain access token");return Q=s,ee=Date.now()+it,x("[GoogleSheets] Access token cached successfully"),s}clearCachedToken(){x("[GoogleSheets] Clearing cached access token"),Q=null,ee=0}async createSpreadsheet(t,e,o){x("[GoogleSheets] Creating spreadsheet:",{title:t,sheetNames:e}),x("[GoogleSheets] Access token length:",o?.length||0);let s={properties:{title:t},sheets:e.map(d=>({properties:{title:d}}))};x("[GoogleSheets] Request body:",JSON.stringify(s));let r;try{r=await fetch(X,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(s)})}catch(d){throw console.error("[GoogleSheets] Network error during createSpreadsheet:",d),new Error(`Network error creating spreadsheet: ${d instanceof Error?d.message:String(d)}`)}if(x("[GoogleSheets] createSpreadsheet response status:",r.status,r.statusText),!r.ok){let d=await r.text();throw console.error("[GoogleSheets] createSpreadsheet API error:",{status:r.status,statusText:r.statusText,errorText:d,headers:Object.fromEntries(r.headers.entries())}),(r.status===401||r.status===403)&&(x("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${r.status}): ${d}`)}let a=await r.json();return x("[GoogleSheets] Spreadsheet created successfully:",{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}),{spreadsheetId:a.spreadsheetId,spreadsheetUrl:a.spreadsheetUrl}}async writeSheetData(t,e,o,s){x("[GoogleSheets] Writing sheet data:",{spreadsheetId:t,sheetName:e,rowCount:o.length,columnCount:o[0]?.length||0});let r=encodeURIComponent(e),a=`${X}/${t}/values/${r}?valueInputOption=RAW`,d;try{d=await fetch(a,{method:"PUT",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({range:e,majorDimension:"ROWS",values:o})})}catch(i){throw console.error("[GoogleSheets] Network error during writeSheetData:",i),new Error(`Network error writing sheet data: ${i instanceof Error?i.message:String(i)}`)}if(x("[GoogleSheets] writeSheetData response status:",d.status,d.statusText),!d.ok){let i=await d.text();throw console.error("[GoogleSheets] writeSheetData API error:",{status:d.status,statusText:d.statusText,errorText:i,sheetName:e}),(d.status===401||d.status===403)&&(x("[GoogleSheets] Auth error detected, clearing cached token"),this.clearCachedToken()),new Error(`Google Sheets API error (${d.status}): ${i}`)}x("[GoogleSheets] Sheet data written successfully:",e)}async applyHeaderStyles(t,e,o,s){let r=[...new Set(o)].filter(l=>l>=0);if(r.length===0)return;let a=await this.resolveSheetId(t,e,s),d=r.map(l=>({repeatCell:{range:{sheetId:a,startRowIndex:l,endRowIndex:l+1},cell:{userEnteredFormat:{backgroundColor:{red:.68,green:.16,blue:.16},horizontalAlignment:"CENTER",textFormat:{bold:!0,foregroundColor:{red:1,green:1,blue:1}}}},fields:"userEnteredFormat(backgroundColor,textFormat,horizontalAlignment)"}})),i;try{i=await fetch(`${X}/${t}:batchUpdate`,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({requests:d})})}catch(l){throw new Error(`Network error styling sheet: ${l instanceof Error?l.message:String(l)}`)}if(!i.ok){let l=await i.text();throw(i.status===401||i.status===403)&&this.clearCachedToken(),new Error(`Google Sheets API error (${i.status}): ${l}`)}}async resolveSheetId(t,e,o){let s=`${t}:${e}`,r=this.sheetIdCache.get(s);if(typeof r=="number")return r;let a;try{a=await fetch(`${X}/${t}?fields=sheets(properties(sheetId,title))`,{method:"GET",headers:{Authorization:`Bearer ${o}`}})}catch(l){throw new Error(`Network error resolving sheet id: ${l instanceof Error?l.message:String(l)}`)}if(!a.ok){let l=await a.text();throw(a.status===401||a.status===403)&&this.clearCachedToken(),new Error(`Google Sheets API error (${a.status}): ${l}`)}let i=(await a.json()).sheets?.find(l=>l.properties?.title===e)?.properties;if(typeof i?.sheetId!="number")throw new Error(`Unable to find sheet id for "${e}"`);return this.sheetIdCache.set(s,i.sheetId),i.sheetId}};function T(n){return`$${(n/100).toFixed(2)}`}function re(n,t,e){let o=n.get(t);return o?(o.students??[]).find(s=>s.id===e)??null:null}function dt(n,t){return n.sessions.find(e=>e.id===t)?.name??t}function ye(n){return JSON.stringify(n??null)}function V(n,t=", "){return n.filter(e=>typeof e=="string"&&e.trim().length>0).join(t)}function se(n,t){return V([n??"",t??""]," ").trim()}function lt(n){return n.lunch&&n.extendedCare?"Lunch + Extended Care":n.lunch?"Lunch":n.extendedCare?"Extended Care":"None"}function oe(n){let t=/^(\d{4})-(\d{2})-(\d{2})$/.exec(n);if(!t)return null;let e=Number(t[1]),o=Number(t[2]),s=Number(t[3]),r=new Date(Date.UTC(e,o-1,s));return r.getUTCFullYear()!==e||r.getUTCMonth()!==o-1||r.getUTCDate()!==s?null:r}function ct(n,t,e){let o=/^\d{4}-(\d{2})-(\d{2})$/.exec(n);if(!o)return!1;let s=Number(o[1]),r=Number(o[2]),a=oe(t),d=oe(e);if(!a||!d)return!1;let i=new Set([a.getUTCFullYear(),d.getUTCFullYear()]);for(let l of i){let m=new Date(Date.UTC(l,s-1,r));if(!(m.getUTCMonth()!==s-1||m.getUTCDate()!==r)&&m>=a&&m<=d)return!0}return!1}function mt(n,t){let e=oe(n),o=oe(t);if(!e||!o)return"";let s=o.getUTCFullYear()-e.getUTCFullYear(),r=o.getUTCMonth()-e.getUTCMonth(),a=o.getUTCDate()-e.getUTCDate();return(r<0||r===0&&a<0)&&(s-=1),String(Math.max(s,0))}var Y=4;function pt(n){let t=new Map,o=n.sessions.map(s=>s.name).map(s=>s.toLowerCase());return n.sessions.forEach((s,r)=>{let a=s.name,d=o[r]??"",i=a;for(let l=1;l<=a.length;l+=1){let m=a.slice(0,l),_=d.slice(0,l);if(o.every((y,S)=>S===r||!y.startsWith(_))){i=m;break}}t.set(s.id,i.trim())}),t}function ze(n,t,e){if(n.length===0)return"No";let o=n.filter(r=>r.options[t]);if(o.length===0)return"No";if(o.length===n.length)return"Yes";let s=o.map(r=>e.get(r.sessionId)??r.sessionId);return`${o.length}(${s.join(",")})`}function ne(n){return[`Student${n}Name`,`Student${n}DOB`,`Student${n}Gender`,`Student${n}School`,`Student${n}Allergies`,`Student${n}Notes`,`Student${n}Sessions`,`Student${n}Lunch`,`Student${n}EC`,`Student${n}Subtotal`]}function He(n,t,e){let o=["Order User Display ID","ParentName","ParentEmail","PrimaryPhone","PrimaryWeChatID","PrimaryWeChatName","SecondaryName","SecondaryPhone","SecondaryWeChatID","SecondaryWeChatName",...ne(1),...ne(2),...ne(3),...ne(4),"Order Discount","Order Total"],s=[],r=new Map;e.sessions.forEach((i,l)=>{r.set(i.id,l)});let a=pt(e);for(let i of n){let l=t.get(i.userAuthId);if((l?.students??[]).length>Y)throw new Error(`Orders export supports at most ${Y} students per user. Found ${(l?.students??[]).length} for ${i.userDisplayId}.`);let m=se(l?.primaryGuardian?.firstName??"",l?.primaryGuardian?.lastName??"")||(l?.displayName??""),_=i.items.filter(w=>w.cancelledAt==null),g=new Map;for(let w of _){let E=g.get(w.studentId)??[];E.push(w),g.set(w.studentId,E)}if(g.size>Y)throw new Error(`Orders export supports at most ${Y} enrolled students per user. Found ${g.size} for ${i.userDisplayId}.`);if(g.size===0)continue;let y=De(i.pricing?.discounts??[]),S=he(i),C=[...g.keys()].sort((w,E)=>{let D=re(t,i.userAuthId,w),R=D?`${D.firstName} ${D.lastName}`.trim():"",b=re(t,i.userAuthId,E),ae=b?`${b.firstName} ${b.lastName}`.trim():"";return R.localeCompare(ae)}),c=[i.userDisplayId,m,l?.email??"",l?.primaryGuardian?.phone??"",l?.primaryGuardian?.wechatId??"",l?.primaryGuardian?.wechatName??"",se(l?.secondaryGuardian?.firstName??"",l?.secondaryGuardian?.lastName??""),l?.secondaryGuardian?.phone??"",l?.secondaryGuardian?.wechatId??"",l?.secondaryGuardian?.wechatName??""],A=[];for(let w=0;w<Y;w+=1){let E=C[w];if(!E){A.push("","","","","","","","","","");continue}let R=[...g.get(E)??[]].sort((L,ie)=>{let rt=r.get(L.sessionId)??Number.MAX_SAFE_INTEGER,st=r.get(ie.sessionId)??Number.MAX_SAFE_INTEGER;return rt-st}),b=re(t,i.userAuthId,E),ae=R.map(L=>a.get(L.sessionId)??L.sessionId),tt=V([b?.dietaryNotes?`Dietary:${b.dietaryNotes}`:"",b?.medicalNotes?`Medical:${b.medicalNotes}`:""]," | "),nt=R.reduce((L,ie)=>L+ie.snapshot.priceSnapshot.itemTotal,0);A.push(b?`${b.firstName} ${b.lastName}`.trim():E,b?.dob??"",b?.gender??"",b?.school??"",b?.allergies??"",tt,ae.join(","),ze(R,"lunch",a),ze(R,"extendedCare",a),T(nt))}s.push({parentName:m,row:[...c,...A,T(Math.abs(y)),T(S)]})}s.sort((i,l)=>i.parentName.localeCompare(l.parentName));let d=s.map(i=>i.row);return[o,...d]}function Ye(n,t){let e=["User Display ID","Parent Name","Parent Email","Order Total","Coupon Discount","Total Paid","Balance Due","Payment Count","Payment Details","Refund Total"],o=[];for(let s of n){if(!s.items.some(y=>y.status==="submitted"||y.status==="paid"))continue;let a=t.get(s.userAuthId),d=he(s),i=s.couponDiscount??0,l=s.totalPaid??0,m=Te(s),_=Re(s),g=(s.payments??[]).map(y=>`${y.method} ${T(y.amount)} ${y.recordedAt}${y.reference?` ref:${y.reference}`:""}`).join("; ");o.push([s.userDisplayId,a?.displayName??"",a?.email??"",T(d),T(i),T(l),T(_),String((s.payments??[]).length),g,T(m)])}return[e,...o]}function Ve(n,t){let e=["Coupon ID","Name","Description","Type","Max Credit (cents)","Eligible Emails","Used By (Order Count)"],o=new Map;for(let r of t)for(let a of r.appliedCouponIds??[])o.set(a,(o.get(a)??0)+1);let s=n.map(r=>[r.id,r.name,r.description,r.coupon_type,String(r.maxCreditCents),(r.eligible_emails??[]).join(", "),String(o.get(r.id)??0)]);return[e,...s]}function qe(n,t,e){let o=["User Display ID","Parent Name","Parent Email","Session ID","Session Name","Joined At"],s=[];for(let r of n){let a=t.get(r.userAuthId);for(let d of r.waitlist??[])s.push([r.userDisplayId,a?.displayName??"",a?.email??"",d.sessionId,dt(e,d.sessionId),d.joinedAt])}return[o,...s]}function Ze(n,t,e){let o=["ParentName","ParentPhone","Parent WeChat ID(s)","Parent WeChat Name(s)","Child","Add-on","Allergies","Notes","Age"],s=new Map;for(let a of t){let d=e.get(a.userAuthId),i=se(d?.primaryGuardian?.firstName??"",d?.primaryGuardian?.lastName??"")||(d?.displayName??""),l=[];d?.primaryGuardian?.phone&&l.push(d.primaryGuardian.phone);let m=se(d?.secondaryGuardian?.firstName??"",d?.secondaryGuardian?.lastName??"");(m||d?.secondaryGuardian?.phone)&&(m&&d?.secondaryGuardian?.phone?l.push(`${m} (${d.secondaryGuardian.phone})`):m?l.push(m):d?.secondaryGuardian?.phone&&l.push(d.secondaryGuardian.phone)),(d?.emergencyContact?.name||d?.emergencyContact?.phone)&&(d?.emergencyContact?.name&&d?.emergencyContact?.phone?l.push(`${d.emergencyContact.name}(${d.emergencyContact.phone})`):d?.emergencyContact?.name?l.push(d.emergencyContact.name):d?.emergencyContact?.phone&&l.push(d.emergencyContact.phone));let _=l.join(", "),g=V([d?.primaryGuardian?.wechatId??"",d?.secondaryGuardian?.wechatId??""]," / "),y=V([d?.primaryGuardian?.wechatName??"",d?.secondaryGuardian?.wechatName??""]," / ");for(let S of a.items){if(S.cancelledAt!=null)continue;let C=n.sessions.find(R=>R.id===S.sessionId);if(!C)continue;let c=re(e,a.userAuthId,S.studentId),A=c?`${c.firstName} ${c.lastName}`.trim():S.snapshot.studentName??S.studentId,w=c?.dob?ct(c.dob,C.startDate,C.endDate):!1,E=V([c?.dietaryNotes?`Dietary: ${c.dietaryNotes}`:"",c?.medicalNotes?`Medical: ${c.medicalNotes}`:""]," | "),D=s.get(S.sessionId)??[];D.push({parentName:i,parentPhone:_,parentWeChatIds:g,parentWeChatNames:y,childName:`${A}${w?" \u{1F382}":""}`,addons:lt(S.options),allergies:c?.allergies??"",notes:E,age:c?.dob?mt(c.dob,C.startDate):""}),s.set(S.sessionId,D)}}let r=[];for(let a of n.sessions){r.push([`\u2728 ${a.name} \u2022 Weekly Student Table`]),r.push(["Session",a.name]),r.push(o);let d=(s.get(a.id)??[]).sort((i,l)=>i.childName.localeCompare(l.childName));if(d.length===0)r.push(["(No enrolled students)","","","","","","","",""]);else for(let i of d)r.push([i.parentName,i.parentPhone,i.parentWeChatIds,i.parentWeChatNames,i.childName,i.addons,i.allergies,i.notes,i.age]);r.push([""])}return r}var ut={studentId:"Student ID",studentFirstName:"Student First Name",studentLastName:"Student Last Name",studentDob:"Student DOB",studentGender:"Student Gender",studentAllergies:"Student Allergies",studentDietaryNotes:"Student Dietary Notes",studentMedicalNotes:"Student Medical Notes",studentSchool:"Student School",studentLastCampYear:"Student Last Camp Year",studentGrade:"Student Grade",studentReferCode:"Student Refer Code",parentDisplayId:"Parent Display ID",parentEmail:"Parent Email",parentDisplayName:"Parent Display Name",primaryFirstName:"Primary First Name",primaryLastName:"Primary Last Name",primaryPhone:"Primary Phone",primaryWechatId:"Primary WeChat ID",primaryWechatName:"Primary WeChat Name",secondaryFirstName:"Secondary First Name",secondaryLastName:"Secondary Last Name",secondaryPhone:"Secondary Phone",emergencyName:"Emergency Contact Name",emergencyPhone:"Emergency Contact Phone",emergencyRelationship:"Emergency Contact Relationship"};function gt(n,t){return{studentId:n.id,studentFirstName:n.firstName,studentLastName:n.lastName,studentDob:n.dob,studentGender:n.gender,studentAllergies:n.allergies,studentDietaryNotes:n.dietaryNotes??"",studentMedicalNotes:n.medicalNotes??"",studentSchool:n.school??"",studentLastCampYear:n.lastCampYear??"",studentGrade:n.grade??"",studentReferCode:n.referCode??"",parentDisplayId:t.displayId,parentEmail:t.email,parentDisplayName:t.displayName,primaryFirstName:t.primaryGuardian?.firstName??"",primaryLastName:t.primaryGuardian?.lastName??"",primaryPhone:t.primaryGuardian?.phone??"",primaryWechatId:t.primaryGuardian?.wechatId??"",primaryWechatName:t.primaryGuardian?.wechatName??"",secondaryFirstName:t.secondaryGuardian?.firstName??"",secondaryLastName:t.secondaryGuardian?.lastName??"",secondaryPhone:t.secondaryGuardian?.phone??"",emergencyName:t.emergencyContact?.name??"",emergencyPhone:t.emergencyContact?.phone??"",emergencyRelationship:t.emergencyContact?.relationship??""}}function Ke(n){let t=[];for(let s of n.values())for(let r of s.students??[])t.push({student:r,user:s});t.sort((s,r)=>{let a=s.user.displayId.localeCompare(r.user.displayId);return a!==0?a:s.student.id.localeCompare(r.student.id)});let e=Object.values(ut),o=t.map(({student:s,user:r})=>Object.values(gt(s,r)));return[e,...o]}var ht={isSystemInitialized:"System Initialized",currentDate:"Current Date",currentTime:"Current Time",allowEnrollment:"Allow Enrollment",maintenanceMode:"Maintenance Mode",financials:"Financials (JSON)",paymentInstructions:"Payment Instructions",returnInstructions:"Return Instructions",releaseAgreementContent:"Release Agreement Content",mediaPolicyContent:"Media Policy Content",formsPageContent:"Forms Page Content",contactEmail:"Contact Email",contactPhone:"Contact Phone",contactAddress:"Contact Address",waitlistLastRecalculationAt:"Waitlist Last Recalculation",waitlistRaw:"Waitlist Config (JSON)"};function yt(n){return{isSystemInitialized:n.isSystemInitialized?"Yes":"No",currentDate:n.currentDate,currentTime:n.currentTime,allowEnrollment:n.systemSwitch.allowEnrollment?"Yes":"No",maintenanceMode:n.systemSwitch.maintenanceMode?"Yes":"No",financials:ye(n.financials),paymentInstructions:n.paymentInstructions.content,returnInstructions:n.returnInstructions?.content??"",releaseAgreementContent:n.releaseAgreementContent?.content??"",mediaPolicyContent:n.mediaPolicyContent?.content??"",formsPageContent:n.formsPageContent?.content??"",contactEmail:n.contactInfo.email,contactPhone:n.contactInfo.phone,contactAddress:n.contactInfo.address??"",waitlistLastRecalculationAt:n.waitlist?.lastRecalculationAt??"",waitlistRaw:ye(n.waitlist??null)}}function Xe(n){let t=Object.values(ht),e=Object.values(yt(n));return[t,e]}function Qe(n){let t=["Key","Value"],e=[["exportedAt",n.exportedAt],["year",String(n.year)],["seasonId",n.seasonId],["seasonName",n.seasonName],["counts",ye(n.counts)]];return[t,...e]}var ft=(n,t)=>t.id,St=(n,t)=>t.label;function Ct(n,t){n&1&&(p(0,"div",3),_e(1,"div",4),p(2,"p"),h(3,"Loading seasons..."),u()())}function _t(n,t){if(n&1&&(p(0,"option",10),h(1),u()),n&2){let e=t.$implicit;O("value",e.id),f(),z(e.name)}}function xt(n,t){n&1&&h(0," Exporting... ")}function wt(n,t){n&1&&h(0," Download JSON File ")}function Et(n,t){n&1&&h(0," Export to Google Sheets ")}function bt(n,t){n&1&&h(0," \u25CB ")}function Nt(n,t){n&1&&h(0," \u25CC ")}function It(n,t){n&1&&h(0," \u2713 ")}function At(n,t){n&1&&h(0," \u2717 ")}function vt(n,t){if(n&1&&(p(0,"span",28),h(1),u()),n&2){let e=I().$implicit;f(),be("(",e.detail,")")}}function Pt(n,t){if(n&1&&(p(0,"div",25)(1,"span",26),v(2,bt,1,0)(3,Nt,1,0)(4,It,1,0)(5,At,1,0),u(),p(6,"span",27),h(7),u(),v(8,vt,2,1,"span",28),u()),n&2){let e,o=t.$implicit;Ee("step-pending",o.status==="pending")("step-in-progress",o.status==="in-progress")("step-completed",o.status==="completed")("step-error",o.status==="error"),f(2),P((e=o.status)==="pending"?2:e==="in-progress"?3:e==="completed"?4:e==="error"?5:-1),f(5),z(o.label),f(),P(o.detail?8:-1)}}function Rt(n,t){if(n&1&&(p(0,"div",17)(1,"h3"),h(2,"Export Progress"),u(),p(3,"div",23),le(4,Pt,9,11,"div",24,St),u()()),n&2){let e=I(2);f(4),ce(e.steps())}}function Dt(n,t){n&1&&h(0," Importing... ")}function Tt(n,t){n&1&&h(0," Select JSON File to Import ")}function Ot(n,t){if(n&1&&(p(0,"div",21)(1,"div",29),h(2,"\u2713"),u(),p(3,"h3"),h(4,"Export Complete"),u(),p(5,"a",30),h(6," Open Spreadsheet \u2192 "),u()()),n&2){let e=I(2);f(5),O("href",e.spreadsheetUrl(),Se)}}function Mt(n,t){n&1&&(p(0,"div",21)(1,"div",29),h(2,"\u2713"),u(),p(3,"h3"),h(4,"JSON Export Complete"),u(),p(5,"p"),h(6,"The file has been downloaded to your device."),u()())}function $t(n,t){if(n&1&&(p(0,"div",21)(1,"div",29),h(2,"\u2713"),u(),p(3,"h3"),h(4,"Import Complete"),u(),p(5,"p"),h(6),u()()),n&2){let e=I(2);f(6),z(e.importSummary())}}function Gt(n,t){if(n&1&&(p(0,"div",22)(1,"p",31),h(2),u()()),n&2){let e=I(2);f(2),z(e.error())}}function Ut(n,t){if(n&1){let e=xe();p(0,"div",5)(1,"h3"),h(2,"Export Season Data"),u(),p(3,"div",6)(4,"label",7),h(5,"Select Season"),u(),p(6,"select",8),k("ngModelChange",function(s){G(e);let r=I();return U(r.onSeasonChange(s))}),p(7,"option",9),h(8,"-- Select a season --"),u(),le(9,_t,2,2,"option",10,ft),u()(),p(11,"div",11)(12,"label"),h(13,"Export Format"),u(),p(14,"div",12)(15,"label",13)(16,"input",14),k("change",function(){G(e);let s=I();return U(s.onFormatChange("google-sheets"))}),u(),p(17,"span"),h(18,"Google Sheets"),u()(),p(19,"label",13)(20,"input",15),k("change",function(){G(e);let s=I();return U(s.onFormatChange("json"))}),u(),p(21,"span"),h(22,"JSON File"),u()()()(),p(23,"button",16),k("click",function(){G(e);let s=I();return U(s.startExport())}),v(24,xt,1,0)(25,wt,1,0)(26,Et,1,0),u()(),v(27,Rt,6,0,"div",17),p(28,"div",5)(29,"h3"),h(30,"Import from JSON"),u(),p(31,"p",18),h(32," Import season data from a previously exported JSON file. "),u(),p(33,"input",19,0),k("change",function(s){G(e);let r=I();return U(r.onFileSelected(s))}),u(),p(35,"button",20),k("click",function(){G(e);let s=we(34);return U(s.click())}),v(36,Dt,1,0)(37,Tt,1,0),u()(),v(38,Ot,7,1,"div",21),v(39,Mt,7,0,"div",21),v(40,$t,7,1,"div",21),v(41,Gt,3,1,"div",22)}if(n&2){let e=I();f(6),O("ngModel",e.selectedSeasonId()),f(3),ce(e.seasons()),f(7),O("checked",e.exportFormat()==="google-sheets"),f(4),O("checked",e.exportFormat()==="json"),f(3),O("disabled",!e.selectedSeasonId()||e.exporting()),f(),P(e.exporting()?24:e.exportFormat()==="json"?25:26),f(3),P(e.steps().length>0?27:-1),f(8),O("disabled",e.importing()),f(),P(e.importing()?36:37),f(2),P(e.spreadsheetUrl()?38:-1),f(),P(e.jsonExportComplete()?39:-1),f(),P(e.importComplete()?40:-1),f(),P(e.error()?41:-1)}}var et=class n{router=B(Ie);userService=B($e);configService=B(Oe);seasonService=B(Me);_steps=N([]);_selectedSeasonId=N(null);_exporting=N(!1);_spreadsheetUrl=N(null);_error=N(null);_loadingSeasons=N(!1);_exportFormat=N("google-sheets");_jsonExportComplete=N(!1);_importing=N(!1);_importComplete=N(!1);_importSummary=N("");steps=this._steps.asReadonly();selectedSeasonId=this._selectedSeasonId.asReadonly();exporting=this._exporting.asReadonly();spreadsheetUrl=this._spreadsheetUrl.asReadonly();error=this._error.asReadonly();loadingSeasons=this._loadingSeasons.asReadonly();exportFormat=this._exportFormat.asReadonly();jsonExportComplete=this._jsonExportComplete.asReadonly();importing=this._importing.asReadonly();importComplete=this._importComplete.asReadonly();importSummary=this._importSummary.asReadonly();seasons=this.seasonService.seasons;async ngOnInit(){if(!this.userService.isAuthenticated()){this.router.navigate(["/login"]);return}if(!this.userService.isAdmin()){this.router.navigate(["/"]);return}this._loadingSeasons.set(!0);try{await this.seasonService.loadAllSeasons()}catch(t){this._error.set(t instanceof Error?t.message:"Failed to load seasons")}finally{this._loadingSeasons.set(!1)}}onSeasonChange(t){this._selectedSeasonId.set(t||null),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([]),this._jsonExportComplete.set(!1)}onFormatChange(t){this._exportFormat.set(t),this._spreadsheetUrl.set(null),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([])}async startExport(){return this._exportFormat()==="json"?this.startJsonExport():this.startGoogleSheetsExport()}async startJsonExport(){let t=this._selectedSeasonId();if(t){this._exporting.set(!0),this._jsonExportComplete.set(!1),this._error.set(null),this._steps.set([{label:"Loading data from Firestore",status:"pending"},{label:"Generating JSON file",status:"pending"}]);try{this.updateStep(0,"in-progress");let e=Z(q()),s=await new H(e).loadAllData(t,m=>{this.updateStep(0,"in-progress",m.detail??m.step)});this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let r={exportedAt:new Date().toISOString(),year:2026,seasonId:t,season:s.season,orders:s.orders,users:Object.fromEntries(s.users),registration:s.registration,coupons:s.coupons,systemConfig:s.systemConfig,adminUserCache:s.adminUserCache,counters:s.counters,adminEmailTemplates:s.adminEmailTemplates,adminEmailSeasonTemplateStats:s.adminEmailSeasonTemplateStats,adminEmailBatchJobs:s.adminEmailBatchJobs},a=JSON.stringify(r,null,2),d=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(d),l=document.createElement("a");l.href=i,l.download=`${s.season.name.replace(/[^a-zA-Z0-9]/g,"-")}-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(i),this.updateStep(1,"completed"),this._jsonExportComplete.set(!0)}catch(e){let o=this.formatExportError(e),s=this._steps().findIndex(r=>r.status==="in-progress");s>=0&&this.updateStep(s,"error",o),this._error.set(o),console.error("[AdminExport] JSON export failed",e)}finally{this._exporting.set(!1)}}}async startGoogleSheetsExport(){let t=this._selectedSeasonId();if(t){this._exporting.set(!0),this._spreadsheetUrl.set(null),this._error.set(null),this._steps.set([{label:"Authenticating with Google",status:"pending"},{label:"Loading data from Firestore",status:"pending"},{label:"Building spreadsheet data",status:"pending"},{label:"Creating Google Spreadsheet",status:"pending"},{label:"Writing sheet data",status:"pending"}]);try{this.updateStep(0,"in-progress");let e=new te,o=await e.acquireAccessToken();this.updateStep(0,"completed"),this.updateStep(1,"in-progress");let s=Z(q()),a=await new H(s).loadAllData(t,g=>{this.updateStep(1,"in-progress",g.detail??g.step)});this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let d=de({Meta:Qe({exportedAt:new Date().toISOString(),year:2026,seasonId:a.season.id,seasonName:a.season.name,counts:{orders:a.orders.length,users:a.users.size,coupons:a.coupons.length,counters:a.counters.length,hasRegistration:a.registration?1:0,hasSystemConfig:a.systemConfig?1:0,hasAdminUserCache:a.adminUserCache?1:0,hasAdminEmailTemplates:a.adminEmailTemplates?1:0,adminEmailSeasonTemplateStats:a.adminEmailSeasonTemplateStats.length,adminEmailBatchJobs:a.adminEmailBatchJobs.length}}),Orders:He(a.orders,a.users,a.season),Payments:Ye(a.orders,a.users),Coupons:Ve(a.coupons,a.orders),Waitlist:qe(a.orders,a.users,a.season),"Weekly Student":Ze(a.season,a.orders,a.users),Students:Ke(a.users)},a.systemConfig?{SystemConfig:Xe(a.systemConfig)}:{}),i=d["Weekly Student"]?.reduce((g,y,S)=>{let C=y[0]??"";return(C.startsWith("\u2728 ")||C==="ParentName")&&g.push(S),g},[])??[];this.updateStep(2,"completed"),this.updateStep(3,"in-progress");let l=`${a.season.name} \u2014 Export ${Ge(new Date().toISOString())}`,m=Object.keys(d),_=await e.createSpreadsheet(l,m,o);this.updateStep(3,"completed"),this.updateStep(4,"in-progress");for(let[g,y]of Object.entries(d))this.updateStep(4,"in-progress",`Writing ${g}...`),await e.writeSheetData(_.spreadsheetId,g,y,o),g==="Weekly Student"&&await e.applyHeaderStyles(_.spreadsheetId,g,i,o);this.updateStep(4,"completed"),this._spreadsheetUrl.set(_.spreadsheetUrl)}catch(e){let o=this.formatExportError(e),s=this._steps().findIndex(r=>r.status==="in-progress");s>=0&&this.updateStep(s,"error",o),this._error.set(o),console.error("[AdminExport] Google Sheets export failed",e)}finally{this._exporting.set(!1)}}}updateStep(t,e,o){this._steps.update(s=>s.map((r,a)=>a===t?fe(de({},r),{status:e,detail:o}):r))}formatExportError(t){if(t instanceof Error){let e=t.code;return typeof e=="string"&&e.length>0?`${e}: ${t.message}`:t.message}return"Export failed"}async onFileSelected(t){let e=t.target,o=e.files?.[0];if(o){this._importing.set(!0),this._importComplete.set(!1),this._error.set(null),this._steps.set([{label:"Reading JSON file",status:"pending"},{label:"Validating data structure",status:"pending"},{label:"Importing to Firestore",status:"pending"}]);try{this.updateStep(0,"in-progress");let s=await o.text(),r=JSON.parse(s);if(this.updateStep(0,"completed"),this.updateStep(1,"in-progress"),!r.season||!r.orders)throw new Error("Invalid export file: missing season or orders data");this.updateStep(1,"completed"),this.updateStep(2,"in-progress");let a=Z(q()),d=r.year??this.configService.activeYear(),{doc:i,setDoc:l,writeBatch:m}=await import("./chunk-GSMCNYGL.js"),_=i(a,`years/${d}/seasons`,r.season.id);await l(_,r.season),this.updateStep(2,"in-progress","Season imported");let g=r.orders,y=500,S=0;for(let C=0;C<g.length;C+=y){let c=m(a),A=g.slice(C,C+y);for(let w of A){let E=i(a,`years/${d}/seasons/${r.season.id}/orders`,w.userAuthId);c.set(E,w)}await c.commit(),S+=A.length,this.updateStep(2,"in-progress",`Imported ${S}/${g.length} orders`)}if(r.users&&typeof r.users=="object"){let C=Object.entries(r.users);for(let c=0;c<C.length;c+=y){let A=m(a),w=C.slice(c,c+y);for(let[E,D]of w){let R=i(a,"users",E);A.set(R,D,{merge:!0})}await A.commit()}this.updateStep(2,"in-progress",`Imported ${C.length} users`)}if(r.registration){let C=i(a,`years/${d}/registrations`,r.season.id);await l(C,r.registration)}this.updateStep(2,"completed"),this._importComplete.set(!0),this._importSummary.set(`Imported season "${r.season.name}" with ${g.length} orders.`)}catch(s){let r=this._steps().findIndex(a=>a.status==="in-progress");r>=0&&this.updateStep(r,"error"),this._error.set(s instanceof Error?s.message:"Import failed")}finally{this._importing.set(!1),e.value=""}}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=Ce({type:n,selectors:[["app-admin-export"]],decls:4,vars:1,consts:[["fileInput",""],["pageTitle","Data Export","pageSubtitle","Export season data to spreadsheets"],[1,"admin-export"],[1,"loading-container"],[1,"spinner"],[1,"export-card"],[1,"form-group"],["for","season-select"],["id","season-select",1,"season-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"format-group"],[1,"format-options"],[1,"format-option"],["type","radio","name","format","value","google-sheets",3,"change","checked"],["type","radio","name","format","value","json",3,"change","checked"],[1,"btn-export",3,"click","disabled"],[1,"steps-card"],[1,"import-description"],["type","file","accept",".json",2,"display","none",3,"change"],[1,"btn-import",3,"click","disabled"],[1,"success-card"],[1,"error-card"],[1,"steps-list"],[1,"step",3,"step-pending","step-in-progress","step-completed","step-error"],[1,"step"],[1,"step-icon"],[1,"step-label"],[1,"step-detail"],[1,"success-icon"],["target","_blank","rel","noopener",1,"spreadsheet-link",3,"href"],[1,"error-message"]],template:function(e,o){e&1&&(p(0,"app-admin-layout",1)(1,"div",2),v(2,Ct,4,0,"div",3)(3,Ut,42,12),u()()),e&2&&(f(2),P(o.loadingSeasons()?2:3))},dependencies:[Ne,je,We,Le,Fe,Ue,ke,Je],styles:[".admin-export[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:1.5rem}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:4rem 2rem}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid var(--sys-outline, #e0e0e0);border-top-color:var(--sys-primary, #c62828);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.export-card[_ngcontent-%COMP%], .steps-card[_ngcontent-%COMP%], .success-card[_ngcontent-%COMP%], .error-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:12px;padding:1.5rem;margin-bottom:1rem}.export-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.season-select[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--sys-outline-variant, #e0e0e0);border-radius:8px;font-size:1rem;background:#fff}.format-group[_ngcontent-%COMP%]{margin-bottom:1rem}.format-group[_ngcontent-%COMP%] > label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem;font-weight:600;color:var(--sys-on-surface, #212121)}.format-options[_ngcontent-%COMP%]{display:flex;gap:1.5rem}.format-option[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;font-weight:400}.format-option[_ngcontent-%COMP%]   input[type=radio][_ngcontent-%COMP%]{cursor:pointer}.import-description[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-on-surface-variant, #666);font-size:.875rem}.btn-import[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-tertiary, #1976d2);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-import[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-tertiary-dark, #1565c0)}.btn-import[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.btn-export[_ngcontent-%COMP%]{width:100%;padding:.75rem 1.25rem;background:var(--sys-primary, #c62828);color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;transition:background .2s ease}.btn-export[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--sys-primary-dark, #a51c1c)}.btn-export[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.steps-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1.125rem;color:var(--sys-on-surface, #212121)}.steps-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.step[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.5rem 0}.step-icon[_ngcontent-%COMP%]{font-size:1rem;width:1.25rem;text-align:center}.step-pending[_ngcontent-%COMP%]{color:var(--sys-on-surface-variant, #999)}.step-in-progress[_ngcontent-%COMP%]{color:var(--sys-tertiary, #1976d2);font-weight:500}.step-completed[_ngcontent-%COMP%]{color:var(--sys-secondary, #2e7d32)}.step-error[_ngcontent-%COMP%]{color:var(--sys-error, #c62828)}.step-detail[_ngcontent-%COMP%]{font-size:.875rem;color:var(--sys-on-surface-variant, #666)}.success-card[_ngcontent-%COMP%]{text-align:center;border-color:var(--sys-secondary, #2e7d32)}.success-icon[_ngcontent-%COMP%]{font-size:2rem;color:var(--sys-secondary, #2e7d32);margin-bottom:.5rem}.success-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 1rem;color:var(--sys-secondary, #2e7d32)}.spreadsheet-link[_ngcontent-%COMP%]{display:inline-block;padding:.75rem 1.5rem;background:var(--sys-secondary, #2e7d32);color:#fff;border-radius:8px;text-decoration:none;font-weight:500}.spreadsheet-link[_ngcontent-%COMP%]:hover{opacity:.9}.error-card[_ngcontent-%COMP%]{border-color:var(--sys-error, #c62828);background:var(--sys-error-container, #ffebee)}.error-message[_ngcontent-%COMP%]{margin:0;color:var(--sys-error, #c62828);font-weight:500}"]})};export{et as AdminExportComponent};
