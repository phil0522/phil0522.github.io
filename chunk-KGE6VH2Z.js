import{b as y}from"./chunk-RYIKU5Y3.js";import{U as n,X as b}from"./chunk-YGANRGOF.js";import{F as c,aa as h,db as m,ha as g}from"./chunk-UYHN5VVP.js";import{I as l,N as d,Ob as u,da as i}from"./chunk-AFX6RXNX.js";var _=class o{functions=d(b);firestore=g(c());_users=i([]);_rebuiltAt=i(null);_rebuiltBy=i(null);_userCount=i(0);_loading=i(!1);_rebuilding=i(!1);_error=i(null);_isLoaded=i(!1);users=this._users.asReadonly();rebuiltAt=this._rebuiltAt.asReadonly();rebuiltBy=this._rebuiltBy.asReadonly();userCount=this._userCount.asReadonly();loading=this._loading.asReadonly();rebuilding=this._rebuilding.asReadonly();error=this._error.asReadonly();isLoaded=this._isLoaded.asReadonly();rebuiltAtFormatted=u(()=>{let e=this._rebuiltAt();return e?y(e):null});async loadCache(){if(!this._isLoaded()){this._loading.set(!0),this._error.set(null);try{let e=h(this.firestore,"admin","userCache"),t=await m(e);if(t.exists()){let r=t.data();this._users.set(r.users),this._rebuiltAt.set(r.rebuiltAt),this._rebuiltBy.set(r.rebuiltBy),this._userCount.set(r.userCount),this._isLoaded.set(!0)}else{this._isLoaded.set(!0),this._loading.set(!1),this._rebuilding()?n("Admin user cache miss - rebuild already in progress, skipping"):(n("Admin user cache miss - triggering automatic rebuild"),await this.rebuildCache());return}}catch(e){console.error("Failed to load user cache:",e),this._error.set("Failed to load user cache"),this._users.set([])}finally{this._loading.set(!1)}}}async reloadCache(){this._isLoaded.set(!1),await this.loadCache()}searchUsers(e){let t=this._users();if(!e||e.trim().length===0)return t;let r=e.toLowerCase().trim();return t.filter(s=>!!(s.email.toLowerCase().includes(r)||s.displayName.toLowerCase().includes(r)||s.displayId.toLowerCase().includes(r)||s.parentName.toLowerCase().includes(r)||s.studentNames.some(a=>a.toLowerCase().includes(r))||s.wechat?.toLowerCase().includes(r)))}getUserByAuthId(e){return this._users().find(t=>t.authId===e)}async ensureUsersInCache(e){if(!this._isLoaded()||this._rebuilding())return!1;let t=this._users(),r=new Set(t.map(a=>a.authId)),s=e.filter(a=>!r.has(a));return s.length>0?(n(`Admin user cache miss for ${s.length} user(s) - triggering rebuild`),await this.rebuildCache(),!0):!1}async rebuildCache(){this._rebuilding.set(!0),this._error.set(null);try{await this.functions.callApi("rebuildAdminUserCache",{}),await this.reloadCache()}catch(e){console.error("Failed to rebuild user cache:",e),this._error.set("Failed to rebuild user cache")}finally{this._rebuilding.set(!1)}}clearCache(){this._users.set([]),this._rebuiltAt.set(null),this._rebuiltBy.set(null),this._userCount.set(0),this._isLoaded.set(!1),this._error.set(null)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=l({token:o,factory:o.\u0275fac,providedIn:"root"})};export{_ as a};
